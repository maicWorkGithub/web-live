!function(e,t){"object"==typeof exports&&"object"==typeof module?module.exports=t():"function"==typeof define&&define.amd?define([],t):"object"==typeof exports?exports.WSWebRTC=t():e.WSWebRTC=t()}(this,function(){return function(e){function t(r){if(i[r])return i[r].exports;var s=i[r]={i:r,l:!1,exports:{}};return e[r].call(s.exports,s,s.exports,t),s.l=!0,s.exports}var i={};return t.m=e,t.c=i,t.i=function(e){return e},t.d=function(e,i,r){t.o(e,i)||Object.defineProperty(e,i,{configurable:!1,enumerable:!0,get:r})},t.n=function(e){var i=e&&e.__esModule?function(){return e.default}:function(){return e};return t.d(i,"a",i),i},t.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},t.p="<%=baseUrl%>/",t(t.s=113)}([function(e,t,i){"use strict";function r(e,t,i){return t in e?Object.defineProperty(e,t,{value:i,enumerable:!0,configurable:!0,writable:!0}):e[t]=i,e}var s;t.XHR={MIX:"mix",JOIN:"join",QUIT:"quit",QUERY:"query",CREATE:"create",MODIFY:"modify",STATUS:"status",ADJUST:"adjust",DESTROY:"destroy",METHOD:"method",HEADERS:"headers",SUCCESS:"success",RESPONSE:"responseText",WITHCREDENTIALS:"withCredentials"},t.RSP=(s={ERROR:-1,SUCCESS:0,RTC:1,AREA:2,OK:"ok",TYPE:"type",DATA:"data",CODE:"code",SEQ:"msgSeq",PARAM:"param",COMMAND:"command",MESSAGE:"message",TO:"to",FROM:"from",CONTENT:"content",USERID:"userId",ROOMID:"roomId",VROOMID:"vRoomId",MSG:"msg"},r(s,"AREA","area"),r(s,"USERS","users"),r(s,"TOKEN","token"),r(s,"TICKET","ticket"),r(s,"STATUS","status"),r(s,"RESULT","result"),r(s,"IP_LIST","ipList"),r(s,"HOST_NAME","hostName"),s),t.HTTP={AUTH:"auth",TIME:"time",TICKET:"ticket",PING:"ping",PONG:"pong",DISPATCH:"dispatch",FULL_LIST:"fullList",QUIT_ROOM:"quitRm",JOIN_ROOM:"userInRm",CREATE_ROOM:"createRm",DESTROY_ROOM:"destroyRm",MIX_QUERY:"chQuery",MIX_STATUS:"chStatus",MIX_ADJUST:"chOptAdjust",MIX_MODIFY:"chOptModify",FULL_VLIST:"fullVList",QUIT_VROOM:"quitVRm",JOIN_VROOM:"userInVRm",CREATE_VROOM:"createVRm",DESTROY_VROOM:"destroyVRm",IN_WHICH_VROOM:"inWhichVRm",MSG_ANSWER:"msgAnswer",SIGNAL_DISPATCH:"signalingDispatch",CASCADE_DISPATCH:"cascadedDispatch",URL_AU:"au",URL_CASCADE_DISPATCH:"cascadedDispatch",URL_SIGNAL_DISPATCH:"signalingDispatch",RESPONSE_KEY_HOST_NAME:"hostName",RESPONSE_KEY_SYSTEM_TIME:"systemTime",RESPONSE_KEY_RESPONSE_TEXT:"responseText"},t.LOG={MIX:"Mix",WSS:"Wss",SKIN:"Skin",AUTH:"Auth",PLAY:"Play",PUSH:"Push",PULL:"Pull",ROOM:"Room",FETCH:"Fetch",DEBUG:"Debug",SCREEN:"Screen",SIGNAL:"Signal",PREVIEW:"Preview",DISPATCH:"Dispatch"},t.SUFFIX={DIV_SUFFIX:"_div_id",VID_SUFFIX:"_video_id"}},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var r={ERROR:1,WARN:2,LOG:3,DEBUG:4,logLevel:3,logPanel:void 0,logCallback:void 0,setLogLevel:function(e){var t=parseInt(e);this.logLevel=t>-1&&t<5?t:this.LOG},setLogPanel:function(e){var t=window.document.getElementById(e);this.logPanel=t||void 0},setLogCallback:function(e){this.logCallback=e},error:function(e,t){if(!(this.logLevel<this.ERROR)){var i=t||"",r="【"+i+"】"+e;this.logPanel?this.logPanel.value+=r+"\n":(window.console&&window.console.error&&window.console.error(r),this.logCallback&&this.logCallback(r))}},warn:function(e,t){if(!(this.logLevel<this.WARN)){var i=t||"",r="【"+i+"】"+e;this.logPanel?this.logPanel.value+=r+"\n":(window.console&&window.console.warn&&window.console.warn(r),this.logCallback&&this.logCallback(r))}},log:function(e,t){if(!(this.logLevel<this.LOG)){var i=t||"",r="【"+i+"】"+e;this.logPanel?this.logPanel.value+=r+"\n":(window.console&&window.console.log&&window.console.log(r),this.logCallback&&this.logCallback(r))}},debug:function(e,t){if(!(this.logLevel<this.DEBUG)){var i=t||"",r="【"+i+"】"+e;this.logPanel?this.logPanel.value+=r+"\n":(window.console&&window.console.debug&&window.console.debug(r),this.logCallback&&this.logCallback(r))}}};t.default=r},function(e,t,i){"use strict";t.Globals={host:"",appId:"",appKey:"",userId:"",userRole:1,observer:void 0,isScreenTest:!1,screenPathType:1,isRtcTest:!1,rtcHosts:[],rtcPushHosts:[],rtcPullHosts:[],signalHosts:[],rtcArea:"",isRtcArea:!1,pushMixUrl:"",pushMixStreamName:"",pullMixUrl:"",pullMixStreamName:"",token:"",ticket:"",isPermission:0,permissionIndex:1,tickScene:"ticket1",impScene:"rtcRoom1",vimpScene:"rtcVRoom1",ssTestHost:"",rtcTestHost:"",dispatchTestSSHost:"",dispatchTestRTCHost:"",dispatchTestSignalHost:"",deviceId:"",version:"v2.5.1",sdkType:"MIC_LINK",regExpression:/^[0-9a-zA-Z-]*$/g,traceId:""},t.HOST={RTC_VER:2,RTC_PORT:8443,RTC_TRAN_PORT:10080,RTC_HEADER_HOST:"X-Host",RTC_HEADER_TOKEN:"X-RTC-Token",RTC_HEADER_TICKET:"X-RTC-Ticket",RTC_HEADER_APP_ID:"X-RTC-App-ID",RTC_HEADER_USER_ID:"X-RTC-User-ID",RTC_HEADER_TRACE_ID:"X-RTC-Trace-ID",PROTOCOL:"https://",PROTOCOL_WS:"wss://",PROTOCOL_RTC:"wsrtc://",PROTOCOL_RTC_SC:"wsrtcsc://",SIG_PORT:19643,SIG_PROTOCOL:"wssig://",SS_HOST:"miclink.chinanetcenter.com",RTC_HOST:"proxy.miclink.haplat.net",DISPATCH_SS_HOST:"miclink.chinanetcenter.com",DISPATCH_RTC_HOST:"dispatchcas.miclink.haplat.net",DISPATCH_SIGNAL_HOST:"dispatchsignal.haplat.net"}},function(e,t,i){"use strict";function r(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function s(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t}function o(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}Object.defineProperty(t,"__esModule",{value:!0});var n=function(){function e(e,t){for(var i=0;i<t.length;i++){var r=t[i];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}return function(t,i,r){return i&&e(t.prototype,i),r&&e(t,r),t}}(),a=i(51),u=function(e){function t(e){r(this,t);var i=s(this,(t.__proto__||Object.getPrototypeOf(t)).call(this));return i.setMaxListeners(e||100),i}return o(t,e),n(t,[{key:"listenTo",value:function(e,t){this.addListener(e,t)}},{key:"removeTo",value:function(e,t){this.removeListener(e,t)}},{key:"removeToAll",value:function(){this.removeAllListeners()}},{key:"trigger",value:function(e){for(var t=arguments.length,i=Array(t>1?t-1:0),r=1;r<t;r++)i[r-1]=arguments[r];this.emit.apply(this,[e].concat(i))}}]),t}(a);t.default=u},function(e,t,i){"use strict";t.Event={SKIN_EVENT:"WS_SKIN_EVENT",AUTH_EVENT:"WS_TICKET_EVENT",SIGNAL_EVENT:"WS_SIGNAL_EVENT",PLAYER_EVENT:"WS_PLAYER_EVENT",PREVIEW_EVENT:"WS_PREVIEW_EVENT",CHANNEL_EVENT:"WS_CHANNEL_EVENT",MIX_EVENT:"WS_MIX_EVENT",MIX_STREAM_EVENT:"WS_MIX_STREAM_EVENT",PULL_STREAM_EVENT:"WS_PULL_STREAM_EVENT",PUSH_STREAM_EVENT:"WS_PUSH_STREAM_EVENT",DISPATCH_EVENT:"WS_DISPATCH_EVENT"},t.DispatchEvent={AREA:"area"},t.SkinEvent={APPEND:"append",REMOVE:"remove"},t.AuthEvent={TOKEN:"WS_GET_TOKEN",TICKET:"WS_GET_TICKET",TICKET_UPDATE:"WS_UPDATE_TICKET"},t.LinkEvent={JOIN:"WS_ROOM_EVENT_JOIN",CREATE:"WS_ROOM_EVENT_CREATE",DESTROY:"WS_ROOM_EVENT_DESTROY",BROADCAST:"WS_ROOM_EVENT_BROADCAST",SIG_EVENT:"WS_ROOM_EVENT_SIGNAL",MIX_EVENT:"WS_ROOM_EVENT_MIX_STREAM",PULL_EVENT:"WS_ROOM_EVENT_PULL_STREAM",PUSH_EVENT:"WS_ROOM_EVENT_PUSH_STREAM",PLAY_EVENT:"WS_ROOM_EVENT_PLAY_STREAM",JOIN_V:"WS_ROOM_EVENT_JOIN_V",CREATE_V:"WS_ROOM_EVENT_CREATE_V",MIX_LAYOUT:"WS_ROOM_EVENT_MIX_LAYOUT"},t.PlayEvent={ERROR:"WS_VIDEO_ERROR",METADATA:"WS_VIDEO_METADATA",SOCKET_OPEN:"WS_LIVE_SOCKET_OPEN",SOCKET_CLOSE:"WS_LIVE_SOCKET_CLOSE",BUFFER_WARNING:"WS_VIDEO_BUFFER_WARNING",DURATION_WARNING:"WS_VIDEO_DURATION_WARNING",RESOLUTION_CHANGE:"WS_VIDEO_RESOLUTION_CHANGE"},t.SignalEvent={CONNECT_FAILED:"WS_SIG_CONNECT_FAILED",CONNECT_SUCCESS:"WS_SIG_CONNECT_SUCCESS",CONNECT_MSG_SEND:"WS_SIG_CONNECT_MSG_SEND",CONNECT_MSG_RECEIVE:"WS_SIG_CONNECT_MSG_RECEIVE"},t.PushStreamEvent={STREAM:"WS_PUSH_STREAM",METADATA:"WS_PUSH_METADATA",ADD_STREAM:"WS_PUSH_ADD_STREAM",VIDEO_ERROR:"WS_PUSH_VIDEO_ERROR",CAMERA_ERROR:"WS_PUSH_CAMERA_ERROR",DISPATCH_ERROR:"WS_PUSH_DISPATCH_ERROR",SERVER_ERROR:"WS_PUSH_SERVER_ERROR",SERVER_SUCCESS:"WS_PUSH_SERVER_SUCCESS",STREAMTRACK_CHANGE:"WS_PUSH_STREAMTRACK_CHANGE",PEER_CONN_SWITCH_EVENT:"WS_PUSH_CONN_SWITCH_EVENT"},t.PullStreamEvent={METADATA:"WS_PULL_METADATA",VIDEO_ERROR:"WS_PULL_VIDEO_ERROR",DISPATCH_ERROR:"WS_PULL_DISPATCH_ERROR",SERVER_ERROR:"WS_PULL_SERVER_ERROR",SERVER_SUCCESS:"WS_PULL_SERVER_SUCCESS",PEER_CONN_SWITCH_EVENT:"WS_PULL_CONN_SWITCH_EVENT"},t.MixStreamEvent={},t.MixEvent={JOIN:"join",QUIT:"quit",QUERY:"query",ADJUST:"adjust",CREATE:"create",MODIFY:"modify",STATUS:"status",DESTROY:"destroy"}},function(e,t,i){"use strict";t.Report={enable:!0,period:60,reportIndex:1},t.ConnType={PUSH:"PUSH",PULL:"PULL"},t.ErrorType={TIMEOUT:"TIMEOUT",REFUSED:"REFUSED",INEXIST:"INEXIST",UNKNOWN:"UNKNOWN"},t.MACRO={RTC_TYPE:"rtc_h5",UP_RES:"up_res",UP_FPS:"up_fps",UP_VBR:"up_vbr",EVENT_SEQ:"evt_seq",EVENT_TIME:"evt_tm",EVENT_NAME:"evt_name",MIC_URL:"mic_url",MIC_TIME:"mic_tm",MIC_TYPE:"mic_type",ERR_TYPE:"err_type",ERR_INFO:"err_info",CONN_ERR:"CONN_ERR",CONN_SUCC:"CONN_SUCC",CONN_TYPE:"conn_type",ROOM_ID:"room_id",TRACE_ID:"trace_id",ENC_MODE:"HW",DEC_MODE:"HW",AENC_MODE:"aenc_mode",VENC_MODE:"venc_mode",ADEC_MODE:"adec_mode",VDEC_MODE:"vdec_mode",NET_INFO:"net_info",SYS_INFO:"sys_info",DEV_INFO:"dev_info",SDK_TYPE:"sdk_type",SDK_INFO:"sdk_info",TRANS_INFO:"trans_info",CAMERA_INFO:"camera_info",PEERS:"peers",MIX_INFO:"MIX_INFO",STOP_RSN:"stop_rsn",EXIT_RSN:"exit_rsn",PUSH_STOP:"PUSH_STOP",PUSH_START:"PUSH_START",PULL_STOP:"PULL_STOP",PULL_START:"PULL_START",RGL_PUSH_REPORT:"RGL_PUSH_REPORT",RGL_PULL_REPORT:"RGL_PULL_REPORT",AVG_VLR:"avg_vlr",AVG_ALR:"avg_alr",AVG_VBR:"avg_vbr",AVG_ABR:"avg_abr",TTL_VSP:"ttl_vsp",TTL_ASP:"ttl_asp",TRANS_DELAY:"delay_ms",JITTER_TIME:"ttl_jit_sec",JITTER_COUNT:"ttl_jit_count",AVG_RVBR:"avg_rvbr",TAR_ENC_BR:"tar_enc_br",AVG_ENC_FPS:"avg_enc_fps",AVG_DEC_FPS:"avg_dec_fps",AVG_TRAN_FPS:"avg_trans_fps"}},function(e,t,i){"use strict";function r(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}Object.defineProperty(t,"__esModule",{value:!0});var s=function(){function e(e,t){for(var i=0;i<t.length;i++){var r=t[i];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}return function(t,i,r){return i&&e(t.prototype,i),r&&e(t,r),t}}(),o=function(){function e(){r(this,e)}return s(e,null,[{key:"isWebRTCSupported",value:function(){return!!window.RTCPeerConnection}},{key:"isMSESupported",value:function(){var e=window.MediaSource||window.WebKitMediaSource;return e&&"function"==typeof e.isTypeSupported&&e.isTypeSupported('video/mp4; codecs="avc1.42E01E,mp4a.40.2"')}},{key:"isGetUserMediaSupported",value:function(){return!(!window.navigator.mediaDevices||!window.navigator.mediaDevices.getUserMedia)}},{key:"getCameraCapacity",value:function(){return window.navigator.mediaDevices&&window.navigator.mediaDevices.getSupportedConstraints?window.navigator.mediaDevices.getSupportedConstraints():{}}},{key:"hasUserMedia",value:function(){return!!(navigator.getUserMedia||navigator.msGetUserMedia||navigator.webkitGetUserMedia||navigator.mozGetUserMedia)}},{key:"hasRTCPeerConnection",value:function(){return!!(window.RTCPeerConnection||window.webkitRTCPeerConnection||window.mozRTCPeerConnection||window.msRTCPeerConnection)}},{key:"getMediaDevices",value:function(e){var t=void 0,i=[],r=[],s=[],o=window.navigator.mediaDevices;o&&o.enumerateDevices?o.enumerateDevices().then(function(o){for(var n in o)if(o.hasOwnProperty(n)){var a={};t=o[n],a.kind=t.kind,a.label=t.label,a.groupId=t.groupId,a.deviceId=t.deviceId,"videoinput"===t.kind?i.push(a):"audioinput"===t.kind?r.push(a):"audiooutput"===t.kind&&s.push(a)}e&&e(i,r,s)}).catch(function(t){e&&e(i,r,s)}):e&&e(i,r,s)}},{key:"getAspectByProfile",value:function(e){var t={aspectRatio:4/3,width:480,height:360,minBitRate:400,maxBitRate:700};switch(String(e).toUpperCase()){case"180P_1":t.aspectRatio=4/3,t.width=240,t.height=180,t.minBitRate=100,t.maxBitRate=400;break;case"180P_2":t.aspectRatio=16/9,t.width=320,t.height=180,t.minBitRate=100,t.maxBitRate=400;break;case"360P_1":t.aspectRatio=4/3,t.width=480,t.height=360,t.minBitRate=400,t.maxBitRate=700;break;case"360P_2":t.aspectRatio=16/9,t.width=640,t.height=360,t.minBitRate=400,t.maxBitRate=700;break;case"480P_1":t.aspectRatio=4/3,t.width=640,t.height=480,t.minBitRate=500,t.maxBitRate=800;break;case"480P_2":t.aspectRatio=16/9,t.width=848,t.height=480,t.minBitRate=500,t.maxBitRate=800;break;case"540P_1":t.aspectRatio=4/3,t.width=720,t.height=540,t.minBitRate=600,t.maxBitRate=1e3;break;case"540P_2":t.aspectRatio=16/9,t.width=960,t.height=540,t.minBitRate=600,t.maxBitRate=1e3;break;case"720P_1":t.aspectRatio=4/3,t.width=960,t.height=720,t.minBitRate=800,t.maxBitRate=1500;break;case"720P_2":t.aspectRatio=16/9,t.width=1280,t.height=720,t.minBitRate=800,t.maxBitRate=1500;break;case"1080P_1":t.aspectRatio=4/3,t.width=1440,t.height=1080,t.minBitRate=1e3,t.maxBitRate=2e3;break;case"1080P_2":t.aspectRatio=16/9,t.width=1920,t.height=1080,t.minBitRate=1e3,t.maxBitRate=2e3}return t}},{key:"getQueryParams",value:function(e){var t={},i=e.split("&");if(!i.length)return t;for(var r=void 0,s=i.length,o=0;o<s;o++)r=i[o].split("="),r.length>1&&(t[r[0]]=r[1]);return t}},{key:"getStreamName",value:function(e){var t=e.split("?"),i="",r=t[0].indexOf("//");if(-1!==r){var s=t[0].substr(r+2);r=s.indexOf("/"),-1!==r&&(i=s.substr(r+1))}return i}},{key:"setRotationDegreee",value:function(e,t){if(e){var i=parseInt(t);i<0&&(i=-i),i>360&&(i%=360);for(var r="rotate("+i+"deg)",s=["transform","oTransform","msTransform","mozTransform","webkitTransform"],o=0;o<s.length;o++)e.style[s[o]]=r}}},{key:"setVideoVolume",value:function(e,t){var i=document.getElementById(e);if(i){var r=parseInt(t);(r<0||r>100)&&(r=100),i.volume=r/100}}},{key:"closeEchoCancellation",value:function(e){for(var t=e,i=["googEchoCancellation","googEchoCancellation2","googNoiseSuppression","googNoiseSuppression2","googAutoGainControl","googHighpassFilter","googTypingNoiseDetection"],r=0;r<i.length;r++)t.audio&&(t.audio[i[r]]=!1);return t}},{key:"randomNumString",value:function(e){var t=parseInt(e);return(isNaN(t)||t<1)&&(t=6),Math.random().toFixed(t).substring(2)}},{key:"str2hex",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"",i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0;if(!e)return"";e+="";for(var r=void 0,s=[],o=e.length,n=0;n<o;n++)r=(e.charCodeAt(n)+i).toString(16),s.push(r.length<2?"0"+r:r);return s.join(t)}},{key:"hex2str",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"",i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0;if(!e)return"";e+="",e=e.split(t);for(var r=void 0,s="",o=e.length,n=0;n<o;n++)r=parseInt(e[n],16)-i,s+=String.fromCharCode(r);return s}},{key:"trim",value:function(e){return this.ltrim(this.rtrim(e))}},{key:"ltrim",value:function(e){if(!e)return"";for(var t=0;t<e.length;t++)if(e.charCodeAt(t)>32)return e.substring(t);return""}},{key:"rtrim",value:function(e){if(!e)return"";for(var t=e.length;t>0;t--)if(e.charCodeAt(t-1)>32)return e.substring(0,t);return""}},{key:"getBrowserUUID",value:function(t){var i=document.createElement("canvas"),r=t||"wsWebRTC",s=i.getContext("2d");s.textBaseline="top",s.font="14px 'Arial'",s.textBaseline="middle",s.fillStyle="#f60",s.fillRect(125,1,62,20),s.fillStyle="#069",s.fillText(r,2,15),s.fillStyle="rgba(102, 204, 0, 0.7)",s.fillText(r,4,17);var o=atob(i.toDataURL().replace("data:image/png;base64,",""));return e.str2hex(o.slice(-16,-12))}},{key:"getBlowserInfo",value:function(){return{appName:navigator.appName,appVersion:navigator.appVersion,platform:navigator.platform,userAgent:navigator.userAgent}}},{key:"uuid",value:function(){for(var e=[],t="0123456789ABCDEF",i=0;i<36;i++)e[i]=t.substr(Math.floor(16*Math.random()),1);return e[14]="4",e[19]=t.substr(3&e[19]|8,1),e[8]=e[13]=e[18]=e[23]="-",e.join("")}},{key:"setVideoDisplay",value:function(e,t){if(e){var i=void 0;if("String"===Object.prototype.toString.call(e).slice(8,-1)){if(!(i=document.getElementById(e)))return;i.style["object-fit"]=t||"fill"}else if("Array"===Object.prototype.toString.call(e).slice(8,-1))for(var r=0;r<e.length;r++)i=document.getElementById(e[r]),i.style["object-fit"]=t||"fill"}else for(var s=document.getElementsByTagName("video"),o=0;o<s.length;o++)s[o].style["object-fit"]=t||"fill"}},{key:"initNotification",value:function(){var e=window.Notification||window.mozNotification||window.webkitNotification;e&&e.requestPermission().then(function(e){console&&console.log("enable notification api: "+("granted"===e))})}},{key:"printCurTime",value:function(){return(new Date).pattern("yyyy-MM-dd HH:mm:ss.S").split(" ")[1]}},{key:"setDataPattern",value:function(){Date.prototype.pattern=function(e){var t={"M+":this.getMonth()+1,"d+":this.getDate(),"h+":this.getHours()%12==0?12:this.getHours()%12,"H+":this.getHours(),"m+":this.getMinutes(),"s+":this.getSeconds(),"q+":Math.floor((this.getMonth()+3)/3),S:this.getMilliseconds()},i={0:"/u65e5",1:"/u4e00",2:"/u4e8c",3:"/u4e09",4:"/u56db",5:"/u4e94",6:"/u516d"};/(y+)/.test(e)&&(e=e.replace(RegExp.$1,(this.getFullYear()+"").substr(4-RegExp.$1.length))),/(E+)/.test(e)&&(e=e.replace(RegExp.$1,(RegExp.$1.length>1?RegExp.$1.length>2?"/u661f/u671f":"/u5468":"")+i[this.getDay()+""]));for(var r in t)new RegExp("("+r+")").test(e)&&(e=e.replace(RegExp.$1,1===RegExp.$1.length?t[r]:("00"+t[r]).substr((""+t[r]).length)));return e}}},{key:"isOldGetUserMedia",value:function(){return/MQQBrowser/i.test(navigator.userAgent)}},{key:"isAndroid",value:function(){return/Android/i.test(navigator.userAgent)}},{key:"isWindowPhone",value:function(){return/Windows Phone/i.test(navigator.userAgent)}},{key:"isIos",value:function(){return/iPad|iPhone|iPod/i.test(navigator.userAgent)}},{key:"isMobile",value:function(){return/Android|webOS|iPhone|iPad|iPod|BlackBerry|Windows Phone|IEMobile|Opera Mini/i.test(navigator.userAgent)}},{key:"isMobileQQ",value:function(){return e.isMobile()&&/QQ\//i.test(navigator.userAgent)}},{key:"isMobileWX",value:function(){return e.isMobile()&&/MicroMessenger/i.test(navigator.userAgent)}},{key:"isSafari",value:function(){return/safari/i.test(navigator.userAgent)&&-1===navigator.userAgent.indexOf("Chrome")}},{key:"isMobileFirefox",value:function(){return e.isMobile()&&/Firefox/i.test(navigator.userAgent)}}]),e}();t.default=o},function(e,t,i){"use strict";function r(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}Object.defineProperty(t,"__esModule",{value:!0});var s=function(){function e(e,t){for(var i=0;i<t.length;i++){var r=t[i];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}return function(t,i,r){return i&&e(t.prototype,i),r&&e(t,r),t}}();i(26);var o=i(0),n=i(1),a=function(e){return e&&e.__esModule?e:{default:e}}(n),u=function(){function e(){r(this,e)}return s(e,null,[{key:"querys",value:function(e){if(!e.url)return null;var t={method:"POST"},i=e.url;for(var r in e)if(e.hasOwnProperty(r))switch(r){case"type":t.method=String(e[r]).toUpperCase();break;case"data":var s=e[r];"string"!=typeof s&&(s=JSON.stringify(e[r]));var n=s;void 0!==e.reportHeader?(n=e.reportHeader+s.substring(1),a.default.debug(n,o.LOG.FETCH)):a.default.log(n,o.LOG.FETCH),t.body=n;break;case"headers":t.headers=e[r]}return t.headers?t.headers["Content-Type"]=e.contentType||"text/plain":"GET"!==t.method&&(t.headers={"Content-Type":e.contentType||"text/plain"}),{url:i,params:t}}},{key:"checkStatus",value:function(e){if(e.status>=200&&e.status<300)return e;var t=new Error(e.statusText);throw t.response=e,t.status=e.status,t}},{key:"ajax",value:function(t){var i=e.querys(t);i&&fetch(i.url,i.params).then(e.checkStatus).then(function(e){var t=e.text();return""!==t?t:"{}"}).then(t.success).catch(function(e){e&&void 0===e.status&&(e.status=-1),t.error&&t.error(e)})}}]),e}();t.default=u},function(e,t,i){"use strict";t.PlayerEvent={PLAYER_EVENT:"playerEvent",MEDIA_EVENT:"mediaEvent",VIDEO_EVENT:"videoEvent"},t.PlayerMessage={ERROR:"error",NETWORK:"network",PLAY_ERROR:"playError",PLAY_ENDED:"playEnded",PLAY_RESTART:"playRestart",METADATA:"metadata",SOCKET_OPEN:"socketOpen",SOCKET_CLOSE:"socketClose",BUFFER_WARNING:"bufferWarning",DURATION_WARNING:"durationWaring",DIMENSION_CHANGE:"dimensionChange",AUDIO_VIDEO_SWITCH:"audioVideoSwitch"}},function(e,t,i){"use strict";t.PullEvent={PULL_EVENT:"pullEvent",PEER_EVENT:"peerEvent",VIDEO_EVENT:"videoEvent"},t.PullMessage={PLAY_ERROR:"playError",DISPATCH_ERROR:"dispatchError",RTC_SERVER_ERROR:"rtcServerError",PLAY_METADATA:"playMetadata",RTC_SERVER_SUCCESS:"rtcServerSuccess",PEER_STAT:"peerStat",PEER_CONN_SWITCH_EVENT:"peerConnectionSwitchEvent"},t.STAT={SSRC:"ssrc",VIDEO_BWE:"VideoBwe",CANDIDATE_PAIR:"googCandidatePair",PEER_PROC:"peerProtocol",PEER_BYTES_RECEIVED:"peerBytesReceived",PEER_STAT_EVENT:"peerStatInfoEvent",PEER_CONN_SWITCH_EVENT:"peerConnectionSwitchEvent"}},function(e,t,i){"use strict";t.PushEvent={PUSH_EVENT:"pushEvent",PEER_EVENT:"peerEvent",VIDEO_EVENT:"videoEvent"},t.PushMessage={PLAY_ERROR:"playError",CAMERA_ERROR:"cameraError",DISPATCH_ERROR:"dispatchError",RTC_SERVER_ERROR:"rtcServerError",PLAY_METADATA:"playMetadata",RTC_SERVER_SUCCESS:"rtcServerSuccess",ADD_STREAM:"addStream",STREAM:"stream",STREAM_TRACK:"streamTrace",PEER_STAT:"peerStat",PEER_CONN_SWITCH_EVENT:"peerConnectionSwitchEvent"},t.VideoType={VP8:"VP8",VP9:"VP9",H264:"H264"},t.STAT={SSRC:"ssrc",VIDEO_BWE:"VideoBwe",CANDIDATE_PAIR:"googCandidatePair",PEER_PROC:"peerProtocol",PEER_BYTES_RECEIVED:"peerBytesReceived",PEER_STAT_EVENT:"peerStatInfoEvent",PEER_CONN_SWITCH_EVENT:"peerConnectionSwitchEvent"}},function(e,t,i){"use strict";function r(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}Object.defineProperty(t,"__esModule",{value:!0});var s=function(){function e(e,t){for(var i=0;i<t.length;i++){var r=t[i];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}return function(t,i,r){return i&&e(t.prototype,i),r&&e(t,r),t}}(),o=i(5),n=i(7),a=function(e){return e&&e.__esModule?e:{default:e}}(n),u=i(2),c=function(){function e(){r(this,e),this.SDK_TYPE="rtc_h5",this.DATA_PATTERN="yyyy-MM-dd HH:mm:ss.S",this.URL="https://wsqlogc.up.lxdns.com/report.php?reportIndex=",this.init()}return s(e,[{key:"init",value:function(){this._netInfo="wifi",this._browserInfo="";var e=window.navigator.userAgent;if(e&&e.length){var t=e.split(" ");t&&t.length>1&&(this._browserInfo=t[t.length-2]+" "+t[t.length-1])}}},{key:"report",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};if(o.Report.enable){var t=e.data||{};t[o.MACRO.DEV_INFO]="Web",t[o.MACRO.EVENT_SEQ]=o.Report.reportIndex,t[o.MACRO.TRACE_ID]=u.Globals.traceId,t[o.MACRO.NET_INFO]=this._netInfo,t[o.MACRO.SYS_INFO]=this._browserInfo,t[o.MACRO.SDK_TYPE]=o.MACRO.RTC_TYPE,t[o.MACRO.SDK_INFO]=u.Globals.version.substring(1);var i="";i=t[o.MACRO.EVENT_NAME]===o.MACRO.RGL_PUSH_REPORT||t[o.MACRO.EVENT_NAME]===o.MACRO.RGL_PULL_REPORT?'#Type webrtc-reg\r\n#Lineheader {"local_time":"[$local_time]","remote_ip":"[$remove_ip]",\r\n':'#Type webrtc\r\n#Lineheader {"local_time":"[$local_time]","remote_ip":"[$remove_ip]",\r\n',a.default.ajax({type:"POST",data:JSON.stringify(t),reportHeader:i,headers:e.headers||{},url:this.URL+o.Report.reportIndex,success:function(){},error:function(){}}),o.Report.reportIndex++}}},{key:"getCurrentTime",value:function(){var e=(new Date).pattern(this.DATA_PATTERN).replace(/-|\.|\:|\s/g,"");return 17===e.length?e:16===e.length?e.substr(0,14)+"0"+e.substr(14,2):15===e.length?e.substr(0,14)+"00"+e.substr(14,1):e}}]),e}();t.default=c},function(e,t,i){"use strict";t.RoomEvent={ROOM_EVENT:"roomEvent",CONNECT_EVENT:"connectEvent",CONNECT_MESSAGE_EVENT:"conMessageEvent",CONNECT_RECREATE_EVENT:"conRecreateEvent",CONNECT_PONG_ERROR_EVENT:"conPongErrorEvent"},t.RoomMessage={JOIN_ROOM:"joinRoom",BROADCAST:"broadcast",CREATE_ROOM:"createRoom",DESTROY_ROOM:"destroyRm",QUIT_VROOM:"quitVRm",JOIN_VROOM:"joinVRoom",CREATE_VROOM:"createVRoom",BROADCAST_V:"broadcastVRm",DESTROY_VROOM:"destroyVRm",WHICH_VROOM:"inWhichVRoom"},t.RoomRole={AUDIENCE:0,INTERACTIVE:1,ANCHOR:2},t.RoomCode={OK:0,EXIST_ROOM:1101,EXIST_NOT_ROOM:1107,EXIST_CONNECTING_LIST:1102,EXIST_CONNECTED_LIST:1103,AGREE_CONNECTED_LIST:1104,CANCEL_EXIST_NOT_CONNECT_LIST:1105,KICK_EXIST_NOT_CONNECT_LIST:1106,ANCHOR_IN_LANCHED:1109,LINK_COUNT_NOT_LIMIT:1108,LINK_COUNT_OVER_LIMIT:1110,URL_FORMAT_ERROR:2301,UNAUTHORIZED:2302,EXCEED_AUTHORITY:2303,REQUEST_NOT_DEFINED:2304,REQUEST_TOO_MANY:2305,SECRET_KEY_OVERDUE:2306,SECRET_TICKET_OVERDUE:2307,SERVER_INTERNAL_ERROR:3301,GATEWAY_TIMEOUT:3302,USER_LOST:3303},t.RoomCommand={KICK:"WSRTC_KICK_CONNECTION",AGREE:"WSRTC_AGREE_CONNECTION",REFUSE:"WSRTC_REFUSE_CONNECTION",CANCEL:"WSRTC_CANCEL_FOR_CONNECTION",REQUEST:"WSRTC_REQUEST_FOR_CONNECTION"}},function(e,t,i){"use strict";function r(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}Object.defineProperty(t,"__esModule",{value:!0});var s=function(){function e(e,t){for(var i=0;i<t.length;i++){var r=t[i];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}return function(t,i,r){return i&&e(t.prototype,i),r&&e(t,r),t}}(),o=function(){function e(){r(this,e)}return s(e,null,[{key:"isFirefox",value:function(){return/firefox/i.test(navigator.userAgent)}},{key:"extractVersion",value:function(e,t){var i=navigator.userAgent.match(e);return i&&i.length>=t?parseInt(i[t],10):-1}}]),e}();t.default=o},function(e,t,i){"use strict";var r={utf8:{stringToBytes:function(e){return r.bin.stringToBytes(unescape(encodeURIComponent(e)))},bytesToString:function(e){return decodeURIComponent(escape(r.bin.bytesToString(e)))}},bin:{stringToBytes:function(e){for(var t=[],i=0;i<e.length;i++)t.push(255&e.charCodeAt(i));return t},bytesToString:function(e){for(var t=[],i=0;i<e.length;i++)t.push(String.fromCharCode(e[i]));return t.join("")}}};e.exports=r},function(e,t,i){"use strict";function r(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}Object.defineProperty(t,"__esModule",{value:!0});var s=function(){function e(e,t){for(var i=0;i<t.length;i++){var r=t[i];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}return function(t,i,r){return i&&e(t.prototype,i),r&&e(t,r),t}}(),o=i(27),n=i(0),a=i(1),u=function(e){return e&&e.__esModule?e:{default:e}}(a),c=function(){function e(t,i){r(this,e),this.params=void 0,this.xhrLoader=void 0,this.TIMEOUT=2e4,this.timeoutTimer=void 0,this.errorCallback=i,this.successCallback=t}return s(e,[{key:"start",value:function(e,t,i){this.stop(),this.parseConfig(i);var r=this.xhrLoader=o.XHR.createXHR();r.onerror=this.xhrLoadError.bind(this),r.onloadend=this.xhrLoadEnd.bind(this);var s="POST";"GET"===String(this.params.method).toUpperCase()&&(s="GET"),u.default.log("xhr: "+e,n.LOG.FETCH),r.open(s,e,!0),r.withCredentials=this.params.withCredentials,this.setHeaders(s),this.parseData(t),this.startTimeout(),"{}"!==this.params.data?r.send(this.params.data):r.send()}},{key:"stop",value:function(){this.stopTimeout(),this.xhrLoader&&(this.xhrLoader.onerror=void 0,this.xhrLoader.onloadend=void 0,this.xhrLoader.abort()),this.xhrLoader=void 0}},{key:"startTimeout",value:function(){this.stopTimeout(),this.timeoutTimer=window.setTimeout(this.xhrLoadTimeout.bind(this),this.TIMEOUT)}},{key:"stopTimeout",value:function(){this.timeoutTimer&&(window.clearTimeout(this.timeoutTimer),this.timeoutTimer=void 0)}},{key:"parseConfig",value:function(e){this.params={data:"{}",method:"post",headers:void 0,withCredentials:!1};for(var t in e)if(e.hasOwnProperty(t))switch(t){case"method":case"headers":this.params[t]=e[t];break;case"withCredentials":this.params[t]="true"===String(e[t])}}},{key:"setHeaders",value:function(e){if(this.params.headers){var t=this.params.headers;for(var i in t)t.hasOwnProperty(i)&&this.xhrLoader.setRequestHeader(i,t[i])}"POST"===e&&this.xhrLoader.setRequestHeader("Content-Type","application/x-www-form-urlencoded")}},{key:"parseData",value:function(e){"string"!=typeof e?"Object"===Object.prototype.toString.call(e).slice(8,-1)&&(this.params.data=JSON.stringify(e)):this.params.data=e}},{key:"xhrLoadEnd",value:function(e){if(this.stopTimeout(),!e||!e.currentTarget)return this.stop(),void(this.errorCallback&&this.errorCallback({status:-1},"null"));var t=e.currentTarget.status,i=e.currentTarget.responseText;t>=200&&t<300||304===t?this.successCallback&&this.successCallback(i,"success"):this.errorCallback&&this.errorCallback({status:t},"error"),this.stop()}},{key:"xhrLoadError",value:function(e){if(this.stopTimeout(),!e||!e.currentTarget)return this.stop(),void(this.errorCallback&&this.errorCallback({status:-1},"null"));this.errorCallback&&this.errorCallback({status:e.currentTarget.status},"error"),this.stop()}},{key:"xhrLoadTimeout",value:function(){this.stop(),this.errorCallback&&this.errorCallback({status:-1},"null")}}]),e}();t.default=c},function(e,t,i){"use strict";var r=i(1),s=function(e){return e&&e.__esModule?e:{default:e}}(r);t.logger={logLevel:3,logCallback:void 0,setLogLevel:function(e){this.logLevel=parseInt(e)},setLogCallback:function(e){this.logCallback=e},error:function(e){this.logLevel<1||(s.default.error(e,"Play"),this.logCallback&&this.logCallback("【"+type+"】"+e))},warn:function(e){this.logLevel<2||(s.default.warn(e,"Play"),this.logCallback&&this.logCallback("【"+type+"】"+e))},log:function(e){this.logLevel<3||(s.default.log(e,"Play"),this.logCallback&&this.logCallback("【"+type+"】"+e))},debug:function(e){this.logLevel<4||(s.default.log(e,"Play"),this.logCallback&&this.logCallback("【"+type+"】"+e))}}},function(e,t,i){"use strict";function r(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}Object.defineProperty(t,"__esModule",{value:!0});var s=function(){function e(e,t){for(var i=0;i<t.length;i++){var r=t[i];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}return function(t,i,r){return i&&e(t.prototype,i),r&&e(t,r),t}}(),o=i(4),n=i(0),a=i(1),u=function(e){return e&&e.__esModule?e:{default:e}}(a),c=function(){function e(t){r(this,e),this.observer=t}return s(e,[{key:"append",value:function(e,t){var i=!(arguments.length>2&&void 0!==arguments[2])||arguments[2],r=arguments.length>3&&void 0!==arguments[3]?arguments[3]:{},s=document.createElement("video");if(!s)return u.default.warn("create video element failed",n.LOG.SKIN),s;if(s.style.width="100%",s.style.height="100%",s.setAttribute("autoplay","autoplay"),s.setAttribute("playsinline",""),s.setAttribute("x5-playsinline",""),s.setAttribute("webkit-playsinline",""),s.setAttribute("oncontextmenu","return false"),s.setAttribute("id",e+n.SUFFIX.VID_SUFFIX),void 0!==r.poster){var a=String(r.poster);""!==a&&s.setAttribute("poster",a)}if("true"===String(r.enableControls)&&s.setAttribute("controls","controls"),t===n.LOG.PUSH&&"false"!==String(i))for(var c=["transform","oTransform","msTransform","mozTransform","webkitTransform"],l=0;l<c.length;l++)s.style[c[l]]="scale(-1, 1)";var h=document.createElement("div");if(!h)return u.default.warn("create div element failed",n.LOG.SKIN),s;h.style.width="100%",h.style.height="100%",h.style.overflow="hidden",h.setAttribute("id",e+n.SUFFIX.DIV_SUFFIX);try{h.appendChild(s),this.observer&&this.observer.trigger(o.Event.SKIN_EVENT,{type:o.SkinEvent.APPEND,code:0,message:t,data:h})}catch(e){}return u.default.log(t+", append video by "+s.id,n.LOG.SKIN),s}},{key:"remove",value:function(e,t){var i=document.getElementById(e);if(!i)return void u.default.log("no video by "+e,n.LOG.SKIN);try{i.srcObject=null;var r=i.parentNode;if(!r)return void u.default.log("no parent by "+e,n.LOG.SKIN);r.removeChild(i);var s=r.parentNode;if(!s)return void u.default.log("no parent parent by "+e,n.LOG.SKIN);s.removeChild(r),this.observer&&this.observer.trigger(o.Event.SKIN_EVENT,{type:o.SkinEvent.REMOVE,code:0,message:t,data:s.id})}catch(e){}u.default.log("romove video by "+e,n.LOG.SKIN)}}]),e}();t.default=c},function(e,t,i){"use strict";function r(e){return e&&e.__esModule?e:{default:e}}function s(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}Object.defineProperty(t,"__esModule",{value:!0});var o=function(){function e(e,t){for(var i=0;i<t.length;i++){var r=t[i];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}return function(t,i,r){return i&&e(t.prototype,i),r&&e(t,r),t}}(),n=i(0),a=i(2);i(26);var u=i(7),c=r(u),l=i(1),h=r(l),d=function(){function e(){s(this,e),this._config={},this._SCENE="rtcRoom3"}return o(e,[{key:"dispatch",value:function(e){var t=this;return this._config=e||{},new Promise(function(e,i){var r=t._getQuerys(),s=c.default.querys(r);fetch(s.url,s.params).then(function(e){if(e.status>=200&&e.status<300)return e;var t=new Error(e.statusText);throw t.response=e,t.status=e.status,t}).then(function(e){return e.text()}).then(function(t){h.default.log(t,n.LOG.ROOM);var r=JSON.parse(t)||{},s=r[n.RSP.MSG],o=parseInt(r[n.RSP.STATUS]);0===o?e(r[n.RSP.HOST_NAME]||""):i({status:o,message:s})}).catch(function(e){i(e)})})}},{key:"_getQuerys",value:function(){var e={command:n.HTTP.DISPATCH,host:a.Globals.host,token:a.Globals.token,appId:a.Globals.appId,userId:a.Globals.userId,scene:a.Globals.impScene,deviceId:a.Globals.deviceId,userRole:a.Globals.permissionIndex};e.roomId=this._config.roomId,e.param={},a.Globals.isPermission||(e.userRole=this._config.userRole),this._config.scene===this._SCENE&&(e.scene=this._SCENE);var t=a.HOST.PROTOCOL;return""===a.Globals.dispatchTestSSHost?t+=a.HOST.DISPATCH_SS_HOST+"/sls/room/dispatch":t+=a.Globals.dispatchTestSSHost+"/sls/room/dispatch",{url:t,data:e}}}]),e}();t.default=d},function(e,t,i){"use strict";function r(e){return e&&e.__esModule?e:{default:e}}function s(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}Object.defineProperty(t,"__esModule",{value:!0});var o=function(){function e(e,t){for(var i=0;i<t.length;i++){var r=t[i];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}return function(t,i,r){return i&&e(t.prototype,i),r&&e(t,r),t}}(),n=i(0),a=i(2),u=i(4),c=i(1),l=r(c),h=i(60),d=r(h),f=i(18),_=r(f),v=i(61),p=r(v),m=function(){function e(){s(this,e),this._config={},this._rtcArea=void 0,this._ssDispatcher=void 0,this._rtcDispatcher=void 0}return o(e,[{key:"init",value:function(e){this._config=e||{}}},{key:"startRTC",value:function(e){this._createRTCDispatcher(e)}},{key:"startArea",value:function(e){this._createAreaDispatcher(e)}},{key:"startIMP",value:function(e){this._createIMPDispatcher(e)}},{key:"stop",value:function(){this._destroyRTCDispatcher(),this._destroyAreaDispatcher(),this._destroyIMPDispatcher()}},{key:"_destroyRTCDispatcher",value:function(){this._rtcDispatcher&&(this._rtcDispatcher.stop(),this._rtcDispatcher=void 0)}},{key:"_createRTCDispatcher",value:function(e){this._rtcDispatcher||(this._rtcDispatcher=new p.default(function(t){t[n.RSP.CODE]!==n.RSP.SUCCESS?e&&e(t[n.RSP.CODE],t[n.RSP.MESSAGE]):(a.Globals.isRtcTest?a.Globals.rtcPushHosts=t[n.RSP.MESSAGE]||[]:a.Globals.rtcHosts=t[n.RSP.MESSAGE]||[],e&&e(n.RSP.SUCCESS,"success"))})),this._rtcDispatcher.start({roomId:this._config.roomId,userRole:this._config.userRole})}},{key:"_destroyAreaDispatcher",value:function(){this._rtcArea&&(this._rtcArea.stop(),this._rtcArea=void 0)}},{key:"_createAreaDispatcher",value:function(e){this._rtcArea||(this._rtcArea=new d.default(function(t){var i="",r=n.RSP.SUCCESS,s="success";t[n.RSP.CODE]!==n.RSP.SUCCESS?(r=n.RSP.ERROR,s=t[n.RSP.MESSAGE],a.Globals.rtcArea="",l.default.warn("area dispatch error",n.LOG.DISPATCH),e&&e(t[n.RSP.CODE],t[n.RSP.MESSAGE])):(i=a.Globals.rtcArea=t[n.RSP.MESSAGE]||"",e&&e(n.RSP.SUCCESS,"success")),a.Globals.observer&&a.Globals.observer.trigger(u.Event.DISPATCH_EVENT,{type:u.DispatchEvent.AREA,code:r,message:s,data:{area:i}})}));var t=a.Globals.isRtcTest?a.Globals.rtcPushHosts:a.Globals.rtcHosts;this._rtcArea.start({host:t.length>0?t[0]:""})}},{key:"_createIMPDispatcher",value:function(e){this._ssDispatcher||(this._ssDispatcher=new _.default),this._ssDispatcher.dispatch({roomId:this._config.roomId,userRole:this._config.userRole}).then(function(t){e&&e(n.RSP.SUCCESS,t)}).catch(function(t){e&&e(n.RSP.ERROR,"")})}},{key:"_destroyIMPDispatcher",value:function(){this._ssDispatcher&&(this._ssDispatcher=void 0)}}]),e}();t.default=m},function(e,t,i){"use strict";function r(e){return e&&e.__esModule?e:{default:e}}function s(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function o(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t}function n(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}Object.defineProperty(t,"__esModule",{value:!0});var a=function(){function e(e,t){for(var i=0;i<t.length;i++){var r=t[i];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}return function(t,i,r){return i&&e(t.prototype,i),r&&e(t,r),t}}(),u=i(4),c=i(0),l=i(1),h=r(l),d=i(3),f=r(d),_=i(65),v=r(_),p=function(e){function t(){s(this,t);var e=o(this,(t.__proto__||Object.getPrototypeOf(t)).call(this));return e._config={},e._manager=void 0,e}return n(t,e),a(t,[{key:"start",value:function(e){this._parseConfig(e),this._manager||(this._manager=new v.default,this._manager.listenTo(u.Event.MIX_STREAM_EVENT,this._onMixStreamHandler.bind(this))),this._manager.start(this._config)}},{key:"startMix",value:function(e){this.start(e)}},{key:"stop",value:function(){this._manager&&(this._manager.removeToAll(),this._manager.stop(),this._manager=void 0)}},{key:"stopMix",value:function(){this.stop()}},{key:"startMixCheck",value:function(e){this._manager&&this._manager.startStatusTimer(e)}},{key:"stopMixCheck",value:function(){this._manager&&this._manager.stopStatusTimer()}},{key:"mixCreate",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};this._manager&&this._manager.mixCreate(e)}},{key:"mixModify",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};this._manager&&this._manager.mixModify(e)}},{key:"mixAdjust",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};this._manager&&this._manager.mixAdjust(e)}},{key:"mixJoin",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};this._manager&&this._manager.mixJoin(e)}},{key:"mixQuit",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};this._manager&&this._manager.mixQuit(e)}},{key:"mixStatus",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};this._manager&&this._manager.mixStatus(e)}},{key:"mixQuery",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};this._manager&&this._manager.mixQuery(e)}},{key:"mixDestroy",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};this._manager&&this._manager.mixDestroy(e)}},{key:"mixHost",value:function(e){this._manager&&this._manager.mixHost(e)}},{key:"mixSwitchHost",value:function(){this._manager&&this._manager.mixSwitchHost()}},{key:"_parseConfig",value:function(e){this._config=e||{}}},{key:"_onMixStreamHandler",value:function(e){e&&(h.default.log(JSON.stringify(e),c.LOG.MIX),this.trigger(u.Event.MIX_STREAM_EVENT,e))}}]),t}(f.default);t.default=p},function(e,t,i){"use strict";function r(e){return e&&e.__esModule?e:{default:e}}function s(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function o(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t}function n(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}Object.defineProperty(t,"__esModule",{value:!0});var a=function(){function e(e,t){for(var i=0;i<t.length;i++){var r=t[i];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}return function(t,i,r){return i&&e(t.prototype,i),r&&e(t,r),t}}(),u=i(2),c=i(4),l=i(0),h=i(8),d=i(1),f=r(d),_=i(3),v=r(_),p=i(17),m=r(p),g=i(83),y=r(g),E=i(68),S=r(E),R=function(e){function t(){s(this,t);var e=o(this,(t.__proto__||Object.getPrototypeOf(t)).call(this));return e._config={},e._playerId="",e._baseSkin=void 0,e._mergeVideoElem=void 0,e._isActive=!1,e._lastWidth=-1,e._lastHeight=-1,e._RESTART_TIME=5e3,e._restartTimer=void 0,e._secretConfig={},e._netRetryCount=0,e._NET_RETRY_COUNT_LIMIT=12,e._videoPlayer=void 0,e._mediaPlayer=void 0,e}return n(t,e),a(t,[{key:"start",value:function(e){this.stop(),this._isActive=!0,this._parseConfig(e),this._appendSkin(),this._playVideo(),this._createMediaPlayer()}},{key:"play",value:function(e){this.start(e)}},{key:"stop",value:function(){this._isActive=!1,this._lastWidth=-1,this._lastHeight=-1,this._destroyRestartTimer(),this._destroyMedia(),this._destroyVideo(),this._removeSkin(),this._destroySkin(),this._mergeVideoElem=void 0}},{key:"setVolume",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:1;this._videoPlayer&&this._videoPlayer.setVolume(e)}},{key:"getVolume",value:function(){return this._videoPlayer?this._videoPlayer.getVolume():-1}},{key:"debug",value:function(e){this._mediaPlayer&&this._mediaPlayer.debug(e)}},{key:"debugSourceBuffer",value:function(){this._mediaPlayer&&this._mediaPlayer.debugSourceBuffer()}},{key:"debugVideoBuffer",value:function(){if(this._mergeVideoElem){var e=this._mergeVideoElem.currentTime,t=this._mergeVideoElem.buffered;if(t.length)for(var i=void 0,r=void 0,s=0;s<t.length;s++)i=t.start(s),r=t.end(s),console.log("videoBuffer["+e+"]["+i+", "+r+"]")}}},{key:"resume",value:function(e){this._isActive||e===this._config.url&&(f.default.log("resume stream",l.LOG.PLAY),this.start(this._config))}},{key:"_quit",value:function(e){return!this._isActive&&(f.default.debug("["+e+"], service stop",l.LOG.PLAY),!0)}},{key:"_restart",value:function(){var e=this;this.stop();var t=void 0,i="true"===String(this._secretConfig.isSecret);"function"==typeof this._secretConfig.urlCallback&&(t=this._secretConfig.urlCallback),i&&t?t(function(t){t&&""!==t&&(e._config.url=t),e.start()}):this.start()}},{key:"_parseConfig",value:function(e){e&&(this._config=e),this._config.url&&""!==String(this._config.url)||f.default.warn("url param invalid",l.LOG.PLAY),void 0===this._config.isLive&&(this._config.isLive=!0),void 0===this._config.isLiveCatch&&(this._config.isLiveCatch=!0),void 0===this._config.userId&&(this._config.userId="web"+Math.random().toFixed(6).substring(2)),this._secretConfig=this._config.secretConfig||{},this._playerId=this._config.playerId=this._config.userId+l.SUFFIX.VID_SUFFIX}},{key:"_appendSkin",value:function(){var e=document.getElementById(this._playerId);e?this._mergeVideoElem=e:(this._mergeVideoElem=this.skin.append(this._config.userId,l.LOG.PLAY),f.default.debug("add play video of "+this._config.userId,l.LOG.PLAY)),this._config.videoElem=this._mergeVideoElem}},{key:"_removeSkin",value:function(){""!==this._playerId&&this.skin.remove(this._playerId,l.LOG.PLAY),this._playerId=""}},{key:"_destroySkin",value:function(){this._baseSkin&&(this._baseSkin=void 0)}},{key:"_createMediaPlayer",value:function(){this._mediaPlayer=new S.default(this._config),this._mediaPlayer.listenTo(h.PlayerEvent.PLAYER_EVENT,this._onMediaEventHandler.bind(this)),this._mediaPlayer.start()}},{key:"_destroyMedia",value:function(){this._mediaPlayer&&(this._mediaPlayer.removeToAll(),this._mediaPlayer.stop(),this._mediaPlayer=void 0)}},{key:"_playVideo",value:function(){this._videoPlayer||(this._videoPlayer=new y.default(this._mergeVideoElem),this._videoPlayer.listenTo(h.PlayerEvent.VIDEO_EVENT,this._onVideoEventHandler.bind(this))),this._videoPlayer.start()}},{key:"_destroyVideo",value:function(){this._videoPlayer&&(this._videoPlayer.removeToAll(),this._videoPlayer.stop(),this._videoPlayer=void 0)}},{key:"_onVideoEventHandler",value:function(e){if(e&&!this._quit("_onVideoEventHandler")){var t=e[l.RSP.TYPE],i=e[l.RSP.CODE],r=e[l.RSP.MESSAGE];switch(t){case h.PlayerMessage.PLAY_ERROR:this.stop(),this._dispatchEvent(c.PlayEvent.ERROR,i,r);break;case h.PlayerMessage.PLAY_RESTART:this._restart()}}}},{key:"_onMediaEventHandler",value:function(e){if(e&&!this._quit("_onMediaEventHandler")){var t=e[l.RSP.TYPE],i=e[l.RSP.CODE],r=e[l.RSP.DATA],s=e[l.RSP.MESSAGE];switch(t){case h.PlayerMessage.SOCKET_OPEN:this._netRetryCount=0,this._dispatchEvent(c.PlayEvent.SOCKET_OPEN,i,s,r);break;case h.PlayerMessage.METADATA:this._metadataHandler(r);break;case h.PlayerMessage.DIMENSION_CHANGE:this._dimensionChangeHandler(r);break;case h.PlayerMessage.AUDIO_VIDEO_SWITCH:this._restart();break;case h.PlayerMessage.BUFFER_WARNING:this._dispatchEvent(c.PlayEvent.BUFFER_WARNING,i,s,r);break;case h.PlayerMessage.DURATION_WARNING:this._resetRestartTimer();break;case h.PlayerMessage.NETWORK:case h.PlayerMessage.SOCKET_CLOSE:this._networkRestart();break;case h.PlayerMessage.ERROR:this._dispatchEvent(c.PlayEvent.ERROR,i,s,r);break;case h.PlayerMessage.PLAY_ENDED:this._resetRestartTimer()}}}},{key:"_resetRestartTimer",value:function(){var e=arguments.length>0&&void 0!==arguments[0]&&arguments[0];this._destroyRestartTimer();var t=e?2*this._RESTART_TIME:this._RESTART_TIME;this._restartTimer=window.setTimeout(this._onRestartTimerHandler.bind(this),t)}},{key:"_destroyRestartTimer",value:function(){this._restartTimer&&(window.clearTimeout(this._restartTimer),this._restartTimer=void 0)}},{key:"_onRestartTimerHandler",value:function(){this._quit("_onRestartTimerHandler")||this._restart()}},{key:"_networkRestart",value:function(){this._netRetryCount++,this._netRetryCount<this._NET_RETRY_COUNT_LIMIT?this._resetRestartTimer(!0):this._dispatchEvent(c.PlayEvent.SOCKET_CLOSE,l.RSP.SUCCESS,"network retry limit")}},{key:"_metadataHandler",value:function(e){var t=this._config.playerId,i=this._lastWidth=parseInt(e.width),r=this._lastHeight=parseInt(e.height);f.default.log("resolution, ["+t+", "+i+"x"+r+"]",l.LOG.PLAY),this._dispatchEvent(c.PlayEvent.METADATA,0,"metadata info",{width:i,height:r})}},{key:"_dimensionChangeHandler",value:function(e){var t=e.aspect1,i=e.aspect2,r=e.isAVCHeader;if(r)return void(0===this._lastWidth&&0===this._lastHeight?(f.default.warn("last resolution is 0x0, video data coming by "+t+"x"+i,l.LOG.PLAY),0!==t&&0!==i&&this._resetRestartTimer()):-1!==this._lastWidth&&-1!==this._lastHeight&&f.default.log("last resolution is "+this._lastWidth+"x"+this._lastHeight,l.LOG.PLAY));this._dispatchEvent(c.PlayEvent.RESOLUTION_CHANGE,0,"dimension change",{isHeader:r,aspect1:t,aspect2:i}),this._restart()}},{key:"_dispatchEvent",value:function(e,t,i){var r=arguments.length>3&&void 0!==arguments[3]?arguments[3]:{};if(!this._quit("_dispatchEvent")){var s="{}";r&&(s=JSON.stringify(r)),f.default.log(e+", "+t+", "+i+", "+s,l.LOG.PLAY),this.trigger(c.Event.PLAYER_EVENT,{type:e,code:t,message:i,data:r})}}},{key:"skin",get:function(){return this._baseSkin||(this._baseSkin=new m.default(u.Globals.observer)),this._baseSkin}}]),t}(v.default);t.default=R},function(e,t,i){"use strict";function r(e){return e&&e.__esModule?e:{default:e}}function s(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}Object.defineProperty(t,"__esModule",{value:!0});var o=function(){function e(e,t){for(var i=0;i<t.length;i++){var r=t[i];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}return function(t,i,r){return i&&e(t.prototype,i),r&&e(t,r),t}}(),n=i(0),a=i(2),u=i(1),c=r(u),l=i(17),h=r(l),d=i(87),f=r(d),_=function(){function e(){s(this,e),this.config={},this.playerId="",this.previewId="",this.playerDom=void 0,this.baseSkin=new h.default(a.Globals.observer),this.basePreview=new f.default(a.Globals.observer)}return o(e,[{key:"start",value:function(e){this.baseSkin&&this.basePreview&&(this.removeSkin(),this.removePreview(),this.config=e||{},this.previewId="preview_"+Math.random().toFixed(6).substring(2),this.playerId=this.config.playerId=this.previewId+n.SUFFIX.VID_SUFFIX,this.appendSkin(),this.basePreview.start(this.config))}},{key:"startPreview",value:function(e){this.start(e)}},{key:"stop",value:function(){this.removeSkin(),this.destroyPreview(),this.destroySkin()}},{key:"stopPreview",value:function(){this.stop()}},{key:"removePreview",value:function(){this.basePreview&&this.basePreview.stop()}},{key:"destroyPreview",value:function(){this.basePreview&&(this.basePreview.stop(),this.basePreview=void 0)}},{key:"appendSkin",value:function(){var e=document.getElementById(this.playerId);e?this.playerDom=e:(this.playerDom=this.baseSkin.append(this.previewId,n.LOG.PREVIEW),c.default.debug("add preview video of "+this.previewId,n.LOG.PREVIEW)),this.config.playerDom=this.playerDom}},{key:"removeSkin",value:function(){""!==this.playerId&&this.baseSkin.remove(this.playerId,n.LOG.PREVIEW),this.playerId="",this.playerDom&&(this.playerDom=void 0)}},{key:"destroySkin",value:function(){this.baseSkin&&(this.baseSkin=void 0)}}]),e}();t.default=_},function(e,t,i){"use strict";function r(e){return e&&e.__esModule?e:{default:e}}function s(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function o(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t}function n(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}Object.defineProperty(t,"__esModule",{value:!0});var a=function(){function e(e,t){for(var i=0;i<t.length;i++){var r=t[i];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}return function(t,i,r){return i&&e(t.prototype,i),r&&e(t,r),t}}(),u=i(4),c=i(2),l=i(0),h=i(9),d=i(6),f=r(d),_=i(1),v=r(_),p=i(3),m=r(p),g=i(17),y=r(g),E=i(90),S=r(E),R=i(19),T=r(R),C=function(e){function t(){s(this,t);var e=o(this,(t.__proto__||Object.getPrototypeOf(t)).call(this));return e._config={},e._isActive=!1,e._isDispatch=!0,e._playerId="",e._playerDom=void 0,e._mixPeerName="",e._baseSkin=void 0,e._basePuller=void 0,e._dispatcher=void 0,e}return n(t,e),a(t,[{key:"quit",value:function(e){return!this._isActive&&(v.default.debug("["+e+"], service stop",l.LOG.PULL),!0)}},{key:"start",value:function(e){if(this.stop(),this._mixPeerName="",this._isActive=!0,this._config=e||{},this._parsePullConfig()){if(this._appendSkin(),!this._isDispatch)return void this.puller.start(this._config);(c.Globals.isRtcTest?c.Globals.rtcPullHosts:c.Globals.rtcHosts).length?this.puller.start(this._config):this._createDispatcher()}}},{key:"startPull",value:function(e){this.start(e)}},{key:"stop",value:function(){this._isActive=!1,this._removeSkin(),this._destroyPuller(),this._destroyDispatcher(),this._destroySkin()}},{key:"stopPull",value:function(){this.stop()}},{key:"switchAudio",value:function(e){this._basePuller&&this._basePuller.switchAudio(e)}},{key:"switchVideo",value:function(e){this._basePuller&&this._basePuller.switchVideo(e)}},{key:"getPeerStatus",value:function(e){this._basePuller&&this._basePuller.getPeerStatus(e)}},{key:"_parseMixPeerName",value:function(){if(!this._config.streamName)if(this._config.url){var e=this._config.url,t=e.split("://");if(t.length>=2){var i=t[1].split("/");i.length>=4&&(this._config.roomId||(this._config.roomId=i[2]),this._config.peerUserId||(this._config.peerUserId=i[3]),this._config.streamName=i[1]+"_"+i[2]+"/"+i[3])}this._config.streamName||this._config.channelId&&this._config.peerUserId&&(this._config.streamName=c.Globals.appId+"_"+this._config.channelId+"/"+this._config.peerUserId)}else this._config.streamName=c.Globals.appId+"_"+(this._config.channelId||this._config.roomId)+"/"+this._config.peerUserId;this._mixPeerName=c.Globals.host+"/"+this._config.streamName}},{key:"_destroyPuller",value:function(){this._basePuller&&(this._basePuller.removeToAll(),this._basePuller.stop(),this._basePuller=void 0)}},{key:"_onPullEventHandler",value:function(e){if(e&&!this.quit("_onPullEventHandler")){var t=e[l.RSP.TYPE],i=e[l.RSP.CODE],r=e[l.RSP.DATA]||{},s=e[l.RSP.MESSAGE];switch(r.userId=this.peerUserId,t){case h.PullMessage.PLAY_METADATA:this._dispatchEvent(u.PullStreamEvent.METADATA,i,s,r||{});break;case h.PullMessage.PLAY_ERROR:this._dispatchEvent(u.PullStreamEvent.VIDEO_ERROR,i,s,r||{});break;case h.PullMessage.RTC_SERVER_ERROR:this._dispatchEvent(u.PullStreamEvent.SERVER_ERROR,i,s,r||{});break;case h.PullMessage.RTC_SERVER_SUCCESS:this._dispatchEvent(u.PullStreamEvent.SERVER_SUCCESS,i,s,r||{});break;case h.PullMessage.PEER_CONN_SWITCH_EVENT:this._dispatchEvent(u.PullStreamEvent.PEER_CONN_SWITCH_EVENT,i,s,r||{})}}}},{key:"_appendSkin",value:function(){var e=document.getElementById(this._playerId);e?this._playerDom=e:(this._playerDom=this.skin.append(this._config.peerUserId,l.LOG.PULL),v.default.debug("add subscribe video of "+this._config.peerUserId,l.LOG.PULL)),this._config.playerDom=this._playerDom}},{key:"_removeSkin",value:function(){""!==this._playerId&&this.skin.remove(this._playerId,l.LOG.PULL),this._playerId="",this._playerDom&&(this._playerDom=void 0)}},{key:"_destroySkin",value:function(){this._baseSkin&&(this._baseSkin=void 0)}},{key:"_parsePullConfig",value:function(){if(this._config.url&&this._parsePullUrl(this._config.url))v.default.log("ready to pull "+this._config.url,l.LOG.PULL);else{if(!this._config.channelId||!this._config.peerUserId)return v.default.warn("invalid pull params",l.LOG.PUSH),!1;this._config.roomId=this._config.channelId,this._config.streamName=c.Globals.appId+"_"+this._config.channelId+"/"+this._config.peerUserId,this._config.url=c.HOST.PROTOCOL_RTC+(this._config.host||c.Globals.host)+"/"+this._config.streamName,v.default.log("ready to pull "+this._config.url,l.LOG.PULL)}return this._playerId=this._config.playerId=this._config.peerUserId+l.SUFFIX.VID_SUFFIX,void 0===this._config.userRole&&(this._config.userRole=1),void 0===this._config.area&&(this._config.area=""),this._isDispatch=!("false"===String(this._config.isDispatch)),!0}},{key:"_parsePullUrl",value:function(e){var t=e,i=t.indexOf("?");if(i>0){var r=t.split("?"),s=f.default.getQueryParams(r[1]);s.area&&(this._config.area=s.area),t=e.substring(0,i)}var o=t.split("://");if(o.length<2)return!1;var n=o[1].split("/");return!(n.length<4)&&(this._config.roomId=n[2],this._config.channelId=n[2],this._config.peerUserId=n[3],this._config.streamName=n[1]+"_"+n[2]+"/"+n[3],!0)}},{key:"_destroyDispatcher",value:function(){this._dispatcher&&(this._dispatcher.stop(),this._dispatcher=void 0)}},{key:"_createDispatcher",value:function(){var e=this;this._dispatcher||(this._dispatcher=new T.default),this._dispatcher.init(this._config),this._dispatcher.startRTC(function(t,i){e.quit("_createDispatcher")||(t!==l.RSP.SUCCESS?e._dispatchEvent(u.PullStreamEvent.DISPATCH_ERROR,t,i):e.puller.start(e._config))})}},{key:"_dispatchEvent",value:function(e,t,i,r){if(!this.quit("_dispatchEvent")){var s="{}";r&&(s=JSON.stringify(r)),v.default.log(e+", "+t+", "+i+", "+s,l.LOG.PULL),this.trigger(u.Event.PULL_STREAM_EVENT,{type:e,code:t,message:i,data:r})}}},{key:"skin",get:function(){return this._baseSkin||(this._baseSkin=new y.default(c.Globals.observer)),this._baseSkin}},{key:"puller",get:function(){return this._basePuller||(this._basePuller=new S.default,this._basePuller.listenTo(h.PullEvent.PULL_EVENT,this._onPullEventHandler.bind(this))),this._basePuller}},{key:"userId",get:function(){return this._config.userId}},{key:"peerUserId",get:function(){return this._config.peerUserId}},{key:"roomId",get:function(){return this._config.roomId}},{key:"peerName",get:function(){return""===this._mixPeerName&&this._parseMixPeerName(),this._mixPeerName}},{key:"peerArea",get:function(){return this._config.area||""}}]),t}(m.default);t.default=C},function(e,t,i){"use strict";function r(e){return e&&e.__esModule?e:{default:e}}function s(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function o(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t}function n(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}Object.defineProperty(t,"__esModule",{value:!0});var a=function(){function e(e,t){for(var i=0;i<t.length;i++){var r=t[i];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}return function(t,i,r){return i&&e(t.prototype,i),r&&e(t,r),t}}(),u=i(4),c=i(2),l=i(0),h=i(10),d=i(1),f=r(d),_=i(3),v=r(_),p=i(17),m=r(p),g=i(100),y=r(g),E=i(19),S=r(E),R=function(e){function t(){s(this,t);var e=o(this,(t.__proto__||Object.getPrototypeOf(t)).call(this));return e._config={},e._playerId="",e._playerDom=void 0,e._isActive=!1,e._isDispatch=!0,e._baseSkin=void 0,e._basePusher=void 0,e._dispatcher=void 0,e}return n(t,e),a(t,[{key:"quit",value:function(e){return!this._isActive&&(f.default.debug("["+e+"], service stop",l.LOG.PUSH),!0)}},{key:"start",value:function(e){var t=this;if(this.stop(),this._isActive=!0,this._config=e||{},this._parsePushConfig()){if(this._appendSkin(),!this._isDispatch)return void this.pusher.start(this._config);(c.Globals.isRtcTest?c.Globals.rtcPushHosts:c.Globals.rtcHosts).length?c.Globals.isRtcArea&&""===c.Globals.rtcArea?(this._createDispatcher(),this._dispatcher.startArea(function(e,i){t.quit("start")||t.pusher.start(t._config)})):this.pusher.start(this._config):(this._createDispatcher(),this._dispatcher.startRTC(function(e,i){t.quit("start")||(e!==l.RSP.SUCCESS?t._dispatchEvent(u.PushStreamEvent.DISPATCH_ERROR,e,i):c.Globals.isRtcArea?t._dispatcher.startArea(function(e,i){t.quit("start")||t.pusher.start(t._config)}):t.pusher.start(t._config))}))}}},{key:"startPush",value:function(e){this.start(e)}},{key:"stop",value:function(){this._isActive=!1,this._removeSkin(),this._destroyPusher(),this._destroyDispatcher(),this._destroySkin()}},{key:"stopPush",value:function(){this.stop()}},{key:"stopAudio",value:function(){this.pusher&&this.pusher.stopAudio()}},{key:"switchAudio",value:function(e){this.pusher&&this.pusher.switchAudio(e)}},{key:"stopVideo",value:function(){this.pusher&&this.pusher.stopVideo()}},{key:"switchVideo",value:function(e){this.pusher&&this.pusher.switchVideo(e)}},{key:"addStream",value:function(e){this.pusher&&this.pusher.addStream(e)}},{key:"getPeerStatus",value:function(e){this.pusher&&this.pusher.getPeerStatus(e)}},{key:"startMixAudio",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"";this.pusher&&this.pusher.startMixAudio(e)}},{key:"stopMixAudio",value:function(){this.pusher&&this.pusher.stopMixAudio()}},{key:"pauseMixAudio",value:function(){this.pusher&&this.pusher.pauseMixAudio()}},{key:"resumeMixAudio",value:function(){this.pusher&&this.pusher.resumeMixAudio()}},{key:"setMixAudioVolume",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0;this.pusher&&this.pusher.setMixAudioVolume(e,t)}},{key:"setMixAudioLoop",value:function(e,t){this.pusher&&this.pusher.setMixAudioLoop(e,t)}},{key:"_appendSkin",value:function(){var e=document.getElementById(this._playerId);if(e)this._playerDom=e;else{var t={};this._config.poster&&(t.poster=this._config.poster),t.enableControls=this._config.enableControls,this._playerDom=this.skin.append(this._config.userId,l.LOG.PUSH,this._config.isMirror,t),f.default.debug("add publish video of "+this._config.userId,l.LOG.PUSH)}this._config.playerDom=this._playerDom}},{key:"_removeSkin",value:function(){""!==this._playerId&&this.skin.remove(this._playerId,l.LOG.PUSH),this._playerId="",this._playerDom&&(this._playerDom=void 0)}},{key:"_destroySkin",value:function(){this._baseSkin&&(this._baseSkin=void 0)}},{key:"_parsePushConfig",value:function(){if(this._config.url&&this._parsePushUrl(this._config.url))f.default.log("ready to push "+this._config.url,l.LOG.PUSH);else{if(!this._config.channelId||!this._config.userId)return f.default.warn("invalid push params",l.LOG.PUSH),!1;this._config.roomId=this._config.channelId,this._config.streamName=c.Globals.appId+"_"+this._config.channelId+"/"+this._config.userId,this._config.url=c.HOST.PROTOCOL_RTC+(this._config.host||c.Globals.host)+"/"+this._config.streamName,f.default.log("ready to push "+this._config.url,l.LOG.PUSH)}return this._playerId=this._config.playerId=this._config.userId+l.SUFFIX.VID_SUFFIX,void 0===this._config.userRole&&(this._config.userRole=1),this._config.camConfig||(this._config.camConfig={audio:!0,video:!0}),this._isDispatch=!("false"===String(this._config.isDispatch)),!0}},{key:"_parsePushUrl",value:function(e){var t=e,i=t.indexOf("?");i>0&&(t=e.substring(0,i));var r=t.split("://");if(r.length<2)return!1;var s=r[1].split("/");return!(s.length<4)&&(this._config.roomId=s[2],this._config.userId=s[3],this._config.streamName=s[1]+"_"+s[2]+"/"+s[3],!0)}},{key:"_destroyDispatcher",value:function(){this._dispatcher&&(this._dispatcher.stop(),this._dispatcher=void 0)}},{key:"_createDispatcher",value:function(){this._dispatcher||(this._dispatcher=new S.default),this._dispatcher.init(this._config)}},{key:"_destroyPusher",value:function(){this._basePusher&&(this._basePusher.removeToAll(),this._basePusher.stop(),this._basePusher=void 0)}},{key:"_onPushEventHandler",value:function(e){if(e&&!this.quit("_onPushEventHandler")){var t=e[l.RSP.TYPE],i=e[l.RSP.CODE],r=e[l.RSP.DATA],s=e[l.RSP.MESSAGE];switch(t){case h.PushMessage.PLAY_METADATA:this._dispatchEvent(u.PushStreamEvent.METADATA,i,s,r||{});break;case h.PushMessage.PLAY_ERROR:this._dispatchEvent(u.PushStreamEvent.VIDEO_ERROR,i,s,r||{});break;case h.PushMessage.CAMERA_ERROR:this._dispatchEvent(u.PushStreamEvent.CAMERA_ERROR,i,s,r||{});break;case h.PushMessage.RTC_SERVER_ERROR:this._dispatchEvent(u.PushStreamEvent.SERVER_ERROR,i,s,r||{});break;case h.PushMessage.RTC_SERVER_SUCCESS:this._dispatchEvent(u.PushStreamEvent.SERVER_SUCCESS,i,s,r||{});break;case h.PushMessage.STREAM_TRACK:this._dispatchEvent(u.PushStreamEvent.STREAMTRACK_CHANGE,i,s,r||{});break;case h.PushMessage.STREAM:this._dispatchEvent(u.PushStreamEvent.STREAM,i,s,r||{});break;case h.PushMessage.ADD_STREAM:this._dispatchEvent(u.PushStreamEvent.ADD_STREAM,i,s,r||{});break;case h.PushMessage.PEER_CONN_SWITCH_EVENT:this._dispatchEvent(u.PushStreamEvent.PEER_CONN_SWITCH_EVENT,i,s,r||{})}}}},{key:"_dispatchEvent",value:function(e,t,i,r){if(!this.quit("_dispatchEvent")){var s="{}";r&&(s=JSON.stringify(r)),f.default.log(e+", "+t+", "+i+", "+s,l.LOG.PUSH),this.trigger(u.Event.PUSH_STREAM_EVENT,{type:e,code:t,message:i,data:r})}}},{key:"skin",get:function(){return this._baseSkin||(this._baseSkin=new m.default(c.Globals.observer)),this._baseSkin}},{key:"pusher",get:function(){return this._basePusher||(this._basePusher=new y.default,this._basePusher.listenTo(h.PushEvent.PUSH_EVENT,this._onPushEventHandler.bind(this))),this._basePusher}},{key:"userId",get:function(){return this._config.userId||""}}]),t}(v.default);t.default=R},function(e,t,i){"use strict";!function(){var t="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",i={rotl:function(e,t){return e<<t|e>>>32-t},rotr:function(e,t){return e<<32-t|e>>>t},endian:function(e){if(e.constructor==Number)return 16711935&i.rotl(e,8)|4278255360&i.rotl(e,24);for(var t=0;t<e.length;t++)e[t]=i.endian(e[t]);return e},randomBytes:function(e){for(var t=[];e>0;e--)t.push(Math.floor(256*Math.random()));return t},bytesToWords:function(e){for(var t=[],i=0,r=0;i<e.length;i++,r+=8)t[r>>>5]|=e[i]<<24-r%32;return t},wordsToBytes:function(e){for(var t=[],i=0;i<32*e.length;i+=8)t.push(e[i>>>5]>>>24-i%32&255);return t},bytesToHex:function(e){for(var t=[],i=0;i<e.length;i++)t.push((e[i]>>>4).toString(16)),t.push((15&e[i]).toString(16));return t.join("")},hexToBytes:function(e){for(var t=[],i=0;i<e.length;i+=2)t.push(parseInt(e.substr(i,2),16));return t},bytesToBase64:function(e){for(var i=[],r=0;r<e.length;r+=3)for(var s=e[r]<<16|e[r+1]<<8|e[r+2],o=0;o<4;o++)8*r+6*o<=8*e.length?i.push(t.charAt(s>>>6*(3-o)&63)):i.push("=");return i.join("")},base64ToBytes:function(e){e=e.replace(/[^A-Z0-9+\/]/gi,"");for(var i=[],r=0,s=0;r<e.length;s=++r%4)0!=s&&i.push((t.indexOf(e.charAt(r-1))&Math.pow(2,-2*s+8)-1)<<2*s|t.indexOf(e.charAt(r))>>>6-2*s);return i}};e.exports=i}()},function(e,t,i){"use strict";!function(e){function t(e){if("string"!=typeof e&&(e=String(e)),/[^a-z0-9\-#$%&'*+.\^_`|~]/i.test(e))throw new TypeError("Invalid character in header field name");return e.toLowerCase()}function i(e){return"string"!=typeof e&&(e=String(e)),e}function r(e){var t={next:function(){var t=e.shift();return{done:void 0===t,value:t}}};return m.iterable&&(t[Symbol.iterator]=function(){return t}),t}function s(e){this.map={},e instanceof s?e.forEach(function(e,t){this.append(t,e)},this):Array.isArray(e)?e.forEach(function(e){this.append(e[0],e[1])},this):e&&Object.getOwnPropertyNames(e).forEach(function(t){this.append(t,e[t])},this)}function o(e){if(e.bodyUsed)return Promise.reject(new TypeError("Already read"));e.bodyUsed=!0}function n(e){return new Promise(function(t,i){e.onload=function(){t(e.result)},e.onerror=function(){i(e.error)}})}function a(e){var t=new FileReader,i=n(t);return t.readAsArrayBuffer(e),i}function u(e){var t=new FileReader,i=n(t);return t.readAsText(e),i}function c(e){for(var t=new Uint8Array(e),i=new Array(t.length),r=0;r<t.length;r++)i[r]=String.fromCharCode(t[r]);return i.join("")}function l(e){if(e.slice)return e.slice(0);var t=new Uint8Array(e.byteLength);return t.set(new Uint8Array(e)),t.buffer}function h(){return this.bodyUsed=!1,this._initBody=function(e){if(this._bodyInit=e,e)if("string"==typeof e)this._bodyText=e;else if(m.blob&&Blob.prototype.isPrototypeOf(e))this._bodyBlob=e;else if(m.formData&&FormData.prototype.isPrototypeOf(e))this._bodyFormData=e;else if(m.searchParams&&URLSearchParams.prototype.isPrototypeOf(e))this._bodyText=e.toString();else if(m.arrayBuffer&&m.blob&&y(e))this._bodyArrayBuffer=l(e.buffer),this._bodyInit=new Blob([this._bodyArrayBuffer]);else{if(!m.arrayBuffer||!ArrayBuffer.prototype.isPrototypeOf(e)&&!E(e))throw new Error("unsupported BodyInit type");this._bodyArrayBuffer=l(e)}else this._bodyText="";this.headers.get("content-type")||("string"==typeof e?this.headers.set("content-type","text/plain;charset=UTF-8"):this._bodyBlob&&this._bodyBlob.type?this.headers.set("content-type",this._bodyBlob.type):m.searchParams&&URLSearchParams.prototype.isPrototypeOf(e)&&this.headers.set("content-type","application/x-www-form-urlencoded;charset=UTF-8"))},m.blob&&(this.blob=function(){var e=o(this);if(e)return e;if(this._bodyBlob)return Promise.resolve(this._bodyBlob);if(this._bodyArrayBuffer)return Promise.resolve(new Blob([this._bodyArrayBuffer]));if(this._bodyFormData)throw new Error("could not read FormData body as blob");return Promise.resolve(new Blob([this._bodyText]))},this.arrayBuffer=function(){return this._bodyArrayBuffer?o(this)||Promise.resolve(this._bodyArrayBuffer):this.blob().then(a)}),this.text=function(){var e=o(this);if(e)return e;if(this._bodyBlob)return u(this._bodyBlob);if(this._bodyArrayBuffer)return Promise.resolve(c(this._bodyArrayBuffer));if(this._bodyFormData)throw new Error("could not read FormData body as text");return Promise.resolve(this._bodyText)},m.formData&&(this.formData=function(){return this.text().then(_)}),this.json=function(){return this.text().then(JSON.parse)},this}function d(e){var t=e.toUpperCase();return S.indexOf(t)>-1?t:e}function f(e,t){t=t||{};var i=t.body;if(e instanceof f){if(e.bodyUsed)throw new TypeError("Already read");this.url=e.url,this.credentials=e.credentials,t.headers||(this.headers=new s(e.headers)),this.method=e.method,this.mode=e.mode,i||null==e._bodyInit||(i=e._bodyInit,e.bodyUsed=!0)}else this.url=String(e);if(this.credentials=t.credentials||this.credentials||"omit",!t.headers&&this.headers||(this.headers=new s(t.headers)),this.method=d(t.method||this.method||"GET"),this.mode=t.mode||this.mode||null,this.referrer=null,("GET"===this.method||"HEAD"===this.method)&&i)throw new TypeError("Body not allowed for GET or HEAD requests");this._initBody(i)}function _(e){var t=new FormData;return e.trim().split("&").forEach(function(e){if(e){var i=e.split("="),r=i.shift().replace(/\+/g," "),s=i.join("=").replace(/\+/g," ");t.append(decodeURIComponent(r),decodeURIComponent(s))}}),t}function v(e){var t=new s;return e.split(/\r?\n/).forEach(function(e){var i=e.split(":"),r=i.shift().trim();if(r){var s=i.join(":").trim();t.append(r,s)}}),t}function p(e,t){t||(t={}),this.type="default",this.status="status"in t?t.status:200,this.ok=this.status>=200&&this.status<300,this.statusText="statusText"in t?t.statusText:"OK",this.headers=new s(t.headers),this.url=t.url||"",this._initBody(e)}if(!e.fetch){var m={searchParams:"URLSearchParams"in e,iterable:"Symbol"in e&&"iterator"in Symbol,blob:"FileReader"in e&&"Blob"in e&&function(){try{return new Blob,!0}catch(e){return!1}}(),formData:"FormData"in e,arrayBuffer:"ArrayBuffer"in e};if(m.arrayBuffer)var g=["[object Int8Array]","[object Uint8Array]","[object Uint8ClampedArray]","[object Int16Array]","[object Uint16Array]","[object Int32Array]","[object Uint32Array]","[object Float32Array]","[object Float64Array]"],y=function(e){return e&&DataView.prototype.isPrototypeOf(e)},E=ArrayBuffer.isView||function(e){return e&&g.indexOf(Object.prototype.toString.call(e))>-1};s.prototype.append=function(e,r){e=t(e),r=i(r);var s=this.map[e];this.map[e]=s?s+","+r:r},s.prototype.delete=function(e){delete this.map[t(e)]},s.prototype.get=function(e){return e=t(e),this.has(e)?this.map[e]:null},s.prototype.has=function(e){return this.map.hasOwnProperty(t(e))},s.prototype.set=function(e,r){this.map[t(e)]=i(r)},s.prototype.forEach=function(e,t){for(var i in this.map)this.map.hasOwnProperty(i)&&e.call(t,this.map[i],i,this)},s.prototype.keys=function(){var e=[];return this.forEach(function(t,i){e.push(i)}),r(e)},s.prototype.values=function(){var e=[];return this.forEach(function(t){e.push(t)}),r(e)},s.prototype.entries=function(){var e=[];return this.forEach(function(t,i){e.push([i,t])}),r(e)},m.iterable&&(s.prototype[Symbol.iterator]=s.prototype.entries);var S=["DELETE","GET","HEAD","OPTIONS","POST","PUT"];f.prototype.clone=function(){return new f(this,{body:this._bodyInit})},h.call(f.prototype),h.call(p.prototype),p.prototype.clone=function(){return new p(this._bodyInit,{status:this.status,statusText:this.statusText,headers:new s(this.headers),url:this.url})},p.error=function(){var e=new p(null,{status:0,statusText:""});return e.type="error",e};var R=[301,302,303,307,308];p.redirect=function(e,t){if(-1===R.indexOf(t))throw new RangeError("Invalid status code");return new p(null,{status:t,headers:{location:e}})},e.Headers=s,e.Request=f,e.Response=p,e.fetch=function(e,t){return new Promise(function(i,r){var s=new f(e,t),o=new XMLHttpRequest;o.onload=function(){var e={status:o.status,statusText:o.statusText,headers:v(o.getAllResponseHeaders()||"")};e.url="responseURL"in o?o.responseURL:e.headers.get("X-Request-URL");var t="response"in o?o.response:o.responseText;i(new p(t,e))},o.onerror=function(){r(new TypeError("Network request failed"))},o.ontimeout=function(){r(new TypeError("Network request failed"))},o.open(s.method,s.url,!0),"include"===s.credentials&&(o.withCredentials=!0),"responseType"in o&&m.blob&&(o.responseType="blob"),s.headers.forEach(function(e,t){o.setRequestHeader(t,e)}),o.send(void 0===s._bodyInit?null:s._bodyInit)})},e.fetch.polyfill=!0}}("undefined"!=typeof self?self:void 0)},function(e,t,i){"use strict";t.XHR=function(){var e={createXHR:function(){return new XMLHttpRequest}},t={createXHR:function(){return new XDomainRequest}};try{return e.createXHR(),e}catch(e){try{return t.createXHR(),t}catch(e){console.error("XHR not supported!")}}}()},function(e,t,i){"use strict";function r(e){return e&&e.__esModule?e:{default:e}}function s(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function o(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t}function n(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}Object.defineProperty(t,"__esModule",{value:!0});var a=function(){function e(e,t){for(var i=0;i<t.length;i++){var r=t[i];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}return function(t,i,r){return i&&e(t.prototype,i),r&&e(t,r),t}}(),u=i(0),c=i(2),l=i(1),h=r(l),d=i(12),f=i(3),_=r(f),v=function(e){function t(){s(this,t);var e=o(this,(t.__proto__||Object.getPrototypeOf(t)).call(this));return e.url="",e.config={},e.seqArray=[],e.socket=void 0,e.activeClose=!1,e.heartCount=1,e.lastPongTime=-1,e.heartTimer=void 0,e.ARRAY_LEN=29,e.PONG_TIMEOUT=6e4,e.HEARTBEAT_PERIOD=8,e.HEARTBEAT_TIMER_TIME=15e3,e.socketId=Math.random().toFixed(4).substring(2),e}return n(t,e),a(t,[{key:"start",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};this.activeClose=!1,this.socket||(this.url=e,this.config=t,h.default.debug(e,u.LOG.ROOM),this.createConnect())}},{key:"stop",value:function(){this.activeClose=!0,this.destroyHeartbeatTimer(),this.destroySocket(),this.seqArray.length&&(this.seqArray.splice(),this.seqArray=[])}},{key:"destroySocket",value:function(){this.socket&&(this.socket.close(),this.socket=void 0),this.heartCount=1,this.lastPongTime=-1}},{key:"createConnect",value:function(){this.socket||(this.socket=new WebSocket(this.url),this.socket.onopen=this.onOpenHandler.bind(this),this.socket.onerror=this.onErrorHandler.bind(this),this.socket.onclose=this.onCloseHandler.bind(this),this.socket.onmessage=this.onMessageHandler.bind(this))}},{key:"reCreateConnect",value:function(){this.stop(),this.dispatchEvent(d.RoomEvent.CONNECT_RECREATE_EVENT)}},{key:"onOpenHandler",value:function(){this.lastPongTime=-1,this.activeClose=!1,h.default.log("websocket.onopen["+this.socketId+"]",u.LOG.ROOM),this.heartCount=0,this.sendHeartbeatPackage(!0)}},{key:"onErrorHandler",value:function(e){e&&e.currentTarget&&h.default.warn("socket.onerror ["+this.socketId+"]["+e.currentTarget.readyState+"]",u.LOG.ROOM)}},{key:"onCloseHandler",value:function(){this.destroyHeartbeatTimer(),this.activeClose?(this.destroySocket(),h.default.log("websocket.onclose activeClose[true]["+this.socketId+"]",u.LOG.ROOM)):(this.activeClose=!0,this.destroySocket(),h.default.warn("websocket.onclose activeClose[false]["+this.socketId+"]",u.LOG.ROOM),this.reCreateConnect())}},{key:"onMessageHandler",value:function(e){if(e&&e.data){var t=e.data,i=JSON.parse(t)||{};if((i[u.RSP.COMMAND]||"")!==u.HTTP.PONG){h.default.log("onmessage recv: "+t,u.LOG.ROOM);var r=parseInt(i[u.RSP.SEQ]);this.ackMessage(r),this.isMsgSeqDuplicate(r)?h.default.log("duplicate [server:"+r+"]["+this.seqArray.toString()+"]",u.LOG.ROOM):this.dispatchEvent(d.RoomEvent.CONNECT_MESSAGE_EVENT,"message",i)}else this.ackPongMessage(i)}}},{key:"destroyHeartbeatTimer",value:function(){this.heartTimer&&(window.clearTimeout(this.heartTimer),this.heartTimer=void 0)}},{key:"createHeartbeatTimer",value:function(){this.destroyHeartbeatTimer(),this.heartTimer=window.setTimeout(this.onHeartbeatTimerHandler.bind(this),this.HEARTBEAT_TIMER_TIME)}},{key:"onHeartbeatTimerHandler",value:function(){this.sendHeartbeatPackage()}},{key:"sendHeartbeatPackage",value:function(){var e={command:u.HTTP.PING,host:c.Globals.host,appId:c.Globals.appId,userId:this.config.userId,scene:c.Globals.impScene,userRole:c.Globals.permissionIndex};if(e.roomId=this.config.roomId,c.Globals.isPermission||(e.userRole=this.config.userRole),(this.heartCount>this.HEARTBEAT_PERIOD||this.heartCount%this.HEARTBEAT_PERIOD==0)&&(this.heartCount=0,h.default.log("sendHeartbeatPackage refresh["+this.socketId+"]",u.LOG.ROOM)),this.heartCount++,this.socket){var t=JSON.stringify(e);1===this.heartCount&&h.default.log(t,u.LOG.ROOM),this.socket.send(t)}this.createHeartbeatTimer()}},{key:"ackMessage",value:function(e){var t={msgSeq:e,command:u.HTTP.MSG_ANSWER,host:c.Globals.host,appId:c.Globals.appId,userId:this.config.userId,scene:c.Globals.impScene},i=JSON.stringify(t);this.socket&&(h.default.log("websocket.onmessage send: "+i,u.LOG.ROOM),this.socket.send(i))}},{key:"isMsgSeqDuplicate",value:function(e){if(isNaN(e))return h.default.warn("message seq is unvalid",u.LOG.ROOM),!0;var t=this.seqArray.length;if(!t)return this.seqArray.push(e),!1;var i=!1;if(this.seqArray.indexOf)-1!==this.seqArray.indexOf(e)&&(i=!0);else for(var r=0;r<t;r++)if(this.seqArray[r]===e){i=!0;break}return!!i||(t>this.ARRAY_LEN&&this.seqArray.shift(),this.seqArray.push(e),!1)}},{key:"ackPongMessage",value:function(e){if(-1===this.lastPongTime)this.lastPongTime=(new Date).getTime();else{var t=(new Date).getTime(),i=t-this.lastPongTime;if(i>this.PONG_TIMEOUT){var r="pong timeout[cur:"+t+"][pre:";return r+=this.lastPongTime+"][diff:"+i+"]",h.default.warn(r,u.LOG.ROOM),this.lastPongTime=t,void this.pongTimeout()}this.lastPongTime=t}var s=e[u.RSP.MSG]||"",o=parseInt(e[u.RSP.STATUS]);0!==o&&(this.stop(),h.default.warn("pong ["+o+"]["+s+"]",u.LOG.ROOM),this.dispatchEvent(d.RoomEvent.CONNECT_PONG_ERROR_EVENT,s,{code:o,message:s}))}},{key:"pongTimeout",value:function(){this.activeClose=!0,h.default.warn("close connection as pong timeout",u.LOG.ROOM),this.destroySocket(),this.reCreateConnect()}},{key:"dispatchEvent",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"",i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{};this.trigger(d.RoomEvent.CONNECT_EVENT,{type:e,message:t,data:i})}}]),t}(_.default);t.default=v},function(e,t,i){"use strict";function r(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}Object.defineProperty(t,"__esModule",{value:!0});var s=function(){function e(e,t){for(var i=0;i<t.length;i++){var r=t[i];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}return function(t,i,r){return i&&e(t.prototype,i),r&&e(t,r),t}}(),o=i(0),n=i(2),a=i(7),u=function(e){return e&&e.__esModule?e:{default:e}}(a),c=function(){function e(){r(this,e),this.url="",this.host=""}return s(e,[{key:"start",value:function(e){this.host=e||"",this.url=n.HOST.PROTOCOL+this.host+"/sls/room"}},{key:"commonOptions",value:function(){var e={host:n.Globals.host,token:n.Globals.token,appId:n.Globals.appId,scene:n.Globals.impScene,deviceId:n.Globals.deviceId};return n.Globals.isPermission&&(e.ticket=n.Globals.ticket),e}},{key:"createRoom",value:function(e){var t=this;return new Promise(function(i,r){var s=t.commonOptions();s.command=o.HTTP.CREATE_ROOM,s.roomId=e.roomId||"",s.userId=e.userId||"",s.userRole=n.Globals.permissionIndex,s.param={},s.param.pushUrl=n.HOST.PROTOCOL_RTC+n.Globals.host+"/"+n.Globals.appId+"/"+s.roomId+"/"+s.userId,n.Globals.isRtcArea&&(s.param.pushUrl+="?area="+n.Globals.rtcArea),s.param.pullUrl=s.param.pushUrl,n.Globals.isPermission||(s.userRole=e.userRole),u.default.ajax({url:t.url,data:s,type:"POST",error:r,success:i})})}},{key:"joinRoom",value:function(e){var t=this;return new Promise(function(i,r){var s=t.commonOptions();s.command=o.HTTP.JOIN_ROOM,s.roomId=e.roomId||"",s.userId=e.userId||"",s.userRole=n.Globals.permissionIndex,s.param={joinRoomId:e.roomId||""},s.param.pushUrl=n.HOST.PROTOCOL_RTC+n.Globals.host+"/"+n.Globals.appId+"/"+s.roomId+"/"+s.userId,n.Globals.isRtcArea&&(s.param.pushUrl+="?area="+n.Globals.rtcArea),s.param.pullUrl=s.param.pushUrl,n.Globals.isPermission||(s.userRole=e.userRole),u.default.ajax({url:t.url,data:s,type:"POST",error:r,success:i})})}},{key:"quitRoom",value:function(e){var t=this;return new Promise(function(i,r){var s=t.commonOptions();s.command=o.HTTP.QUIT_ROOM,s.roomId=e.roomId||"",s.userId=e.userId||"",s.userRole=n.Globals.permissionIndex,s.param={quitRoomId:e.roomId||""},n.Globals.isPermission||(s.userRole=e.userRole),u.default.ajax({url:t.url,data:s,type:"POST",error:r,success:i})})}},{key:"destroyRoom",value:function(e){var t=this;return new Promise(function(i,r){var s=t.commonOptions();s.command=o.HTTP.DESTROY_ROOM,s.roomId=e.roomId||"",s.userId=e.userId||"",s.userRole=n.Globals.permissionIndex,s.param={},n.Globals.isPermission||(s.userRole=e.userRole),u.default.ajax({url:t.url,data:s,type:"POST",error:r,success:i})})}},{key:"fullListRoom",value:function(e){var t=this;return new Promise(function(i,r){var s=t.commonOptions();s.command=o.HTTP.FULL_LIST,s.roomId=e.roomId||"",s.userId=e.userId||"",s.userRole=n.Globals.permissionIndex,s.param={},n.Globals.isPermission||(s.userRole=e.userRole),u.default.ajax({url:t.url,data:s,type:"POST",error:r,success:i})})}}]),e}();t.default=c},function(e,t,i){"use strict";function r(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function s(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t}function o(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}Object.defineProperty(t,"__esModule",{value:!0});var n=function(){function e(e,t){for(var i=0;i<t.length;i++){var r=t[i];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}return function(t,i,r){return i&&e(t.prototype,i),r&&e(t,r),t}}(),a=i(3),u=function(e){return e&&e.__esModule?e:{default:e}}(a),c=function(e){function t(){return r(this,t),s(this,(t.__proto__||Object.getPrototypeOf(t)).call(this))}return o(t,e),n(t,[{key:"start",value:function(e){}},{key:"stop",value:function(){}},{key:"createRoom",value:function(){arguments.length>0&&void 0!==arguments[0]&&arguments[0]}},{key:"joinRoom",value:function(){arguments.length>0&&void 0!==arguments[0]&&arguments[0]}},{key:"quitRoom",value:function(){arguments.length>0&&void 0!==arguments[0]&&arguments[0]}},{key:"destroyRoom",value:function(){arguments.length>0&&void 0!==arguments[0]&&arguments[0]}},{key:"fullListRoom",value:function(){arguments.length>0&&void 0!==arguments[0]&&arguments[0]}},{key:"createVRoom",value:function(e){}},{key:"joinVRoom",value:function(e){}},{key:"quitVRoom",value:function(e){}},{key:"destroyVRoom",value:function(e){}},{key:"fullVListRoom",value:function(e){}},{key:"inWhichVRoom",value:function(e){}}]),t}(u.default);t.default=c},function(e,t,i){"use strict";function r(e){return e&&e.__esModule?e:{default:e}}function s(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function o(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t}function n(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}Object.defineProperty(t,"__esModule",{value:!0});var a=function(){function e(e,t){for(var i=0;i<t.length;i++){var r=t[i];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}return function(t,i,r){return i&&e(t.prototype,i),r&&e(t,r),t}}(),u=i(0),c=i(12),l=i(1),h=r(l),d=i(84),f=r(d),_=i(3),v=r(_),p=function(e){function t(){s(this,t);var e=o(this,(t.__proto__||Object.getPrototypeOf(t)).call(this));return e._config={},e._isActive=!1,e._interactiver=void 0,e}return n(t,e),a(t,[{key:"start",value:function(e){this._isActive=!0,this._config=e||{},this._interactiver||(this._interactiver=new f.default,this._interactiver.start(this._config.host))}},{key:"stop",value:function(){this._isActive=!1,this._interactiver&&(this._interactiver=void 0)}},{key:"createVRoom",value:function(){var e=this,t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};this._interactiver&&this._interactiver.createRoom({vRoomId:t.vChannelId,userRole:this._config.userRole,roomId:t.roomId||this._config.roomId,userId:t.userId||this._config.userId}).then(function(i){if(!e._quit("createVRoom")){h.default.log("create vRoom response: "+i,u.LOG.ROOM);var r=JSON.parse(i)||{},s=r[u.RSP.MSG]||"",o=parseInt(r[u.RSP.STATUS]);o===u.RSP.SUCCESS?e._dispatchVEvent(c.RoomMessage.CREATE_VROOM,u.RSP.SUCCESS,u.RSP.OK,{vRoomId:t.vChannelId}):o===c.RoomCode.EXIST_ROOM?e.joinVRoom(t):e._dispatchVEvent(c.RoomMessage.CREATE_VROOM,o,s,{vRoomId:t.vChannelId})}}).catch(function(i){e._quit("createVRoom")||(h.default.warn("create vRoom failed",u.LOG.ROOM),e._dispatchVEvent(c.RoomMessage.CREATE_VROOM,u.RSP.ERROR,"create vRoom failed",{vRoomId:t.vChannelId}))})}},{key:"joinVRoom",value:function(){var e=this,t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};this._interactiver&&this._interactiver.joinRoom({vRoomId:t.vChannelId,userRole:this._config.userRole,roomId:t.roomId||this._config.roomId,userId:t.userId||this._config.userId}).then(function(i){if(!e._quit("joinVRoom")){h.default.log("join vRoom response: "+i,u.LOG.ROOM);var r=JSON.parse(i)||{},s=r[u.RSP.MSG]||"",o=parseInt(r[u.RSP.STATUS]);o===u.RSP.SUCCESS?e._dispatchVEvent(c.RoomMessage.JOIN_VROOM,u.RSP.SUCCESS,u.RSP.OK,{vRoomId:t.vChannelId}):o===c.RoomCode.EXIST_NOT_ROOM?e.createVRoom(t):o!==c.RoomCode.AGREE_CONNECTED_LIST?e._dispatchVEvent(c.RoomMessage.JOIN_VROOM,o,s,{vRoomId:t.vChannelId}):e.fullVListRoom(t)}}).catch(function(i){e._quit("joinVRoom")||(h.default.warn("join vRoom failed",u.LOG.ROOM),e._dispatchVEvent(c.RoomMessage.JOIN_VROOM,u.RSP.ERROR,"join vRoom failed",{vRoomId:t.vChannelId}))})}},{key:"quitVRoom",value:function(){var e=this,t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};this._interactiver&&this._interactiver.quitRoom({vRoomId:t.vChannelId,userRole:this._config.userRole,roomId:t.roomId||this._config.roomId,userId:t.userId||this._config.userId}).then(function(t){e._quit("quitVRoom")||h.default.log("quit vRoom response: "+t,u.LOG.ROOM)}).catch(function(t){e._quit("quitVRoom")||h.default.warn("quit vRoom failed",u.LOG.ROOM)})}},{key:"destroyVRoom",value:function(){var e=this,t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};this._interactiver&&this._interactiver.destroyRoom({vRoomId:t.vChannelId,userRole:this._config.userRole,roomId:t.roomId||this._config.roomId,userId:t.userId||this._config.userId}).then(function(t){e._quit("destroyVRoom")||h.default.log("destroy vRoom response: "+t,u.LOG.ROOM)}).catch(function(t){e._quit("destroyVRoom")||h.default.warn("destroy vRoom failed",u.LOG.ROOM)})}},{key:"fullVListRoom",value:function(){var e=this,t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};this._interactiver&&this._interactiver.fullListRoom({vRoomId:t.vChannelId,userRole:this._config.userRole,roomId:t.roomId||this._config.roomId,userId:t.userId||this._config.userId}).then(function(t){e._quit("fullVListRoom")||h.default.log("fullList vRoom response: "+t,u.LOG.ROOM)}).catch(function(t){e._quit("fullVListRoom")||h.default.warn("fullList vRoom failed",u.LOG.ROOM)})}},{key:"inWhichVRoom",value:function(){var e=this,t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};this._interactiver&&this._interactiver.inWhichVRoom({userRole:this._config.userRole,roomId:t.roomId||this._config.roomId,userId:t.userId||this._config.userId}).then(function(t){if(!e._quit("inWhichVRoom")){h.default.log("inWhichVRoom response: "+t,u.LOG.ROOM);var i=JSON.parse(t)||{};if(parseInt(i[u.RSP.STATUS])===u.RSP.SUCCESS){var r=i[u.RSP.RESULT]||{};if(r[u.RSP.VROOMID]){var s=r[u.RSP.VROOMID];s&&s.length&&e._dispatchVEvent(c.RoomMessage.WHICH_VROOM,u.RSP.SUCCESS,u.RSP.OK,{vRoomId:s})}}}}).catch(function(t){e._quit("inWhichVRoom")||h.default.warn("inWhichVRoom failed",u.LOG.ROOM)})}},{key:"_quit",value:function(e){return!this._isActive&&(h.default.debug("["+e+"], server stop",u.LOG.ROOM),!0)}},{key:"_dispatchVEvent",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:-1,i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:"",r=arguments.length>3&&void 0!==arguments[3]?arguments[3]:{};this._quit("_dispatchVEvent")||this.trigger(c.RoomEvent.ROOM_EVENT,{type:e,code:t,message:i,data:r})}}]),t}(v.default);t.default=p},function(e,t,i){"use strict";(function(e){function r(e){return e&&e.__esModule?e:{default:e}}function s(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function o(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t}function n(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}Object.defineProperty(t,"__esModule",{value:!0});var a=function(){function e(e,t){for(var i=0;i<t.length;i++){var r=t[i];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}return function(t,i,r){return i&&e(t.prototype,i),r&&e(t,r),t}}(),u=i(4),c=i(0),l=i(2),h=i(1),d=r(h),f=i(3),_=r(f),v=i(62),p=r(v),m=function(t){function i(e){s(this,i);var t=o(this,(i.__proto__||Object.getPrototypeOf(i)).call(this));return t._config={},t._isActive=!1,t._isInitial=!0,t._initSendData=e,t._host="",t._subscribeTopics=[],t._client=void 0,t._dispatcher=void 0,t._mode=2,t._path="/ws",t.PROTOCOL="wss://",t.HEARTBEAT=15,t.UNI="/uni/",t.MULTI="/multi/",t.BROAD="/broad",t.MESSAGE={BROAD:1,UNI:2,MULT:3},t.QOS=1,t.RETAINED=!1,t.CLIENT_ID="web_client_"+Math.random().toFixed(6).substring(2),t}return n(i,t),a(i,[{key:"connect",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"",i=this,r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:[],s=arguments.length>3&&void 0!==arguments[3]?arguments[3]:{};this.disconnect(),this._config={},this._isActive=!0,this._subscribeTopics=[],""===e&&(e=l.HOST.SIG_PROTOCOL+(s.host||l.Globals.host)+"/"+l.Globals.appId+"/"+(s.channelId||""));var o=void 0;l.Globals.signalHosts.length?(o=Object.assign(s,{host:l.Globals.signalHosts[0],hosts:l.Globals.signalHosts}),this._joinChanel(e,t,r,o)):(this._dispatcher||(this._dispatcher=new p.default(function(n){n[c.RSP.CODE]!==c.RSP.SUCCESS?i._dispatchEvent(u.SignalEvent.CONNECT_FAILED,n[c.RSP.CODE],n[c.RSP.MESSAGE]):(l.Globals.signalHosts=n[c.RSP.MESSAGE]||[],o=Object.assign(s,{host:l.Globals.signalHosts[0],hosts:l.Globals.signalHosts}),i._joinChanel(e,t,r,o)),i._dispatcher&&(i._dispatcher.stop(),i._dispatcher=void 0)})),this._dispatcher.start({url:e,userid:t,mode:s.mode,host:s.host,scene:s.scene}))}},{key:"sendUnicastMessage",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"";if(e&&this._client){var i=this._config.uriPath+this.UNI+e;d.default.log("send message "+t,c.LOG.SIGNAL);try{this._client.send(i,t,this.QOS,this.RETAINED)}catch(e){this._dispatchEvent(u.SignalEvent.CONNECT_MSG_SEND,c.RSP.ERROR,e.message,{topic:i,message:t})}}}},{key:"sendMulticastMessage",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"";if(e&&this._client){var i=this._config.uriPath+this.MULTI+e;d.default.log("send message "+t,c.LOG.SIGNAL);try{this._client.send(i,t,this.QOS,this.RETAINED)}catch(e){this._dispatchEvent(u.SignalEvent.CONNECT_MSG_SEND,c.RSP.ERROR,e.message,{topic:i,message:t})}}}},{key:"sendBroadcastMessage",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"";if(this._client){var t=this._config.uriPath+this.BROAD;d.default.log("send message "+e,c.LOG.SIGNAL);try{this._client.send(t,e,this.QOS,this.RETAINED)}catch(i){this._dispatchEvent(u.SignalEvent.CONNECT_MSG_SEND,c.RSP.ERROR,i.message,{topic:t,message:e})}}}},{key:"subscribeTopic",value:function(e){if(this._client&&e&&""!==e){var t=this._config.uriPath+this.UNI+e;d.default.log("subscribe topic: "+t,c.LOG.SIGNAL),this._subscribeTopics.indexOf(t)<0&&this._subscribeTopics.push(t);try{this._client.subscribe(t,{qos:this.QOS})}catch(e){d.default.log("subscribe topic: "+t+" failed!",c.LOG.SIGNAL)}}}},{key:"unsubscribeTopic",value:function(e){if(this._client&&e&&""!==e){var t=this._config.uriPath+this.UNI+e,i=this._subscribeTopics.indexOf(t);i>=0&&this._subscribeTopics.splice(i,1),d.default.log("unsubscribe topic: "+t,c.LOG.SIGNAL);try{this._client.unsubscribe(t)}catch(e){d.default.log("unsubscribe topic: "+t+" failed!",c.LOG.SIGNAL)}}}},{key:"disconnect",value:function(){var e=this;this._isActive=!1,this._subscribeTopics.forEach(function(t){if(e._client){d.default.log("unsubscribe topic: "+t,c.LOG.SIGNAL);try{e._client.unsubscribe(t)}catch(e){d.default.log("unsubscribe topic: "+t+" failed!",c.LOG.SIGNAL)}}}),this._subscribeTopics=[],this._client&&(this._client.isConnected()&&this._client.disconnect(),this._client=void 0)}},{key:"_quit",value:function(e){return!this._isActive&&(d.default.debug("["+e+"], service stop",c.LOG.SIGNAL),!0)}},{key:"_joinChanel",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"",i=this,r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:[],s=arguments.length>3&&void 0!==arguments[3]?arguments[3]:{},o=e.split("://");this._config.userId=t,this._config.groups=r,this._config.uriPath=o.length?o[1]:"",this._config.uriPath=this._parseUri(this._config.uriPath),this._addInitialTopics(),this._parseConfig(s),this._createClient();var n={useSSL:!0,reconnect:!0,cleanSession:!1,password:l.Globals.token,keepAliveInterval:this.HEARTBEAT,onFailure:this.onConnectFailHandler.bind(this),onSuccess:this.onConnectSuccessHandler.bind(this)};if(2===this._mode?n.userName=l.Globals.appId+"+"+l.Globals.host+"+"+t:n.userName=l.Globals.host+":"+l.Globals.appId+"+"+l.Globals.host+"+"+t,this._config.keepalive&&(n.keepAliveInterval=this._config.keepalive),this._config.hosts){var a="",u=[],c=this.PROTOCOL;this._config.hosts.forEach(function(e){a=c,e.indexOf(":")>=0?a+=e+i._path:a+=e+":"+l.HOST.SIG_PORT+i._path,u.push(a)}),n.uris=u}this._client.connect(n)}},{key:"_parseUri",value:function(e){var t=e,i=e.indexOf("?");if(i>=0&&(t=t.substring(0,i),"/"===t[t.length-1]&&(t=t.substring(0,t.length-1))),(i=t.indexOf("/"))>=0){var r=t.substring(0,i);return(r=r.replace(/\./g,"_"))+t.substr(i)}return t}},{key:"_parseConfig",value:function(e){for(var t in e)if(e.hasOwnProperty(t))switch(t){case"host":case"hosts":this._config[t]=e[t];break;case"keepalive":var i=Number(e[t]);isNaN(i)||(this._config[t]=i<10||i>=60?30:i);break;case"mode":this._mode=1===parseInt(e[t])?1:2}this._path=2===this._mode?"":"/ws"}},{key:"_addInitialTopics",value:function(){var e=this,t=void 0,i=[this.BROAD,this.UNI+this._config.userId];this._config.groups.forEach(function(t){i.push(e.MULTI+t)}),i.forEach(function(i){t=e._config.uriPath+i,e._subscribeTopics.indexOf(t)<0&&e._subscribeTopics.push(t)})}},{key:"_createClient",value:function(){var t="",i=l.HOST.SIG_PORT,r=this._config.host||"";if(r.indexOf(":")>=0){var s=r.split(":");t=s[0],i=parseInt(s[1])}else t=r;d.default.log("ready to create client["+this.CLIENT_ID+"]",c.LOG.SIGNAL),e.MQTT?this._client=new e.MQTT.Client(t,i,this._path,this.CLIENT_ID):this._client=new e.Client(t,i,this._path,this.CLIENT_ID),this._client.onConnectionLost=this.onConnectionLostHandler.bind(this),this._client.onMessageArrived=this.onMessageArrivedHandler.bind(this)}},{key:"_subscribe",value:function(e){if(e&&this._client){this._subscribeTopics.indexOf(e)<0&&this._subscribeTopics.push(e),d.default.log("subscribe topic: "+e,c.LOG.SIGNAL);try{this._client.subscribe(e,{qos:this.QOS})}catch(t){d.default.log("subscribe topic: "+e+" failed!",c.LOG.SIGNAL)}}}},{key:"onConnectFailHandler",value:function(e){this._client&&!this._quit("onConnectFailHandler")&&(d.default.error("connect failed["+e.errorCode+"]:"+e.errorMessage,c.LOG.SIGNAL),this.disconnect(),this._dispatchEvent(u.SignalEvent.CONNECT_FAILED,e.errorCode,e.errorMessage))}},{key:"onConnectSuccessHandler",value:function(){var e=this;if(this._client&&!this._quit("onConnectSuccessHandler")&&(this._host=this._client.host,this._subscribeTopics.forEach(function(t){e._subscribe(t)}),d.default.log("connect "+this._host+" success",c.LOG.SIGNAL),this._isInitial&&(this._isInitial=!1,this._dispatchEvent(u.SignalEvent.CONNECT_SUCCESS,c.RSP.SUCCESS,c.RSP.OK)),this._initSendData)){var t=0,i=this._initSendData.userId||"",r=this._initSendData.message||"";void 0!==this._initSendData.type&&(t=parseInt(this._initSendData.type)),t===this.MESSAGE.UNI?this.sendUnicastMessage(i,r):t===this.MESSAGE.BROAD&&this.sendBroadcastMessage(r),this._initSendData=void 0}}},{key:"onConnectionLostHandler",value:function(e){if(!this._quit("onConnectSuccessHandler")){var t="connect lost, [";t+=e.errorCode+"]["+e.errorMessage+"]",d.default.warn(t,c.LOG.SIGNAL)}}},{key:"onMessageArrivedHandler",value:function(e){if(!this._quit("onMessageArrivedHandler")){var t="recv message:"+e.payloadString+" from topic:"+e.topic;d.default.log(t,c.LOG.SIGNAL),this._dispatchEvent(u.SignalEvent.CONNECT_MSG_RECEIVE,c.RSP.SUCCESS,e.payloadString,{topic:e.topic,message:e.payloadString})}}},{key:"onMessageDeliveredHandler",value:function(e){if(!this._quit("onMessageDeliveredHandler")){e.payloadString,e.topic}}},{key:"onTraceHandler",value:function(e){this._quit("onTraceHandler")||d.default.debug(e.severity+":"+e.message,c.LOG.SIGNAL)}},{key:"_dispatchEvent",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:"",r=arguments.length>3&&void 0!==arguments[3]?arguments[3]:{};this.trigger(u.Event.SIGNAL_EVENT,{type:e,code:t,message:i,data:r})}},{key:"MSG",get:function(){return this.MESSAGE}},{key:"userId",get:function(){return this._config.userId||""}}]),i}(_.default);t.default=m}).call(t,i(38))},function(e,t,i){"use strict";function r(e){return e&&e.__esModule?e:{default:e}}function s(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function o(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t}function n(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}Object.defineProperty(t,"__esModule",{value:!0});var a=function(){function e(e,t){for(var i=0;i<t.length;i++){var r=t[i];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}return function(t,i,r){return i&&e(t.prototype,i),r&&e(t,r),t}}(),u=i(9),c=i(0),l=i(5),h=i(1),d=r(h),f=i(13),_=r(f),v=i(3),p=r(v),m=function(e){function t(){return s(this,t),o(this,(t.__proto__||Object.getPrototypeOf(t)).call(this))}return n(t,e),a(t,[{key:"start",value:function(){var e=this;if(this.peer)try{_.default.isFirefox()?this._fireFoxStat():this.peer.getStats(function(t){e._parseStats(t)})}catch(e){d.default.log(e.toString(),c.LOG.PULL)}}},{key:"_parseStats",value:function(e){if(e){for(var t=void 0,i={},r=e.result(),s=0;s<r.length;s++)switch(t=r[s],t.type){case u.STAT.SSRC:this._avSSRC(t,i);break;case u.STAT.CANDIDATE_PAIR:this._candidatePair(t,i)}this._dispatchEvent(u.STAT.PEER_STAT_EVENT,c.RSP.SUCCESS,"stat info",i),this._dispatchEvent(u.STAT.PEER_CONN_SWITCH_EVENT,c.RSP.SUCCESS,"",i.connInfo)}}},{key:"_avSSRC",value:function(e,t){var i="",r=0,s=0,o="0.000",n="0.000";e.names().forEach(function(t){if("mediaType"===t)i=String(e.stat(t));else if("packetsLost"===t){var a=parseInt(e.stat(t));isNaN(a)||(r=a)}else if("packetsReceived"===t){var u=parseInt(e.stat(t));isNaN(u)||(s=u)}else if("googFrameRateReceived"===t){var c=parseInt(e.stat(t));isNaN(c)||(o=c.toFixed(3))}else if("googFrameRateDecoded"===t){var l=parseInt(e.stat(t));isNaN(l)||(n=l.toFixed(3))}}),"audio"===i?(t[l.MACRO.TTL_ASP]=s.toFixed(0),t[l.MACRO.AVG_ALR]=(r/(r+s)).toFixed(3)):"video"===i&&(t[l.MACRO.TTL_VSP]=s.toFixed(0),t[l.MACRO.AVG_DEC_FPS]=n,t[l.MACRO.AVG_TRAN_FPS]=o,t[l.MACRO.AVG_VLR]=(r/(r+s)).toFixed(3))}},{key:"_candidatePair",value:function(e,t){var i="udp",r={},s=!1,o=-1;e.names().forEach(function(t){"googTransportType"===t?(i=String(e.stat(t)),r[u.STAT.PEER_PROC]=i):"bytesReceived"===t?(o=parseInt(e.stat(t)),r[u.STAT.PEER_BYTES_RECEIVED]=o.toFixed(0)):"googActiveConnection"===t&&(s="true"===String(e.stat(t)))}),s&&(t.connInfo=r,t[l.MACRO.TRANS_INFO]="rtc_"+i)}},{key:"_fireFoxStat",value:function(){var e=this;if(this.peer){var t=void 0,i=void 0,r={},s=this.peer.getReceivers();s&&s.length&&s.forEach(function(e){e.track&&("audio"===String(e.track.kind)?t=e:"video"===String(e.track.kind)&&(i=e))}),t&&i&&this._parseAudioReceiver(t,r).then(function(t){e._parseVideoReceiver(i,t).then(function(t){e._dispatchEvent(u.STAT.PEER_STAT_EVENT,c.RSP.SUCCESS,"stat info",t)}).catch(function(e){d.default.log(e.toString(),c.LOG.PULL)})}).catch(function(e){d.default.log(e.toString(),c.LOG.PULL)}),t&&!i?this._parseAudioReceiver(t,r).then(function(t){e._dispatchEvent(u.STAT.PEER_STAT_EVENT,c.RSP.SUCCESS,"stat info",t)}).catch(function(e){d.default.log(e.toString(),c.LOG.PULL)}):i&&!t&&this._parseVideoReceiver(i,r).then(function(t){e._dispatchEvent(u.STAT.PEER_STAT_EVENT,c.RSP.SUCCESS,"stat info",t)}).catch(function(e){d.default.log(e.toString(),c.LOG.PULL)})}}},{key:"_parseAudioReceiver",value:function(e,t){var i=this;return new Promise(function(r,s){e.getStats().then(function(e){var s=void 0;for(var o in e)if(e.hasOwnProperty(o))switch(s=e[o]||{},s.type){case"inboundrtp":i._avInboundrtp(s,t,!0)}r(t)}).catch(function(e){s(e)})})}},{key:"_parseVideoReceiver",value:function(e,t){var i=this;return new Promise(function(r,s){e.getStats().then(function(e){var s=void 0;for(var o in e)if(e.hasOwnProperty(o))switch(s=e[o]||{},s.type){case"inboundrtp":i._avInboundrtp(s,t,!1)}r(t)}).catch(function(e){s(e)})})}},{key:"_avInboundrtp",value:function(e,t,i){var r=0,s=0,o=0;for(var n in e)if(e.hasOwnProperty(n))switch(n){case"packetsLost":var a=parseInt(e[n]);isNaN(a)||(r=a);break;case"packetsReceived":var u=parseInt(e[n]);isNaN(u)||(s=u);break;case"framerateMean":var c=parseInt(e[n]);isNaN(c)||(o=c)}if(s>0){var h=(r/(r+s)).toFixed(3);i?(t[l.MACRO.AVG_ALR]=h,t[l.MACRO.TTL_ASP]=s.toFixed(0)):(t[l.MACRO.AVG_VLR]=h,t[l.MACRO.TTL_VSP]=s.toFixed(0),t[l.MACRO.AVG_TRAN_FPS]=o.toFixed(3))}}},{key:"_dispatchEvent",value:function(e,t,i){var r=arguments.length>3&&void 0!==arguments[3]?arguments[3]:{};this.trigger(u.PullMessage.PEER_STAT,{type:e,code:t,message:i,data:r})}},{key:"peer",get:function(){return this._peer},set:function(e){this._peer!==e&&(this._peer=e)}}]),t}(p.default);t.default=m},function(e,t,i){"use strict";function r(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}Object.defineProperty(t,"__esModule",{value:!0});var s=function(){function e(e,t){for(var i=0;i<t.length;i++){var r=t[i];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}return function(t,i,r){return i&&e(t.prototype,i),r&&e(t,r),t}}(),o=i(2),n=function(){function e(){r(this,e),this._url="",this._roomId="",this._camera="",this._upRES="",this._upFPS="-1",this._upVBR="500",this._micType="av"}return s(e,[{key:"roomId",get:function(){return this._roomId},set:function(e){this._roomId=e||""}},{key:"camera",get:function(){return this._camera},set:function(e){this._camera=e||""}},{key:"micType",get:function(){return this._micType},set:function(e){this._micType=e||""}},{key:"upRES",get:function(){return this._upRES},set:function(e){this._upRES=e||""}},{key:"upVBR",get:function(){return this._upVBR},set:function(e){this._upVBR=e||"500"}},{key:"upFPS",get:function(){return this._upFPS},set:function(e){this._upFPS=e||"-1"}},{key:"url",get:function(){return this._url},set:function(e){var t="",i=[],r=e.split("?");r&&(i=r[0].split("/"))&&i.length>1&&(t=o.Globals.host+"/"+i[i.length-2]+"/"+i[i.length-1]),this._url=t}}]),e}();t.default=n},function(e,t,i){"use strict";function r(e){return e&&e.__esModule?e:{default:e}}function s(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function o(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t}function n(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}Object.defineProperty(t,"__esModule",{value:!0});var a=function(){function e(e,t){for(var i=0;i<t.length;i++){var r=t[i];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}return function(t,i,r){return i&&e(t.prototype,i),r&&e(t,r),t}}(),u=i(10),c=i(0),l=i(5),h=i(1),d=r(h),f=i(13),_=r(f),v=i(3),p=r(v),m=function(e){function t(){return s(this,t),o(this,(t.__proto__||Object.getPrototypeOf(t)).call(this))}return n(t,e),a(t,[{key:"start",value:function(){var e=this;if(this.peer)try{_.default.isFirefox()?this._fireFoxStat():this.peer.getStats(function(t){e._parseStats(t)})}catch(e){d.default.log(e.toString(),c.LOG.PUSH)}}},{key:"_parseStats",value:function(e){if(e){for(var t=void 0,i={},r=e.result(),s=0;s<r.length;s++)switch(t=r[s],t.type){case u.STAT.VIDEO_BWE:this._videoBWE(t,i);break;case u.STAT.SSRC:this._avSSRC(t,i);break;case u.STAT.CANDIDATE_PAIR:this._candidatePair(t,i)}this._dispatchEvent(u.STAT.PEER_STAT_EVENT,c.RSP.SUCCESS,"stat info",i),this._dispatchEvent(u.STAT.PEER_CONN_SWITCH_EVENT,c.RSP.SUCCESS,"",i.connInfo)}}},{key:"_videoBWE",value:function(e,t){e.names().forEach(function(i){if("googRetransmitBitrate"===i){var r=parseInt(e.stat(i));isNaN(r)||(t[l.MACRO.AVG_RVBR]=(r/1e3).toFixed(3))}else if("googTargetEncBitrate"===i){var s=parseInt(e.stat(i));isNaN(s)||(t[l.MACRO.TAR_ENC_BR]=(s/1e3).toFixed(3))}else if("googTransmitBitrate"===i){var o=parseInt(e.stat(i));isNaN(o)||(t[l.MACRO.AVG_VBR]=(o/1e3).toFixed(3))}})}},{key:"_avSSRC",value:function(e,t){var i="",r=0,s=0,o="0.000",n="0.000";e.names().forEach(function(t){if("mediaType"===t)i=String(e.stat(t));else if("packetsLost"===t){var a=parseInt(e.stat(t));isNaN(a)||(r=a)}else if("packetsSent"===t){var u=parseInt(e.stat(t));isNaN(u)||(s=u)}else if("googFrameRateSent"===t){var c=parseInt(e.stat(t));isNaN(c)||(o=c.toFixed(3))}else if("googFrameRateInput"===t){var l=parseInt(e.stat(t));isNaN(l)||(n=l.toFixed(3))}}),"audio"===i?(t[l.MACRO.TTL_ASP]=s.toFixed(0),(r||s)&&(t[l.MACRO.AVG_ALR]=(r/(r+s)).toFixed(3))):"video"===i&&(t[l.MACRO.TTL_VSP]=s.toFixed(0),t[l.MACRO.AVG_ENC_FPS]=n,t[l.MACRO.AVG_TRAN_FPS]=o,(r||s)&&(t[l.MACRO.AVG_VLR]=(r/(r+s)).toFixed(3)))}},{key:"_candidatePair",value:function(e,t){var i="udp",r={},s=!1,o=-1;e.names().forEach(function(t){"googTransportType"===t?(i=String(e.stat(t)),r[u.STAT.PEER_PROC]=i):"bytesReceived"===t?(o=parseInt(e.stat(t)),r[u.STAT.PEER_BYTES_RECEIVED]=o.toFixed(0)):"googActiveConnection"===t&&(s="true"===String(e.stat(t)))}),s&&(t.connInfo=r,t[l.MACRO.TRANS_INFO]="rtc_"+i)}},{key:"_fireFoxStat",value:function(){var e=this;if(this.peer){var t=void 0,i=void 0,r={},s=this.peer.getSenders();s&&s.length&&s.forEach(function(e){e.track&&("audio"===String(e.track.kind)?t=e:"video"===String(e.track.kind)&&(i=e))}),t&&i&&this._parseAudioSender(t,r).then(function(t){e._parseVideoSender(i,t).then(function(t){e._dispatchEvent(u.STAT.PEER_STAT_EVENT,c.RSP.SUCCESS,"stat info",t)}).catch(function(e){d.default.log(e.toString(),c.LOG.PUSH)})}).catch(function(e){d.default.log(e.toString(),c.LOG.PUSH)}),t&&!i?this._parseAudioSender(t,r).then(function(t){e._dispatchEvent(u.STAT.PEER_STAT_EVENT,c.RSP.SUCCESS,"stat info",t)}).catch(function(e){d.default.log(e.toString(),c.LOG.PUSH)}):i&&!t&&this._parseVideoSender(i,r).then(function(t){e._dispatchEvent(u.STAT.PEER_STAT_EVENT,c.RSP.SUCCESS,"stat info",t)}).catch(function(e){d.default.log(e.toString(),c.LOG.PUSH)})}}},{key:"_parseAudioSender",value:function(e,t){var i=this;return new Promise(function(r,s){e.getStats().then(function(e){var s=void 0;for(var o in e)if(e.hasOwnProperty(o))switch(s=e[o]||{},s.type){case"inboundrtp":i._avInboundrtp(s,t,!0);break;case"outboundrtp":i._avOutboundrtp(s,t,!0)}r(t)}).catch(function(e){s(e)})})}},{key:"_parseVideoSender",value:function(e,t){var i=this;return new Promise(function(r,s){e.getStats().then(function(e){var s=void 0;for(var o in e)if(e.hasOwnProperty(o))switch(s=e[o]||{},s.type){case"inboundrtp":i._avInboundrtp(s,t,!1);break;case"outboundrtp":i._avOutboundrtp(s,t,!1)}r(t)}).catch(function(e){s(e)})})}},{key:"_avInboundrtp",value:function(e,t,i){var r=0,s=0;for(var o in e)if(e.hasOwnProperty(o))switch(o){case"packetsLost":var n=parseInt(e[o]);isNaN(n)||(r=n);break;case"packetsReceived":var a=parseInt(e[o]);isNaN(a)||(s=a)}if(s>0){var u=(r/(r+s)).toFixed(3);i?t[l.MACRO.AVG_ALR]=u:t[l.MACRO.AVG_VLR]=u}}},{key:"_avOutboundrtp",value:function(e,t,i){var r=0,s=0;for(var o in e)if(e.hasOwnProperty(o))switch(o){case"packetsSent":var n=parseInt(e[o]);isNaN(n)||(r=n);break;case"framerateMean":var a=parseInt(e[o]);isNaN(a)||(s=a)}i?t[l.MACRO.TTL_ASP]=r.toFixed(0):(t[l.MACRO.TTL_VSP]=r.toFixed(0),t[l.MACRO.AVG_TRAN_FPS]=s.toFixed(3))}},{key:"_dispatchEvent",value:function(e,t,i){var r=arguments.length>3&&void 0!==arguments[3]?arguments[3]:{};this.trigger(u.PushMessage.PEER_STAT,{type:e,code:t,message:i,data:r})}},{key:"peer",get:function(){return this._peer},set:function(e){this._peer!==e&&(this._peer=e)}}]),t}(p.default);t.default=m},function(e,t,i){"use strict";function r(e){return e&&e.__esModule?e:{default:e}}var s=i(50),o=r(s),n=i(52),a=r(n),u=i(45),c=r(u);t.MD5=function(){return{md5:function(e){return(0,o.default)(e+"licDJ%^782ja")}}}(),t.SHA1=function(){return{sha1:function(e){return(0,a.default)(e)}}}(),t.BLOWFISH=function(){return{encrypt:function(e){return this._blowfish||(this._blowfish=new c.default("JLSDKJqwokm@69137$j*76%%6jfjl8372691826#hfjsdf23sd")),this._blowfish.encrypt(e)},decrypt:function(e){this._blowfish=new c.default("JLSDKJqwokm@69137$j*76%%6jfjl8372691826#hfjsdf23sd");var t=this._blowfish.decrypt(e);if(!t||!t.length)return"";var i=!1,r=t.length-1;do{if(0!==t.charCodeAt(r)){r!==t.length-1&&(i=!0);break}}while(r--);return i?t.substring(0,r+1):t}}}()},function(e,t,i){"use strict";function r(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}Object.defineProperty(t,"__esModule",{value:!0});var s=function(){function e(e,t){for(var i=0;i<t.length;i++){var r=t[i];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}return function(t,i,r){return i&&e(t.prototype,i),r&&e(t,r),t}}(),o=i(1),n=function(e){return e&&e.__esModule?e:{default:e}}(o),a=function(){function e(){r(this,e)}return s(e,null,[{key:"setBandwidth",value:function(e,t,i){var r=e.split("\n");if(r.length<1)return n.default.warn("sdp is empty","SDP"),e;for(var s=-1,o=0;o<r.length;o++)if(0===r[o].indexOf("m="+t)){s=o;break}if(-1===s)return n.default.warn("not found the m line for "+t,"SDP"),r.join("\n");for(n.default.debug("found the m line for "+t+" at "+s+" line","SDP"),s++;0===r[s].indexOf("i=")||0===r[s].indexOf("c=");)s++;if(0===r[s].indexOf("b="))return n.default.debug("replace b line at line "+s,"SDP"),r[s]="b=AS:"+i,r.join("\n");n.default.debug("add new b line before line "+s,"SDP");var a=r.slice(0,s);return a.push("b=AS:"+i),a=a.concat(r.slice(s,s.length)),a.join("\n")}},{key:"bitrateConstant",value:function(e,t){var i=e.split("\n");if(i.length<1)return n.default.warn("sdp is empty","SDP"),e;for(var r=-1,s="video"===t?"H264":"opus",o=0;o<i.length;o++)if(0===i[o].indexOf("a=rtpmap")&&-1!==i[o].indexOf(s)){r=o;break}if(-1===r)return n.default.warn("not found the rtpmap line for a=rtpmap","SDP"),i.join("\n");n.default.debug("found the rtpmap line for a=rtpmap at "+r+" line","SDP");var a="video"===t?100:111;try{var u=i[r].split(":"),c=u[1].split(" ");c[0]}catch(e){a="video"===t?100:111}r++;for(;0===i[r].indexOf("a=rtcp-fb");)r++;if(0===i[r].indexOf("a=fmtp"))return n.default.debug("replace fmtp line at line "+r,"SDP"),-1!==i[r].indexOf("useinbandfec=")?(i[r]=i[r].replace("useinbandfec=0","cbr=1"),i[r]=i[r].replace("useinbandfec=1","cbr=1")):i[r]+=";cbr=1",i.join("\n");n.default.debug("add new fmtp line before line "+r,"SDP");var l=i.slice(0,r);return"audio"===t?l.push("a=fmtp:"+a+" minptime=10;cbr=1"):"video"===t&&l.push("a=fmtp:"+a+" profile-level-id=42e01f;packetization-mode=1;cbr=1"),l=l.concat(i.slice(r,r.length)),l.join("\n")}},{key:"bitrateControl",value:function(e,t){var i=e.split("\n");if(i.length<1)return n.default.warn("sdp is empty","SDP"),e;for(var r=-1,s=0;s<i.length;s++)if(0===i[s].indexOf("a=rtpmap")&&-1!==i[s].indexOf("H264")){r=s;break}if(-1===r)return n.default.warn("not found the rtpmap line for a=rtpmap","SDP"),i.join("\n");n.default.debug("found the rtpmap line for a=rtpmap at "+r+" line","SDP");var o=100;try{var a=i[r].split(":"),u=a[1].split(" ");u[0]}catch(e){o=100}r++;for(;0===i[r].indexOf("a=rtcp-fb");)r++;if(0===i[r].indexOf("a=fmtp"))return n.default.debug("replace fmtp line at line "+r,"SDP"),i[r]+=";x-google-min-bitrate="+t.min+";",i[r]+="x-google-max-bitrate="+t.max+";",i[r]+="x-google-start-bitrate="+t.start,i.join("\n");n.default.debug("add new fmtp line before line "+r,"SDP");var c=i.slice(0,r),l="a=fmtp:"+o+" profile-level-id=42e01f;packetization-mode=1";return l+=";x-google-min-bitrate="+t.min+";",l+="x-google-max-bitrate="+t.max+";",l+="x-google-start-bitrate="+t.start,c.push(l),c=c.concat(i.slice(r,r.length)),c.join("\n")}},{key:"getIceUfrag",value:function(e){var t=e.split("\n");if(!t||t.length<1)return"";for(var i=-1,r=0;r<t.length;r++)if(0===t[r].indexOf("a=ice-ufrag")){i=r;break}if(-1===i)return"";var s=t[i],o=s.split(":");return o&&o.length>1?o[1]:""}},{key:"setIceUfrag",value:function(e,t){var i=e.split("\n");if(!i||i.length<1)return e;for(var r=0;r<i.length;r++)0===i[r].indexOf("a=ice-ufrag")&&(i[r]="a=ice-ufrag:"+t);return i.join("\n")}},{key:"removeCandidate",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"udp",i=e.split("\n");if(!i||i.length<1)return e;for(var r=void 0,s=0,o=!0;s<i.length;o?s++:s)0===i[s].indexOf("a=candidate")?(r=String(i[s]).toLowerCase(),r.indexOf(t)>0?(i.splice(s,1),o=!1):o=!0):o=!0;return i.join("\n")}},{key:"hasCandidate",value:function(e){var t={hasUDP:!1,hasTCP:!1},i=e.split("\n");if(!i||i.length<1)return t;var r=void 0;return i.forEach(function(e){0===e.indexOf("a=candidate")&&(r=String(e).toLowerCase(),r.indexOf("udp")>0&&(t.hasUDP=!0),r.indexOf("tcp")>0&&(t.hasTCP=!0))}),t}}]),e}();t.default=a},function(e,t,i){"use strict";(function(e,r){var s,o,n="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e};!function(e,a){"object"===n(t)&&"object"===n(r)?r.exports.MQTT=a():(s=a,void 0!==(o="function"==typeof s?s.call(t,i,t,r):s)&&(r.exports=o))}(0,function(){return function(t){function i(t,i){var r=i,s=t[i],n=s>>4,a=s&=15;i+=1;var u,c=0,d=1;do{if(i==t.length)return[null,r];u=t[i++],c+=(127&u)*d,d*=128}while(0!=(128&u));var f=i+c;if(f>t.length)return[null,r];var _=new y(n);switch(n){case h.CONNACK:1&t[i++]&&(_.sessionPresent=!0),_.returnCode=t[i++];break;case h.PUBLISH:var v=a>>1&3,p=o(t,i);i+=2;var m=l(t,i,p);i+=p,v>0&&(_.messageIdentifier=o(t,i),i+=2);var g=new e.MQTT.Message(t.subarray(i,f));1==(1&a)&&(g.retained=!0),8==(8&a)&&(g.duplicate=!0),g.qos=v,g.destinationName=m,_.payloadMessage=g;break;case h.PUBACK:case h.PUBREC:case h.PUBREL:case h.PUBCOMP:case h.UNSUBACK:_.messageIdentifier=o(t,i);break;case h.SUBACK:_.messageIdentifier=o(t,i),i+=2,_.returnCode=t.subarray(i,f)}return[_,f]}function r(e,t,i){return t[i++]=e>>8,t[i++]=e%256,i}function s(e,t,i,s){return s=r(t,i,s),c(e,i,s),s+t}function o(e,t){return 256*e[t]+e[t+1]}function a(e){var t=new Array(1),i=0;do{var r=e%128;e>>=7,e>0&&(r|=128),t[i++]=r}while(e>0&&i<4);return t}function u(e){for(var t=0,i=0;i<e.length;i++){var r=e.charCodeAt(i);r>2047?(55296<=r&&r<=56319&&(i++,t++),t+=3):r>127?t+=2:t++}return t}function c(e,t,i){for(var r=i,s=0;s<e.length;s++){var o=e.charCodeAt(s);if(55296<=o&&o<=56319){var n=e.charCodeAt(++s);if(isNaN(n))throw new Error(p(_.MALFORMED_UNICODE,[o,n]));o=n-56320+(o-55296<<10)+65536}o<=127?t[r++]=o:o<=2047?(t[r++]=o>>6&31|192,t[r++]=63&o|128):o<=65535?(t[r++]=o>>12&15|224,t[r++]=o>>6&63|128,t[r++]=63&o|128):(t[r++]=o>>18&7|240,t[r++]=o>>12&63|128,t[r++]=o>>6&63|128,t[r++]=63&o|128)}return t}function l(e,t,i){for(var r,s="",o=t;o<t+i;){var n=e[o++];if(n<128)r=n;else{var a=e[o++]-128;if(a<0)throw new Error(p(_.MALFORMED_UTF,[n.toString(16),a.toString(16),""]));if(n<224)r=64*(n-192)+a;else{var u=e[o++]-128;if(u<0)throw new Error(p(_.MALFORMED_UTF,[n.toString(16),a.toString(16),u.toString(16)]));if(n<240)r=4096*(n-224)+64*a+u;else{var c=e[o++]-128;if(c<0)throw new Error(p(_.MALFORMED_UTF,[n.toString(16),a.toString(16),u.toString(16),c.toString(16)]));if(!(n<248))throw new Error(p(_.MALFORMED_UTF,[n.toString(16),a.toString(16),u.toString(16),c.toString(16)]));r=262144*(n-240)+4096*a+64*u+c}}}r>65535&&(r-=65536,s+=String.fromCharCode(55296+(r>>10)),r=56320+(1023&r)),s+=String.fromCharCode(r)}return s}var h={CONNECT:1,CONNACK:2,PUBLISH:3,PUBACK:4,PUBREC:5,PUBREL:6,PUBCOMP:7,SUBSCRIBE:8,SUBACK:9,UNSUBSCRIBE:10,UNSUBACK:11,PINGREQ:12,PINGRESP:13,DISCONNECT:14},d=function(e,t){for(var i in e)if(e.hasOwnProperty(i)){if(!t.hasOwnProperty(i)){var r="Unknown property, "+i+". Valid properties are:";for(var s in t)t.hasOwnProperty(s)&&(r=r+" "+s);throw new Error(r)}if(n(e[i])!==t[i])throw new Error(p(_.INVALID_TYPE,[n(e[i]),i]))}},f=function(e,t){return function(){return e.apply(t,arguments)}},_={OK:{code:0,text:"AMQJSC0000I OK."},CONNECT_TIMEOUT:{code:1,text:"AMQJSC0001E Connect timed out."},SUBSCRIBE_TIMEOUT:{code:2,text:"AMQJS0002E Subscribe timed out."},UNSUBSCRIBE_TIMEOUT:{code:3,text:"AMQJS0003E Unsubscribe timed out."},PING_TIMEOUT:{code:4,text:"AMQJS0004E Ping timed out."},INTERNAL_ERROR:{code:5,text:"AMQJS0005E Internal error. Error Message: {0}, Stack trace: {1}"},CONNACK_RETURNCODE:{code:6,text:"AMQJS0006E Bad Connack return code:{0} {1}."},SOCKET_ERROR:{code:7,text:"AMQJS0007E Socket error:{0}."},SOCKET_CLOSE:{code:8,text:"AMQJS0008I Socket closed."},MALFORMED_UTF:{code:9,text:"AMQJS0009E Malformed UTF data:{0} {1} {2}."},UNSUPPORTED:{code:10,text:"AMQJS0010E {0} is not supported by this browser."},INVALID_STATE:{code:11,text:"AMQJS0011E Invalid state {0}."},INVALID_TYPE:{code:12,text:"AMQJS0012E Invalid type {0} for {1}."},INVALID_ARGUMENT:{code:13,text:"AMQJS0013E Invalid argument {0} for {1}."},UNSUPPORTED_OPERATION:{code:14,text:"AMQJS0014E Unsupported operation."},INVALID_STORED_DATA:{code:15,text:"AMQJS0015E Invalid data in local storage key={0} value={1}."},INVALID_MQTT_MESSAGE_TYPE:{code:16,text:"AMQJS0016E Invalid MQTT message type {0}."},MALFORMED_UNICODE:{code:17,text:"AMQJS0017E Malformed Unicode string:{0} {1}."},BUFFER_FULL:{code:18,text:"AMQJS0018E Message buffer is full, maximum buffer size: {0}."}},v={0:"Connection Accepted",1:"Connection Refused: unacceptable protocol version",2:"Connection Refused: identifier rejected",3:"Connection Refused: server unavailable",4:"Connection Refused: bad user name or password",5:"Connection Refused: not authorized"},p=function(e,t){var i=e.text;if(t)for(var r,s,o=0;o<t.length;o++)if(r="{"+o+"}",(s=i.indexOf(r))>0){var n=i.substring(0,s),a=i.substring(s+r.length);i=n+t[o]+a}return i},m=[0,6,77,81,73,115,100,112,3],g=[0,4,77,81,84,84,4],y=function(e,t){this.type=e;for(var i in t)t.hasOwnProperty(i)&&(this[i]=t[i])};y.prototype.encode=function(){var e,t=(15&this.type)<<4,i=0,o=[],n=0;switch(void 0!==this.messageIdentifier&&(i+=2),this.type){case h.CONNECT:switch(this.mqttVersion){case 3:i+=m.length+3;break;case 4:i+=g.length+3}i+=u(this.clientId)+2,void 0!==this.willMessage&&(i+=u(this.willMessage.destinationName)+2,e=this.willMessage.payloadBytes,e instanceof Uint8Array||(e=new Uint8Array(l)),i+=e.byteLength+2),void 0!==this.userName&&(i+=u(this.userName)+2),void 0!==this.password&&(i+=u(this.password)+2);break;case h.SUBSCRIBE:t|=2;for(var c=0;c<this.topics.length;c++)o[c]=u(this.topics[c]),i+=o[c]+2;i+=this.requestedQos.length;break;case h.UNSUBSCRIBE:t|=2;for(var c=0;c<this.topics.length;c++)o[c]=u(this.topics[c]),i+=o[c]+2;break;case h.PUBREL:t|=2;break;case h.PUBLISH:this.payloadMessage.duplicate&&(t|=8),t=t|=this.payloadMessage.qos<<1,this.payloadMessage.retained&&(t|=1),n=u(this.payloadMessage.destinationName),i+=n+2;var l=this.payloadMessage.payloadBytes;i+=l.byteLength,l instanceof ArrayBuffer?l=new Uint8Array(l):l instanceof Uint8Array||(l=new Uint8Array(l.buffer));break;case h.DISCONNECT:}var d=a(i),f=d.length+1,_=new ArrayBuffer(i+f),v=new Uint8Array(_);if(v[0]=t,v.set(d,1),this.type==h.PUBLISH)f=s(this.payloadMessage.destinationName,n,v,f);else if(this.type==h.CONNECT){switch(this.mqttVersion){case 3:v.set(m,f),f+=m.length;break;case 4:v.set(g,f),f+=g.length}var p=0;this.cleanSession&&(p=2),void 0!==this.willMessage&&(p|=4,p|=this.willMessage.qos<<3,this.willMessage.retained&&(p|=32)),void 0!==this.userName&&(p|=128),void 0!==this.password&&(p|=64),v[f++]=p,f=r(this.keepAliveInterval,v,f)}switch(void 0!==this.messageIdentifier&&(f=r(this.messageIdentifier,v,f)),this.type){case h.CONNECT:f=s(this.clientId,u(this.clientId),v,f),void 0!==this.willMessage&&(f=s(this.willMessage.destinationName,u(this.willMessage.destinationName),v,f),f=r(e.byteLength,v,f),v.set(e,f),f+=e.byteLength),void 0!==this.userName&&(f=s(this.userName,u(this.userName),v,f)),void 0!==this.password&&(f=s(this.password,u(this.password),v,f));break;case h.PUBLISH:v.set(l,f);break;case h.SUBSCRIBE:for(var c=0;c<this.topics.length;c++)f=s(this.topics[c],o[c],v,f),v[f++]=this.requestedQos[c];break;case h.UNSUBSCRIBE:for(var c=0;c<this.topics.length;c++)f=s(this.topics[c],o[c],v,f)}return _};var E=function(e,t,i){this._client=e,this._window=t,this._keepAliveInterval=1e3*i,this.isReset=!1;var r=new y(h.PINGREQ).encode(),s=function(e){return function(){return o.apply(e)}},o=function(){this.isReset?(this.isReset=!1,this._client._trace("Pinger.doPing","send PINGREQ"),this._client.socket.send(r),this.timeout=this._window.setTimeout(s(this),this._keepAliveInterval)):(this._client._trace("Pinger.doPing","Timed out"),this._client._disconnected(_.PING_TIMEOUT.code,p(_.PING_TIMEOUT)))};this.reset=function(){this.isReset=!0,this._window.clearTimeout(this.timeout),this._keepAliveInterval>0&&(this.timeout=setTimeout(s(this),this._keepAliveInterval))},this.cancel=function(){this._window.clearTimeout(this.timeout)}},S=function(e,t,i,r,s){this._window=t,i||(i=30);this.timeout=setTimeout(function(e,t,i){return function(){return e.apply(t,i)}}(r,e,s),1e3*i),this.cancel=function(){this._window.clearTimeout(this.timeout)}},R=function(e,i,r,s,o){if(!("WebSocket"in t&&null!==t.WebSocket))throw new Error(p(_.UNSUPPORTED,["WebSocket"]));if(!("localStorage"in t&&null!==t.localStorage))throw new Error(p(_.UNSUPPORTED,["localStorage"]));if(!("ArrayBuffer"in t&&null!==t.ArrayBuffer))throw new Error(p(_.UNSUPPORTED,["ArrayBuffer"]));this._trace("Paho.MQTT.Client",e,i,r,s,o),this.host=i,this.port=r,this.path=s,this.uri=e,this.clientId=o,this._wsuri=null,this._localKey=i+":"+r+("/mqtt"!=s?":"+s:"")+":"+o+":",this._msg_queue=[],this._buffered_msg_queue=[],this._sentMessages={},this._receivedMessages={},this._notify_msg_sent={},this._message_identifier=1,this._sequence=0;for(var n in localStorage)0!==n.indexOf("Sent:"+this._localKey)&&0!==n.indexOf("Received:"+this._localKey)||this.restore(n)};R.prototype.host=null,R.prototype.port=null,R.prototype.path=null,R.prototype.uri=null,R.prototype.clientId=null,R.prototype.socket=null,R.prototype.connected=!1,R.prototype.maxMessageIdentifier=65536,R.prototype.connectOptions=null,R.prototype.hostIndex=null,R.prototype.onConnected=null,R.prototype.onConnectionLost=null,R.prototype.onMessageDelivered=null,R.prototype.onMessageArrived=null,R.prototype.traceFunction=null,R.prototype._msg_queue=null,R.prototype._buffered_msg_queue=null,R.prototype._connectTimeout=null,R.prototype.sendPinger=null,R.prototype.receivePinger=null,R.prototype._reconnectInterval=1,R.prototype._reconnecting=!1,R.prototype._reconnectTimeout=null,R.prototype.disconnectedPublishing=!1,R.prototype.disconnectedBufferSize=5e3,R.prototype.receiveBuffer=null,R.prototype._traceBuffer=null,R.prototype._MAX_TRACE_ENTRIES=100,R.prototype.connect=function(e){var t=this._traceMask(e,"password");if(this._trace("Client.connect",t,this.socket,this.connected),this.connected)throw new Error(p(_.INVALID_STATE,["already connected"]));if(this.socket)throw new Error(p(_.INVALID_STATE,["already connected"]));this._reconnecting&&(this._reconnectTimeout.cancel(),this._reconnectTimeout=null,this._reconnecting=!1),this.connectOptions=e,this._reconnectInterval=1,this._reconnecting=!1,e.uris?(this.hostIndex=0,this._doConnect(e.uris[0])):this._doConnect(this.uri)},R.prototype.subscribe=function(e,t){if(this._trace("Client.subscribe",e,t),!this.connected)throw new Error(p(_.INVALID_STATE,["not connected"]));var i=new y(h.SUBSCRIBE);i.topics=[e],void 0!==t.qos?i.requestedQos=[t.qos]:i.requestedQos=[0],t.onSuccess&&(i.onSuccess=function(e){t.onSuccess({invocationContext:t.invocationContext,grantedQos:e})}),t.onFailure&&(i.onFailure=function(e){t.onFailure({invocationContext:t.invocationContext,errorCode:e,errorMessage:p(e)})}),t.timeout&&(i.timeOut=new S(this,window,t.timeout,t.onFailure,[{invocationContext:t.invocationContext,errorCode:_.SUBSCRIBE_TIMEOUT.code,errorMessage:p(_.SUBSCRIBE_TIMEOUT)}])),this._requires_ack(i),this._schedule_message(i)},R.prototype.unsubscribe=function(e,t){if(this._trace("Client.unsubscribe",e,t),!this.connected)throw new Error(p(_.INVALID_STATE,["not connected"]));var i=new y(h.UNSUBSCRIBE);i.topics=[e],t.onSuccess&&(i.callback=function(){t.onSuccess({invocationContext:t.invocationContext})}),t.timeout&&(i.timeOut=new S(this,window,t.timeout,t.onFailure,[{invocationContext:t.invocationContext,errorCode:_.UNSUBSCRIBE_TIMEOUT.code,errorMessage:p(_.UNSUBSCRIBE_TIMEOUT)}])),this._requires_ack(i),this._schedule_message(i)},R.prototype.send=function(e){this._trace("Client.send",e);var t=new y(h.PUBLISH);if(t.payloadMessage=e,this.connected)e.qos>0?this._requires_ack(t):this.onMessageDelivered&&(this._notify_msg_sent[t]=this.onMessageDelivered(t.payloadMessage)),this._schedule_message(t);else{if(!this._reconnecting||!this.disconnectedPublishing)throw new Error(p(_.INVALID_STATE,["not connected"]));if(Object.keys(this._sentMessages).length+this._buffered_msg_queue.length>this.disconnectedBufferSize)throw new Error(p(_.BUFFER_FULL,[this.disconnectedBufferSize]));e.qos>0?this._requires_ack(t):(t.sequence=++this._sequence,this._buffered_msg_queue.push(t))}},R.prototype.disconnect=function(){if(this._trace("Client.disconnect"),this._reconnecting&&(this._reconnectTimeout.cancel(),this._reconnectTimeout=null,this._reconnecting=!1),!this.socket)throw new Error(p(_.INVALID_STATE,["not connecting or connected"]));var e=new y(h.DISCONNECT);this._notify_msg_sent[e]=f(this._disconnected,this),this._schedule_message(e)},R.prototype.getTraceLog=function(){if(null!==this._traceBuffer){this._trace("Client.getTraceLog",new Date),this._trace("Client.getTraceLog in flight messages",this._sentMessages.length);for(var e in this._sentMessages)this._trace("_sentMessages ",e,this._sentMessages[e]);for(var e in this._receivedMessages)this._trace("_receivedMessages ",e,this._receivedMessages[e]);return this._traceBuffer}},R.prototype.startTrace=function(){null===this._traceBuffer&&(this._traceBuffer=[]),this._trace("Client.startTrace",new Date,"@VERSION@")},R.prototype.stopTrace=function(){delete this._traceBuffer},R.prototype._doConnect=function(e){if(this.connectOptions.useSSL){var t=e.split(":");t[0]="wss",e=t.join(":")}this._wsuri=e,this.connected=!1,this.connectOptions.mqttVersion<4?this.socket=new WebSocket(e,["mqttv3.1"]):this.socket=new WebSocket(e,["mqtt"]),this.socket.binaryType="arraybuffer",this.socket.onopen=f(this._on_socket_open,this),this.socket.onmessage=f(this._on_socket_message,this),this.socket.onerror=f(this._on_socket_error,this),this.socket.onclose=f(this._on_socket_close,this),this.sendPinger=new E(this,window,this.connectOptions.keepAliveInterval),this.receivePinger=new E(this,window,this.connectOptions.keepAliveInterval),this._connectTimeout&&(this._connectTimeout.cancel(),this._connectTimeout=null),this._connectTimeout=new S(this,window,this.connectOptions.timeout,this._disconnected,[_.CONNECT_TIMEOUT.code,p(_.CONNECT_TIMEOUT)])},R.prototype._schedule_message=function(e){this._msg_queue.push(e),this.connected&&this._process_queue()},R.prototype.store=function(e,t){var i={type:t.type,messageIdentifier:t.messageIdentifier,version:1};switch(t.type){case h.PUBLISH:t.pubRecReceived&&(i.pubRecReceived=!0),i.payloadMessage={};for(var r="",s=t.payloadMessage.payloadBytes,o=0;o<s.length;o++)s[o]<=15?r=r+"0"+s[o].toString(16):r+=s[o].toString(16);i.payloadMessage.payloadHex=r,i.payloadMessage.qos=t.payloadMessage.qos,i.payloadMessage.destinationName=t.payloadMessage.destinationName,t.payloadMessage.duplicate&&(i.payloadMessage.duplicate=!0),t.payloadMessage.retained&&(i.payloadMessage.retained=!0),0===e.indexOf("Sent:")&&(void 0===t.sequence&&(t.sequence=++this._sequence),i.sequence=t.sequence);break;default:throw Error(p(_.INVALID_STORED_DATA,[key,i]))}localStorage.setItem(e+this._localKey+t.messageIdentifier,JSON.stringify(i))},R.prototype.restore=function(t){var i=localStorage.getItem(t),r=JSON.parse(i),s=new y(r.type,r);switch(r.type){case h.PUBLISH:for(var o=r.payloadMessage.payloadHex,n=new ArrayBuffer(o.length/2),a=new Uint8Array(n),u=0;o.length>=2;){var c=parseInt(o.substring(0,2),16);o=o.substring(2,o.length),a[u++]=c}var l=new e.MQTT.Message(a);l.qos=r.payloadMessage.qos,l.destinationName=r.payloadMessage.destinationName,r.payloadMessage.duplicate&&(l.duplicate=!0),r.payloadMessage.retained&&(l.retained=!0),s.payloadMessage=l;break;default:throw Error(p(_.INVALID_STORED_DATA,[t,i]))}0===t.indexOf("Sent:"+this._localKey)?(s.payloadMessage.duplicate=!0,this._sentMessages[s.messageIdentifier]=s):0===t.indexOf("Received:"+this._localKey)&&(this._receivedMessages[s.messageIdentifier]=s)},R.prototype._process_queue=function(){for(var e=null,t=this._msg_queue.reverse();e=t.pop();)this._socket_send(e),this._notify_msg_sent[e]&&(this._notify_msg_sent[e](),delete this._notify_msg_sent[e])},R.prototype._requires_ack=function(e){var t=Object.keys(this._sentMessages).length;if(t>this.maxMessageIdentifier)throw Error("Too many messages:"+t);for(;void 0!==this._sentMessages[this._message_identifier];)this._message_identifier++;e.messageIdentifier=this._message_identifier,this._sentMessages[e.messageIdentifier]=e,e.type===h.PUBLISH&&this.store("Sent:",e),this._message_identifier===this.maxMessageIdentifier&&(this._message_identifier=1)},R.prototype._on_socket_open=function(){var e=new y(h.CONNECT,this.connectOptions);e.clientId=this.clientId,this._socket_send(e)},R.prototype._on_socket_message=function(e){this._trace("Client._on_socket_message",e.data);for(var t=this._deframeMessages(e.data),i=0;i<t.length;i+=1)this._handleMessage(t[i])},R.prototype._deframeMessages=function(e){var t=new Uint8Array(e),r=[];if(this.receiveBuffer){var s=new Uint8Array(this.receiveBuffer.length+t.length);s.set(this.receiveBuffer),s.set(t,this.receiveBuffer.length),t=s,delete this.receiveBuffer}try{for(var o=0;o<t.length;){var n=i(t,o),a=n[0];if(o=n[1],null===a)break;r.push(a)}o<t.length&&(this.receiveBuffer=t.subarray(o))}catch(e){var u="undefined"==e.hasOwnProperty("stack")?e.stack.toString():"No Error Stack Available";return void this._disconnected(_.INTERNAL_ERROR.code,p(_.INTERNAL_ERROR,[e.message,u]))}return r},R.prototype._handleMessage=function(e){this._trace("Client._handleMessage",e);try{switch(e.type){case h.CONNACK:if(this._connectTimeout.cancel(),this._reconnectTimeout&&this._reconnectTimeout.cancel(),this.connectOptions.cleanSession){for(var t in this._sentMessages){var i=this._sentMessages[t];localStorage.removeItem("Sent:"+this._localKey+i.messageIdentifier)}this._sentMessages={};for(var t in this._receivedMessages){var r=this._receivedMessages[t];localStorage.removeItem("Received:"+this._localKey+r.messageIdentifier)}this._receivedMessages={}}if(0!==e.returnCode){this._disconnected(_.CONNACK_RETURNCODE.code,p(_.CONNACK_RETURNCODE,[e.returnCode,v[e.returnCode]]));break}this.connected=!0,this.connectOptions.uris&&(this.hostIndex=this.connectOptions.uris.length);var s=[];for(var o in this._sentMessages)this._sentMessages.hasOwnProperty(o)&&s.push(this._sentMessages[o]);if(this._buffered_msg_queue.length>0)for(var n=null,a=this._buffered_msg_queue.reverse();n=a.pop();)s.push(n),this.onMessageDelivered&&(this._notify_msg_sent[n]=this.onMessageDelivered(n.payloadMessage));for(var s=s.sort(function(e,t){return e.sequence-t.sequence}),u=0,c=s.length;u<c;u++){var i=s[u];if(i.type==h.PUBLISH&&i.pubRecReceived){var l=new y(h.PUBREL,{messageIdentifier:i.messageIdentifier});this._schedule_message(l)}else this._schedule_message(i)}this.connectOptions.onSuccess&&this.connectOptions.onSuccess({invocationContext:this.connectOptions.invocationContext});var d=!1;this._reconnecting&&(d=!0,this._reconnectInterval=1,this._reconnecting=!1),this._connected(d,this._wsuri),this._process_queue();break;case h.PUBLISH:this._receivePublish(e);break;case h.PUBACK:var i=this._sentMessages[e.messageIdentifier];i&&(delete this._sentMessages[e.messageIdentifier],localStorage.removeItem("Sent:"+this._localKey+e.messageIdentifier),this.onMessageDelivered&&this.onMessageDelivered(i.payloadMessage));break;case h.PUBREC:var i=this._sentMessages[e.messageIdentifier];if(i){i.pubRecReceived=!0;var l=new y(h.PUBREL,{messageIdentifier:e.messageIdentifier});this.store("Sent:",i),this._schedule_message(l)}break;case h.PUBREL:var r=this._receivedMessages[e.messageIdentifier];localStorage.removeItem("Received:"+this._localKey+e.messageIdentifier),r&&(this._receiveMessage(r),delete this._receivedMessages[e.messageIdentifier]);var f=new y(h.PUBCOMP,{messageIdentifier:e.messageIdentifier});this._schedule_message(f);break;case h.PUBCOMP:var i=this._sentMessages[e.messageIdentifier];delete this._sentMessages[e.messageIdentifier],localStorage.removeItem("Sent:"+this._localKey+e.messageIdentifier),this.onMessageDelivered&&this.onMessageDelivered(i.payloadMessage);break;case h.SUBACK:var i=this._sentMessages[e.messageIdentifier];i&&(i.timeOut&&i.timeOut.cancel(),128===e.returnCode[0]?i.onFailure&&i.onFailure(e.returnCode):i.onSuccess&&i.onSuccess(e.returnCode),delete this._sentMessages[e.messageIdentifier]);break;case h.UNSUBACK:var i=this._sentMessages[e.messageIdentifier];i&&(i.timeOut&&i.timeOut.cancel(),i.callback&&i.callback(),delete this._sentMessages[e.messageIdentifier]);break;case h.PINGRESP:this.sendPinger.reset();break;case h.DISCONNECT:this._disconnected(_.INVALID_MQTT_MESSAGE_TYPE.code,p(_.INVALID_MQTT_MESSAGE_TYPE,[e.type]));break;default:this._disconnected(_.INVALID_MQTT_MESSAGE_TYPE.code,p(_.INVALID_MQTT_MESSAGE_TYPE,[e.type]))}}catch(e){var m="undefined"==e.hasOwnProperty("stack")?e.stack.toString():"No Error Stack Available";return void this._disconnected(_.INTERNAL_ERROR.code,p(_.INTERNAL_ERROR,[e.message,m]))}},R.prototype._on_socket_error=function(e){this._reconnecting||this._disconnected(_.SOCKET_ERROR.code,p(_.SOCKET_ERROR,[e.data]))},R.prototype._on_socket_close=function(){this._reconnecting||this._disconnected(_.SOCKET_CLOSE.code,p(_.SOCKET_CLOSE))},R.prototype._socket_send=function(e){if(1==e.type){var t=this._traceMask(e,"password");this._trace("Client._socket_send",t)}else this._trace("Client._socket_send",e);this.socket.send(e.encode()),this.sendPinger.reset()},R.prototype._receivePublish=function(e){switch(e.payloadMessage.qos){case"undefined":case 0:this._receiveMessage(e);break;case 1:var t=new y(h.PUBACK,{messageIdentifier:e.messageIdentifier});this._schedule_message(t),this._receiveMessage(e);break;case 2:this._receivedMessages[e.messageIdentifier]=e,this.store("Received:",e);var i=new y(h.PUBREC,{messageIdentifier:e.messageIdentifier});this._schedule_message(i);break;default:throw Error("Invaild qos="+wireMmessage.payloadMessage.qos)}},R.prototype._receiveMessage=function(e){this.onMessageArrived&&this.onMessageArrived(e.payloadMessage)},R.prototype._connected=function(e,t){this.onConnected&&this.onConnected(e,t)},R.prototype._reconnect=function(){this._trace("Client._reconnect"),this.connected||(this._reconnecting=!0,this.sendPinger.cancel(),this.receivePinger.cancel(),this._reconnectInterval<128&&(this._reconnectInterval=2*this._reconnectInterval),this.connectOptions.uris?(this.hostIndex++,this.hostIndex>=this.connectOptions.uris.length&&(this.hostIndex=0),this._doConnect(this.connectOptions.uris[this.hostIndex])):this._doConnect(this.uri))},R.prototype._disconnected=function(e,t){if(this._trace("Client._disconnected",e,t),void 0!==e&&this._reconnecting)return void(this._reconnectTimeout=new S(this,window,this._reconnectInterval,this._reconnect));if(this.sendPinger.cancel(),this.receivePinger.cancel(),this._connectTimeout&&(this._connectTimeout.cancel(),this._connectTimeout=null),this._msg_queue=[],this._buffered_msg_queue=[],this._notify_msg_sent={},this.socket&&(this.socket.onopen=null,this.socket.onmessage=null,this.socket.onerror=null,this.socket.onclose=null,1===this.socket.readyState&&this.socket.close(),delete this.socket),this.connectOptions.uris&&this.hostIndex<this.connectOptions.uris.length-1)this.hostIndex++,this._doConnect(this.connectOptions.uris[this.hostIndex]);else if(void 0===e&&(e=_.OK.code,t=p(_.OK)),this.connected){if(this.connected=!1,this.onConnectionLost&&this.onConnectionLost({errorCode:e,errorMessage:t,reconnect:this.connectOptions.reconnect,uri:this._wsuri}),e!==_.OK.code&&this.connectOptions.reconnect)return this._reconnectInterval=1,void this._reconnect()}else 4===this.connectOptions.mqttVersion&&!1===this.connectOptions.mqttVersionExplicit?(this._trace("Failed to connect V4, dropping back to V3"),this.connectOptions.mqttVersion=3,this.connectOptions.uris?(this.hostIndex=0,this._doConnect(this.connectOptions.uris[0])):this._doConnect(this.uri)):this.connectOptions.onFailure&&this.connectOptions.onFailure({invocationContext:this.connectOptions.invocationContext,errorCode:e,errorMessage:t})},R.prototype._trace=function(){if(this.traceFunction){for(var e in arguments)void 0!==arguments[e]&&arguments.splice(e,1,JSON.stringify(arguments[e]));var t=Array.prototype.slice.call(arguments).join("");this.traceFunction({severity:"Debug",message:t})}if(null!==this._traceBuffer)for(var e=0,i=arguments.length;e<i;e++)this._traceBuffer.length==this._MAX_TRACE_ENTRIES&&this._traceBuffer.shift(),0===e?this._traceBuffer.push(arguments[e]):void 0===arguments[e]?this._traceBuffer.push(arguments[e]):this._traceBuffer.push("  "+JSON.stringify(arguments[e]))},R.prototype._traceMask=function(e,t){var i={};for(var r in e)e.hasOwnProperty(r)&&(i[r]=r==t?"******":e[r]);return i};var T=function(e,t,i,r){var s;if("string"!=typeof e)throw new Error(p(_.INVALID_TYPE,[void 0===e?"undefined":n(e),"host"]));if(2==arguments.length){r=t,s=e;var o=s.match(/^(wss?):\/\/((\[(.+)\])|([^\/]+?))(:(\d+))?(\/.*)$/);if(!o)throw new Error(p(_.INVALID_ARGUMENT,[e,"host"]));e=o[4]||o[2],t=parseInt(o[7]),i=o[8]}else{if(3==arguments.length&&(r=i,i="/mqtt"),"number"!=typeof t||t<0)throw new Error(p(_.INVALID_TYPE,[void 0===t?"undefined":n(t),"port"]));if("string"!=typeof i)throw new Error(p(_.INVALID_TYPE,[void 0===i?"undefined":n(i),"path"]));var a=-1!==e.indexOf(":")&&"["!==e.slice(0,1)&&"]"!==e.slice(-1);s="ws://"+(a?"["+e+"]":e)+":"+t+i}for(var u=0,c=0;c<r.length;c++){var l=r.charCodeAt(c);55296<=l&&l<=56319&&c++,u++}if("string"!=typeof r||u>65535)throw new Error(p(_.INVALID_ARGUMENT,[r,"clientId"]));var h=new R(s,e,t,i,r);this._getHost=function(){return e},this._setHost=function(){throw new Error(p(_.UNSUPPORTED_OPERATION))},this._getPort=function(){return t},this._setPort=function(){throw new Error(p(_.UNSUPPORTED_OPERATION))},this._getPath=function(){return i},this._setPath=function(){throw new Error(p(_.UNSUPPORTED_OPERATION))},this._getURI=function(){return s},this._setURI=function(){throw new Error(p(_.UNSUPPORTED_OPERATION))},this._getClientId=function(){return h.clientId},this._setClientId=function(){throw new Error(p(_.UNSUPPORTED_OPERATION))},this._getOnConnected=function(){return h.onConnected},this._setOnConnected=function(e){if("function"!=typeof e)throw new Error(p(_.INVALID_TYPE,[void 0===e?"undefined":n(e),"onConnected"]));h.onConnected=e},this._getDisconnectedPublishing=function(){return h.disconnectedPublishing},this._setDisconnectedPublishing=function(e){h.disconnectedPublishing=e},this._getDisconnectedBufferSize=function(){return h.disconnectedBufferSize},this._setDisconnectedBufferSize=function(e){h.disconnectedBufferSize=e},this._getOnConnectionLost=function(){return h.onConnectionLost},this._setOnConnectionLost=function(e){if("function"!=typeof e)throw new Error(p(_.INVALID_TYPE,[void 0===e?"undefined":n(e),"onConnectionLost"]));h.onConnectionLost=e},this._getOnMessageDelivered=function(){return h.onMessageDelivered},this._setOnMessageDelivered=function(e){if("function"!=typeof e)throw new Error(p(_.INVALID_TYPE,[void 0===e?"undefined":n(e),"onMessageDelivered"]));h.onMessageDelivered=e},this._getOnMessageArrived=function(){return h.onMessageArrived},this._setOnMessageArrived=function(e){if("function"!=typeof e)throw new Error(p(_.INVALID_TYPE,[void 0===e?"undefined":n(e),"onMessageArrived"]));h.onMessageArrived=e},this._getTrace=function(){return h.traceFunction},this._setTrace=function(e){if("function"!=typeof e)throw new Error(p(_.INVALID_TYPE,[void 0===e?"undefined":n(e),"onTrace"]));h.traceFunction=e},this.connect=function(e){if(e=e||{},d(e,{timeout:"number",userName:"string",password:"string",willMessage:"object",keepAliveInterval:"number",cleanSession:"boolean",useSSL:"boolean",invocationContext:"object",onSuccess:"function",onFailure:"function",hosts:"object",ports:"object",reconnect:"boolean",mqttVersion:"number",mqttVersionExplicit:"boolean",uris:"object"}),void 0===e.keepAliveInterval&&(e.keepAliveInterval=60),e.mqttVersion>4||e.mqttVersion<3)throw new Error(p(_.INVALID_ARGUMENT,[e.mqttVersion,"connectOptions.mqttVersion"]));if(void 0===e.mqttVersion?(e.mqttVersionExplicit=!1,e.mqttVersion=4):e.mqttVersionExplicit=!0,void 0!==e.password&&void 0===e.userName)throw new Error(p(_.INVALID_ARGUMENT,[e.password,"connectOptions.password"]));if(e.willMessage){if(!(e.willMessage instanceof C))throw new Error(p(_.INVALID_TYPE,[e.willMessage,"connectOptions.willMessage"]));if(e.willMessage.stringPayload=null,void 0===e.willMessage.destinationName)throw new Error(p(_.INVALID_TYPE,[n(e.willMessage.destinationName),"connectOptions.willMessage.destinationName"]))}if(void 0===e.cleanSession&&(e.cleanSession=!0),e.hosts){if(!(e.hosts instanceof Array))throw new Error(p(_.INVALID_ARGUMENT,[e.hosts,"connectOptions.hosts"]));if(e.hosts.length<1)throw new Error(p(_.INVALID_ARGUMENT,[e.hosts,"connectOptions.hosts"]));for(var t=!1,r=0;r<e.hosts.length;r++){if("string"!=typeof e.hosts[r])throw new Error(p(_.INVALID_TYPE,[n(e.hosts[r]),"connectOptions.hosts["+r+"]"]));if(/^(wss?):\/\/((\[(.+)\])|([^\/]+?))(:(\d+))?(\/.*)$/.test(e.hosts[r])){if(0===r)t=!0;else if(!t)throw new Error(p(_.INVALID_ARGUMENT,[e.hosts[r],"connectOptions.hosts["+r+"]"]))}else if(t)throw new Error(p(_.INVALID_ARGUMENT,[e.hosts[r],"connectOptions.hosts["+r+"]"]))}if(t)e.uris=e.hosts;else{if(!e.ports)throw new Error(p(_.INVALID_ARGUMENT,[e.ports,"connectOptions.ports"]));if(!(e.ports instanceof Array))throw new Error(p(_.INVALID_ARGUMENT,[e.ports,"connectOptions.ports"]));if(e.hosts.length!==e.ports.length)throw new Error(p(_.INVALID_ARGUMENT,[e.ports,"connectOptions.ports"]));e.uris=[];for(var r=0;r<e.hosts.length;r++){if("number"!=typeof e.ports[r]||e.ports[r]<0)throw new Error(p(_.INVALID_TYPE,[n(e.ports[r]),"connectOptions.ports["+r+"]"]));var o=e.hosts[r],a=e.ports[r],u=-1!==o.indexOf(":");s="ws://"+(u?"["+o+"]":o)+":"+a+i,e.uris.push(s)}}}h.connect(e)},this.subscribe=function(e,t){if("string"!=typeof e)throw new Error("Invalid argument:"+e);if(t=t||{},d(t,{qos:"number",invocationContext:"object",onSuccess:"function",onFailure:"function",timeout:"number"}),t.timeout&&!t.onFailure)throw new Error("subscribeOptions.timeout specified with no onFailure callback.");if(void 0!==t.qos&&0!==t.qos&&1!==t.qos&&2!==t.qos)throw new Error(p(_.INVALID_ARGUMENT,[t.qos,"subscribeOptions.qos"]));h.subscribe(e,t)},this.unsubscribe=function(e,t){if("string"!=typeof e)throw new Error("Invalid argument:"+e);if(t=t||{},d(t,{invocationContext:"object",onSuccess:"function",onFailure:"function",timeout:"number"}),t.timeout&&!t.onFailure)throw new Error("unsubscribeOptions.timeout specified with no onFailure callback.");h.unsubscribe(e,t)},this.send=function(e,t,i,r){var s;if(0===arguments.length)throw new Error("Invalid argument.length");if(1==arguments.length){if(!(e instanceof C)&&"string"!=typeof e)throw new Error("Invalid argument:"+(void 0===e?"undefined":n(e)));if(s=e,void 0===s.destinationName)throw new Error(p(_.INVALID_ARGUMENT,[s.destinationName,"Message.destinationName"]));h.send(s)}else s=new C(t),s.destinationName=e,arguments.length>=3&&(s.qos=i),arguments.length>=4&&(s.retained=r),h.send(s)},this.publish=function(e,t,i,r){console.log("Publising message to: ",e);var s;if(0===arguments.length)throw new Error("Invalid argument.length");if(1==arguments.length){if(!(e instanceof C)&&"string"!=typeof e)throw new Error("Invalid argument:"+(void 0===e?"undefined":n(e)));if(s=e,void 0===s.destinationName)throw new Error(p(_.INVALID_ARGUMENT,[s.destinationName,"Message.destinationName"]));h.send(s)}else s=new C(t),s.destinationName=e,arguments.length>=3&&(s.qos=i),arguments.length>=4&&(s.retained=r),h.send(s)},this.disconnect=function(){h.disconnect()},this.getTraceLog=function(){return h.getTraceLog()},this.startTrace=function(){h.startTrace()},this.stopTrace=function(){h.stopTrace()},this.isConnected=function(){return h.connected}};T.prototype={get host(){return this._getHost()},set host(e){this._setHost(e)},get port(){return this._getPort()},set port(e){this._setPort(e)},get path(){return this._getPath()},set path(e){this._setPath(e)},get clientId(){return this._getClientId()},set clientId(e){this._setClientId(e)},get onConnected(){return this._getOnConnected()},set onConnected(e){this._setOnConnected(e)},get disconnectedPublishing(){return this._getDisconnectedPublishing()},set disconnectedPublishing(e){this._setDisconnectedPublishing(e)},get disconnectedBufferSize(){return this._getDisconnectedBufferSize()},set disconnectedBufferSize(e){this._setDisconnectedBufferSize(e)},get onConnectionLost(){return this._getOnConnectionLost()},set onConnectionLost(e){this._setOnConnectionLost(e)},get onMessageDelivered(){return this._getOnMessageDelivered()},set onMessageDelivered(e){this._setOnMessageDelivered(e)},get onMessageArrived(){return this._getOnMessageArrived()},set onMessageArrived(e){this._setOnMessageArrived(e)},get trace(){return this._getTrace()},set trace(e){this._setTrace(e)}};var C=function(e){var t;if(!("string"==typeof e||e instanceof ArrayBuffer||e instanceof Int8Array||e instanceof Uint8Array||e instanceof Int16Array||e instanceof Uint16Array||e instanceof Int32Array||e instanceof Uint32Array||e instanceof Float32Array||e instanceof Float64Array))throw p(_.INVALID_ARGUMENT,[e,"newPayload"]);t=e,this._getPayloadString=function(){return"string"==typeof t?t:l(t,0,t.length)},this._getPayloadBytes=function(){if("string"==typeof t){var e=new ArrayBuffer(u(t)),i=new Uint8Array(e);return c(t,i,0),i}return t};var i;this._getDestinationName=function(){return i},this._setDestinationName=function(e){if("string"!=typeof e)throw new Error(p(_.INVALID_ARGUMENT,[e,"newDestinationName"]));i=e};var r=0;this._getQos=function(){return r},this._setQos=function(e){if(0!==e&&1!==e&&2!==e)throw new Error("Invalid argument:"+e);r=e};var s=!1;this._getRetained=function(){return s},this._setRetained=function(e){if("boolean"!=typeof e)throw new Error(p(_.INVALID_ARGUMENT,[e,"newRetained"]));s=e};var o=!1;this._getDuplicate=function(){return o},this._setDuplicate=function(e){o=e}};return C.prototype={get payloadString(){return this._getPayloadString()},get payloadBytes(){return this._getPayloadBytes()},get destinationName(){return this._getDestinationName()},set destinationName(e){this._setDestinationName(e)},get topic(){return this._getDestinationName()},set topic(e){this._setDestinationName(e)},get qos(){return this._getQos()},set qos(e){this._setQos(e)},get retained(){return this._getRetained()},set retained(e){this._setRetained(e)},get duplicate(){return this._getDuplicate()},set duplicate(e){this._setDuplicate(e)}},{Client:T,Message:C}}(window)})}).call(t,i(38),i(54)(e))},function(e,t,i){"use strict";function r(e){return e&&e.__esModule?e:{default:e}}function s(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}Object.defineProperty(t,"__esModule",{value:!0});var o=function(){function e(e,t){for(var i=0;i<t.length;i++){var r=t[i];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}return function(t,i,r){return i&&e(t.prototype,i),r&&e(t,r),t}}(),n=i(110),a=r(n),u=i(59),c=r(u),l=i(111),h=r(l),d=function(){function e(){s(this,e),this._camera=void 0,this._notificater=void 0}return o(e,null,[{key:"parseSPS",value:function(e){return c.default.parseSPS(new Uint8Array(e))}},{key:"aspectDetect",value:function(e,t){this._camera||(this._camera=new a.default),this._camera.setLogCallback(t),this._camera.detect(e)}},{key:"notify",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};this._notificater||(this._notificater=new h.default),this._notificater.notify(e.title||"",e)}}]),e}();t.default=d},function(e,t,i){"use strict";function r(e){return e&&e.__esModule?e:{default:e}}function s(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}Object.defineProperty(t,"__esModule",{value:!0});var o=function(){function e(e,t){for(var i=0;i<t.length;i++){var r=t[i];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}return function(t,i,r){return i&&e(t.prototype,i),r&&e(t,r),t}}(),n=i(0),a=i(7),u=r(a),c=i(1),l=r(c),h=function(){function e(){s(this,e)}return o(e,null,[{key:"fetch",value:function(e){var t="POST"===String(e.type).toUpperCase(),i={url:e.url||"",type:t?"POST":"GET",error:e.error||function(t){l.default.warn("["+e.url+"]"+t.toString(),n.LOG.AUTH)},success:e.success||function(t){l.default.log("["+e.url+"]"+t.toString(),n.LOG.AUTH)}};e.data&&"POST"===i.type&&(i.data=e.data),u.default.ajax(i)}}]),e}();t.default=h},function(e,t,i){"use strict";function r(e){return e&&e.__esModule?e:{default:e}}function s(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}Object.defineProperty(t,"__esModule",{value:!0});var o=function(){function e(e,t){for(var i=0;i<t.length;i++){var r=t[i];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}return function(t,i,r){return i&&e(t.prototype,i),r&&e(t,r),t}}(),n=i(0),a=i(5),u=i(2),c=i(6),l=r(c),h=i(1),d=r(h),f=i(56),_=r(f),v=i(3),p=r(v),m=function(){function e(t){s(this,e),this._auther=void 0,this._callback=t,this._isAccessControl=0}return o(e,[{key:"start",value:function(e){u.Globals.observer?u.Globals.observer.removeToAll():u.Globals.observer=new p.default(512),this._parseInitConfig(e||{}),this._isAccessControl?""===u.Globals.token||u.Globals.isPermission&&""===u.Globals.ticket?this._callback({code:n.RSP.ERROR,message:"unvalid authenticate"}):this._callback({code:n.RSP.SUCCESS,message:u.Globals.token}):this._getToken()}},{key:"stop",value:function(){this._auther&&(this._auther.stop(),this._auther=void 0),this._callback&&(this._callback=void 0)}},{key:"_getToken",value:function(){var e=this;this._auther||(this._auther=new _.default(function(t){0===t[n.RSP.CODE]&&(u.Globals.token=t[n.RSP.MESSAGE]),e._callback&&e._callback({code:t[n.RSP.CODE],message:t[n.RSP.MESSAGE]})})),this._auther.start()}},{key:"_resetInitConfig",value:function(){u.Globals.isRtcArea=!1,u.Globals.rtcArea="",u.Globals.isScreenTest=!1,u.Globals.screenPathType=1,u.Globals.isRtcTest=!1,u.Globals.rtcHosts=[],u.Globals.rtcPushHosts=[],u.Globals.rtcPullHosts=[],u.Globals.signalHosts=[],u.Globals.ssTestHost="",u.Globals.rtcTestHost="",u.Globals.dispatchTestSSHost="",u.Globals.dispatchTestRTCHost="",u.Globals.dispatchTestSignalHost=""}},{key:"_parseInitConfig",value:function(e){this._resetInitConfig();for(var t in e)if(e.hasOwnProperty(t))switch(t){case"host":case"token":case"ticket":case"appId":case"appKey":case"userId":case"sdkType":case"deviceId":case"impScene":case"vimpScene":case"rtcPushHosts":case"rtcPullHosts":u.Globals[t]=e[t];break;case"userRole":case"screenPathType":case"permissionIndex":var i=parseInt(e[t]);isNaN(i)||(u.Globals[t]=i);break;case"reportConfig":var r=e[t]||{};if(void 0!==r.period){var s=parseInt(r.period);!isNaN(s)&&s>0&&(a.Report.period=s)}a.Report.enable=!("false"===String(r.enable));break;case"ssTestHost":case"rtcTestHost":case"dispatchTestSSHost":case"dispatchTestRTCHost":case"dispatchTestSignalHost":u.Globals[t]=e[t];break;case"logConfig":var o=e[t]||{};o.id&&d.default.setLogPanel(o.id),o.level&&d.default.setLogLevel(o.level),o.callback&&d.default.setLogCallback(o.callback);break;case"isRtcArea":case"isRtcTest":case"isScreenTest":u.Globals[t]="true"===String(e[t]);break;case"isPermission":u.Globals[t]=!("false"===String(e[t]));break;case"isAccessControl":this._isAccessControl=!("false"===String(e[t]))}if(l.default.setDataPattern(),"true"===String(e.enableNotification))try{l.default.initNotification()}catch(e){}a.Report.reportIndex=1,""===u.Globals.deviceId&&(u.Globals.deviceId="web-"+l.default.uuid());var n=parseInt(Number((new Date).getTime())/1e3);u.Globals.traceId="h5_"+u.Globals.appId+"_"+u.Globals.userId+"_"+n}}]),e}();t.default=m},function(e,t,i){"use strict";function r(e){return e&&e.__esModule?e:{default:e}}function s(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function o(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t}function n(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}Object.defineProperty(t,"__esModule",{value:!0});var a=function(){function e(e,t){for(var i=0;i<t.length;i++){var r=t[i];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}return function(t,i,r){return i&&e(t.prototype,i),r&&e(t,r),t}}(),u=i(4),c=i(12),l=i(1),h=r(l),d=i(0),f=i(2),_=i(24),v=r(_),p=i(23),m=r(p),g=i(20),y=r(g),E=i(21),S=r(E),R=i(22),T=r(R),C=i(3),b=r(C),P=i(19),O=r(P),A=i(32),k=(r(A),i(85)),I=r(k),w=i(86),M=r(w),L=function(e){function t(){s(this,t);var e=o(this,(t.__proto__||Object.getPrototypeOf(t)).call(this));return e._config={},e._streamConfig={},e._pullers=[],e._lastUsers=[],e._pushClass=void 0,e._playClass=void 0,e._isActive=!1,e._isDirectLink=!1,e._vPullers=[],e._lastVUsers=[],e._vChannelId="",e._signalClass=void 0,e._previewClass=void 0,e._licRoomClass=void 0,e._dispatchClass=void 0,e._slsHost="",e._pushHosts=[],e._curPushHost="",e._mixClass=void 0,e._isMixControl=!1,e._roomRole=c.RoomRole.AUDIENCE,e}return n(t,e),a(t,[{key:"init",value:function(){}},{key:"stop",value:function(){this._isActive=!1,this._destroyPreview(),this._releaseLicRoom(),this._destroyStream(),this._unAllPull(),this._unAllVPull()}},{key:"startPreview",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};this._createPreview(e)}},{key:"stopPreview",value:function(){this._destroyPreview()}},{key:"createChannel",value:function(e,t,i){var r=this;this.destroyChannel(),this._isActive=!0,this._roomRole=c.RoomRole.ANCHOR,this._config=Object.assign(i,{userRole:0,userId:t,channelId:e}),this._config.roomId=e,this._streamConfig={},this._config.streamConfig&&(this._streamConfig=this._config.streamConfig),this._isMixControl="true"===String(this._streamConfig.isMix),this._startDispatch(function(s,o){s===d.RSP.ERROR?r._dispatchEvent(u.LinkEvent.CREATE,d.RSP.ERROR,o,{}):r._createLicRoom(e,t,i)})}},{key:"destroyChannel",value:function(){this._destroyPreview(),this._destroyLicRoom(),this._destroyStream(),this._unAllPull(),this._unAllVPull(),this._destroyMixerStream(),this._destroyDispatcher()}},{key:"joinChannel",value:function(e,t,i){this.quitChannel(),this._isActive=!0,this._roomRole=c.RoomRole.AUDIENCE,this._config=Object.assign(i,{userRole:1,userId:t,channelId:e}),this._config.roomId=e,this._streamConfig={},this._config.streamConfig&&(this._config.streamConfig.isMix=!1,this._streamConfig=this._config.streamConfig),this._isMixControl=!1,this._streamConfig.isMix=!1,this._isDirectLink="true"===String(this._config.isDirectLink),this._isDirectLink?this.changeRole(c.RoomRole.INTERACTIVE):this._createStream(this._config.channelId,this._config.userId,this._config)}},{key:"quitChannel",value:function(){this._destroyPreview(),this._quitLicRoom(),this._destroyStream(),this._unAllPull(),this._unAllVPull(),this._destroyMixerStream(),this._destroyDispatcher()}},{key:"changeRole",value:function(e){this._roomRole!==c.RoomRole.ANCHOR&&(e===c.RoomRole.INTERACTIVE&&this._roomRole===c.RoomRole.AUDIENCE?(h.default.log("change role from audience to viewer",d.LOG.ROOM),this._config.channelId&&this._config.userId&&(this._roomRole=e,this._joinLicRoom())):e===c.RoomRole.AUDIENCE&&this._roomRole===c.RoomRole.INTERACTIVE&&(h.default.log("change role from viewer to audience",d.LOG.ROOM),this._config.channelId&&this._config.userId&&(this._roomRole=e,this._quitLicRoom(),this._unAllPull(),this._unAllVPull(),this._destroyPushStream(),this._createStream(this._config.channelId,this._config.userId,this._config))))}},{key:"sendMessage",value:function(e,t){arguments.length>2&&void 0!==arguments[2]&&arguments[2]}},{key:"broadcastMessage",value:function(e){}},{key:"createVChannel",value:function(e){this._licRoomClass&&e&&e.vChannelId&&(this._vChannelId=e.vChannelId,this._licRoomClass.createVRoom(e))}},{key:"joinVChannel",value:function(e){this._licRoomClass&&e&&e.vChannelId&&(this._vChannelId=e.vChannelId,this._licRoomClass.joinVRoom(e))}},{key:"quitVChannel",value:function(e){this._licRoomClass&&e&&e.vChannelId&&this._licRoomClass.quitVRoom(e)}},{key:"destroyVChannel",value:function(e){this._licRoomClass&&e&&e.vChannelId&&this._licRoomClass.destroyVRoom(e)}},{key:"fullVChannel",value:function(e){this._licRoomClass&&e&&e.vChannelId&&this._licRoomClass.fullVListRoom(e)}},{key:"inWhichVChannel",value:function(e){this._licRoomClass&&this._licRoomClass.inWhichVRoom(e)}},{key:"debug",value:function(e){this._playClass&&this._playClass.debug(e)}},{key:"debugSourceBuffer",value:function(){this._playClass&&this._playClass.debugSourceBuffer()}},{key:"stopAudio",value:function(){this._pushClass&&this._pushClass.stopAudio()}},{key:"stopVideo",value:function(){this._pushClass&&this._pushClass.stopVideo()}},{key:"switchAudio",value:function(e){this._pushClass&&this._pushClass.switchAudio(e)}},{key:"switchVideo",value:function(e){this._pushClass&&this._pushClass.switchVideo(e)}},{key:"addStream",value:function(e){this._pushClass&&this._pushClass.addStream(e)}},{key:"startMixAudio",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"";this._pushClass&&this._pushClass.startMixAudio(e)}},{key:"stopMixAudio",value:function(){this._pushClass&&this._pushClass.stopMixAudio()}},{key:"pauseMixAudio",value:function(){this._pushClass&&this._pushClass.pauseMixAudio()}},{key:"resumeMixAudio",value:function(){this._pushClass&&this._pushClass.resumeMixAudio()}},{key:"setMixAudioVolume",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0;this._pushClass&&this._pushClass.setMixAudioVolume(e,t)}},{key:"setMixAudioLoop",value:function(e,t){this._pushClass&&this._pushClass.setMixAudioLoop(e,t)}},{key:"_quit",value:function(e){return!this._isActive&&(h.default.debug("["+e+"]server stop",d.LOG.ROOM),!0)}},{key:"_createPreview",value:function(e){this._destroyPreview(),this._previewClass=new T.default,this._previewClass.start(e)}},{key:"_destroyPreview",value:function(){this._previewClass&&(this._previewClass.stop(),this._previewClass=void 0)}},{key:"_destroyDispatcher",value:function(){this._dispatchClass&&(this._dispatchClass.stop(),this._dispatchClass=void 0)}},{key:"_createDispatcher",value:function(){this._dispatchClass||(this._dispatchClass=new O.default),this._dispatchClass.init({roomId:this._config.roomId,userRole:this._config.userRole})}},{key:"_startDispatch",value:function(e){var t=this,i=f.Globals.isRtcTest?f.Globals.rtcPushHosts:f.Globals.rtcHosts;f.Globals.isRtcArea&&(i.length<=0||""===f.Globals.rtcArea)?(this._createDispatcher(),this._dispatchClass.startIMP(function(e,i){e===d.RSP.SUCCESS?t._slsHost=i:t._slsHost=""}),i.length<=0?this._dispatchClass.startRTC(function(i,r){t._quit("rtc dispatch")||(i===d.RSP.SUCCESS?t._dispatchClass.startArea(function(i,r){t._quit("area dispatch")||e&&e(d.RSP.SUCCESS,"success")}):e&&e(d.RSP.ERROR,r))}):this._dispatchClass.startArea(function(i,r){t._quit("area dispatch")||e&&e(d.RSP.SUCCESS,"success")})):e&&e(d.RSP.SUCCESS)}},{key:"_createLicRoom",value:function(e,t,i){this._destroyLicRoom(),this._licRoomClass=new I.default,this._licRoomClass.listenTo(c.RoomEvent.ROOM_EVENT,this._onRoomEventHandler.bind(this));var r=Object.assign(i,{userRole:0,userId:t,roomId:e});""!==this._slsHost&&(r.slsHost=this._slsHost),this._licRoomClass.start(r),this._licRoomClass.createRoom(r)}},{key:"_destroyLicRoom",value:function(){this._licRoomClass&&(this._licRoomClass.removeToAll(),this._licRoomClass.destroyRoom({userId:this._config.userId,roomId:this._config.channelId}),""!==this._vChannelId&&this.quitVChannel({vChannelId:this._vChannelId}),this._licRoomClass.stop(),this._licRoomClass=void 0)}},{key:"_joinLicRoom",value:function(){var e=this;this._destroyPlayStream(),this._startDispatch(function(t,i){if(t===d.RSP.ERROR)e._dispatchEvent(u.LinkEvent.JOIN,d.RSP.ERROR,i,{});else{e._createPushStream(e._config.channelId,e._config.userId,e._config),e._quitLicRoom(),e._licRoomClass=new M.default,e._licRoomClass.listenTo(c.RoomEvent.ROOM_EVENT,e._onRoomEventHandler.bind(e));var r=Object.assign(e._config,{userRole:1,roomId:e._config.channelId});""!==e._slsHost&&(r.slsHost=e._slsHost),e._licRoomClass.start(r),e._licRoomClass.joinRoom(r)}})}},{key:"_quitLicRoom",value:function(){this._licRoomClass&&(this._licRoomClass.removeToAll(),this._licRoomClass.quitRoom({userId:this._config.userId,roomId:this._config.channelId}),""!==this._vChannelId&&this.quitVChannel({vChannelId:this._vChannelId}),this._licRoomClass.stop(),this._licRoomClass=void 0)}},{key:"_fullListRoom",value:function(){this._licRoomClass&&this._licRoomClass.fullListRoom({roomId:this._config.roomId,userId:this._config.userId})}},{key:"_releaseLicRoom",value:function(){this._roomRole!==c.RoomRole.ANCHOR?this._quitLicRoom():this._destroyLicRoom()}},{key:"_onRoomEventHandler",value:function(e){if(e&&!this._quit("_onRoomEventHandler")){var t=e[d.RSP.TYPE],i=e[d.RSP.CODE],r=e[d.RSP.DATA],s=e[d.RSP.MESSAGE];switch(t){case c.RoomMessage.BROADCAST:r?this._updateBroadcast(r):this._unAllPull();break;case c.RoomMessage.JOIN_ROOM:this._dispatchEvent(u.LinkEvent.JOIN,i,s,r);break;case c.RoomMessage.CREATE_ROOM:this._createPushStream(this._config.channelId,this._config.userId,this._config),this._dispatchEvent(u.LinkEvent.CREATE,i,s,r);break;case c.RoomMessage.DESTROY_ROOM:(r?r[d.RSP.ROOMID]:"")===this._config.channelId&&(this._dispatchEvent(u.LinkEvent.DESTROY,i,s,r),this.stop());break;case c.RoomMessage.JOIN_VROOM:i!==d.RSP.SUCCESS&&this._dispatchEvent(u.LinkEvent.JOIN_V,i,s,r);break;case c.RoomMessage.CREATE_VROOM:i!==d.RSP.SUCCESS&&this._dispatchEvent(u.LinkEvent.CREATE_V,i,s,r);break;case c.RoomMessage.BROADCAST_V:this._updateVBroadcast(r);break;case c.RoomMessage.DESTROY_VROOM:this._unAllVPull(),this._isMixControl&&this._roomRole===c.RoomRole.ANCHOR&&this._dispatchEvent(u.LinkEvent.MIX_LAYOUT,d.RSP.SUCCESS,d.RSP.OK,{group:[]})}}}},{key:"_parsePullConfig",value:function(e){var t={url:e,isMix:!1,userId:this._config.userId,userRole:0===this._config.userRole?0:1},i=this._streamConfig;for(var r in i)if(i.hasOwnProperty(r))switch(r){case"networkConfig":t[r]=i[r]||{};break;case"isTrackDetect":t[r]="true"===String(i[r])}return t}},{key:"_pull",value:function(e){var t=this,i=arguments.length>1&&void 0!==arguments[1]&&arguments[1],r=i?this._vPullers:this._pullers;if(r.map(function(e){return e.peerUserId}).indexOf(e.userId)<0){var s=e.pullUrl||"";""===s&&(s=f.HOST.PROTOCOL_RTC+(this._config.host||f.Globals.host)+"/"+f.Globals.appId+"/"+this._config.roomId+"/"+e.userId);var o=this._parsePullConfig(s),n=new m.default;n.listenTo(u.Event.PULL_STREAM_EVENT,function(e){if(e&&!t._quit("PULL_STREAM_EVENT")){var i=e[d.RSP.TYPE],r=e[d.RSP.CODE],s=e[d.RSP.DATA]||{},o=e[d.RSP.MESSAGE];switch(i){case u.PullStreamEvent.VIDEO_ERROR:case u.PullStreamEvent.SERVER_ERROR:case u.PullStreamEvent.SERVER_SUCCESS:t._dispatchEvent(u.LinkEvent.PULL_EVENT,r,o,Object.assign(s,{type:i,userId:n.peerUserId}))}}}),n.start(o),r.push(n),!i&&this._isMixControl&&this._joinMixer(n.peerUserId,n.peerArea)}else h.default.debug(e.userId+" already in pulling",d.LOG.ROOM)}},{key:"_unPull",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]&&arguments[1],i=t?this._vPullers:this._pullers;if(i.map(function(e){return e.peerUserId}).indexOf(e.userId)<0)h.default.debug(e.userId+" no need to unpull as not in pulling",d.LOG.ROOM);else{h.default.log("ready to unpull "+e.userId+" stream",d.LOG.ROOM);for(var r=void 0,s=void 0,o=i,n=e.userId,a=0;a<o.length;a++)if(r=o[a],s=r.peerUserId,n===s){t||this._quitMixer(s),r.removeToAll(),r.stop(),i.splice(a,1),r=void 0;break}}}},{key:"_unAllPull",value:function(){var e=this;this._pullers.forEach(function(t){t&&(e._quitMixer(t.peerUserId),t.stop())}),this._pullers.splice(0,this._pullers.length),this._pullers=[],this._lastUsers=[],this._roomRole===c.RoomRole.ANCHOR&&this._dispatchEvent(u.LinkEvent.BROADCAST,d.RSP.SUCCESS,"broadcast",{users:[]})}},{key:"_unAllVPull",value:function(){this._vPullers.forEach(function(e){e&&e.stop()}),this._vPullers.splice(0,this._vPullers.length),this._vPullers=[],this._lastVUsers=[]}},{key:"_updateBroadcast",value:function(e){var t=this;if(e.length<=0)return void this._unAllPull();var i=this._lastUsers.slice(0,this._lastUsers.length),r=i.map(function(e){return e.userId});this._lastUsers=e;var s=this._lastUsers.map(function(e){return e.userId}),o=[];i.forEach(function(e){e.userId&&e.userId!==t._config.userId&&s.indexOf(e.userId)<0&&o.push(e)}),o.forEach(function(e){t._unPull(e)});var n=[];if(e.forEach(function(e){e.userId&&e.userId!==t._config.userId&&r.indexOf(e.userId)<0&&n.push(e)}),n.forEach(function(e){t._pull(e)}),this._roomRole===c.RoomRole.ANCHOR){var a=[];this._lastUsers.forEach(function(e){e.userId&&e.userId!==t._config.userId&&a.push(e.userId)}),this._dispatchEvent(u.LinkEvent.BROADCAST,d.RSP.SUCCESS,"broadcast",{users:a})}}},{key:"_updateVBroadcast",value:function(e){var t=this;if(e.length<=0)return this._unAllVPull(),void(this._isMixControl&&this._roomRole===c.RoomRole.ANCHOR&&this._dispatchEvent(u.LinkEvent.MIX_LAYOUT,d.RSP.SUCCESS,d.RSP.OK,{group:[this._lastUsers]}));var i=this._lastVUsers.slice(0,this._lastVUsers.length),r=i.map(function(e){return e.userId});this._lastVUsers=e;var s=this._lastVUsers.map(function(e){return e.userId}),o=[];i.forEach(function(e){e.userId&&s.indexOf(e.userId)<0&&o.push(e)}),o.forEach(function(e){t._unPull(e,!0)});var n=[];if(e.forEach(function(e){e.userId&&e.userId!==t._config.userId&&r.indexOf(e.userId)<0&&n.push(e)}),n.forEach(function(e){t._pull(e,!0)}),this._isMixControl&&this._roomRole===c.RoomRole.ANCHOR){var a=this._sortVRoomByGroup(this._lastVUsers);a.unshift(this._lastUsers),this._dispatchEvent(u.LinkEvent.MIX_LAYOUT,d.RSP.SUCCESS,d.RSP.OK,{group:a})}}},{key:"_sortVRoomByGroup",value:function(e){var t=void 0,i=-1,r=[],s=[];return e.forEach(function(e){e[d.RSP.ROOMID]&&(i=r.indexOf(e[d.RSP.ROOMID]),i<0?(r.push(e[d.RSP.ROOMID]),s.push([e])):i<s.length&&s[i]&&(t=s[i],t.push(e)))}),s}},{key:"_createStream",value:function(e,t,i){this._roomRole===c.RoomRole.ANCHOR?this._createPushStream(e,t,i):this._roomRole===c.RoomRole.AUDIENCE&&this._createPlayStream(t,i)}},{key:"_destroyStream",value:function(){this._destroyPushStream(),this._destroyPlayStream()}},{key:"_createPushStream",value:function(e,t,i){this._destroyPushStream();var r=f.HOST.PROTOCOL_RTC;r+=i.host||f.Globals.host,r+="/"+f.Globals.appId+"/"+e+"/"+t;var s=this._parsePushConfig(r);this._pushClass=new v.default,this._pushClass.listenTo(u.Event.PUSH_STREAM_EVENT,this._onPushEventHandler.bind(this)),this._pushClass.start(s)}},{key:"_destroyPushStream",value:function(){this._pushClass&&(this._pushClass.removeToAll(),this._pushClass.stop(),this._pushClass=void 0)}},{key:"_parsePushConfig",value:function(e){var t={url:e,isMix:!1,isMixCheck:!1,isDispatch:!f.Globals.isRtcArea,camConfig:{audio:!0,video:!0},userRole:this._roomRole===c.RoomRole.ANCHOR?0:1},i=this._streamConfig;for(var r in i)if(i.hasOwnProperty(r))switch(r){case"isSei":case"isScreen":case"isMirror":case"enableCustom":case"enableControls":t[r]=i[r];break;case"videoType":t[r]=i[r]||"";break;case"camConfig":case"mixConfig":case"screenConfig":case"networkConfig":case"mixAudioConfig":case"watermarkConfig":t[r]=i[r]||{}}return t}},{key:"_onPushEventHandler",value:function(e){if(e&&!this._quit("_onPushEventHandler")){var t=e[d.RSP.TYPE],i=e[d.RSP.CODE],r=e[d.RSP.DATA]||{},s=e[d.RSP.MESSAGE];switch(t){case u.PushStreamEvent.SERVER_SUCCESS:this._dispatchEvent(u.LinkEvent.PUSH_EVENT,i,s,Object.assign(r,{type:t})),this._pushHosts=r.hosts||[],this._curPushHost=r.currentHost||"",this._isMixControl&&this._roomRole===c.RoomRole.ANCHOR&&this._createMixerStream(),this._fullListRoom(),this.inWhichVChannel({roomId:this._config.roomId,userId:this._config.userId});break;case u.PushStreamEvent.VIDEO_ERROR:case u.PushStreamEvent.CAMERA_ERROR:case u.PushStreamEvent.SERVER_ERROR:case u.PushStreamEvent.STREAMTRACK_CHANGE:case u.PushStreamEvent.PEER_CONN_SWITCH_EVENT:this._dispatchEvent(u.LinkEvent.PUSH_EVENT,i,s,Object.assign(r,{type:t}))}}}},{key:"_createMixerStream",value:function(){this._mixClass||(this._mixClass=new y.default,this._mixClass.listenTo(u.Event.MIX_STREAM_EVENT,this._onMixerEventHandler.bind(this)));var e=this._streamConfig.mixConfig||{};this._mixClass.startMix({url:e.roomUrl||"",hosts:this._pushHosts||[],userId:this._config.userId||"",channelId:this._config.channelId||""}),this._mixClass.mixHost(this._curPushHost),this._mixClass.mixCreate(e),"true"===String(this._streamConfig.isMixCheck)&&this._mixClass.startMixCheck()}},{key:"_joinMixer",value:function(e,t){this._isMixControl&&this._roomRole===c.RoomRole.ANCHOR&&this._mixClass&&this._mixClass.mixJoin({userId:e,area:t})}},{key:"_quitMixer",value:function(e){this._isMixControl&&this._roomRole===c.RoomRole.ANCHOR&&this._mixClass&&this._mixClass.mixQuit({userId:e})}},{key:"_destroyMixerStream",value:function(){this._mixClass&&(this._mixClass.stopMixCheck(),this._mixClass.mixDestroy(),this._mixClass.stop(),this._mixClass=void 0)}},{key:"_onMixerEventHandler",value:function(e){var t=this;if(e&&!this._quit("_onMixerEventHandler")){var i=e[d.RSP.TYPE],r=e[d.RSP.CODE],s=e[d.RSP.DATA]||{},o=e[d.RSP.MESSAGE];switch(i){case u.MixEvent.CREATE:this._pullers&&r===d.RSP.SUCCESS&&this._mixClass&&this._pullers.forEach(function(e){e&&t._mixClass.mixJoin({userId:e.peerUserId})});break;case u.MixEvent.QUERY:if(404===parseInt(r)){if(this._mixClass){var n=this._streamConfig.mixConfig||{};this._mixClass.mixCreate(n),"true"===String(this._streamConfig.isMixCheck)&&this._mixClass.startMixCheck()}return}}this._dispatchEvent(u.LinkEvent.MIX_EVENT,r,o,Object.assign(s,{type:i}))}}},{key:"_createPlayStream",value:function(e,t){this._destroyPlayStream(),this._playClass=new S.default,this._playClass.listenTo(u.Event.PLAYER_EVENT,this._onPlayEventHandler.bind(this));var i=this._parsePlayConfig(e,t);this._playClass.start(i)}},{key:"_destroyPlayStream",value:function(){this._playClass&&(this._playClass.removeToAll(),this._playClass.stop(),this._playClass=void 0)}},{key:"_onPlayEventHandler",value:function(e){if(e&&!this._quit("_onPlayEventHandler")){var t=e[d.RSP.TYPE],i=e[d.RSP.CODE],r=e[d.RSP.DATA]||{},s=e[d.RSP.MESSAGE];switch(t){case u.PlayEvent.ERROR:case u.PlayEvent.SOCKET_CLOSE:case u.PlayEvent.BUFFER_WARNING:this._dispatchEvent(u.LinkEvent.PLAY_EVENT,i,s,Object.assign(r,{type:t}))}}}},{key:"_parsePlayConfig",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},i={url:"",isLive:!0,userId:e,liveDelayTime:6,isLiveCatch:!0},r=t.playConfig||{};for(var s in r)if(r.hasOwnProperty(s))switch(s){case"url":var o=r[s]||"",n=o;0!==o.indexOf("https://")&&(n=o.length>7&&0===o.indexOf("http://")?f.HOST.PROTOCOL+o.substring(7):f.HOST.PROTOCOL+o),n.indexOf(".flv")<0&&(n+=".flv"),i[s]=n;break;case"isLiveCatch":case"enableAudioStrategy":i[s]=!("false"===String(r[s]));break;case"liveDelayTime":var a=parseInt(r[s]);!isNaN(a)&&a>0&&(i[s]=a);break;case"seiConfig":case"secretConfig":i[s]=r[s]||{}}return i}},{key:"_dispatchEvent",value:function(e,t,i,r){if(!this._quit("_dispatchEvent")){var s="{}";r&&(s=JSON.stringify(r)),h.default.log(e+", "+t+", "+i+", "+s,d.LOG.ROOM),this.trigger(u.Event.CHANNEL_EVENT,{type:e,code:t,message:i,data:r})}}}]),t}(b.default);t.default=L},function(e,t,i){"use strict";function r(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}Object.defineProperty(t,"__esModule",{value:!0});var s=function(){function e(e,t){for(var i=0;i<t.length;i++){var r=t[i];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}return function(t,i,r){return i&&e(t.prototype,i),r&&e(t,r),t}}(),o=i(4),n=i(32),a=function(e){return e&&e.__esModule?e:{default:e}}(n),u=function(){function e(){r(this,e)}return s(e,[{key:"createChannel",value:function(e){var t=new a.default;return e&&t.listenTo(o.Event.SIGNAL_EVENT,e),t}},{key:"joinChannel",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"",i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:"",r=arguments.length>3&&void 0!==arguments[3]?arguments[3]:[],s=arguments.length>4&&void 0!==arguments[4]?arguments[4]:{};e&&e.connect(t,i,r,s)}},{key:"quitChannel",value:function(e){e&&e.disconnect()}},{key:"sendUnicastMessage",value:function(e,t,i){if(e){var r=i;"Object"===Object.prototype.toString.call(i).slice(8,-1)&&(r=JSON.stringify(i)),e.sendUnicastMessage(t,r)}}},{key:"sendMulticastMessage",value:function(e,t,i){if(e){var r=i;"Object"===Object.prototype.toString.call(i).slice(8,-1)&&(r=JSON.stringify(i)),e.sendMulticastMessage(t,r)}}},{key:"sendBroadcastMessage",value:function(e,t){if(e){var i=t;"Object"===Object.prototype.toString.call(t).slice(8,-1)&&(i=JSON.stringify(t)),e.sendBroadcastMessage(i)}}}]),e}();t.default=u},function(e,t,i){"use strict";function r(e){var t=e.length;if(t%4>0)throw new Error("Invalid string. Length must be a multiple of 4");return"="===e[t-2]?2:"="===e[t-1]?1:0}function s(e){return 3*e.length/4-r(e)}function o(e){var t,i,s,o,n,a=e.length;o=r(e),n=new h(3*a/4-o),i=o>0?a-4:a;var u=0;for(t=0;t<i;t+=4)s=l[e.charCodeAt(t)]<<18|l[e.charCodeAt(t+1)]<<12|l[e.charCodeAt(t+2)]<<6|l[e.charCodeAt(t+3)],n[u++]=s>>16&255,n[u++]=s>>8&255,n[u++]=255&s;return 2===o?(s=l[e.charCodeAt(t)]<<2|l[e.charCodeAt(t+1)]>>4,n[u++]=255&s):1===o&&(s=l[e.charCodeAt(t)]<<10|l[e.charCodeAt(t+1)]<<4|l[e.charCodeAt(t+2)]>>2,n[u++]=s>>8&255,n[u++]=255&s),n}function n(e){return c[e>>18&63]+c[e>>12&63]+c[e>>6&63]+c[63&e]}function a(e,t,i){for(var r,s=[],o=t;o<i;o+=3)r=(e[o]<<16)+(e[o+1]<<8)+e[o+2],s.push(n(r));return s.join("")}function u(e){for(var t,i=e.length,r=i%3,s="",o=[],n=0,u=i-r;n<u;n+=16383)o.push(a(e,n,n+16383>u?u:n+16383));return 1===r?(t=e[i-1],s+=c[t>>2],s+=c[t<<4&63],s+="=="):2===r&&(t=(e[i-2]<<8)+e[i-1],s+=c[t>>10],s+=c[t>>4&63],s+=c[t<<2&63],s+="="),o.push(s),o.join("")}t.byteLength=s,t.toByteArray=o,t.fromByteArray=u;for(var c=[],l=[],h="undefined"!=typeof Uint8Array?Uint8Array:Array,d="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",f=0,_=d.length;f<_;++f)c[f]=d[f],l[d.charCodeAt(f)]=f;l["-".charCodeAt(0)]=62,l["_".charCodeAt(0)]=63},function(e,t,i){"use strict";function r(e){if(0==e.length)throw"0 length key";this.bf_P=this.Fbf_P(),this.bf_S0=this.Fbf_S0(),this.bf_S1=this.Fbf_S1(),this.bf_S2=this.Fbf_S2(),this.bf_S3=this.Fbf_S3(),this.escape=function(e){for(var t="",i=0;i<e.length;i++){var r=e.charCodeAt(i),s=Math.floor(r/16),o=r%16;s+=s<10?48:55,o+=o<10?48:55,t+=String.fromCharCode(s)+String.fromCharCode(o)}return t},this.wordbyte0=function(e){return Math.floor(Math.floor(Math.floor(e/256)/256)/256)%256},this.wordbyte1=function(e){return Math.floor(Math.floor(e/256)/256)%256},this.wordbyte2=function(e){return Math.floor(e/256)%256},this.wordbyte3=function(e){return e%256},this.xor=function(e,t){var i=e^t;return i<0&&(i=4294967296+i),i},this.key=e.length>56?e.substr(0,56):e;for(var t=0,i=0;i<18;++i){var r=256*(256*(256*this.key.charCodeAt(t%this.key.length)+this.key.charCodeAt((t+1)%this.key.length))+this.key.charCodeAt((t+2)%this.key.length))+this.key.charCodeAt((t+3)%this.key.length);this.bf_P[i]=this.xor(this.bf_P[i],r),t=(t+4)%this.key.length}this.xl_par=0,this.xr_par=0;for(var i=0;i<18;i+=2)this.encipher(),this.bf_P[i]=this.xl_par,this.bf_P[i+1]=this.xr_par;for(t=0;t<256;t+=2)this.encipher(),this.bf_S0[t]=this.xl_par,this.bf_S0[t+1]=this.xr_par;for(t=0;t<256;t+=2)this.encipher(),this.bf_S1[t]=this.xl_par,this.bf_S1[t+1]=this.xr_par;for(t=0;t<256;t+=2)this.encipher(),this.bf_S2[t]=this.xl_par,this.bf_S2[t+1]=this.xr_par;for(t=0;t<256;t+=2)this.encipher(),this.bf_S3[t]=this.xl_par,this.bf_S3[t+1]=this.xr_par;this.unescape=function(e){var t="";for(i=0;i<e.length;i++){var r=e.charCodeAt(i++),s=e.charCodeAt(i);r-=r<58?48:r>96?87:55,s-=s<58?48:s>96?87:55,t+=String.fromCharCode(16*r+s)}return t}}r.prototype.Fbf_P=function(){return[608135816,2242054355,320440878,57701188,2752067618,698298832,137296536,3964562569,1160258022,953160567,3193202383,887688300,3232508343,3380367581,1065670069,3041331479,2450970073,2306472731]},r.prototype.Fbf_S0=function(){return[3509652390,2564797868,805139163,3491422135,3101798381,1780907670,3128725573,4046225305,614570311,3012652279,134345442,2240740374,1667834072,1901547113,2757295779,4103290238,227898511,1921955416,1904987480,2182433518,2069144605,3260701109,2620446009,720527379,3318853667,677414384,3393288472,3101374703,2390351024,1614419982,1822297739,2954791486,3608508353,3174124327,2024746970,1432378464,3864339955,2857741204,1464375394,1676153920,1439316330,715854006,3033291828,289532110,2706671279,2087905683,3018724369,1668267050,732546397,1947742710,3462151702,2609353502,2950085171,1814351708,2050118529,680887927,999245976,1800124847,3300911131,1713906067,1641548236,4213287313,1216130144,1575780402,4018429277,3917837745,3693486850,3949271944,596196993,3549867205,258830323,2213823033,772490370,2760122372,1774776394,2652871518,566650946,4142492826,1728879713,2882767088,1783734482,3629395816,2517608232,2874225571,1861159788,326777828,3124490320,2130389656,2716951837,967770486,1724537150,2185432712,2364442137,1164943284,2105845187,998989502,3765401048,2244026483,1075463327,1455516326,1322494562,910128902,469688178,1117454909,936433444,3490320968,3675253459,1240580251,122909385,2157517691,634681816,4142456567,3825094682,3061402683,2540495037,79693498,3249098678,1084186820,1583128258,426386531,1761308591,1047286709,322548459,995290223,1845252383,2603652396,3431023940,2942221577,3202600964,3727903485,1712269319,422464435,3234572375,1170764815,3523960633,3117677531,1434042557,442511882,3600875718,1076654713,1738483198,4213154764,2393238008,3677496056,1014306527,4251020053,793779912,2902807211,842905082,4246964064,1395751752,1040244610,2656851899,3396308128,445077038,3742853595,3577915638,679411651,2892444358,2354009459,1767581616,3150600392,3791627101,3102740896,284835224,4246832056,1258075500,768725851,2589189241,3069724005,3532540348,1274779536,3789419226,2764799539,1660621633,3471099624,4011903706,913787905,3497959166,737222580,2514213453,2928710040,3937242737,1804850592,3499020752,2949064160,2386320175,2390070455,2415321851,4061277028,2290661394,2416832540,1336762016,1754252060,3520065937,3014181293,791618072,3188594551,3933548030,2332172193,3852520463,3043980520,413987798,3465142937,3030929376,4245938359,2093235073,3534596313,375366246,2157278981,2479649556,555357303,3870105701,2008414854,3344188149,4221384143,3956125452,2067696032,3594591187,2921233993,2428461,544322398,577241275,1471733935,610547355,4027169054,1432588573,1507829418,2025931657,3646575487,545086370,48609733,2200306550,1653985193,298326376,1316178497,3007786442,2064951626,458293330,2589141269,3591329599,3164325604,727753846,2179363840,146436021,1461446943,4069977195,705550613,3059967265,3887724982,4281599278,3313849956,1404054877,2845806497,146425753,1854211946]},r.prototype.Fbf_S1=function(){return[1266315497,3048417604,3681880366,3289982499,290971e4,1235738493,2632868024,2414719590,3970600049,1771706367,1449415276,3266420449,422970021,1963543593,2690192192,3826793022,1062508698,1531092325,1804592342,2583117782,2714934279,4024971509,1294809318,4028980673,1289560198,2221992742,1669523910,35572830,157838143,1052438473,1016535060,1802137761,1753167236,1386275462,3080475397,2857371447,1040679964,2145300060,2390574316,1461121720,2956646967,4031777805,4028374788,33600511,2920084762,1018524850,629373528,3691585981,3515945977,2091462646,2486323059,586499841,988145025,935516892,3367335476,2599673255,2839830854,265290510,3972581182,2759138881,3795373465,1005194799,847297441,406762289,1314163512,1332590856,1866599683,4127851711,750260880,613907577,1450815602,3165620655,3734664991,3650291728,3012275730,3704569646,1427272223,778793252,1343938022,2676280711,2052605720,1946737175,3164576444,3914038668,3967478842,3682934266,1661551462,3294938066,4011595847,840292616,3712170807,616741398,312560963,711312465,1351876610,322626781,1910503582,271666773,2175563734,1594956187,70604529,3617834859,1007753275,1495573769,4069517037,2549218298,2663038764,504708206,2263041392,3941167025,2249088522,1514023603,1998579484,1312622330,694541497,2582060303,2151582166,1382467621,776784248,2618340202,3323268794,2497899128,2784771155,503983604,4076293799,907881277,423175695,432175456,1378068232,4145222326,3954048622,3938656102,3820766613,2793130115,2977904593,26017576,3274890735,3194772133,1700274565,1756076034,4006520079,3677328699,720338349,1533947780,354530856,688349552,3973924725,1637815568,332179504,3949051286,53804574,2852348879,3044236432,1282449977,3583942155,3416972820,4006381244,1617046695,2628476075,3002303598,1686838959,431878346,2686675385,1700445008,1080580658,1009431731,832498133,3223435511,2605976345,2271191193,2516031870,1648197032,4164389018,2548247927,300782431,375919233,238389289,3353747414,2531188641,2019080857,1475708069,455242339,2609103871,448939670,3451063019,1395535956,2413381860,1841049896,1491858159,885456874,4264095073,4001119347,1565136089,3898914787,1108368660,540939232,1173283510,2745871338,3681308437,4207628240,3343053890,4016749493,1699691293,1103962373,3625875870,2256883143,3830138730,1031889488,3479347698,1535977030,4236805024,3251091107,2132092099,1774941330,1199868427,1452454533,157007616,2904115357,342012276,595725824,1480756522,206960106,497939518,591360097,863170706,2375253569,3596610801,1814182875,2094937945,3421402208,1082520231,3463918190,2785509508,435703966,3908032597,1641649973,2842273706,3305899714,1510255612,2148256476,2655287854,3276092548,4258621189,236887753,3681803219,274041037,1734335097,3815195456,3317970021,1899903192,1026095262,4050517792,356393447,2410691914,3873677099,3682840055]},r.prototype.Fbf_S2=function(){return[3913112168,2491498743,4132185628,2489919796,1091903735,1979897079,3170134830,3567386728,3557303409,857797738,1136121015,1342202287,507115054,2535736646,337727348,3213592640,1301675037,2528481711,1895095763,1721773893,3216771564,62756741,2142006736,835421444,2531993523,1442658625,3659876326,2882144922,676362277,1392781812,170690266,3921047035,1759253602,3611846912,1745797284,664899054,1329594018,3901205900,3045908486,2062866102,2865634940,3543621612,3464012697,1080764994,553557557,3656615353,3996768171,991055499,499776247,1265440854,648242737,3940784050,980351604,3713745714,1749149687,3396870395,4211799374,3640570775,1161844396,3125318951,1431517754,545492359,4268468663,3499529547,1437099964,2702547544,3433638243,2581715763,2787789398,1060185593,1593081372,2418618748,4260947970,69676912,2159744348,86519011,2512459080,3838209314,1220612927,3339683548,133810670,1090789135,1078426020,1569222167,845107691,3583754449,4072456591,1091646820,628848692,1613405280,3757631651,526609435,236106946,48312990,2942717905,3402727701,1797494240,859738849,992217954,4005476642,2243076622,3870952857,3732016268,765654824,3490871365,2511836413,1685915746,3888969200,1414112111,2273134842,3281911079,4080962846,172450625,2569994100,980381355,4109958455,2819808352,2716589560,2568741196,3681446669,3329971472,1835478071,660984891,3704678404,4045999559,3422617507,3040415634,1762651403,1719377915,3470491036,2693910283,3642056355,3138596744,1364962596,2073328063,1983633131,926494387,3423689081,2150032023,4096667949,1749200295,3328846651,309677260,2016342300,1779581495,3079819751,111262694,1274766160,443224088,298511866,1025883608,3806446537,1145181785,168956806,3641502830,3584813610,1689216846,3666258015,3200248200,1692713982,2646376535,4042768518,1618508792,1610833997,3523052358,4130873264,2001055236,3610705100,2202168115,4028541809,2961195399,1006657119,2006996926,3186142756,1430667929,3210227297,1314452623,4074634658,4101304120,2273951170,1399257539,3367210612,3027628629,1190975929,2062231137,2333990788,2221543033,2438960610,1181637006,548689776,2362791313,3372408396,3104550113,3145860560,296247880,1970579870,3078560182,3769228297,1714227617,3291629107,3898220290,166772364,1251581989,493813264,448347421,195405023,2709975567,677966185,3703036547,1463355134,2715995803,1338867538,1343315457,2802222074,2684532164,233230375,2599980071,2000651841,3277868038,1638401717,4028070440,3237316320,6314154,819756386,300326615,590932579,1405279636,3267499572,3150704214,2428286686,3959192993,3461946742,1862657033,1266418056,963775037,2089974820,2263052895,1917689273,448879540,3550394620,3981727096,150775221,3627908307,1303187396,508620638,2975983352,2726630617,1817252668,1876281319,1457606340,908771278,3720792119,3617206836,2455994898,1729034894,1080033504]},r.prototype.Fbf_S3=function(){return[976866871,3556439503,2881648439,1522871579,1555064734,1336096578,3548522304,2579274686,3574697629,3205460757,3593280638,3338716283,3079412587,564236357,2993598910,1781952180,1464380207,3163844217,3332601554,1699332808,1393555694,1183702653,3581086237,1288719814,691649499,2847557200,2895455976,3193889540,2717570544,1781354906,1676643554,2592534050,3230253752,1126444790,2770207658,2633158820,2210423226,2615765581,2414155088,3127139286,673620729,2805611233,1269405062,4015350505,3341807571,4149409754,1057255273,2012875353,2162469141,2276492801,2601117357,993977747,3918593370,2654263191,753973209,36408145,2530585658,25011837,3520020182,2088578344,530523599,2918365339,1524020338,1518925132,3760827505,3759777254,1202760957,3985898139,3906192525,674977740,4174734889,2031300136,2019492241,3983892565,4153806404,3822280332,352677332,2297720250,60907813,90501309,3286998549,1016092578,2535922412,2839152426,457141659,509813237,4120667899,652014361,1966332200,2975202805,55981186,2327461051,676427537,3255491064,2882294119,3433927263,1307055953,942726286,933058658,2468411793,3933900994,4215176142,1361170020,2001714738,2830558078,3274259782,1222529897,1679025792,2729314320,3714953764,1770335741,151462246,3013232138,1682292957,1483529935,471910574,1539241949,458788160,3436315007,1807016891,3718408830,978976581,1043663428,3165965781,1927990952,4200891579,2372276910,3208408903,3533431907,1412390302,2931980059,4132332400,1947078029,3881505623,4168226417,2941484381,1077988104,1320477388,886195818,18198404,3786409e3,2509781533,112762804,3463356488,1866414978,891333506,18488651,661792760,1628790961,3885187036,3141171499,876946877,2693282273,1372485963,791857591,2686433993,3759982718,3167212022,3472953795,2716379847,445679433,3561995674,3504004811,3574258232,54117162,3331405415,2381918588,3769707343,4154350007,1140177722,4074052095,668550556,3214352940,367459370,261225585,2610173221,4209349473,3468074219,3265815641,314222801,3066103646,3808782860,282218597,3406013506,3773591054,379116347,1285071038,846784868,2669647154,3771962079,3550491691,2305946142,453669953,1268987020,3317592352,3279303384,3744833421,2610507566,3859509063,266596637,3847019092,517658769,3462560207,3443424879,370717030,4247526661,2224018117,4143653529,4112773975,2788324899,2477274417,1456262402,2901442914,1517677493,1846949527,2295493580,3734397586,2176403920,1280348187,1908823572,3871786941,846861322,1172426758,3287448474,3383383037,1655181056,3139813346,901632758,1897031941,2986607138,3066810236,3447102507,1393639104,373351379,950779232,625454576,3124240540,4148612726,2007998917,544563296,2244738638,2330496472,2058025392,1291430526,424198748,50039436,29584100,3605783033,2429876329,2791104160,1057563949,3255363231,3075367218,3463963227,1469046755,985887462]},r.prototype.encrypt=function(e){for(var t=0;t<e.length%8;t++)e+="\0";for(var i="",t=0;t<e.length;t+=8){var r=e.substr(t,4),s=e.substr(t+4,4),o=r.charCodeAt(3)|r.charCodeAt(2)<<8|r.charCodeAt(1)<<16|r.charCodeAt(0)<<24;o<0&&(o=4294967296+o);var n=s.charCodeAt(3)|s.charCodeAt(2)<<8|s.charCodeAt(1)<<16|s.charCodeAt(0)<<24;n<0&&(n=4294967296+n),this.xl_par=o,this.xr_par=n,this.encipher(),i+=this.wordescape(this.xl_par)+this.wordescape(this.xr_par)}return i},r.prototype.decrypt=function(e){for(var t=0;t<e.length%16;t++)e+="\0";for(var i="",t=0;t<e.length;t+=16){var r=this.unescape(e.substr(t,8)),s=this.unescape(e.substr(t+8,8)),o=r.charCodeAt(3)|r.charCodeAt(2)<<8|r.charCodeAt(1)<<16|r.charCodeAt(0)<<24;o<0&&(o=4294967296+o);var n=s.charCodeAt(3)|s.charCodeAt(2)<<8|s.charCodeAt(1)<<16|s.charCodeAt(0)<<24;n<0&&(n=4294967296+n),this.xl_par=o,this.xr_par=n,this.decipher(),i+=this.wordescape(this.xl_par)+this.wordescape(this.xr_par)}return this.unescape(i)},r.prototype.wordescape=function(e){for(var t="",i=new Array(this.wordbyte3(e),this.wordbyte2(e),this.wordbyte1(e),this.wordbyte0(e)),r=3;r>=0;r--){var s=Math.floor(i[r]/16),o=i[r]%16;s+=s<10?48:55,o+=o<10?48:55,t+=String.fromCharCode(s)+String.fromCharCode(o)}return t},r.prototype.wordunescape=function(e){for(var t=0,i=6;i>=0;i-=2){var r=e.charCodeAt(i),s=e.charCodeAt(i+1);r-=r<58?48:55,s-=s<58?48:55,t=256*t+(16*r+s)}return t},r.prototype.round=function(e,t,i){var r=this;return r.xor(e,r.xor(r.xor(r.bf_S0[r.wordbyte0(t)]+r.bf_S1[r.wordbyte1(t)],r.bf_S2[r.wordbyte2(t)])+r.bf_S3[r.wordbyte3(t)],r.bf_P[i]))},r.prototype.encipher=function(){var e=this,t=e.xl_par,i=e.xr_par;t=e.xor(t,e.bf_P[0]),i=e.round(i,t,1),t=e.round(t,i,2),i=e.round(i,t,3),t=e.round(t,i,4),i=e.round(i,t,5),t=e.round(t,i,6),i=e.round(i,t,7),t=e.round(t,i,8),i=e.round(i,t,9),t=e.round(t,i,10),i=e.round(i,t,11),t=e.round(t,i,12),i=e.round(i,t,13),t=e.round(t,i,14),i=e.round(i,t,15),t=e.round(t,i,16),i=e.xor(i,e.bf_P[17]),e.xl_par=i,e.xr_par=t},r.prototype.decipher=function(){var e=this,t=e.xl_par,i=e.xr_par;t=e.xor(t,e.bf_P[17]),i=e.round(i,t,16),t=e.round(t,i,15),i=e.round(i,t,14),t=e.round(t,i,13),i=e.round(i,t,12),t=e.round(t,i,11),i=e.round(i,t,10),t=e.round(t,i,9),i=e.round(i,t,8),t=e.round(t,i,7),i=e.round(i,t,6),t=e.round(t,i,5),i=e.round(i,t,4),t=e.round(t,i,3),i=e.round(i,t,2),t=e.round(t,i,1),i=e.xor(i,e.bf_P[0]),e.xl_par=i,e.xr_par=t},e.exports=r},function(e,t,i){"use strict";(function(e){function r(){return o.TYPED_ARRAY_SUPPORT?2147483647:1073741823}function s(e,t){if(r()<t)throw new RangeError("Invalid typed array length");return o.TYPED_ARRAY_SUPPORT?(e=new Uint8Array(t),e.__proto__=o.prototype):(null===e&&(e=new o(t)),e.length=t),e}function o(e,t,i){if(!(o.TYPED_ARRAY_SUPPORT||this instanceof o))return new o(e,t,i);if("number"==typeof e){if("string"==typeof t)throw new Error("If encoding is specified then the first argument must be a string");return c(this,e)}return n(this,e,t,i)}function n(e,t,i,r){if("number"==typeof t)throw new TypeError('"value" argument must not be a number');return"undefined"!=typeof ArrayBuffer&&t instanceof ArrayBuffer?d(e,t,i,r):"string"==typeof t?l(e,t,i):f(e,t)}function a(e){if("number"!=typeof e)throw new TypeError('"size" argument must be a number');if(e<0)throw new RangeError('"size" argument must not be negative')}function u(e,t,i,r){return a(t),t<=0?s(e,t):void 0!==i?"string"==typeof r?s(e,t).fill(i,r):s(e,t).fill(i):s(e,t)}function c(e,t){if(a(t),e=s(e,t<0?0:0|_(t)),!o.TYPED_ARRAY_SUPPORT)for(var i=0;i<t;++i)e[i]=0;return e}function l(e,t,i){if("string"==typeof i&&""!==i||(i="utf8"),!o.isEncoding(i))throw new TypeError('"encoding" must be a valid string encoding');var r=0|p(t,i);e=s(e,r);var n=e.write(t,i);return n!==r&&(e=e.slice(0,n)),e}function h(e,t){var i=t.length<0?0:0|_(t.length);e=s(e,i);for(var r=0;r<i;r+=1)e[r]=255&t[r];return e}function d(e,t,i,r){if(t.byteLength,i<0||t.byteLength<i)throw new RangeError("'offset' is out of bounds");if(t.byteLength<i+(r||0))throw new RangeError("'length' is out of bounds");return t=void 0===i&&void 0===r?new Uint8Array(t):void 0===r?new Uint8Array(t,i):new Uint8Array(t,i,r),o.TYPED_ARRAY_SUPPORT?(e=t,e.__proto__=o.prototype):e=h(e,t),e}function f(e,t){if(o.isBuffer(t)){var i=0|_(t.length);return e=s(e,i),0===e.length?e:(t.copy(e,0,0,i),e)}if(t){if("undefined"!=typeof ArrayBuffer&&t.buffer instanceof ArrayBuffer||"length"in t)return"number"!=typeof t.length||J(t.length)?s(e,0):h(e,t);if("Buffer"===t.type&&Z(t.data))return h(e,t.data)}throw new TypeError("First argument must be a string, Buffer, ArrayBuffer, Array, or array-like object.")}function _(e){if(e>=r())throw new RangeError("Attempt to allocate Buffer larger than maximum size: 0x"+r().toString(16)+" bytes");return 0|e}function v(e){return+e!=e&&(e=0),o.alloc(+e)}function p(e,t){if(o.isBuffer(e))return e.length;if("undefined"!=typeof ArrayBuffer&&"function"==typeof ArrayBuffer.isView&&(ArrayBuffer.isView(e)||e instanceof ArrayBuffer))return e.byteLength;"string"!=typeof e&&(e=""+e);var i=e.length;if(0===i)return 0;for(var r=!1;;)switch(t){case"ascii":case"latin1":case"binary":return i;case"utf8":case"utf-8":case void 0:return q(e).length;case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":return 2*i;case"hex":return i>>>1;case"base64":return K(e).length;default:if(r)return q(e).length;t=(""+t).toLowerCase(),r=!0}}function m(e,t,i){var r=!1;if((void 0===t||t<0)&&(t=0),t>this.length)return"";if((void 0===i||i>this.length)&&(i=this.length),i<=0)return"";if(i>>>=0,t>>>=0,i<=t)return"";for(e||(e="utf8");;)switch(e){case"hex":return M(this,t,i);case"utf8":case"utf-8":return A(this,t,i);case"ascii":return I(this,t,i);case"latin1":case"binary":return w(this,t,i);case"base64":return O(this,t,i);case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":return L(this,t,i);default:if(r)throw new TypeError("Unknown encoding: "+e);e=(e+"").toLowerCase(),r=!0}}function g(e,t,i){var r=e[t];e[t]=e[i],e[i]=r}function y(e,t,i,r,s){if(0===e.length)return-1;if("string"==typeof i?(r=i,i=0):i>2147483647?i=2147483647:i<-2147483648&&(i=-2147483648),i=+i,isNaN(i)&&(i=s?0:e.length-1),i<0&&(i=e.length+i),i>=e.length){if(s)return-1;i=e.length-1}else if(i<0){if(!s)return-1;i=0}if("string"==typeof t&&(t=o.from(t,r)),o.isBuffer(t))return 0===t.length?-1:E(e,t,i,r,s);if("number"==typeof t)return t&=255,o.TYPED_ARRAY_SUPPORT&&"function"==typeof Uint8Array.prototype.indexOf?s?Uint8Array.prototype.indexOf.call(e,t,i):Uint8Array.prototype.lastIndexOf.call(e,t,i):E(e,[t],i,r,s);throw new TypeError("val must be string, number or Buffer")}function E(e,t,i,r,s){function o(e,t){return 1===n?e[t]:e.readUInt16BE(t*n)}var n=1,a=e.length,u=t.length;if(void 0!==r&&("ucs2"===(r=String(r).toLowerCase())||"ucs-2"===r||"utf16le"===r||"utf-16le"===r)){if(e.length<2||t.length<2)return-1;n=2,a/=2,u/=2,i/=2}var c;if(s){var l=-1;for(c=i;c<a;c++)if(o(e,c)===o(t,-1===l?0:c-l)){if(-1===l&&(l=c),c-l+1===u)return l*n}else-1!==l&&(c-=c-l),l=-1}else for(i+u>a&&(i=a-u),c=i;c>=0;c--){for(var h=!0,d=0;d<u;d++)if(o(e,c+d)!==o(t,d)){h=!1;break}if(h)return c}return-1}function S(e,t,i,r){i=Number(i)||0;var s=e.length-i;r?(r=Number(r))>s&&(r=s):r=s;var o=t.length;if(o%2!=0)throw new TypeError("Invalid hex string");r>o/2&&(r=o/2);for(var n=0;n<r;++n){var a=parseInt(t.substr(2*n,2),16);if(isNaN(a))return n;e[i+n]=a}return n}function R(e,t,i,r){return X(q(t,e.length-i),e,i,r)}function T(e,t,i,r){return X(Y(t),e,i,r)}function C(e,t,i,r){return T(e,t,i,r)}function b(e,t,i,r){return X(K(t),e,i,r)}function P(e,t,i,r){return X(W(t,e.length-i),e,i,r)}function O(e,t,i){return 0===t&&i===e.length?Q.fromByteArray(e):Q.fromByteArray(e.slice(t,i))}function A(e,t,i){i=Math.min(e.length,i);for(var r=[],s=t;s<i;){var o=e[s],n=null,a=o>239?4:o>223?3:o>191?2:1;if(s+a<=i){var u,c,l,h;switch(a){case 1:o<128&&(n=o);break;case 2:u=e[s+1],128==(192&u)&&(h=(31&o)<<6|63&u)>127&&(n=h);break;case 3:u=e[s+1],c=e[s+2],128==(192&u)&&128==(192&c)&&(h=(15&o)<<12|(63&u)<<6|63&c)>2047&&(h<55296||h>57343)&&(n=h);break;case 4:u=e[s+1],c=e[s+2],l=e[s+3],128==(192&u)&&128==(192&c)&&128==(192&l)&&(h=(15&o)<<18|(63&u)<<12|(63&c)<<6|63&l)>65535&&h<1114112&&(n=h)}}null===n?(n=65533,a=1):n>65535&&(n-=65536,r.push(n>>>10&1023|55296),n=56320|1023&n),r.push(n),s+=a}return k(r)}function k(e){var t=e.length;if(t<=$)return String.fromCharCode.apply(String,e);for(var i="",r=0;r<t;)i+=String.fromCharCode.apply(String,e.slice(r,r+=$));return i}function I(e,t,i){var r="";i=Math.min(e.length,i);for(var s=t;s<i;++s)r+=String.fromCharCode(127&e[s]);return r}function w(e,t,i){var r="";i=Math.min(e.length,i);for(var s=t;s<i;++s)r+=String.fromCharCode(e[s]);return r}function M(e,t,i){var r=e.length;(!t||t<0)&&(t=0),(!i||i<0||i>r)&&(i=r);for(var s="",o=t;o<i;++o)s+=F(e[o]);return s}function L(e,t,i){for(var r=e.slice(t,i),s="",o=0;o<r.length;o+=2)s+=String.fromCharCode(r[o]+256*r[o+1]);return s}function N(e,t,i){if(e%1!=0||e<0)throw new RangeError("offset is not uint");if(e+t>i)throw new RangeError("Trying to access beyond buffer length")}function D(e,t,i,r,s,n){if(!o.isBuffer(e))throw new TypeError('"buffer" argument must be a Buffer instance');if(t>s||t<n)throw new RangeError('"value" argument is out of bounds');if(i+r>e.length)throw new RangeError("Index out of range")}function x(e,t,i,r){t<0&&(t=65535+t+1);for(var s=0,o=Math.min(e.length-i,2);s<o;++s)e[i+s]=(t&255<<8*(r?s:1-s))>>>8*(r?s:1-s)}function U(e,t,i,r){t<0&&(t=4294967295+t+1);for(var s=0,o=Math.min(e.length-i,4);s<o;++s)e[i+s]=t>>>8*(r?s:3-s)&255}function V(e,t,i,r,s,o){if(i+r>e.length)throw new RangeError("Index out of range");if(i<0)throw new RangeError("Index out of range")}function G(e,t,i,r,s){return s||V(e,t,i,4,3.4028234663852886e38,-3.4028234663852886e38),z.write(e,t,i,r,23,4),i+4}function H(e,t,i,r,s){return s||V(e,t,i,8,1.7976931348623157e308,-1.7976931348623157e308),z.write(e,t,i,r,52,8),i+8}function B(e){if(e=j(e).replace(ee,""),e.length<2)return"";for(;e.length%4!=0;)e+="=";return e}function j(e){return e.trim?e.trim():e.replace(/^\s+|\s+$/g,"")}function F(e){return e<16?"0"+e.toString(16):e.toString(16)}function q(e,t){t=t||1/0;for(var i,r=e.length,s=null,o=[],n=0;n<r;++n){if((i=e.charCodeAt(n))>55295&&i<57344){if(!s){if(i>56319){(t-=3)>-1&&o.push(239,191,189);continue}if(n+1===r){(t-=3)>-1&&o.push(239,191,189);continue}s=i;continue}if(i<56320){(t-=3)>-1&&o.push(239,191,189),s=i;continue}i=65536+(s-55296<<10|i-56320)}else s&&(t-=3)>-1&&o.push(239,191,189);if(s=null,i<128){if((t-=1)<0)break;o.push(i)}else if(i<2048){if((t-=2)<0)break;o.push(i>>6|192,63&i|128)}else if(i<65536){if((t-=3)<0)break;o.push(i>>12|224,i>>6&63|128,63&i|128)}else{if(!(i<1114112))throw new Error("Invalid code point");if((t-=4)<0)break;o.push(i>>18|240,i>>12&63|128,i>>6&63|128,63&i|128)}}return o}function Y(e){for(var t=[],i=0;i<e.length;++i)t.push(255&e.charCodeAt(i));return t}function W(e,t){for(var i,r,s,o=[],n=0;n<e.length&&!((t-=2)<0);++n)i=e.charCodeAt(n),r=i>>8,s=i%256,o.push(s),o.push(r);return o}function K(e){return Q.toByteArray(B(e))}function X(e,t,i,r){for(var s=0;s<r&&!(s+i>=t.length||s>=e.length);++s)t[s+i]=e[s];return s}function J(e){return e!==e}var Q=i(44),z=i(47),Z=i(49);t.Buffer=o,t.SlowBuffer=v,t.INSPECT_MAX_BYTES=50,o.TYPED_ARRAY_SUPPORT=void 0!==e.TYPED_ARRAY_SUPPORT?e.TYPED_ARRAY_SUPPORT:function(){try{var e=new Uint8Array(1);return e.__proto__={__proto__:Uint8Array.prototype,foo:function(){return 42}},42===e.foo()&&"function"==typeof e.subarray&&0===e.subarray(1,1).byteLength}catch(e){return!1}}(),t.kMaxLength=r(),o.poolSize=8192,o._augment=function(e){return e.__proto__=o.prototype,e},o.from=function(e,t,i){return n(null,e,t,i)},o.TYPED_ARRAY_SUPPORT&&(o.prototype.__proto__=Uint8Array.prototype,o.__proto__=Uint8Array,"undefined"!=typeof Symbol&&Symbol.species&&o[Symbol.species]===o&&Object.defineProperty(o,Symbol.species,{value:null,configurable:!0})),o.alloc=function(e,t,i){return u(null,e,t,i)},o.allocUnsafe=function(e){return c(null,e)},o.allocUnsafeSlow=function(e){return c(null,e)},o.isBuffer=function(e){return!(null==e||!e._isBuffer)},o.compare=function(e,t){if(!o.isBuffer(e)||!o.isBuffer(t))throw new TypeError("Arguments must be Buffers");if(e===t)return 0;for(var i=e.length,r=t.length,s=0,n=Math.min(i,r);s<n;++s)if(e[s]!==t[s]){i=e[s],r=t[s];break}return i<r?-1:r<i?1:0},o.isEncoding=function(e){switch(String(e).toLowerCase()){case"hex":case"utf8":case"utf-8":case"ascii":case"latin1":case"binary":case"base64":case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":return!0;default:return!1}},o.concat=function(e,t){if(!Z(e))throw new TypeError('"list" argument must be an Array of Buffers');if(0===e.length)return o.alloc(0);var i;if(void 0===t)for(t=0,i=0;i<e.length;++i)t+=e[i].length;var r=o.allocUnsafe(t),s=0;for(i=0;i<e.length;++i){var n=e[i];if(!o.isBuffer(n))throw new TypeError('"list" argument must be an Array of Buffers');n.copy(r,s),s+=n.length}return r},o.byteLength=p,o.prototype._isBuffer=!0,o.prototype.swap16=function(){var e=this.length;if(e%2!=0)throw new RangeError("Buffer size must be a multiple of 16-bits");for(var t=0;t<e;t+=2)g(this,t,t+1);return this},o.prototype.swap32=function(){var e=this.length;if(e%4!=0)throw new RangeError("Buffer size must be a multiple of 32-bits");for(var t=0;t<e;t+=4)g(this,t,t+3),g(this,t+1,t+2);return this},o.prototype.swap64=function(){var e=this.length;if(e%8!=0)throw new RangeError("Buffer size must be a multiple of 64-bits");for(var t=0;t<e;t+=8)g(this,t,t+7),g(this,t+1,t+6),g(this,t+2,t+5),g(this,t+3,t+4);return this},o.prototype.toString=function(){var e=0|this.length;return 0===e?"":0===arguments.length?A(this,0,e):m.apply(this,arguments)},o.prototype.equals=function(e){if(!o.isBuffer(e))throw new TypeError("Argument must be a Buffer");return this===e||0===o.compare(this,e)},o.prototype.inspect=function(){var e="",i=t.INSPECT_MAX_BYTES;return this.length>0&&(e=this.toString("hex",0,i).match(/.{2}/g).join(" "),this.length>i&&(e+=" ... ")),"<Buffer "+e+">"},o.prototype.compare=function(e,t,i,r,s){if(!o.isBuffer(e))throw new TypeError("Argument must be a Buffer");if(void 0===t&&(t=0),void 0===i&&(i=e?e.length:0),void 0===r&&(r=0),void 0===s&&(s=this.length),t<0||i>e.length||r<0||s>this.length)throw new RangeError("out of range index");if(r>=s&&t>=i)return 0;if(r>=s)return-1;if(t>=i)return 1;if(t>>>=0,i>>>=0,r>>>=0,s>>>=0,this===e)return 0;for(var n=s-r,a=i-t,u=Math.min(n,a),c=this.slice(r,s),l=e.slice(t,i),h=0;h<u;++h)if(c[h]!==l[h]){n=c[h],a=l[h];break}return n<a?-1:a<n?1:0},o.prototype.includes=function(e,t,i){return-1!==this.indexOf(e,t,i)},o.prototype.indexOf=function(e,t,i){return y(this,e,t,i,!0)},o.prototype.lastIndexOf=function(e,t,i){return y(this,e,t,i,!1)},o.prototype.write=function(e,t,i,r){if(void 0===t)r="utf8",i=this.length,t=0;else if(void 0===i&&"string"==typeof t)r=t,i=this.length,t=0;else{if(!isFinite(t))throw new Error("Buffer.write(string, encoding, offset[, length]) is no longer supported");t|=0,isFinite(i)?(i|=0,void 0===r&&(r="utf8")):(r=i,i=void 0)}var s=this.length-t;if((void 0===i||i>s)&&(i=s),e.length>0&&(i<0||t<0)||t>this.length)throw new RangeError("Attempt to write outside buffer bounds");r||(r="utf8");for(var o=!1;;)switch(r){case"hex":return S(this,e,t,i);case"utf8":case"utf-8":return R(this,e,t,i);case"ascii":return T(this,e,t,i);case"latin1":case"binary":return C(this,e,t,i);case"base64":return b(this,e,t,i);case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":return P(this,e,t,i);default:if(o)throw new TypeError("Unknown encoding: "+r);r=(""+r).toLowerCase(),o=!0}},o.prototype.toJSON=function(){return{type:"Buffer",data:Array.prototype.slice.call(this._arr||this,0)}};var $=4096;o.prototype.slice=function(e,t){var i=this.length;e=~~e,t=void 0===t?i:~~t,e<0?(e+=i)<0&&(e=0):e>i&&(e=i),t<0?(t+=i)<0&&(t=0):t>i&&(t=i),t<e&&(t=e);var r;if(o.TYPED_ARRAY_SUPPORT)r=this.subarray(e,t),r.__proto__=o.prototype;else{var s=t-e;r=new o(s,void 0);for(var n=0;n<s;++n)r[n]=this[n+e]}return r},o.prototype.readUIntLE=function(e,t,i){e|=0,t|=0,i||N(e,t,this.length);for(var r=this[e],s=1,o=0;++o<t&&(s*=256);)r+=this[e+o]*s;return r},o.prototype.readUIntBE=function(e,t,i){e|=0,t|=0,i||N(e,t,this.length);for(var r=this[e+--t],s=1;t>0&&(s*=256);)r+=this[e+--t]*s;return r},o.prototype.readUInt8=function(e,t){return t||N(e,1,this.length),this[e]},o.prototype.readUInt16LE=function(e,t){return t||N(e,2,this.length),this[e]|this[e+1]<<8},o.prototype.readUInt16BE=function(e,t){return t||N(e,2,this.length),this[e]<<8|this[e+1]},o.prototype.readUInt32LE=function(e,t){return t||N(e,4,this.length),(this[e]|this[e+1]<<8|this[e+2]<<16)+16777216*this[e+3]},o.prototype.readUInt32BE=function(e,t){return t||N(e,4,this.length),16777216*this[e]+(this[e+1]<<16|this[e+2]<<8|this[e+3])},o.prototype.readIntLE=function(e,t,i){e|=0,t|=0,i||N(e,t,this.length);for(var r=this[e],s=1,o=0;++o<t&&(s*=256);)r+=this[e+o]*s;return s*=128,r>=s&&(r-=Math.pow(2,8*t)),r},o.prototype.readIntBE=function(e,t,i){e|=0,t|=0,i||N(e,t,this.length);for(var r=t,s=1,o=this[e+--r];r>0&&(s*=256);)o+=this[e+--r]*s;return s*=128,o>=s&&(o-=Math.pow(2,8*t)),o},o.prototype.readInt8=function(e,t){return t||N(e,1,this.length),128&this[e]?-1*(255-this[e]+1):this[e]},o.prototype.readInt16LE=function(e,t){t||N(e,2,this.length);var i=this[e]|this[e+1]<<8;return 32768&i?4294901760|i:i},o.prototype.readInt16BE=function(e,t){t||N(e,2,this.length);var i=this[e+1]|this[e]<<8;return 32768&i?4294901760|i:i},o.prototype.readInt32LE=function(e,t){return t||N(e,4,this.length),this[e]|this[e+1]<<8|this[e+2]<<16|this[e+3]<<24},o.prototype.readInt32BE=function(e,t){return t||N(e,4,this.length),this[e]<<24|this[e+1]<<16|this[e+2]<<8|this[e+3]},o.prototype.readFloatLE=function(e,t){return t||N(e,4,this.length),z.read(this,e,!0,23,4)},o.prototype.readFloatBE=function(e,t){return t||N(e,4,this.length),z.read(this,e,!1,23,4)},o.prototype.readDoubleLE=function(e,t){return t||N(e,8,this.length),z.read(this,e,!0,52,8)},o.prototype.readDoubleBE=function(e,t){return t||N(e,8,this.length),z.read(this,e,!1,52,8)},o.prototype.writeUIntLE=function(e,t,i,r){if(e=+e,t|=0,i|=0,!r){D(this,e,t,i,Math.pow(2,8*i)-1,0)}var s=1,o=0;for(this[t]=255&e;++o<i&&(s*=256);)this[t+o]=e/s&255;return t+i},o.prototype.writeUIntBE=function(e,t,i,r){if(e=+e,t|=0,i|=0,!r){D(this,e,t,i,Math.pow(2,8*i)-1,0)}var s=i-1,o=1;for(this[t+s]=255&e;--s>=0&&(o*=256);)this[t+s]=e/o&255;return t+i},o.prototype.writeUInt8=function(e,t,i){return e=+e,t|=0,i||D(this,e,t,1,255,0),o.TYPED_ARRAY_SUPPORT||(e=Math.floor(e)),this[t]=255&e,t+1},o.prototype.writeUInt16LE=function(e,t,i){return e=+e,t|=0,i||D(this,e,t,2,65535,0),o.TYPED_ARRAY_SUPPORT?(this[t]=255&e,this[t+1]=e>>>8):x(this,e,t,!0),t+2},o.prototype.writeUInt16BE=function(e,t,i){return e=+e,t|=0,i||D(this,e,t,2,65535,0),o.TYPED_ARRAY_SUPPORT?(this[t]=e>>>8,this[t+1]=255&e):x(this,e,t,!1),t+2},o.prototype.writeUInt32LE=function(e,t,i){return e=+e,t|=0,i||D(this,e,t,4,4294967295,0),o.TYPED_ARRAY_SUPPORT?(this[t+3]=e>>>24,this[t+2]=e>>>16,this[t+1]=e>>>8,this[t]=255&e):U(this,e,t,!0),t+4},o.prototype.writeUInt32BE=function(e,t,i){return e=+e,t|=0,i||D(this,e,t,4,4294967295,0),o.TYPED_ARRAY_SUPPORT?(this[t]=e>>>24,this[t+1]=e>>>16,this[t+2]=e>>>8,this[t+3]=255&e):U(this,e,t,!1),t+4},o.prototype.writeIntLE=function(e,t,i,r){if(e=+e,t|=0,!r){var s=Math.pow(2,8*i-1);D(this,e,t,i,s-1,-s)}var o=0,n=1,a=0;for(this[t]=255&e;++o<i&&(n*=256);)e<0&&0===a&&0!==this[t+o-1]&&(a=1),this[t+o]=(e/n>>0)-a&255;return t+i},o.prototype.writeIntBE=function(e,t,i,r){if(e=+e,t|=0,!r){var s=Math.pow(2,8*i-1);D(this,e,t,i,s-1,-s)}var o=i-1,n=1,a=0;for(this[t+o]=255&e;--o>=0&&(n*=256);)e<0&&0===a&&0!==this[t+o+1]&&(a=1),this[t+o]=(e/n>>0)-a&255;return t+i},o.prototype.writeInt8=function(e,t,i){return e=+e,t|=0,i||D(this,e,t,1,127,-128),o.TYPED_ARRAY_SUPPORT||(e=Math.floor(e)),e<0&&(e=255+e+1),this[t]=255&e,t+1},o.prototype.writeInt16LE=function(e,t,i){return e=+e,t|=0,i||D(this,e,t,2,32767,-32768),o.TYPED_ARRAY_SUPPORT?(this[t]=255&e,this[t+1]=e>>>8):x(this,e,t,!0),t+2},o.prototype.writeInt16BE=function(e,t,i){return e=+e,t|=0,i||D(this,e,t,2,32767,-32768),o.TYPED_ARRAY_SUPPORT?(this[t]=e>>>8,this[t+1]=255&e):x(this,e,t,!1),t+2},o.prototype.writeInt32LE=function(e,t,i){return e=+e,t|=0,i||D(this,e,t,4,2147483647,-2147483648),o.TYPED_ARRAY_SUPPORT?(this[t]=255&e,this[t+1]=e>>>8,this[t+2]=e>>>16,this[t+3]=e>>>24):U(this,e,t,!0),t+4},o.prototype.writeInt32BE=function(e,t,i){return e=+e,t|=0,i||D(this,e,t,4,2147483647,-2147483648),e<0&&(e=4294967295+e+1),o.TYPED_ARRAY_SUPPORT?(this[t]=e>>>24,this[t+1]=e>>>16,this[t+2]=e>>>8,this[t+3]=255&e):U(this,e,t,!1),t+4},o.prototype.writeFloatLE=function(e,t,i){return G(this,e,t,!0,i)},o.prototype.writeFloatBE=function(e,t,i){return G(this,e,t,!1,i)},o.prototype.writeDoubleLE=function(e,t,i){return H(this,e,t,!0,i)},o.prototype.writeDoubleBE=function(e,t,i){return H(this,e,t,!1,i)},o.prototype.copy=function(e,t,i,r){if(i||(i=0),r||0===r||(r=this.length),t>=e.length&&(t=e.length),t||(t=0),r>0&&r<i&&(r=i),r===i)return 0;if(0===e.length||0===this.length)return 0;if(t<0)throw new RangeError("targetStart out of bounds");if(i<0||i>=this.length)throw new RangeError("sourceStart out of bounds");if(r<0)throw new RangeError("sourceEnd out of bounds");r>this.length&&(r=this.length),e.length-t<r-i&&(r=e.length-t+i);var s,n=r-i;if(this===e&&i<t&&t<r)for(s=n-1;s>=0;--s)e[s+t]=this[s+i];else if(n<1e3||!o.TYPED_ARRAY_SUPPORT)for(s=0;s<n;++s)e[s+t]=this[s+i];else Uint8Array.prototype.set.call(e,this.subarray(i,i+n),t);return n},o.prototype.fill=function(e,t,i,r){if("string"==typeof e){if("string"==typeof t?(r=t,t=0,i=this.length):"string"==typeof i&&(r=i,i=this.length),1===e.length){var s=e.charCodeAt(0);s<256&&(e=s)}if(void 0!==r&&"string"!=typeof r)throw new TypeError("encoding must be a string");if("string"==typeof r&&!o.isEncoding(r))throw new TypeError("Unknown encoding: "+r)}else"number"==typeof e&&(e&=255);if(t<0||this.length<t||this.length<i)throw new RangeError("Out of range index");if(i<=t)return this;t>>>=0,i=void 0===i?this.length:i>>>0,e||(e=0);var n;if("number"==typeof e)for(n=t;n<i;++n)this[n]=e;else{var a=o.isBuffer(e)?e:q(new o(e,r).toString()),u=a.length;for(n=0;n<i-t;++n)this[n+t]=a[n%u]}return this};var ee=/[^+\/0-9A-Za-z-_]/g}).call(t,i(53))},function(e,t,i){"use strict";t.read=function(e,t,i,r,s){var o,n,a=8*s-r-1,u=(1<<a)-1,c=u>>1,l=-7,h=i?s-1:0,d=i?-1:1,f=e[t+h];for(h+=d,o=f&(1<<-l)-1,f>>=-l,l+=a;l>0;o=256*o+e[t+h],h+=d,l-=8);for(n=o&(1<<-l)-1,o>>=-l,l+=r;l>0;n=256*n+e[t+h],h+=d,l-=8);if(0===o)o=1-c;else{if(o===u)return n?NaN:1/0*(f?-1:1);n+=Math.pow(2,r),o-=c}return(f?-1:1)*n*Math.pow(2,o-r)},t.write=function(e,t,i,r,s,o){var n,a,u,c=8*o-s-1,l=(1<<c)-1,h=l>>1,d=23===s?Math.pow(2,-24)-Math.pow(2,-77):0,f=r?0:o-1,_=r?1:-1,v=t<0||0===t&&1/t<0?1:0;for(t=Math.abs(t),isNaN(t)||t===1/0?(a=isNaN(t)?1:0,n=l):(n=Math.floor(Math.log(t)/Math.LN2),t*(u=Math.pow(2,-n))<1&&(n--,u*=2),t+=n+h>=1?d/u:d*Math.pow(2,1-h),t*u>=2&&(n++,u/=2),n+h>=l?(a=0,n=l):n+h>=1?(a=(t*u-1)*Math.pow(2,s),n+=h):(a=t*Math.pow(2,h-1)*Math.pow(2,s),n=0));s>=8;e[i+f]=255&a,f+=_,a/=256,s-=8);for(n=n<<s|a,c+=s;c>0;e[i+f]=255&n,f+=_,n/=256,c-=8);e[i+f-_]|=128*v}},function(e,t,i){"use strict";function r(e){return!!e.constructor&&"function"==typeof e.constructor.isBuffer&&e.constructor.isBuffer(e)}function s(e){return"function"==typeof e.readFloatLE&&"function"==typeof e.slice&&r(e.slice(0,0))}e.exports=function(e){return null!=e&&(r(e)||s(e)||!!e._isBuffer)}},function(e,t,i){"use strict";var r={}.toString;e.exports=Array.isArray||function(e){return"[object Array]"==r.call(e)}},function(e,t,i){"use strict";!function(){var t=i(25),r=i(14).utf8,s=i(48),o=i(14).bin,n=function e(i,n){i.constructor==String?i=n&&"binary"===n.encoding?o.stringToBytes(i):r.stringToBytes(i):s(i)?i=Array.prototype.slice.call(i,0):Array.isArray(i)||(i=i.toString());for(var a=t.bytesToWords(i),u=8*i.length,c=1732584193,l=-271733879,h=-1732584194,d=271733878,f=0;f<a.length;f++)a[f]=16711935&(a[f]<<8|a[f]>>>24)|4278255360&(a[f]<<24|a[f]>>>8);a[u>>>5]|=128<<u%32,a[14+(u+64>>>9<<4)]=u;for(var _=e._ff,v=e._gg,p=e._hh,m=e._ii,f=0;f<a.length;f+=16){var g=c,y=l,E=h,S=d;c=_(c,l,h,d,a[f+0],7,-680876936),d=_(d,c,l,h,a[f+1],12,-389564586),h=_(h,d,c,l,a[f+2],17,606105819),l=_(l,h,d,c,a[f+3],22,-1044525330),c=_(c,l,h,d,a[f+4],7,-176418897),d=_(d,c,l,h,a[f+5],12,1200080426),h=_(h,d,c,l,a[f+6],17,-1473231341),l=_(l,h,d,c,a[f+7],22,-45705983),c=_(c,l,h,d,a[f+8],7,1770035416),d=_(d,c,l,h,a[f+9],12,-1958414417),h=_(h,d,c,l,a[f+10],17,-42063),l=_(l,h,d,c,a[f+11],22,-1990404162),c=_(c,l,h,d,a[f+12],7,1804603682),d=_(d,c,l,h,a[f+13],12,-40341101),h=_(h,d,c,l,a[f+14],17,-1502002290),l=_(l,h,d,c,a[f+15],22,1236535329),c=v(c,l,h,d,a[f+1],5,-165796510),d=v(d,c,l,h,a[f+6],9,-1069501632),h=v(h,d,c,l,a[f+11],14,643717713),l=v(l,h,d,c,a[f+0],20,-373897302),c=v(c,l,h,d,a[f+5],5,-701558691),d=v(d,c,l,h,a[f+10],9,38016083),h=v(h,d,c,l,a[f+15],14,-660478335),l=v(l,h,d,c,a[f+4],20,-405537848),c=v(c,l,h,d,a[f+9],5,568446438),d=v(d,c,l,h,a[f+14],9,-1019803690),h=v(h,d,c,l,a[f+3],14,-187363961),l=v(l,h,d,c,a[f+8],20,1163531501),c=v(c,l,h,d,a[f+13],5,-1444681467),d=v(d,c,l,h,a[f+2],9,-51403784),h=v(h,d,c,l,a[f+7],14,1735328473),l=v(l,h,d,c,a[f+12],20,-1926607734),c=p(c,l,h,d,a[f+5],4,-378558),d=p(d,c,l,h,a[f+8],11,-2022574463),h=p(h,d,c,l,a[f+11],16,1839030562),l=p(l,h,d,c,a[f+14],23,-35309556),c=p(c,l,h,d,a[f+1],4,-1530992060),d=p(d,c,l,h,a[f+4],11,1272893353),h=p(h,d,c,l,a[f+7],16,-155497632),l=p(l,h,d,c,a[f+10],23,-1094730640),c=p(c,l,h,d,a[f+13],4,681279174),d=p(d,c,l,h,a[f+0],11,-358537222),h=p(h,d,c,l,a[f+3],16,-722521979),l=p(l,h,d,c,a[f+6],23,76029189),c=p(c,l,h,d,a[f+9],4,-640364487),d=p(d,c,l,h,a[f+12],11,-421815835),h=p(h,d,c,l,a[f+15],16,530742520),l=p(l,h,d,c,a[f+2],23,-995338651),c=m(c,l,h,d,a[f+0],6,-198630844),d=m(d,c,l,h,a[f+7],10,1126891415),h=m(h,d,c,l,a[f+14],15,-1416354905),l=m(l,h,d,c,a[f+5],21,-57434055),c=m(c,l,h,d,a[f+12],6,1700485571),d=m(d,c,l,h,a[f+3],10,-1894986606),h=m(h,d,c,l,a[f+10],15,-1051523),l=m(l,h,d,c,a[f+1],21,-2054922799),c=m(c,l,h,d,a[f+8],6,1873313359),d=m(d,c,l,h,a[f+15],10,-30611744),h=m(h,d,c,l,a[f+6],15,-1560198380),l=m(l,h,d,c,a[f+13],21,1309151649),c=m(c,l,h,d,a[f+4],6,-145523070),d=m(d,c,l,h,a[f+11],10,-1120210379),h=m(h,d,c,l,a[f+2],15,718787259),l=m(l,h,d,c,a[f+9],21,-343485551),c=c+g>>>0,l=l+y>>>0,h=h+E>>>0,d=d+S>>>0}return t.endian([c,l,h,d])};n._ff=function(e,t,i,r,s,o,n){var a=e+(t&i|~t&r)+(s>>>0)+n;return(a<<o|a>>>32-o)+t},n._gg=function(e,t,i,r,s,o,n){var a=e+(t&r|i&~r)+(s>>>0)+n;return(a<<o|a>>>32-o)+t},n._hh=function(e,t,i,r,s,o,n){var a=e+(t^i^r)+(s>>>0)+n;return(a<<o|a>>>32-o)+t},n._ii=function(e,t,i,r,s,o,n){var a=e+(i^(t|~r))+(s>>>0)+n;return(a<<o|a>>>32-o)+t},n._blocksize=16,n._digestsize=16,e.exports=function(e,i){if(void 0===e||null===e)throw new Error("Illegal argument "+e);var r=t.wordsToBytes(n(e,i));return i&&i.asBytes?r:i&&i.asString?o.bytesToString(r):t.bytesToHex(r)}}()},function(e,t,i){"use strict";function r(){this._events=this._events||{},this._maxListeners=this._maxListeners||void 0}function s(e){return"function"==typeof e}function o(e){return"number"==typeof e}function n(e){return"object"===(void 0===e?"undefined":u(e))&&null!==e}function a(e){return void 0===e}var u="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e};e.exports=r,r.EventEmitter=r,r.prototype._events=void 0,r.prototype._maxListeners=void 0,r.defaultMaxListeners=10,r.prototype.setMaxListeners=function(e){if(!o(e)||e<0||isNaN(e))throw TypeError("n must be a positive number");return this._maxListeners=e,this},r.prototype.emit=function(e){var t,i,r,o,u,c;if(this._events||(this._events={}),"error"===e&&(!this._events.error||n(this._events.error)&&!this._events.error.length)){if((t=arguments[1])instanceof Error)throw t;var l=new Error('Uncaught, unspecified "error" event. ('+t+")");throw l.context=t,l}if(i=this._events[e],a(i))return!1;if(s(i))switch(arguments.length){case 1:i.call(this);break;case 2:i.call(this,arguments[1]);break;case 3:i.call(this,arguments[1],arguments[2]);break;default:o=Array.prototype.slice.call(arguments,1),i.apply(this,o)}else if(n(i))for(o=Array.prototype.slice.call(arguments,1),c=i.slice(),r=c.length,u=0;u<r;u++)c[u].apply(this,o);return!0},r.prototype.addListener=function(e,t){var i;if(!s(t))throw TypeError("listener must be a function");return this._events||(this._events={}),this._events.newListener&&this.emit("newListener",e,s(t.listener)?t.listener:t),this._events[e]?n(this._events[e])?this._events[e].push(t):this._events[e]=[this._events[e],t]:this._events[e]=t,n(this._events[e])&&!this._events[e].warned&&(i=a(this._maxListeners)?r.defaultMaxListeners:this._maxListeners)&&i>0&&this._events[e].length>i&&(this._events[e].warned=!0,console.error("(node) warning: possible EventEmitter memory leak detected. %d listeners added. Use emitter.setMaxListeners() to increase limit.",this._events[e].length),"function"==typeof console.trace&&console.trace()),this},r.prototype.on=r.prototype.addListener,r.prototype.once=function(e,t){function i(){this.removeListener(e,i),r||(r=!0,t.apply(this,arguments))}if(!s(t))throw TypeError("listener must be a function");var r=!1;return i.listener=t,this.on(e,i),this},r.prototype.removeListener=function(e,t){var i,r,o,a;if(!s(t))throw TypeError("listener must be a function");if(!this._events||!this._events[e])return this;if(i=this._events[e],o=i.length,r=-1,i===t||s(i.listener)&&i.listener===t)delete this._events[e],this._events.removeListener&&this.emit("removeListener",e,t);else if(n(i)){for(a=o;a-- >0;)if(i[a]===t||i[a].listener&&i[a].listener===t){r=a;break}if(r<0)return this;1===i.length?(i.length=0,delete this._events[e]):i.splice(r,1),this._events.removeListener&&this.emit("removeListener",e,t)}return this},r.prototype.removeAllListeners=function(e){var t,i;if(!this._events)return this;if(!this._events.removeListener)return 0===arguments.length?this._events={}:this._events[e]&&delete this._events[e],this;if(0===arguments.length){for(t in this._events)"removeListener"!==t&&this.removeAllListeners(t);return this.removeAllListeners("removeListener"),this._events={},this}if(i=this._events[e],s(i))this.removeListener(e,i);else if(i)for(;i.length;)this.removeListener(e,i[i.length-1]);return delete this._events[e],this},r.prototype.listeners=function(e){return this._events&&this._events[e]?s(this._events[e])?[this._events[e]]:this._events[e].slice():[]},r.prototype.listenerCount=function(e){if(this._events){var t=this._events[e];if(s(t))return 1;if(t)return t.length}return 0},r.listenerCount=function(e,t){return e.listenerCount(t)}},function(e,t,i){"use strict";(function(t){!function(){var r=i(25),s=i(14).utf8,o=i(14).bin,n=function(e){e.constructor==String?e=s.stringToBytes(e):void 0!==t&&"function"==typeof t.isBuffer&&t.isBuffer(e)?e=Array.prototype.slice.call(e,0):Array.isArray(e)||(e=e.toString());var i=r.bytesToWords(e),o=8*e.length,n=[],a=1732584193,u=-271733879,c=-1732584194,l=271733878,h=-1009589776;i[o>>5]|=128<<24-o%32,i[15+(o+64>>>9<<4)]=o;for(var d=0;d<i.length;d+=16){for(var f=a,_=u,v=c,p=l,m=h,g=0;g<80;g++){if(g<16)n[g]=i[d+g];else{var y=n[g-3]^n[g-8]^n[g-14]^n[g-16];n[g]=y<<1|y>>>31}var E=(a<<5|a>>>27)+h+(n[g]>>>0)+(g<20?1518500249+(u&c|~u&l):g<40?1859775393+(u^c^l):g<60?(u&c|u&l|c&l)-1894007588:(u^c^l)-899497514);h=l,l=c,c=u<<30|u>>>2,u=a,a=E}a+=f,u+=_,c+=v,l+=p,h+=m}return[a,u,c,l,h]},a=function(e,t){var i=r.wordsToBytes(n(e));return t&&t.asBytes?i:t&&t.asString?o.bytesToString(i):r.bytesToHex(i)};a._blocksize=16,a._digestsize=20,e.exports=a}()}).call(t,i(46).Buffer)},function(e,t,i){"use strict";var r,s="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e};r=function(){return this}();try{r=r||Function("return this")()||(0,eval)("this")}catch(e){"object"===("undefined"==typeof window?"undefined":s(window))&&(r=window)}e.exports=r},function(e,t,i){"use strict";e.exports=function(e){return e.webpackPolyfill||(e.deprecate=function(){},e.paths=[],e.children||(e.children=[]),Object.defineProperty(e,"loaded",{enumerable:!0,get:function(){return e.l}}),Object.defineProperty(e,"id",{enumerable:!0,get:function(){return e.i}}),e.webpackPolyfill=1),e}},function(e,t,i){"use strict";function r(e){function t(r){if(i[r])return i[r].exports;var s=i[r]={i:r,l:!1,exports:{}};return e[r].call(s.exports,s,s.exports,t),s.l=!0,s.exports}var i={};t.m=e,t.c=i,t.i=function(e){return e},t.d=function(e,i,r){t.o(e,i)||Object.defineProperty(e,i,{configurable:!1,enumerable:!0,get:r})},t.r=function(e){Object.defineProperty(e,"__esModule",{value:!0})},t.n=function(e){var i=e&&e.__esModule?function(){return e.default}:function(){return e};return t.d(i,"a",i),i},t.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},t.p="/",t.oe=function(e){throw console.error(e),e};var r=t(t.s=ENTRY_MODULE);return r.default||r}function s(e){return(e+"").replace(/[.?*+^$[\]\\(){}|-]/g,"\\$&")}function o(e){return!isNaN(1*e)}function n(e,t,r){var n={};n[r]=[];var a=t.toString(),u=a.match(/^function\s?\(\w+,\s*\w+,\s*(\w+)\)/);if(!u)return n;for(var h,d=u[1],f=new RegExp("(\\\\n|\\W)"+s(d)+l,"g");h=f.exec(a);)"dll-reference"!==h[3]&&n[r].push(h[3]);for(f=new RegExp("\\("+s(d)+'\\("(dll-reference\\s('+c+'))"\\)\\)'+l,"g");h=f.exec(a);)e[h[2]]||(n[r].push(h[1]),e[h[2]]=i(h[1]).m),n[h[2]]=n[h[2]]||[],n[h[2]].push(h[4]);for(var _=Object.keys(n),v=0;v<_.length;v++)for(var p=0;p<n[_[v]].length;p++)o(n[_[v]][p])&&(n[_[v]][p]=1*n[_[v]][p]);return n}function a(e){return Object.keys(e).reduce(function(t,i){return t||e[i].length>0},!1)}function u(e,t){for(var i={main:[t]},r={main:[]},s={main:{}};a(i);)for(var o=Object.keys(i),u=0;u<o.length;u++){var c=o[u],l=i[c],h=l.pop();if(s[c]=s[c]||{},!s[c][h]&&e[c][h]){s[c][h]=!0,r[c]=r[c]||[],r[c].push(h);for(var d=n(e,e[c][h],c),f=Object.keys(d),_=0;_<f.length;_++)i[f[_]]=i[f[_]]||[],i[f[_]]=i[f[_]].concat(d[f[_]])}}return r}var c="[\\.|\\-|\\+|\\w|/|@]+",l="\\((/\\*.*?\\*/)?s?.*?("+c+").*?\\)";e.exports=function(e,t){t=t||{};var s={main:i.m},o=t.all?{main:Object.keys(s.main)}:u(s,e),n="";Object.keys(o).filter(function(e){return"main"!==e}).forEach(function(e){for(var t=0;o[e][t];)t++;o[e].push(t),s[e][t]="(function(module, exports, __webpack_require__) { module.exports = __webpack_require__; })",n=n+"var "+e+" = ("+r.toString().replace("ENTRY_MODULE",JSON.stringify(t))+")({"+o[e].map(function(t){return JSON.stringify(t)+": "+s[e][t].toString()}).join(",")+"});\n"}),n=n+"new (("+r.toString().replace("ENTRY_MODULE",JSON.stringify(e))+")({"+o.main.map(function(e){return JSON.stringify(e)+": "+s.main[e].toString()}).join(",")+"}))(self);";var a=new window.Blob([n],{type:"text/javascript"});if(t.bare)return a;var c=window.URL||window.webkitURL||window.mozURL||window.msURL,l=c.createObjectURL(a),h=new window.Worker(l);return h.objectURL=l,h}},function(e,t,i){"use strict";function r(e){return e&&e.__esModule?e:{default:e}}function s(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}Object.defineProperty(t,"__esModule",{value:!0});var o=function(){function e(e,t){for(var i=0;i<t.length;i++){var r=t[i];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}return function(t,i,r){return i&&e(t.prototype,i),r&&e(t,r),t}}(),n=i(0),a=i(2),u=i(7),c=r(u),l=i(1),h=r(l),d=i(36),f=function(){function e(t){s(this,e),this._callback=t,this._url="",this._reqOptions={},this._isActive=!1,this._retryCount=0,this._retryTimer=void 0,this._CLIENT="ios",this._RETRY_CNT_LIMIT=3,this._RETRY_TIMER_TIME=2e3}return o(e,[{key:"start",value:function(){this._isActive=!0,this._url=a.HOST.PROTOCOL,""===a.Globals.ssTestHost?this._url+=a.HOST.SS_HOST+"/":this._url+=a.Globals.ssTestHost+"/",this._url+="sls/room/auth",this._reqOptions={command:n.HTTP.AUTH,host:a.Globals.host,appId:a.Globals.appId,userId:a.Globals.userId,scene:a.Globals.impScene,deviceId:a.Globals.deviceId,userRole:a.Globals.permissionIndex,token:d.SHA1.sha1(a.Globals.appId+a.Globals.userId+a.Globals.appKey),param:{sdk:a.Globals.sdkType,appid:a.Globals.appId,appkey:a.Globals.appKey,t:(new Date).getTime().toString(),v:1,version:1,type:this._CLIENT}},a.Globals.isPermission||(this._reqOptions.userRole=a.Globals.userRole),this._sendRequest()}},{key:"stop",value:function(){this._isActive=!1,this._destroyRetryTimer()}},{key:"_quit",value:function(e){return!this._isActive&&(h.default.debug("["+e+"], server stop",n.LOG.AUTH),this.stop(),!0)}},{key:"_destroyRetryTimer",value:function(){this._retryCount=0,this._retryTimer&&(window.clearTimeout(this._retryTimer),delete this._retryTimer,this._retryTimer=void 0)}},{key:"_resendRequest",value:function(){this._retryCount<this._RETRY_CNT_LIMIT?(this._retryCount++,h.default.log("retry auth after "+this._RETRY_TIMER_TIME+"ms",n.LOG.AUTH),this._retryTimer=window.setTimeout(this._sendRequest.bind(this),this._RETRY_TIMER_TIME)):(this.stop(),h.default.warn("retry auth limit",n.LOG.AUTH),this._callback&&this._callback({code:n.RSP.ERROR,message:"retry auth limit"}))}},{key:"_sendRequest",value:function(){var e=this;if(!this._quit("_sendRequest")){new Promise(function(t,i){c.default.ajax({url:e._url,type:"POST",error:i,success:t,data:e._reqOptions})}).then(function(t){if(!e._quit("authPromise done")){if(!t)return void e._resendRequest();var i={},r="",s="",o=n.RSP.ERROR;e._retryCount=0;try{i=JSON.parse(t)||{},s=String(i[n.RSP.MSG]),r=String(i[n.RSP.TOKEN]),o=parseInt(i[n.RSP.STATUS])}catch(e){o=n.RSP.ERROR,s=e.toString()}e._callback&&e._callback({code:o,message:0===o?r:s})}},function(t){e._quit("authPromise failed")||(t&&t.message&&h.default.debug("authPromise failed: "+t.message,n.LOG.AUTH),e._resendRequest())})}}}]),e}();t.default=f},function(e,t,i){"use strict";function r(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t}function s(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}function o(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}Object.defineProperty(t,"__esModule",{value:!0});var n=function(){function e(e,t){for(var i=0;i<t.length;i++){var r=t[i];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}return function(t,i,r){return i&&e(t.prototype,i),r&&e(t,r),t}}(),a=t.RuntimeException=function(){function e(t){o(this,e),this._message=t}return n(e,[{key:"toString",value:function(){return this.name+": "+this.message}},{key:"name",get:function(){return"RuntimeException"}},{key:"message",get:function(){return this._message}}]),e}();t.IllegalStateException=function(e){function t(e){return o(this,t),r(this,(t.__proto__||Object.getPrototypeOf(t)).call(this,e))}return s(t,e),n(t,[{key:"name",get:function(){return"IllegalStateException"}}]),t}(a),t.InvalidArgumentException=function(e){function t(e){return o(this,t),r(this,(t.__proto__||Object.getPrototypeOf(t)).call(this,e))}return s(t,e),n(t,[{key:"name",get:function(){return"InvalidArgumentException"}}]),t}(a),t.NotImplementedException=function(e){function t(e){return o(this,t),r(this,(t.__proto__||Object.getPrototypeOf(t)).call(this,e))}return s(t,e),n(t,[{key:"name",get:function(){return"NotImplementedException"}}]),t}(a)},function(e,t,i){"use strict";function r(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}Object.defineProperty(t,"__esModule",{value:!0});var s=function(){function e(e,t){for(var i=0;i<t.length;i++){var r=t[i];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}return function(t,i,r){return i&&e(t.prototype,i),r&&e(t,r),t}}(),o=i(57),n=function(){function e(t){r(this,e),this.TAG="ExpGolomb",this._buffer=t,this._buffer_index=0,this._total_bytes=t.byteLength,this._total_bits=8*t.byteLength,this._current_word=0,this._current_word_bits_left=0}return s(e,[{key:"destroy",value:function(){this._buffer=null}},{key:"_fillCurrentWord",value:function(){var e=this._total_bytes-this._buffer_index;if(e<=0)throw new o.IllegalStateException("ExpGolomb: _fillCurrentWord() but no bytes available");var t=Math.min(4,e),i=new Uint8Array(4);i.set(this._buffer.subarray(this._buffer_index,this._buffer_index+t)),this._current_word=new DataView(i.buffer).getUint32(0,!1),this._buffer_index+=t,this._current_word_bits_left=8*t}},{key:"readBits",value:function(e){if(e>32)throw new o.InvalidArgumentException("ExpGolomb: readBits() bits exceeded max 32bits!");if(e<=this._current_word_bits_left){var t=this._current_word>>>32-e;return this._current_word<<=e,this._current_word_bits_left-=e,t}var i=this._current_word_bits_left?this._current_word:0;i>>>=32-this._current_word_bits_left;var r=e-this._current_word_bits_left;this._fillCurrentWord();var s=Math.min(r,this._current_word_bits_left),n=this._current_word>>>32-s;return this._current_word<<=s,this._current_word_bits_left-=s,i=i<<s|n}},{key:"readBool",value:function(){return 1===this.readBits(1)}},{key:"readByte",value:function(){return this.readBits(8)}},{key:"_skipLeadingZero",value:function(){var e=void 0;for(e=0;e<this._current_word_bits_left;e++)if(0!=(this._current_word&2147483648>>>e))return this._current_word<<=e,this._current_word_bits_left-=e,e;return this._fillCurrentWord(),e+this._skipLeadingZero()}},{key:"readUEG",value:function(){var e=this._skipLeadingZero();return this.readBits(e+1)-1}},{key:"readSEG",value:function(){var e=this.readUEG();return 1&e?e+1>>>1:-1*(e>>>1)}}]),e}();t.default=n},function(e,t,i){"use strict";function r(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}Object.defineProperty(t,"__esModule",{value:!0});var s=function(){function e(e,t){for(var i=0;i<t.length;i++){var r=t[i];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}return function(t,i,r){return i&&e(t.prototype,i),r&&e(t,r),t}}(),o=i(58),n=function(e){return e&&e.__esModule?e:{default:e}}(o),a=function(){function e(){r(this,e)}return s(e,null,[{key:"_ebsp2rbsp",value:function(e){for(var t=e,i=t.byteLength,r=new Uint8Array(i),s=0,o=0;o<i;o++)o>=2&&3===t[o]&&0===t[o-1]&&0===t[o-2]||(r[s]=t[o],s++);return new Uint8Array(r.buffer,0,s)}},{key:"parseSPS",value:function(t){var i=e._ebsp2rbsp(t),r=new n.default(i);r.readByte();var s=r.readByte();r.readByte();var o=r.readByte();r.readUEG();var a=e.getProfileString(s),u=e.getLevelString(o),c=1,l=420,h=[0,420,422,444],d=8;if((100===s||110===s||122===s||244===s||44===s||83===s||86===s||118===s||128===s||138===s||144===s)&&(c=r.readUEG(),3===c&&r.readBits(1),c<=3&&(l=h[c]),d=r.readUEG()+8,r.readUEG(),r.readBits(1),r.readBool()))for(var f=3!==c?8:12,_=0;_<f;_++)r.readBool()&&(_<6?e._skipScalingList(r,16):e._skipScalingList(r,64));r.readUEG();var v=r.readUEG();if(0===v)r.readUEG();else if(1===v){r.readBits(1),r.readSEG(),r.readSEG();for(var p=r.readUEG(),m=0;m<p;m++)r.readSEG()}r.readUEG(),r.readBits(1);var g=r.readUEG(),y=r.readUEG(),E=r.readBits(1);0===E&&r.readBits(1),r.readBits(1);var S=0,R=0,T=0,C=0;r.readBool()&&(S=r.readUEG(),R=r.readUEG(),T=r.readUEG(),C=r.readUEG());var b=1,P=1,O=0,A=!0,k=0,I=0;if(r.readBool()){if(r.readBool()){var w=r.readByte(),M=[1,12,10,16,40,24,20,32,80,18,15,64,160,4,3,2],L=[1,11,11,11,33,11,11,11,33,11,11,33,99,3,2,1];w>0&&w<16?(b=M[w-1],P=L[w-1]):255===w&&(b=r.readByte()<<8|r.readByte(),P=r.readByte()<<8|r.readByte())}if(r.readBool()&&r.readBool(),r.readBool()&&(r.readBits(4),r.readBool()&&r.readBits(24)),r.readBool()&&(r.readUEG(),r.readUEG()),r.readBool()){var N=r.readBits(32),D=r.readBits(32);A=r.readBool(),k=D,I=2*N,O=k/I}}var x=1;1===b&&1===P||(x=b/P);var U=0,V=0;if(0===c)U=1,V=2-E;else{var G=3===c?1:2,H=1===c?2:1;U=G,V=H*(2-E)}var B=16*(g+1),j=16*(y+1)*(2-E);B-=(S+R)*U,j-=(T+C)*V;var F=Math.ceil(B*x);return r.destroy(),r=null,{profile_string:a,level_string:u,bit_depth:d,chroma_format:l,chroma_format_string:e.getChromaFormatString(l),frame_rate:{fixed:A,fps:O,fps_den:I,fps_num:k},sar_ratio:{width:b,height:P},codec_size:{width:B,height:j},present_size:{width:F,height:j}}}},{key:"_skipScalingList",value:function(e,t){for(var i=8,r=8,s=0,o=0;o<t;o++)0!==r&&(s=e.readSEG(),r=(i+s+256)%256),i=0===r?i:r}},{key:"getProfileString",value:function(e){switch(e){case 66:return"Baseline";case 77:return"Main";case 88:return"Extended";case 100:return"High";case 110:return"High10";case 122:return"High422";case 244:return"High444";default:return"Unknown"}}},{key:"getLevelString",value:function(e){return(e/10).toFixed(1)}},{key:"getChromaFormatString",value:function(e){switch(e){case 420:return"4:2:0";case 422:return"4:2:2";case 444:return"4:4:4";default:return"Unknown"}}}]),e}();t.default=a},function(e,t,i){"use strict";function r(e){return e&&e.__esModule?e:{default:e}}function s(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}Object.defineProperty(t,"__esModule",{value:!0});var o=function(){function e(e,t){for(var i=0;i<t.length;i++){var r=t[i];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}return function(t,i,r){return i&&e(t.prototype,i),r&&e(t,r),t}}(),n=i(0),a=i(2),u=i(1),c=r(u),l=i(15),h=r(l),d=function(){function e(t){s(this,e),this._callback=t,this._xhrLoad=void 0,this._reqOptions={},this._rspOptions={code:-1,message:""},this._isActive=!1,this._retryCount=0,this._retryTimer=void 0,this._RETRY_CNT_LIMIT=3,this._RETRY_TIMER_TIME=2e3}return o(e,[{key:"start",value:function(e){this._isActive=!0,this._parseConfig(e||{}),this._assembleRtcAreaUrl(),this._sendRequest(this._reqOptions,this._requestDone.bind(this),this._requestFailed.bind(this))}},{key:"stop",value:function(){this._isActive=!1,this._destroyCheckTimer(),this._xhrLoad&&(this._xhrLoad.stop(),this._xhrLoad=void 0)}},{key:"_quit",value:function(e){return!this._isActive&&(c.default.debug("["+e+"], service stop",n.LOG.DISPATCH),!0)}},{key:"_parseConfig",value:function(e){this._reqOptions={},this._reqOptions.host=e.host||""}},{key:"_assembleRtcAreaUrl",value:function(){var e=void 0;e=""===a.Globals.rtcTestHost?a.HOST.RTC_HOST:a.Globals.rtcTestHost,this._reqOptions.url=a.HOST.PROTOCOL+e+":"+a.HOST.RTC_PORT+"/area",this._reqOptions.url+="?nodeaddr="+this._reqOptions.host+":"+a.HOST.RTC_TRAN_PORT}},{key:"_updateResponse",value:function(e,t){this._rspOptions[n.RSP.CODE]=e,this._rspOptions[n.RSP.MESSAGE]=t}},{key:"_sendRequest",value:function(e,t,i){try{var r=e.url||"";this._xhrLoad||(this._xhrLoad=new h.default(t,i)),this._xhrLoad.start(r,{},{method:"get"})}catch(e){i&&i(e.toString())}}},{key:"_requestDone",value:function(e){if(!this._quit("_requestDone")){if(!e)return void this._retryDispatchArea();c.default.log("response: "+e,n.LOG.DISPATCH);var t=JSON.parse(e)||{};this._retryCount=0,this._destroyCheckTimer(),this._updateResponse(n.RSP.SUCCESS,t[n.RSP.AREA]||""),this._callback&&this._callback(this._rspOptions)}}},{key:"_requestFailed",value:function(e){if(!this._quit("dispatchFailed")){if(e){var t=e[n.RSP.STATUS]||-1,i=e[n.HTTP.RESPONSE_KEY_RESPONSE_TEXT]||"";c.default.warn("["+t+"]"+i,n.LOG.DISPATCH)}this._retryDispatchArea()}}},{key:"_retryDispatchArea",value:function(){if(this._retryCount<this._RETRY_CNT_LIMIT)this._retryCount++,this._destroyCheckTimer(),this._retryTimer=window.setTimeout(this._retryDispatchAreaHandler.bind(this),this._RETRY_TIMER_TIME);else{this.stop();var e="retry dispatch area limit";c.default.warn(e,n.LOG.DISPATCH),this._updateResponse(n.RSP.ERROR,e),this._callback&&this._callback(this._rspOptions)}}},{key:"_retryDispatchAreaHandler",value:function(){this._sendRequest(this._reqOptions,this._requestDone.bind(this),this._requestFailed.bind(this))}},{key:"_destroyCheckTimer",value:function(){this._retryTimer&&(window.clearTimeout(this._retryTimer),delete this._retryTimer,this._retryTimer=void 0)}}]),e}();t.default=d},function(e,t,i){"use strict";function r(e){return e&&e.__esModule?e:{default:e}}function s(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}Object.defineProperty(t,"__esModule",{value:!0});var o=function(){function e(e,t){for(var i=0;i<t.length;i++){var r=t[i];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}return function(t,i,r){return i&&e(t.prototype,i),r&&e(t,r),t}}(),n=i(0),a=i(2),u=i(1),c=r(u),l=i(36),h=i(15),d=r(h),f=function(){function e(t){s(this,e),this._callback=t,this._xhrLoad=void 0,this._reqOptions={},this._rspOptions={code:-1,message:""},this._isActive=!1,this._retryCount=0,this._retryTimer=void 0,this._SCENE=1,this._RETRY_CNT_LIMIT=3,this._RETRY_TIMER_TIME=5e3}return o(e,[{key:"start",value:function(e){this._isActive=!0,this._parseConfig(e||{}),this._assembleUrl(),this._sendPostRequest(this._reqOptions,this._dispatchDone.bind(this),this._dispatchFailed.bind(this))}},{key:"stop",value:function(){this._isActive=!1,this._destroyCheckTimer(),this._xhrLoad&&(this._xhrLoad.stop(),this._xhrLoad=void 0)}},{key:"_quit",value:function(e){return!this._isActive&&(c.default.debug("["+e+"], service stop",n.LOG.DISPATCH),this.stop(),!0)}},{key:"_parseConfig",value:function(e){this._reqOptions={};var t={command:n.HTTP.CASCADE_DISPATCH,param:{userType:1,host:a.Globals.host,room:a.Globals.appId+"_"+e.roomId}};void 0!==e.userRole&&(t.param.userType=parseInt(e.userRole)),void 0!==e.interflow&&(t.param.interflow=parseInt(e.interflow)),this._reqOptions.request=t}},{key:"_assembleUrl",value:function(){var e=void 0;e=""===a.Globals.dispatchTestRTCHost?a.HOST.DISPATCH_RTC_HOST:a.Globals.dispatchTestRTCHost,this._reqOptions.url=a.HOST.PROTOCOL+e+"/",this._reqOptions.url+=a.Globals.userId+"/",this._reqOptions.url+=a.Globals.appId+"/",this._reqOptions.url+=a.Globals.version+"/",this._reqOptions.url+=this._SCENE+"/",this._reqOptions.url+=n.HTTP.URL_CASCADE_DISPATCH+"/js?",this._reqOptions.url+="r="+(new Date).getTime().toString()+"&k="+a.Globals.token}},{key:"_updateResponse",value:function(e,t){this._rspOptions[n.RSP.CODE]=e,this._rspOptions[n.RSP.MESSAGE]=t}},{key:"_destroyCheckTimer",value:function(){this._retryTimer&&(window.clearTimeout(this._retryTimer),delete this._retryTimer,this._retryTimer=void 0)}},{key:"_dispatchDone",value:function(e){if(!this._quit("_dispatchDone")){if(!e)return void this._retryDispatch();var t=l.BLOWFISH.decrypt(e);c.default.log("response: "+t,n.LOG.DISPATCH);var i=JSON.parse(t);if(0!==parseInt(i[n.RSP.STATUS]))return void this._retryDispatch();var r=i[n.RSP.IP_LIST];if(!r||!r.length)return void this._retryDispatch();this._retryCount=0,this._destroyCheckTimer(),this._updateResponse(n.RSP.SUCCESS,r),this._callback&&this._callback(this._rspOptions)}}},{key:"_dispatchFailed",value:function(e){if(!this._quit("_dispatchFailed")){if(e){var t=e[n.RSP.STATUS]||-1,i=e[n.HTTP.RESPONSE_KEY_RESPONSE_TEXT]||"";i=l.BLOWFISH.decrypt(i),c.default.warn("["+t+"]"+i,n.LOG.DISPATCH)}this._retryDispatch()}}},{key:"_retryDispatch",value:function(){var e=this;if(this._retryCount<this._RETRY_CNT_LIMIT)this._retryCount++,this._destroyCheckTimer(),this._retryTimer=window.setTimeout(function(){e._sendPostRequest(e._reqOptions,e._dispatchDone.bind(e),e._dispatchFailed.bind(e))},this._RETRY_TIMER_TIME);else{this.stop();var t="retry dispatch limit";c.default.warn(t,n.LOG.DISPATCH),this._updateResponse(n.RSP.ERROR,t),this._callback&&this._callback(this._rspOptions)}}},{key:"_sendPostRequest",value:function(e,t,i){try{var r=e.url,s=e.request,o=JSON.stringify(s);c.default.log(o,n.LOG.DISPATCH);var a=l.BLOWFISH.encrypt(o);this._sendXHRRequest(r,a,t,i)}catch(e){i&&i(e.toString())}}},{key:"_sendXHRRequest",value:function(e,t,i,r){this._xhrLoad||(this._xhrLoad=new d.default(i,r)),this._xhrLoad.start(e,t)}}]),e}();t.default=f},function(e,t,i){"use strict";function r(e){return e&&e.__esModule?e:{default:e}}function s(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}Object.defineProperty(t,"__esModule",{value:!0});var o=function(){function e(e,t){for(var i=0;i<t.length;i++){var r=t[i];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}return function(t,i,r){return i&&e(t.prototype,i),r&&e(t,r),t}}(),n=i(0),a=i(2),u=i(7),c=r(u),l=i(1),h=r(l),d=function(){function e(t){s(this,e),this._callback=t,this._url="",this._data="",this._isActive=!1,this._SCENE=1,this._PLATFORM="web",this._PROTOCOL="mqtt_wss",this._retryCount=0,this._retryTimer=void 0,this._RETRY_CNT_LIMIT=3,this._RETRY_TIMER_TIME=2e3}return o(e,[{key:"start",value:function(e){this._isActive=!0,this._parseConfig(e||{}),this._assembleUrl(),this._sendRequest()}},{key:"stop",value:function(){this._isActive=!1,this._destroyRetryTimer()}},{key:"_quit",value:function(e){return!this._isActive&&(h.default.debug("["+e+"], server stop",n.LOG.DISPATCH),this.stop(),!0)}},{key:"_parseConfig",value:function(e){var t={command:n.HTTP.DISPATCH,token:a.Globals.token,appid:a.Globals.appId,protocol:this._PROTOCOL,sdkPlatform:this._PLATFORM,sdkVersion:a.Globals.version,timestamp:(new Date).getTime()};t.url=e.url||"",t.host=e.host||a.Globals.host,t.scene=e.scene||this._SCENE,t.userid=e.userId||a.Globals.userId,t.version=1===parseInt(e.mode)?"1.0":"2.0",this._data=JSON.stringify(t)}},{key:"_assembleUrl",value:function(){var e=void 0;e=""===a.Globals.dispatchTestSignalHost?a.HOST.DISPATCH_SIGNAL_HOST:a.Globals.dispatchTestSignalHost,this._url=a.HOST.PROTOCOL+e}},{key:"_destroyRetryTimer",value:function(){this._retryCount=0,this._retryTimer&&(window.clearTimeout(this._retryTimer),delete this._retryTimer,this._retryTimer=void 0)}},{key:"_resendRequest",value:function(){this._retryCount<this._RETRY_CNT_LIMIT?(this._retryCount++,h.default.log("retry signal dispatch after "+this._RETRY_TIMER_TIME+"ms",n.LOG.DISPATCH),this._retryTimer=window.setTimeout(this._sendRequest.bind(this),this._RETRY_TIMER_TIME)):(this.stop(),h.default.warn("retry signal dispatch limit",n.LOG.DISPATCH),this._callback&&this._callback({code:n.RSP.ERROR,message:"retry signal dispatch limit"}))}},{key:"_sendRequest",value:function(){var e=this;if(!this._quit("_sendRequest")){new Promise(function(t,i){c.default.ajax({type:"POST",url:e._url,data:e._data,error:i,success:t})}).then(function(t){if(!e._quit("signalDispatchPromise done")){if(!t)return void e._resendRequest();try{var i=t;h.default.log("response: "+i,n.LOG.DISPATCH);var r=JSON.parse(i)||{};if(0!==parseInt(r[n.RSP.STATUS]))return void e._resendRequest();var s=r[n.RSP.RESULT];if(!s)return void e._resendRequest();var o=s.ips;if(!o||!o.length)return void e._resendRequest();e._retryCount=0,e._destroyRetryTimer(),e._callback&&e._callback({code:n.RSP.SUCCESS,message:o})}catch(t){e._callback&&e._callback({code:n.RSP.ERROR,message:t.toString()})}}},function(t){e._quit("signalDispatchPromise failed")||(t&&void 0!==t.status&&h.default.warn("["+t.status+"]"+(t.message||""),n.LOG.DISPATCH),e._resendRequest())})}}}]),e}();t.default=d},function(e,t,i){"use strict";function r(e){return e&&e.__esModule?e:{default:e}}function s(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}Object.defineProperty(t,"__esModule",{value:!0});var o=function(){function e(e,t){for(var i=0;i<t.length;i++){var r=t[i];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}return function(t,i,r){return i&&e(t.prototype,i),r&&e(t,r),t}}(),n=i(0),a=i(7),u=r(a),c=i(1),l=r(c),h=function(){function e(t){s(this,e),this.OK=0,this.UNKNOW=-1,this._isStop=!0,this._callback=t}return o(e,[{key:"start",value:function(e){if(e){this._isStop=!1;var t=e.type;switch(t){case n.XHR.CREATE:case n.XHR.JOIN:case n.XHR.QUIT:case n.XHR.QUERY:case n.XHR.DESTROY:case n.XHR.ADJUST:case n.XHR.MODIFY:case n.XHR.STATUS:this._sendCommandfetch(e,t);break;default:l.default.log("unkown mix type",n.LOG.MIX)}}}},{key:"stop",value:function(){this._isStop=!0,this._callback=void 0}},{key:"_quit",value:function(e){return!!this._isStop&&(l.default.debug("["+e+"], service stop",n.LOG.MIX),!0)}},{key:"_sendCommandfetch",value:function(e,t){var i=this;u.default.ajax({type:"POST",url:e.url||"",data:e.data||"",headers:e.headers||{},success:function(e){i._quit("_sendCommandfetch")||(l.default.log(t+" command success",n.LOG.MIX),i._onSuccessHandler(t,e))},error:function(e){if(!i._quit("_sendCommandfetch")&&e){var r=i.UNKNOW;void 0!==e.status&&(r=parseInt(e.status)),l.default.log(t+" command response ["+r+", "+(e.message||"create failed")+"]",n.LOG.MIX),i._onErrorHandler(r,t)}}})}},{key:"_onSuccessHandler",value:function(e,t){if(!this._quit("_onSuccessHandler")){var i={};if(t)try{i=JSON.parse(t)}catch(e){i={}}this._callback&&this._callback({type:e,code:this.OK,message:"success",data:i})}}},{key:"_onErrorHandler",value:function(e,t){if(!this._quit("_onErrorHandler")){var i="",r=parseInt(e);i=404===r?"room not exist":409===r?"stream conflict":500===r?"nginx internal error":403===r?"authentication faied, forbidden access":590===r?"room limit by only one anchor and six viewers":400===r?"request error by error url or http headers or body":"unknow status error code",this._callback&&this._callback({type:t,code:r,message:i,data:{}})}}}]),e}();t.default=h},function(e,t,i){"use strict";function r(e){return e&&e.__esModule?e:{default:e}}function s(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function o(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t}function n(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}Object.defineProperty(t,"__esModule",{value:!0});var a=function(){function e(e,t){for(var i=0;i<t.length;i++){var r=t[i];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}return function(t,i,r){return i&&e(t.prototype,i),r&&e(t,r),t}}(),u=i(4),c=i(0),l=i(2),h=i(66),d=r(h),f=i(63),_=r(f),v=i(1),p=r(v),m=i(3),g=r(m),y=function(e){function t(){s(this,t);var e=o(this,(t.__proto__||Object.getPrototypeOf(t)).call(this));return e._config={},e._isStop=!0,e._parser=void 0,e._commandFetch=void 0,e}return n(t,e),a(t,[{key:"start",value:function(){this._isStop=!1,this._parser||(this._parser=new d.default),this._commandFetch||(this._commandFetch=new _.default(this._onCommandFetchHandler.bind(this))),this._config={},this._config.headerFiels={},this._updateTokenTicket(),this._config.headerFiels[l.HOST.RTC_HEADER_APP_ID]=l.Globals.appId,this._config.headerFiels[l.HOST.RTC_HEADER_USER_ID]=l.Globals.userId,this._config.headerFiels[l.HOST.RTC_HEADER_TRACE_ID]=l.Globals.traceId}},{key:"stop",value:function(){this._isStop=!0,this._commandFetch&&(this._commandFetch.stop(),this._commandFetch=void 0),this._parser&&(this._parser=void 0)}},{key:"createControl",value:function(e){if(e&&!this._quit("createControl")&&this._parser){var t=this._parser.createParse(e);this._commandFetch&&(this._updateTokenTicket(),this._commandFetch.start({type:c.XHR.CREATE,data:t,url:e.mixUrl||"",headers:this._config.headerFiels}))}}},{key:"modifyControl",value:function(e){if(e&&!this._quit("modifyControl")&&this._parser){var t=this._parser.modifyParse(e);this._commandFetch&&(this._updateTokenTicket(),this._commandFetch.start({type:c.XHR.MODIFY,data:t,url:e.mixUrl||"",headers:this._config.headerFiels}))}}},{key:"adjustControl",value:function(e){if(e&&!this._quit("adjustControl")&&this._parser){var t=this._parser.adjustParse(e);this._commandFetch&&(this._updateTokenTicket(),this._commandFetch.start({type:c.XHR.ADJUST,data:t,url:e.mixUrl||"",headers:this._config.headerFiels}))}}},{key:"joinControl",value:function(e){if(e&&!this._quit("joinControl")&&this._parser){var t=this._parser.joinParse(e);this._commandFetch&&(this._updateTokenTicket(),this._commandFetch.start({type:c.XHR.JOIN,data:t,url:e.mixUrl||"",headers:this._config.headerFiels}))}}},{key:"quitControl",value:function(e){if(e&&!this._quit("quitControl")&&this._parser){var t=this._parser.quitParse(e);this._commandFetch&&(this._updateTokenTicket(),this._commandFetch.start({type:c.XHR.QUIT,data:t,url:e.mixUrl||"",headers:this._config.headerFiels}))}}},{key:"statusControl",value:function(e){if(e&&!this._quit("statusControl")&&this._parser){var t=this._parser.statusParse(e);this._commandFetch&&(this._updateTokenTicket(),this._commandFetch.start({type:c.XHR.STATUS,data:t,url:e.mixUrl||"",headers:this._config.headerFiels}))}}},{key:"queryControl",value:function(e){if(e&&!this._quit("queryControl")&&this._parser){var t=this._parser.queryParse(e);this._commandFetch&&(this._updateTokenTicket(),this._commandFetch.start({type:c.XHR.QUERY,data:t,url:e.mixUrl||"",headers:this._config.headerFiels}))}}},{key:"destroyControl",value:function(e){if(e&&!this._quit("destroyControl")&&this._parser){var t=this._parser.destroyParse(e);this._commandFetch&&(this._updateTokenTicket(),this._commandFetch.start({type:c.XHR.DESTROY,data:t,url:e.mixUrl||"",headers:this._config.headerFiels}))}}},{key:"_quit",value:function(e){return!!this._isStop&&(p.default.debug("["+e+"], service stop",c.LOG.MIX),!0)}},{key:"_updateTokenTicket",value:function(){this._config.headerFiels&&(this._config.headerFiels[l.HOST.RTC_HEADER_TOKEN]=l.Globals.token,l.Globals.isPermission&&(this._config.headerFiels[l.HOST.RTC_HEADER_TICKET]=l.Globals.ticket))}},{key:"_onCommandFetchHandler",value:function(e){if(!this._quit("_onCommandFetchHandler")){var t=e[c.RSP.TYPE],i=e[c.RSP.CODE],r=e[c.RSP.DATA]||{},s=e[c.RSP.MESSAGE]||"";switch(t){case c.XHR.JOIN:case c.XHR.QUIT:case c.XHR.QUERY:case c.XHR.CREATE:case c.XHR.MODIFY:case c.XHR.STATUS:case c.XHR.DESTROY:this.trigger(u.Event.MIX_STREAM_EVENT,{type:t,code:i,message:s,data:r})}}}}]),t}(g.default);t.default=y},function(e,t,i){"use strict";function r(e){return e&&e.__esModule?e:{default:e}}function s(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function o(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t}function n(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}Object.defineProperty(t,"__esModule",{value:!0});var a=function(){function e(e,t){for(var i=0;i<t.length;i++){var r=t[i];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}return function(t,i,r){return i&&e(t.prototype,i),r&&e(t,r),t}}(),u=i(0),c=i(4),l=i(2),h=i(5),d=i(67),f=r(d),_=i(64),v=r(_),p=i(3),m=r(p),g=function(e){function t(){s(this,t);var e=o(this,(t.__proto__||Object.getPrototypeOf(t)).call(this));return e._url="",e._hosts=[],e._config={},e._active=!1,e._reportor=void 0,e._controler=void 0,e._STATUS_TIME=6e4,e._statusTimer=void 0,e}return n(t,e),a(t,[{key:"start",value:function(e){var t=this;this._hosts=[],this._active=!0,this._config=e||{},this._config.channelId&&(this._config.roomId=this._config.channelId),this._config.url&&(this._config.roomUrl=this._config.url),this._config.hosts&&this._config.hosts.length&&(this._hosts=this._config.hosts,this._config.dispatchIP=this._config.hosts[0]),this._url=this._assembleMixUrl(),this._config.mixUrl=this._url+"&nodeaddr="+(this._config.dispatchIP||"")+":"+l.HOST.RTC_TRAN_PORT,h.Report.enable&&!this._reportor&&(this._reportor=new f.default),this._controler||(this._controler=new v.default,this._controler.listenTo(c.Event.MIX_STREAM_EVENT,function(e){t._reportStatus(e),t.trigger(c.Event.MIX_STREAM_EVENT,e)}),this._controler.start())}},{key:"stop",value:function(){this._active=!1,this.stopStatusTimer(),this._controler&&(this._controler.stop(),this._controler.removeToAll(),this._controler=void 0),this._reportor&&(this._reportor=void 0)}},{key:"mixSwitchHost",value:function(){if(this._hosts&&this._hosts.length){for(var e=!1,t=0;t<this._hosts.length;t++)if(this._config.dispatchIP!==this._hosts[t]){e=!0,this._config.dispatchIP=this._hosts[t];break}e&&""!==this._url&&(this._config.mixUrl=this._url+"&nodeaddr="+(this._config.dispatchIP||"")+":"+l.HOST.RTC_TRAN_PORT)}}},{key:"mixHost",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"",t=String(e);""!==t&&"null"!==t&&"undefined"!==t&&this._config.dispatchIP!==t&&(this._config.dispatchIP=t,""!==this._url&&(this._config.mixUrl=this._url+"&nodeaddr="+(this._config.dispatchIP||"")+":"+l.HOST.RTC_TRAN_PORT))}},{key:"mixCreate",value:function(e){if(this._controler){var t=e||{};if(!t.area&&l.Globals.isRtcArea){var i=this._config.area||l.Globals.rtcArea;""!==i&&(t.area=i)}var r=this._parseParams(t);this._controler.createControl(r)}}},{key:"mixModify",value:function(e){if(this._controler){var t=this._parseParams(e);this._controler.modifyControl(t)}}},{key:"mixAdjust",value:function(e){if(this._controler){var t=this._parseParams(e);this._controler.adjustControl(t)}}},{key:"mixDestroy",value:function(e){if(this._controler){var t=this._parseParams(e);this._controler.destroyControl(t)}}},{key:"mixJoin",value:function(e){if(this._controler){var t=this._parseParams(e);this._controler.joinControl(t)}}},{key:"mixQuit",value:function(e){if(this._controler){var t=this._parseParams(e);this._controler.quitControl(t)}}},{key:"mixStatus",value:function(e){if(this._controler){var t=this._parseParams(e);this._controler.statusControl(t)}}},{key:"stopStatusTimer",value:function(){this._statusTimer&&(window.clearInterval(this._statusTimer),this._statusTimer=void 0)}},{key:"startStatusTimer",value:function(e){var t=this;this.stopStatusTimer();var i=parseInt(e);i=!isNaN(i)&&i>=10?1e3*e:this._STATUS_TIME,this._statusTimer=window.setInterval(function(){t.mixQuery({roomId:t._config.roomId||""})},i)}},{key:"mixQuery",value:function(e){if(this._controler){var t=this._parseParams(e);this._controler.queryControl(t)}}},{key:"_assembleMixUrl",value:function(){var e=void 0;e=""===l.Globals.rtcTestHost?l.HOST.RTC_HOST:l.Globals.rtcTestHost;var t=l.HOST.PROTOCOL+e+":";if(t+=l.HOST.RTC_PORT+"/mix_control?",t+="v="+l.HOST.RTC_VER,t+="&wsHost="+(this._config.host||l.Globals.host),l.Globals.isRtcArea){var i=this._config.area||l.Globals.rtcArea;""!==i&&(t+="&area="+i)}return t}},{key:"_parseParams",value:function(e){var t=e||{};return t.channelId&&(t.roomId=t.channelId),t.roomId||(t.roomId=this._config.roomId||""),t.userId||(t.userId=this._config.userId||""),t.mixUrl||(t.mixUrl=this._config.mixUrl||""),t.roomUrl||(t.roomUrl=this._config.roomUrl||""),t.host||(t.host=this._config.host||l.Globals.host),t.dispatchIP||(t.dispatchIP=this._config.dispatchIP||""),t}},{key:"_reportStatus",value:function(e){if(this._active&&h.Report.enable&&this._reportor){var t=e[u.RSP.TYPE],i=e[u.RSP.CODE],r=e[u.RSP.DATA]||{},s=e[u.RSP.MESSAGE]||"";if(t===u.XHR.QUERY&&i===u.RSP.SUCCESS&&"success"===s&&this._reportor&&r.streams){var o=[];r.streams.forEach(function(e){e.name&&o.push(e.name)}),this._reportor.peers=o,this._reportor.roomId=this._config.roomId||"",this._reportor.reportStatus()}}}}]),t}(m.default);t.default=g},function(e,t,i){"use strict";function r(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}Object.defineProperty(t,"__esModule",{value:!0});var s=function(){function e(e,t){for(var i=0;i<t.length;i++){var r=t[i];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}return function(t,i,r){return i&&e(t.prototype,i),r&&e(t,r),t}}(),o=i(0),n=i(2),a=function(){function e(){r(this,e),this.IDLE=120}return s(e,[{key:"createParse",value:function(e){var t=e||{},i=t.roomUrl||"",r=t.host||n.Globals.host,s=n.Globals.appId+"_"+t.roomId,a=s+"/"+t.userId,u={action:o.XHR.CREATE,idle:this.IDLE,room:s};if(void 0!==t.lifeType){var c=parseInt(t.lifeType);0!==c&&1!==c||(u.life_type=c)}var l=[];if(void 0!==t.peers){if(l=t.peers)for(var h=void 0,d=0;d<l.length;d++)(h=l[d])&&h.name&&(l[d].name=this._formatPeerName(h.name))}else{var f={layout_index:0,name:r+"/"+this._formatPeerName(a)};if(void 0!==t.area?""!==String(t.area)&&(f.area=String(t.area)):n.Globals.isRtcArea&&""!==n.Globals.rtcArea&&(f.area=n.Globals.rtcArea),void 0!==t.layoutIndex){var _=parseInt(t.layoutIndex);!isNaN(_)&&_>=0&&(f.layout_index=_)}l.push(f)}u.peers=l;var v={layout:1,room_url:i,resolution:{width:t.width||800,height:t.height||450}};return u.mix_config=this._createModifyCommonParams(v,t),u}},{key:"modifyParse",value:function(e){var t=e||{},i=t.roomUrl||"",r=n.Globals.appId+"_"+t.roomId,s={action:o.XHR.MODIFY,idle:this.IDLE,room:r},a={layout:1,room_url:i,resolution:{width:t.width||800,height:t.height||450}};return s.mix_config=this._createModifyCommonParams(a,t),s}},{key:"adjustParse",value:function(e){var t=e||{},i=t.roomUrl||"",r=n.Globals.appId+"_"+t.roomId,s={action:o.XHR.ADJUST,room:r};if(void 0!==t.peers){var a=t.peers||[];if(a)for(var u=void 0,c=0;c<a.length;c++)(u=a[c])&&u.name&&(a[c].name=this._formatPeerName(u.name));s.peers=a}var l={room_url:i};return s.mix_config=this._createModifyCommonParams(l,t),s}},{key:"statusParse",value:function(e){var t=e||{},i=n.Globals.appId+"_"+t.roomId;return{action:o.XHR.STATUS,room:i}}},{key:"queryParse",value:function(e){var t=e||{},i=n.Globals.appId+"_"+t.roomId;return{action:o.XHR.QUERY,room:i}}},{key:"joinParse",value:function(e){var t=e||{},i=t.peerName,r=n.Globals.appId+"_"+t.roomId;if(!i){i=(t.host||n.Globals.host)+"/"+(r+"/"+t.userId)}var s={action:o.XHR.JOIN,room:r};s.peers=[];var a={layout_index:-1,name:this._formatPeerName(i)};if(void 0!==t.layoutIndex){var u=parseInt(t.layoutIndex);!isNaN(u)&&u>=0&&(a.layout_index=u)}return void 0!==t.area&&""!==String(t.area)&&(a.area=String(t.area)),s.peers.push(a),s}},{key:"quitParse",value:function(e){var t=e||{},i=t.peerName,r=n.Globals.appId+"_"+t.roomId;if(!i){i=(t.host||n.Globals.host)+"/"+(r+"/"+t.userId)}var s={action:o.XHR.QUIT,room:r};return s.peers=[{name:this._formatPeerName(i)}],s}},{key:"destroyParse",value:function(e){var t=e||{},i=n.Globals.appId+"_"+t.roomId;return{action:o.XHR.DESTROY,room:i}}},{key:"_formatPeerName",value:function(e){if(!e)return"";var t=e.indexOf("?");return t<0?e:e.substring(0,t)}},{key:"_createModifyCommonParams",value:function(e,t){var i=e||{};for(var r in t)if(t.hasOwnProperty(r))switch(r){case"maxBitrate":var s=parseInt(t[r]);s>=300&&s<=4e3&&(i.max_bitrate=s);break;case"framerate":case"frameRate":var o=parseInt(t[r]);o>=15&&o<=30&&(i.frame_rate=o);break;case"audioBitrate":var n=parseInt(t[r]);n>=0&&n<=512&&(i.audio_bitrate=n);break;case"audioChannel":var a=parseInt(t[r]);1!==a&&2!==a||(i.audio_channels=a);break;case"resolution":var u={},c=t[r];c&&c.width&&c.height&&(u.width=parseInt(c.width),u.height=parseInt(c.height),i.resolution=u);break;case"fill":var l=parseInt(t[r]);0!==l&&1!==l&&2!==l||(i.fill=l);break;case"layout":var h=parseInt(t[r]);0!==h&&1!==h&&2!==h&&11!==h&&12!==h||(i.layout=h);break;case"layoutContent":case"layout_content":var d=t[r];d&&(i.layout_content=d);break;case"sei":var f=parseInt(t[r]);0!==f&&1!==f||(i.sei=f);break;case"dump":var _=parseInt(t[r]);0!==_&&1!==_||(i.hdl_dump=_);break;case"distUrl":var v=t[r];v&&""!==v&&(i.dist_url=v);break;case"packetLostThreshold":var p=parseInt(t[r]);isNaN(p)||(i.plc_threshold=p)}return i}}]),e}();t.default=a},function(e,t,i){"use strict";function r(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}Object.defineProperty(t,"__esModule",{value:!0});var s=function(){function e(e,t){for(var i=0;i<t.length;i++){var r=t[i];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}return function(t,i,r){return i&&e(t.prototype,i),r&&e(t,r),t}}(),o=i(2),n=i(5),a=i(11),u=function(e){return e&&e.__esModule?e:{default:e}}(a),c=function(){function e(){r(this,e),this._peers=[],this._roomId="",this._reportor=void 0}return s(e,[{key:"reportStatus",value:function(){this._reportor||(this._reportor=new u.default);var e={};e[n.MACRO.PEERS]=this.peers,e[n.MACRO.ROOM_ID]=this.roomId,e[n.MACRO.EVENT_NAME]=n.MACRO.MIX_INFO,e[n.MACRO.DEV_INFO]=o.Globals.deviceId,e[n.MACRO.MIC_TIME]=e[n.MACRO.EVENT_TIME]=this._reportor.getCurrentTime(),this._reportor.report({data:e})}},{key:"roomId",get:function(){return this._roomId},set:function(e){this._roomId=e||""}},{key:"peers",get:function(){return this._peers},set:function(e){this._peers=e||[]}}]),e}();t.default=c},function(e,t,i){"use strict";function r(e){return e&&e.__esModule?e:{default:e}}function s(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function o(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t}function n(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}Object.defineProperty(t,"__esModule",{value:!0});var a=function(){function e(e,t){for(var i=0;i<t.length;i++){var r=t[i];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}return function(t,i,r){return i&&e(t.prototype,i),r&&e(t,r),t}}(),u=i(8),c=i(70),l=r(c),h=i(3),d=r(h),f=function(e){function t(e){s(this,t);var i=o(this,(t.__proto__||Object.getPrototypeOf(t)).call(this));return i.player=void 0,i.config=e||{},i}return n(t,e),a(t,[{key:"start",value:function(){this.listenTo(u.PlayerEvent.MEDIA_EVENT,this.onMediaEventHandler.bind(this)),this.player=new l.default(this.config,this),this.player.start()}},{key:"stop",value:function(){this.removeToAll(),this.player&&(this.player.destroy(),this.player=void 0)}},{key:"debug",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};this.player&&this.player.debugLogLevel(e)}},{key:"debugSourceBuffer",value:function(){this.player&&this.player.debugSourceBuffer()}},{key:"onMediaEventHandler",value:function(e){e&&this.trigger(u.PlayerEvent.PLAYER_EVENT,e)}}]),t}(d.default);t.default=f},function(e,t,i){"use strict";function r(e){return e&&e.__esModule?e:{default:e}}function s(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}Object.defineProperty(t,"__esModule",{value:!0});var o=function(){function e(e,t){for(var i=0;i<t.length;i++){var r=t[i];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}return function(t,i,r){return i&&e(t.prototype,i),r&&e(t,r),t}}(),n=i(72),a=r(n),u=i(71),c=r(u),l=function(){function e(t,i){s(this,e),this.wsobserver=i,this.config=this.parseConfig(t),this.defaultConfig={maxBufferedLen:500,minBufferedLen:300,startBufferLen:500,normalBufferLen:2e3,maxLiveTimeDelay:6,normalLiveTimeDelay:2,maxPreBufferedLen:20,minPreBufferedLen:10,maxCacheBufferLen:100},this.managerConfig={url:this.url,isLive:this.isLive,enableSEI:this.config.seiConfig.isSei,enableAudioStrategy:this.config.enableAudioStrategy,startBufferLen:this.defaultConfig.startBufferLen,normalBufferLen:this.defaultConfig.normalBufferLen},this.playerConfig={isLive:this.isLive,startTime:void 0,isLiveCatch:this.config.isLiveCatch,seiCallback:this.config.seiConfig.seiCallback,maxBufferedLen:this.defaultConfig.maxBufferedLen,minBufferedLen:this.defaultConfig.minBufferedLen,maxCacheBufferLen:this.defaultConfig.maxCacheBufferLen,maxPreBufferedLen:this.defaultConfig.maxPreBufferedLen,minPreBufferedLen:this.defaultConfig.minPreBufferedLen,normalLiveTimeDelay:this.defaultConfig.normalLiveTimeDelay,maxLiveTimeDelay:this.config.liveDelayTime?this.config.liveDelayTime:this.defaultConfig.maxLiveTimeDelay},this.msePlayer=new a.default(this,this.videoElement,this.playerConfig),this.moduleManager=new c.default(this,this.msePlayer,this.managerConfig)}return o(e,[{key:"start",value:function(){this.moduleManager&&this.moduleManager.start()}},{key:"destroy",value:function(){this.moduleManager&&(this.moduleManager.destroy(),this.moduleManager=void 0),this.msePlayer&&(this.msePlayer.destroy(),this.msePlayer=void 0)}},{key:"parseConfig",value:function(e){var t={url:"",isLive:!0,isLiveCatch:!0,enableAudioStrategy:!0,seiConfig:{isSei:!1,seiCallback:void 0}};for(var i in e)if(e.hasOwnProperty(i))switch(i){case"videoElem":t[i]=e[i];break;case"url":t[i]=String(e[i]);break;case"isLive":case"isLiveCatch":case"enableAudioStrategy":t[i]=!("false"===String(e[i]));break;case"liveDelayTime":var r=parseInt(e[i]);r>=3&&r<=20&&(t[i]=r);break;case"seiConfig":var s=e[i];s&&"true"===String(s.isSei)&&(t.seiConfig.isSei=!0,s.seiCallback&&(t.seiConfig.seiCallback=s.seiCallback))}return this.url=t.url,this.isLive=t.isLive,this.videoElement=t.videoElem,t}},{key:"getKeyframeByTime",value:function(e){return this.moduleManager?this.moduleManager.getKeyframeByTime(e):-1}},{key:"debugSourceBuffer",value:function(){this.msePlayer&&this.msePlayer.debugSourceBuffer()}},{key:"debugLogLevel",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};this.moduleManager&&this.moduleManager.debugLogLevel(e)}},{key:"observer",get:function(){return this.wsobserver}}]),e}();t.default=l},function(e,t,i){"use strict";e.exports=i(69)},function(e,t,i){"use strict";function r(e){return e&&e.__esModule?e:{default:e}}function s(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}Object.defineProperty(t,"__esModule",{value:!0});var o=function(){function e(e,t){for(var i=0;i<t.length;i++){var r=t[i];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}return function(t,i,r){return i&&e(t.prototype,i),r&&e(t,r),t}}(),n=i(74),a=r(n),u=i(75),c=r(u),l=i(77),h=r(l),d=function(){function e(t,i,r){s(this,e),this.handler=t,this.msePlayer=i,this.config=r||{},this.remuxer=new c.default(this,{enableAudioStrategy:this.config.enableAudioStrategy}),this.config.timescale=this.remuxer.timescale,this.parser=new a.default(this,this.config),this.downloader=new h.default(this,this.config.url)}return o(e,[{key:"start",value:function(){this.downloader&&this.downloader.startLoad()}},{key:"destroy",value:function(){this.downloader&&(this.downloader.destroy(),this.downloader=void 0),this.msePlayer&&(this.msePlayer.destroy(),this.msePlayer=void 0),this.remuxer&&(this.remuxer.destroy(),this.remuxer=void 0),this.parser&&(this.parser.destroy(),this.parser=void 0),this.downloader&&(this.downloader.destroy(),this.downloader=void 0)}},{key:"downloadToStream",value:function(e){if(this.parser){var t=this.parser.addPreTagData(new Uint8Array(e));this.parser.parseFlv(t)}}},{key:"getKeyframeByTime",value:function(e){return this.parser?this.parser.getKeyframeByTime(e):-1}},{key:"parseToSetMSEDuration",value:function(e){this.msePlayer&&this.msePlayer.setDuration(e)}},{key:"parseToRemux",value:function(e,t,i,r){this.remuxer&&this.remuxer.remux(e,t,i,r)}},{key:"onSEIParsingData",value:function(e){this.msePlayer&&this.msePlayer.onSEIParsingData(e)}},{key:"remuxToFragParsed",value:function(){this.msePlayer&&this.msePlayer.onFragParsed()}},{key:"remuxToFragParsingInitSegment",value:function(e){this.msePlayer&&this.msePlayer.onFragParsingInitSegment(e)}},{key:"remuxToFragParsingData",value:function(e){this.msePlayer&&this.msePlayer.onFragParsingData(e)}},{key:"debugLogLevel",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},t=0,i=!1;e.play&&(i="true"===String(e.play.enable),t=i?parseInt(e.play.level):0,isNaN(t)&&(t=0),this.msePlayer&&this.msePlayer.debugLogLevel({level:t})),e.parse&&(i="true"===String(e.parse.enable),t=i?parseInt(e.parse.level):0,isNaN(t)&&(t=0),this.parser&&this.parser.debugLogLevel({level:t})),e.remux&&(i="true"===String(e.remux.enable),t=i?parseInt(e.remux.level):0,isNaN(t)&&(t=0),this.remuxer&&this.remuxer.debugLogLevel({level:t}))}},{key:"observer",get:function(){return this.handler.observer||{}}}]),e}();t.default=d},function(e,t,i){"use strict";function r(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}Object.defineProperty(t,"__esModule",{value:!0});var s=function(){function e(e,t){for(var i=0;i<t.length;i++){var r=t[i];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}return function(t,i,r){return i&&e(t.prototype,i),r&&e(t,r),t}}(),o=i(8),n=i(16),a=i(13),u=function(e){return e&&e.__esModule?e:{default:e}}(a),c=function(){function e(t,i,s){r(this,e),this.handler=t,this.config=s,this.seiSegments=[],this.audioSegments=[],this.videoSegments=[],this.onmso=this.onMediaSourceOpen.bind(this),this.onmse=this.onMediaSourceEnded.bind(this),this.onmsc=this.onMediaSourceClose.bind(this),this.onasbue=this.onAudioSBUpdateEnd.bind(this),this.onvsbue=this.onVideoSBUpdateEnd.bind(this),this.onasbe=this.onAudioSBUpdateError.bind(this),this.onvsbe=this.onVideoSBUpdateError.bind(this),this.onvplay=this.onMediaPlay.bind(this),this.onvmetadata=this.onMediaMetadata.bind(this),this.onvtimeupdate=this.onMediaTimeUpdate.bind(this),this.audioCodec=null,this.videoCodec=null,this.loadedmetadata=!1,this.audioSourceBuffer=null,this.videoSourceBuffer=null,this.width=0,this.height=0,this.isDebugLevel=0,this.keyframeSeek={waitForPlay:!1,keyframeTime:0},this.isRemoveBuffer=!0,this.isPushParsingData=!0,this.attachMedia(i)}return s(e,[{key:"destroy",value:function(){this.seiSegments=[],this.audioSegments=[],this.videoSegments=[],this.loadedmetadata=!1,this.detachMedia(),this.audioCodec=null,this.videoCodec=null,this.width=0,this.height=0,this.isRemoveBuffer=!0,this.isPushParsingData=!0}},{key:"getBufferLen",value:function(){var e=this.getMediaBufferLen();return e<=0&&(e=this.getSourceBufferLen())<=0&&n.logger.debug("MSEPlayer.getBufferLen buffer initial"),e}},{key:"getMediaBufferLen",value:function(){var e=-1;if(!this.video)return e;var t=this.video.buffered,i=this.video.currentTime;if(t.length){for(var r=0;r<t.length;r++)if(i>=t.start(r)&&i<=t.end(r)){e=t.end(r)-i;break}}else e=0;return e}},{key:"getSourceBufferLen",value:function(){var e=-1;return this.video?this.audioSourceBuffer&&-1!==(e=this.getAudioSourceBufferLen())?e:(this.videoSourceBuffer&&(e=this.getVideoSourceBufferLen()),e):e}},{key:"getAudioSourceBufferLen",value:function(){for(var e=this.video.currentTime,t=0;t<this.audioSourceBuffer.buffered.length;t++){var i=this.audioSourceBuffer.buffered.start(t),r=this.audioSourceBuffer.buffered.end(t);if(e>=i&&e<=r)return r-i}return-1}},{key:"getVideoSourceBufferLen",value:function(){for(var e=this.video.currentTime,t=0;t<this.videoSourceBuffer.buffered.length;t++){var i=this.videoSourceBuffer.buffered.start(t),r=this.videoSourceBuffer.buffered.end(t);if(e>=i&&e<=r)return r-i}return-1}},{key:"removePreBuffer",value:function(){this.video&&this.isRemoveBuffer&&(this.removePreAudioBuffer(),this.removePreVideoBuffer())}},{key:"removePreAudioBuffer",value:function(){var e=void 0,t=void 0,i=void 0,r=this.video.currentTime;if(this.audioSourceBuffer&&!this.audioSourceBuffer.updating){i=this.audioSourceBuffer.buffered.length;for(var s=0;s<i;s++)if(e=this.audioSourceBuffer.buffered.start(s),t=this.audioSourceBuffer.buffered.end(s),this.isDebugLevel>0&&n.logger.log("audioBuffer["+s+"]["+r+","+e+"-"+t+"]"),r>t)this.audioSourceBuffer.remove(e,t),this.isDebugLevel>0&&n.logger.log("audioBuffer remove, ["+e+"-"+t+"]");else if(r-e>this.config.maxPreBufferedLen){var o=r-this.config.minPreBufferedLen;this.audioSourceBuffer.remove(e,o),this.isDebugLevel>0&&n.logger.log("audioBuffer remove, ["+e+"-"+o+"]")}}}},{key:"removePreVideoBuffer",value:function(){var e=void 0,t=void 0,i=void 0,r=this.video.currentTime;if(this.videoSourceBuffer&&!this.videoSourceBuffer.updating){i=this.videoSourceBuffer.buffered.length;for(var s=0;s<i;s++)if(e=this.videoSourceBuffer.buffered.start(s),t=this.videoSourceBuffer.buffered.end(s),this.isDebugLevel>0&&n.logger.log("videoBuffer["+s+"]["+r+","+e+"-"+t+"]"),r>t)this.videoSourceBuffer.remove(e,t),this.isDebugLevel>0&&n.logger.log("videoBuffer remove, ["+e+"-"+t+"]");else if(r-e>this.config.maxPreBufferedLen){var a=r-this.config.minPreBufferedLen;this.videoSourceBuffer.remove(e,a),this.isDebugLevel>0&&n.logger.log("videoBuffer remove, ["+e+"-"+a+"]")}else{if(t-r>this.config.maxCacheBufferLen){if(t-r<10*this.config.maxCacheBufferLen){var u=Math.floor(t-this.config.normalLiveTimeDelay),c=this.getKeyframeByTime(u);(c<0||c>t)&&(c=u),n.logger.log("videoBuffer warning, currentTime:"+r+", targetTime:"+c+", buffer["+e+", "+t+"]"),this.video.currentTime=c;break}this.video.pause(),this.isRemoveBuffer=!1,n.logger.warn("videoBuffer warning, ["+r+"],["+e+","+t+"]"),this.dispatch(o.PlayerEvent.MEDIA_EVENT,{type:o.PlayerMessage.DURATION_WARNING,code:0,message:"source buffer length too large warning",data:{current:r,duration:this.video.duration}});break}if(1===i&&r<e){var l=(t-e)/2,h=this.getKeyframeByTime(l);(h<e||h>t)&&(h=e),n.logger.log("videoBuffer skip gap, currentTime:"+r+", targetTime:"+h+", buffer["+e+", "+t+"]"),this.video.currentTime=h;break}}}}},{key:"removeAllBuffer",value:function(e){this.video&&(this.removeAllAudioBuffer(e),this.removeAllVideoBuffer(e))}},{key:"removeAllAudioBuffer",value:function(e){if(this.audioSourceBuffer&&(e&&this.audioSourceBuffer.abort(),!this.audioSourceBuffer.updating))for(var t=void 0,i=void 0,r=0;r<this.audioSourceBuffer.buffered.length;r++)t=this.audioSourceBuffer.buffered.start(r),i=this.audioSourceBuffer.buffered.end(r),this.audioSourceBuffer.remove(t,i),n.logger.log("MSEPlayer.remove all audioBuffer, ["+t+"-"+i+"]")}},{key:"removeAllVideoBuffer",value:function(e){if(this.videoSourceBuffer&&(e&&this.videoSourceBuffer.abort(),!this.videoSourceBuffer.updating))for(var t=void 0,i=void 0,r=0;r<this.videoSourceBuffer.buffered.length;r++)t=this.videoSourceBuffer.buffered.start(r),i=this.videoSourceBuffer.buffered.end(r),this.videoSourceBuffer.remove(t,i),n.logger.log("MSEPlayer.remove all videoBuffer, ["+t+"-"+i+"]")}},{key:"catchLiveDelay",value:function(){if(this.video&&this.config.isLiveCatch){var e=this.video.buffered;if(e.length)for(var t=void 0,i=void 0,r=this.video.currentTime,s=0;s<e.length;s++)if(t=e.start(s),i=e.end(s),!(r<t||r>i)&&i-r>this.config.maxLiveTimeDelay){var o=Math.floor(i-this.config.normalLiveTimeDelay),a=this.getKeyframeByTime(o);(a<0||a>i)&&(a=o),n.logger.log("MSEPlayer.catchLiveDelay, currentTime:"+r+", targetTime:"+a+", buffer["+t+", "+i+"]"),this.video.currentTime=a;break}}}},{key:"appendAudioBuffer",value:function(){if(this.audioSourceBuffer&&!1===this.audioSourceBuffer.updating&&this.audioSegments.length>0){var e=this.audioSegments.shift();try{this.audioSourceBuffer.appendBuffer(e)}catch(t){n.logger.error("MSEPlayer.appendAudioBuffer["+t.name+"]"+t.message),"QuotaExceededError"===t.name&&(this.audioSegments.unshift(e),this.checkBufferedLen(!0))}}}},{key:"appendVideoBuffer",value:function(){if(this.videoSourceBuffer&&!this.videoSourceBuffer.updating&&this.videoSegments.length>0){var e=this.videoSegments.shift();try{this.videoSourceBuffer.appendBuffer(e)}catch(t){n.logger.error("MSEPlayer.appendVideoBuffer["+t.name+"]"+t.message),"QuotaExceededError"===t.name&&(this.videoSegments.unshift(e),this.checkBufferedLen())}}}},{key:"onSEIParsingData",value:function(e){this.seiSegments.push(e)}},{key:"onFragParsingInitSegment",value:function(e){if(e){if(this.isPushParsingData=!0,e.audio){var t=void 0,i=this.audioCodec=e.audio.audioCodec;i&&!this.audioSourceBuffer&&this.mediaSource&&"open"===this.mediaSource.readyState&&(n.logger.log("MSEPlayer.onFragParsingInitSegment create audio sb codec="+this.audioCodec),t=this.audioSourceBuffer=this.mediaSource.addSourceBuffer("video/mp4;codecs="+i),this.addAudioSBEventListeners(t)),e.audio.audioMoov&&(this.audioSegments=[],this.audioSegments.push(e.audio.audioMoov),n.logger.log("MSEPlayer.onFragParsingInitSegment, push audio moov"))}if(e.video){var r=void 0,s=this.videoCodec=e.video.videoCodec;s&&!this.videoSourceBuffer&&this.mediaSource&&"open"===this.mediaSource.readyState&&(n.logger.log("MSEPlayer.onFragParsingInitSegment create video sb codec="+this.videoCodec),r=this.videoSourceBuffer=this.mediaSource.addSourceBuffer("video/mp4;codecs="+s),this.addVideoSBEventListeners(r)),e.video.videoMoov&&(this.videoSegments=[],this.videoSegments.push(e.video.videoMoov),n.logger.log("MSEPlayer.onFragParsingInitSegment, push video moov"))}}}},{key:"onFragParsingData",value:function(e){this.isPushParsingData&&("audio"===e.type?this.audioSourceBuffer?(this.audioSegments.push(e.moof),this.audioSegments.push(e.mdat)):(this.isPushParsingData=!1,n.logger.log("MSEPlayer.onFragParsingData, push audio data but no audioSourceBuffer"),this.removeAudioSBEventListeners(this.audioSourceBuffer)):"video"===e.type&&(this.videoSourceBuffer?(this.videoSegments.push(e.moof),this.videoSegments.push(e.mdat)):(this.isPushParsingData=!1,n.logger.log("MSEPlayer.onFragParsingData, push video data but no videoSourceBuffer"),this.removeVideoSBEventListeners(this.videoSourceBuffer))),this.isPushParsingData||this.dispatch(o.PlayerEvent.MEDIA_EVENT,{type:o.PlayerMessage.AUDIO_VIDEO_SWITCH,code:0,message:"audio or video data coming but its sourceBuffer null"}))}},{key:"onFragParsed",value:function(){this.appendAudioBuffer(),this.appendVideoBuffer()}},{key:"onMediaSourceOpen",value:function(e){n.logger.log("MSEPlayer.onMediaSourceOpen"),this.addMediaEventListeners(this.video),this.mediaSource.removeEventListener("sourceopen",this.onmso);var t=null,i=null;this.audioCodec&&!this.audioSourceBuffer&&(t=this.audioSourceBuffer=this.mediaSource.addSourceBuffer("video/mp4;codecs="+this.audioCodec),this.addAudioSBEventListeners(t)),this.videoCodec&&!this.videoSourceBuffer&&(i=this.videoSourceBuffer=this.mediaSource.addSourceBuffer("video/mp4;codecs="+this.videoCodec),this.addVideoSBEventListeners(i)),this.appendAudioBuffer(),this.appendVideoBuffer()}},{key:"onMediaSourceClose",value:function(e){n.logger.log("MSEPlayer.onMediaSourceClose")}},{key:"onMediaSourceEnded",value:function(){n.logger.log("MSEPlayer.onMediaSourceEnded")}},{key:"onMediaMetadata",value:function(e){n.logger.log("MSEPlayer.onMediaMetadata"),this.loadedmetadata=!0,this.width=parseInt(e.target.videoWidth),this.height=parseInt(e.target.videoHeight),this.dispatch(o.PlayerEvent.MEDIA_EVENT,{type:o.PlayerMessage.METADATA,code:0,message:"metadata info",data:{width:this.width,height:this.height}}),u.default.isFirefox()&&u.default.extractVersion(/Firefox\/(\d+)\./,1)>=61&&this.video&&this.video.play()}},{key:"onMediaPlay",value:function(){if(this.config.startTime&&this.config.startTime>=0&&(this.video.currentTime=this.config.startTime,this.config.startTime=void 0),this.keyframeSeek.waitForPlay){var e=this.video.currentTime;n.logger.log("MSEPlayer.onMediaPlay, currentTime = "+e+", keyframeTime = "+this.keyframeSeek.keyframeTime),e===this.keyframeSeek.keyframeTime?this.keyframeSeek.waitForPlay=!1:(n.logger.log("MSEPlayer.onMediaPlay, waiting for keyframe play but not, back to play it!"),this.video.currentTime=this.keyframeSeek.keyframeTime)}}},{key:"onMediaTimeUpdate",value:function(){if(this.config.seiCallback)for(var e=void 0;this.seiSegments.length;){if(e=this.seiSegments.shift(),!(e.wstime-Math.floor(this.video.currentTime)<=0)){this.seiSegments.unshift(e);break}this.config.seiCallback(e)}this.config.isLive&&(this.video.duration-this.video.currentTime<2*this.config.maxCacheBufferLen?this.catchLiveDelay():(this.removeMediaEventListeners(this.video),n.logger.warn("duration warning, ["+this.video.currentTime+"],["+this.video.duration+"]"),this.dispatch(o.PlayerEvent.MEDIA_EVENT,{type:o.PlayerMessage.DURATION_WARNING,code:0,message:"duration abnormal warning",data:{current:this.video.currentTime,duration:this.video.duration}})))}},{key:"getKeyframeByTime",value:function(e){return this.handler?this.handler.getKeyframeByTime(e):-1}},{key:"onMediaAttaching",value:function(e){if(this.video=e,e){window.MediaSource=window.MediaSource||window.WebKitMediaSource;var t=this.mediaSource=new MediaSource;this.addMediaSourceEventListeners(t),e.src=URL.createObjectURL(t)}}},{key:"onMediaDetaching",value:function(){if(this.removeMediaEventListeners(this.video),this.mediaSource){var e=this.mediaSource;if(this.audioSourceBuffer){try{e.removeSourceBuffer(this.audioSourceBuffer),this.removeAudioSBEventListeners(this.audioSourceBuffer)}catch(e){n.logger.log("MSEPlayer.removeAudioSourceBuffer error, "+e.message)}this.audioSourceBuffer=null}if(this.videoSourceBuffer){try{e.removeSourceBuffer(this.videoSourceBuffer),this.removeVideoSBEventListeners(this.videoSourceBuffer)}catch(e){n.logger.log("MSEPlayer.removeVideoSourceBuffer error, "+e.message)}this.videoSourceBuffer=null}if("open"===e.readyState)try{e.endOfStream()}catch(e){n.logger.warn("endOfStream error: "+e.message)}if(this.removeMediaSourceEventListeners(e),this.video)try{this.video.src="",this.video.removeAttribute("src")}catch(e){n.logger.warn("unlinking src of video error: "+e.message)}this.mediaSource=null,this.video=null,this.audioSourceBuffer=this.videoSourceBuffer=null}}},{key:"onAudioSBUpdateEnd",value:function(){this.checkBufferedLen(),this.appendAudioBuffer()}},{key:"onVideoSBUpdateEnd",value:function(){this.checkBufferedLen(),this.appendVideoBuffer()}},{key:"checkBufferedLen",value:function(){this.removePreBuffer()}},{key:"onAudioSBUpdateError",value:function(e){n.logger.error("MSEPlayer.onAudioSBUpdateError")}},{key:"onVideoSBUpdateError",value:function(e){n.logger.error("MSEPlayer.onVideoSBUpdateError")}},{key:"clearData",value:function(){this.audioSegments=[],this.videoSegments=[],this.removeAllBuffer(!0)}},{key:"setDuration",value:function(e){this.mediaSource&&e>0&&(this.mediaSource.duration=e)}},{key:"detachMedia",value:function(){this.onMediaDetaching()}},{key:"attachMedia",value:function(e){this.onMediaAttaching(e)}},{key:"addMediaSourceEventListeners",value:function(e){e&&(e.addEventListener("sourceopen",this.onmso),e.addEventListener("sourceended",this.onmse),e.addEventListener("sourceclose",this.onmsc))}},{key:"removeMediaSourceEventListeners",value:function(e){e&&(e.removeEventListener("sourceopen",this.onmso),e.removeEventListener("sourceended",this.onmse),e.removeEventListener("sourceclose",this.onmsc))}},{key:"addMediaEventListeners",value:function(e){e&&(e.addEventListener("loadedmetadata",this.onvmetadata),e.addEventListener("timeupdate",this.onvtimeupdate),e.addEventListener("play",this.onvplay))}},{key:"removeMediaEventListeners",value:function(e){e&&(e.removeEventListener("loadedmetadata",this.onvmetadata),e.removeEventListener("timeupdate",this.onvtimeupdate),e.removeEventListener("play",this.onvplay))}},{key:"addAudioSBEventListeners",value:function(e){e&&(e.addEventListener("updateend",this.onasbue),e.addEventListener("error",this.onasbe))}},{key:"removeAudioSBEventListeners",value:function(e){e&&(e.removeEventListener("updateend",this.onasbue),e.removeEventListener("error",this.onasbe))}},{key:"addVideoSBEventListeners",value:function(e){e&&(e.addEventListener("updateend",this.onvsbue),e.addEventListener("error",this.onvsbe))}},{key:"removeVideoSBEventListeners",value:function(e){e&&(e.removeEventListener("updateend",this.onvsbue),e.removeEventListener("error",this.onvsbe))}},{key:"dispatch",value:function(e,t){this.handler&&this.handler.observer&&this.handler.observer.trigger(e,t)}},{key:"debugSourceBuffer",value:function(){if(this.video){var e=void 0,t=void 0,i=this.video.currentTime;if(this.audioSourceBuffer)for(var r=0;r<this.audioSourceBuffer.buffered.length;r++)e=this.audioSourceBuffer.buffered.start(r),t=this.audioSourceBuffer.buffered.end(r),n.logger.log("audioSourceBuffer["+i+", "+e+"-"+t+"]");if(this.videoSourceBuffer)for(var s=0;s<this.videoSourceBuffer.buffered.length;s++)e=this.videoSourceBuffer.buffered.start(s),t=this.videoSourceBuffer.buffered.end(s),n.logger.log("videoSourceBuffer["+i+", "+e+"-"+t+"]")}}},{key:"debugLogLevel",value:function(e){var t=parseInt(e.level);isNaN(t)?this.isDebugLevel=0:this.isDebugLevel=t}}]),e}();t.default=c},function(e,t,i){"use strict";function r(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}Object.defineProperty(t,"__esModule",{value:!0});var s=function(){function e(e,t){for(var i=0;i<t.length;i++){var r=t[i];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}return function(t,i,r){return i&&e(t.prototype,i),r&&e(t,r),t}}(),o=i(8),n=function(){function e(t){r(this,e),this._handler=t,this._isEnded=!1,this._lastAudioConfig=void 0}return s(e,[{key:"receiveAVCEndedFrame",value:function(){this._handler&&this._handler.observer&&(this.isEnded=!0,this._handler.observer.trigger(o.PlayerEvent.MEDIA_EVENT,{type:o.PlayerMessage.PLAY_ENDED,code:0,message:"AVC end of sequence"}))}},{key:"dimensionChange",value:function(e){this._handler&&this._handler.observer&&this._handler.observer.trigger(o.PlayerEvent.MEDIA_EVENT,{type:o.PlayerMessage.DIMENSION_CHANGE,code:0,message:"stream dimension change",data:e||{}})}},{key:"audioVideoSwitchChange",value:function(e){this._handler&&this._handler.observer&&(this.isEnded=!0,this._handler.observer.trigger(o.PlayerEvent.MEDIA_EVENT,{type:o.PlayerMessage.AUDIO_VIDEO_SWITCH,code:0,message:e}))}},{key:"isEnded",get:function(){return this._isEnded},set:function(e){this._isEnded=e}},{key:"lastAudioConfig",get:function(){return this._lastAudioConfig},set:function(e){if(this._lastAudioConfig){if(this._lastAudioConfig===e.toString())return;if(this._handler){if(this.isEnded=!0,!this._handler.observer)return;this._handler.observer.trigger(o.PlayerEvent.MEDIA_EVENT,{type:o.PlayerMessage.PLAY_ENDED,code:0,message:"audio config different"})}}else this._lastAudioConfig=e.toString()}}]),e}();t.default=n},function(e,t,i){"use strict";function r(e){return e&&e.__esModule?e:{default:e}}function s(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}Object.defineProperty(t,"__esModule",{value:!0});var o=function(){function e(e,t){for(var i=0;i<t.length;i++){var r=t[i];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}return function(t,i,r){return i&&e(t.prototype,i),r&&e(t,r),t}}(),n=i(76),a=r(n),u=i(16),c=i(73),l=r(c),h=i(79),d=r(h),f=function(){function e(t,i){s(this,e),this.config=i,this.handler=t,this.tagTypes={8:"audio",9:"video",18:"metadata"},this.preTagData=null,this.FLV_HEADER_LEN=9,this.FLV_TAG_HEADER_LEN=11,this.FLV_PREV_TAG_SIZE_LEN=4,this.AMF_DATA_TYPE_STRING=2,this.AMF_DATA_TYPE_ECMA_ARRAY=8,this.width=0,this.height=0,this.lengthSizeMinusOne=0,this.hasFlvHeaderParsed=!1,this.bufLen=this.config.startBufferLen,this.audioCodec="",this.audioConfig=void 0,this.audioSampleRate=void 0,this.audioChannelCount=void 0,this.isDebugLevel=0,this.hasAudio=!1,this.hasVideo=!1,this.isFirstRemux=!0,this.avcHeaderLogCount=1,this.keySampleTimeArray=[],this.AVC_HEADER_LOG_LIMIT=100,this.AVC_HEADER_LOG_CYCLE=1e6,this.SCRIPTTYPE={NUMBER:0,BOOLEAN:1,STRING:2,OBJECT:3,MOVIE_CLIP:4,NULL:5,UNDEFINED:6,REFERENCE:7,ECMA_ARRAY:8,END_OF_DATA:9,STRICT_ARRAY:10,DATE:11,LONG_STRING:12},this.keyframes={times:[],filepositions:[],parsingTimes:!1,parsingKeyframes:!1,parsingFilePositions:!1,timesName:"times",keyframesName:"keyframes",filepositionsName:"filepositions"},this.SEI_UUID=[84,128,131,151,240,35,71,75,183,247,79,50,181,78,6,172],this._parserError=new l.default(this.handler),this.reset()}return o(e,[{key:"destroy",value:function(){this.hasFlvHeaderParsed=!1,this.lengthSizeMinusOne=0,this.reset()}},{key:"reset",value:function(){this.resetAvcTrack(),this.resetAacTrack(),this.resetId3Track(),this.videoWidth=-1,this.videoHeight=-1,this.hasAudio=!1,this.hasVideo=!1,this.preTagData=null,this.isFirstRemux=!0,this.avcHeaderLogCount=1,this.keySampleTimeArray=[],this.isFirstParseAVCHeader=!0,this.bufLen=this.config.startBufferLen,this._audioVideoSwitch=0,this._parserError.isEnded=!1,this.aacTrack.config=this.audioConfig,this.aacTrack.timescale=this.config.timescale,this.avcTrack.timescale=this.config.timescale,this.aacTrack.channelCount=this.audioChannelCount,this.aacTrack.audiosamplerate=this.audioSampleRate,this.aacTrack.codec=""===this.audioCodec?"mp4a.40.5":this.audioCodec}},{key:"resetAvcTrack",value:function(){this.avcTrack={type:"video",id:1,sequenceNumber:0,samples:[],len:0,nbNalu:0,duration:0,startDts:-1,endDts:0}}},{key:"resetAacTrack",value:function(){this.aacTrack={type:"audio",id:2,sequenceNumber:0,samples:[],len:0,duration:0,startDts:-1,endDts:0}}},{key:"resetId3Track",value:function(){this.id3Track={type:"id3",id:3,sequenceNumber:0,samples:[],len:0}}},{key:"parseVideoTag",value:function(e,t){return t=t||{},t.codecID=15&e[0],t.frameType=(240&e[0])>>>4,7===t.codecID?this.parseAVCTag(e.subarray(1),t):t}},{key:"parseAVCTag",value:function(e,t){var i=["AVC Sequence Header","AVC NALU","AVC End-of-Sequence"],r=0,s=0;if(t=t||{},t.avcPacketType=i[e[0]],r=128&e[1],s=(127&e[1])<<16|e[2]<<8|e[3],t.CompositionTime=r?-s:s,this.isDebugLevel>0&&u.logger.log(e[0]+", FLVParser.parseAVCTag timestamp = "+t.timestamp),1===e[0]){0!==t.timestamp&&(this.hasVideo=!0),-1!==this.avcTrack.startDts&&t.timestamp>=this.avcTrack.startDts+this.bufLen&&(this.avcTrack.endDts=t.timestamp,this.isDebugLevel>0&&u.logger.log("FLVParser.parseAVCTag, ready to remux by startDts = "+this.avcTrack.startDts+", endDts = "+this.avcTrack.endDts),this.remux(),this.bufLen=this.config.normalBufferLen);for(var o=[],n=0,a=4,c=void 0;a<e.byteLength;){for(var l=0,h=this.lengthSizeMinusOne+1,f=0;f<h;f++)l+=e[a+f]<<8*(h-f-1);if(a+=h,0!==l){if(a+l>e.byteLength){u.logger.log("parseAVCTag error, offset="+a+", naluDataLen="+l+",tag.byteLength="+e.byteLength);break}var _={data:e.subarray(a,a+l),type:1===t.frameType?5:1};6===_.data[0]?this.config.enableSEI?(c=new d.default(_.data),this.parseSEIFrame(c,t.timestamp+t.CompositionTime)):_=void 0:(o.push(_),n+=_.data.length),a+=l}}if(n>0){var v={units:{units:o,length:n},pts:90*(t.timestamp+t.CompositionTime),dts:90*t.timestamp,key:1===t.frameType};if(v.key){var p=v.pts/9e4;this.keySampleTimeArray.indexOf(p)<0&&this.keySampleTimeArray.push(p)}if(this.avcTrack.samples.push(v),this.avcTrack.nbNalu+=o.length,this.avcTrack.len+=n,-1===this.avcTrack.startDts&&(this.avcTrack.startDts=t.timestamp),this.avcTrack.endDts=t.timestamp,v.key&&this.isDebugLevel>3)for(var m=void 0,g=v.units.units,y=0;y<g.length;y++)m=g[y],console.log("FLVParser.parseAVCTag, IDR = "+m.data)}else u.logger.log("discard empty nalu, dts="+t.timestamp+", pts="+(t.timestamp+t.CompositionTime)+", dataLen="+t.dataSize+", naluLen="+n)}else 0===e[0]?this.parseAVCDecoderConfigurationRecord(e.subarray(4)):2===e[0]?(u.logger.log("receive AVC end of sequence"),this._parserError&&(this._parserError.isEnded=!0,this._parserError.receiveAVCEndedFrame())):u.logger.error("FLVParser.parseAVCTag, parseAVCTag error, type = "+e[0])}},{key:"parseAVCDecoderConfigurationRecord",value:function(e){this.avcTrack.sps=[],this.lengthSizeMinusOne=3&e[4];for(var t=31&e[5],i=void 0,r=6,s=0;s<t;s++){var o=(e[r]<<8)+e[r+1];r+=2;var n={data:e.subarray(r,r+o),type:7};r+=o;var a=new d.default(n.data),c=a.readSPS();if(this.avcTrack.width=c.width,this.avcTrack.height=c.height,c.pixelRatio&&(this.avcTrack.pixelRatio=c.pixelRatio),(this.isDebugLevel>0||this.avcHeaderLogCount%this.AVC_HEADER_LOG_LIMIT==0)&&(u.logger.log("FLVParser.parseAVCHeader, naluSizeLength = "+this.lengthSizeMinusOne),u.logger.log("FLVParser.parseAVCHeader, sps = "+n.data)),this.isFirstParseAVCHeader)this.videoWidth=c.width,this.videoHeight=c.height,this.isFirstParseAVCHeader=!1,u.logger.log("parse resolution from sps = "+this.videoWidth+"*"+this.videoHeight),u.logger.log("FLVParser.parseAVCHeader, naluSizeLength = "+this.lengthSizeMinusOne),u.logger.log("FLVParser.parseAVCHeader, sps = "+n.data),this._parserError&&this._parserError.dimensionChange({isAVCHeader:!0,aspect1:this.videoWidth,aspect2:this.videoHeight});else if(this.videoWidth!==c.width||this.videoHeight!==c.height){var l=c.width+"x"+c.height,h=this.videoWidth+"x"+this.videoHeight;if(this._parserError)return void this._parserError.dimensionChange({aspect1:h,aspect2:l,isAVCHeader:!1})}for(var f="avc1.",_=n.data.subarray(1,4),v=0;v<3;v++){var p=_[v].toString(16);p.length<2&&(p="0"+p),f+=p}this.avcTrack.codec=f,this.avcTrack.sps.push(n.data)}this.avcTrack.pps=[],i=e[r],r++;for(var m=0;m<i;m++){var g=(e[r]<<8)+e[r+1];r+=2;var y={data:e.subarray(r,r+g),type:8};r+=g,this.avcTrack.pps.push(y.data),(this.isFirstParseAVCHeader||this.isDebugLevel>0||this.avcHeaderLogCount%this.AVC_HEADER_LOG_LIMIT==0)&&u.logger.log("FLVParser.parseAVCHeader, pps = "+y.data)}this.isFirstParseAVCHeader=!1,++this.avcHeaderLogCount/this.AVC_HEADER_LOG_CYCLE>1&&(this.avcHeaderLogCount=0)}},{key:"parseSEIFrame",value:function(e,t){e.readUByte();for(var i=0,r=0,s=0,o=!1;!o&&e.bytesAvailable>1;){r=0;do{i=e.readUByte(),r+=i}while(255===i);s=0;do{i=e.readUByte(),s+=i}while(255===i);if((5===r||19===r)&&s>=this.SEI_UUID.length&&e.data.length>=s){o=!0;for(var n=[],u=[],c=this.SEI_UUID.length,l=s-this.SEI_UUID.length;c--;)n.push(e.readUByte());if(n.toString()===this.SEI_UUID.toString()){for(;l--;)u.push(e.readUByte());var h=void 0,d=a.default.utf8ByteArrayToString(u);try{h=JSON.parse(d)||{}}catch(e){h={}}h.wstime=90*t/9e4,this.handler&&this.handler.onSEIParsingData(h)}}else if(s<e.bytesAvailable)for(var f=0;f<s;f++)e.readUByte()}}},{key:"parseAudioTag",value:function(e,t){var i=["Linear PCM, platform endian","ADPCM","MP3","Linear PCM, little endian","Nellymoser 16-kHz mono","Nellymoser 8-kHz mono","Nellymoser","G.711 A-law logarithmic PCM","G.711 mu-law logarithmic PCM","reserved","AAC","Speex","MP3 8-Khz","Device-specific sound"],r=["5.5-kHz","11-kHz","22-kHz","44-kHz"],s=(240&e[0])>>>4;return t=t||{},t.soundFormat=i[s],t.soundRate=r[(12&e[0])>>>2],t.soundSize=(32&e[0])>>>1?"16-bit":"8-bit",t.soundType=1&e[0]?"Stereo":"Mono",10===s?this.parseAACTag(e.subarray(1),t):t}},{key:"parseAACTag",value:function(e,t){var i=["AAC Sequence Header","AAC Raw"];if(t=t||{},t.aacPacketType=i[e[0]],this.isDebugLevel>0&&u.logger.log(e[0]+", FLVParser.parseAACTag timestamp = "+t.timestamp),1===e[0]){0!==t.timestamp&&(this.hasAudio=!0),-1!==this.aacTrack.startDts&&t.timestamp>=this.aacTrack.startDts+this.bufLen&&(this.aacTrack.endDts=t.timestamp,this.isDebugLevel>0&&u.logger.log("FLVParser.parseAACTag, ready to remux by startDts = "+this.aacTrack.startDts+", endDts = "+this.aacTrack.endDts),this.remux(),this.bufLen=this.config.normalBufferLen),-1===this.aacTrack.startDts&&(this.aacTrack.startDts=t.timestamp);var r={unit:e.subarray(1),pts:90*t.timestamp,dts:90*t.timestamp,ts:t.timestamp};this.aacTrack.samples.push(r),this.aacTrack.endDts=t.timestamp,this.aacTrack.len+=r.unit.length}else if(0===e[0]){var s=this.getAdtsConfig(e.subarray(1),null);this.audioCodec=s.codec,this.audioConfig=s.config,this.audioSampleRate=s.samplerate,this.audioChannelCount=s.channelCount,this._parserError&&(this._parserError.lastAudioConfig=s.config)}else u.logger.error("parseAACTag error, type = "+e[0])}},{key:"getAdtsConfig",value:function(e,t){var i=void 0,r=void 0,s=void 0,o=void 0,n=void 0,a=navigator.userAgent.toLowerCase(),c=[96e3,88200,64e3,48e3,44100,32e3,24e3,22050,16e3,12e3,11025,8e3,7350];return i=(248&e[0])>>>3,r=(7&e[0])<<1|e[1]>>>7,o=(120&e[1])>>3,-1!==a.indexOf("firefox")?r>=6?(i=5,n=new Array(4),s=r-3):(i=2,n=new Array(2),s=r):-1!==a.indexOf("android")?(i=2,n=new Array(2),s=r):(i=5,n=new Array(4),t&&(-1!==t.indexOf("mp4a.40.29")||-1!==t.indexOf("mp4a.40.5"))||!t&&r>=6?s=r-3:((t&&-1!==t.indexOf("mp4a.40.2")&&r>=6&&1===o||!t&&1===o)&&(i=2,n=new Array(2)),s=r)),n[0]=i<<3,n[0]|=(14&r)>>1,n[1]|=(1&r)<<7,n[1]|=o<<3,5===i&&(n[1]|=(14&s)>>1,n[2]=(1&s)<<7,n[2]|=8,n[3]=0),u.logger.log("FLVParser.parseADTSConfig, audioCodec=mp4a.40."+i+" samplerate="+c[r]+" channel="+o+" exIndex="+s+" config="+n),{config:n,channelCount:o,codec:"mp4a.40."+i,samplerate:c[r]}}},{key:"remux",value:function(){var e=this.avcTrack,t=this.aacTrack;this.hasVideo||(this.avcTrack.startDts=-1);var i=e.startDts,r=e.endDts;-1===i&&(i=t.startDts,r=t.endDts);var s={type:"audio",id:2,sequenceNumber:0,samples:[],len:0,duration:0,startDts:-1,endDts:0};if(s.config=this.audioConfig,s.timescale=this.config.timescale,s.channelCount=this.audioChannelCount,s.audiosamplerate=this.audioSampleRate,s.codec=""===this.audioCodec?"mp4a.40.5":this.audioCodec,t.samples.length)for(var o=t.samples,n=o[0];n.ts<r;){if(n=o.shift(),s.samples.push(n),s.len+=n.unit.length,this.aacTrack.len-=n.unit.length,-1===s.startDts&&(s.startDts=n.ts),s.endDts=n.ts,0===o.length){this.resetAacTrack();break}n=o[0],t.startDts=n.ts,s.endDts=n.ts}if(s.duration=(s.endDts-s.startDts)/1e3,e.duration=(this.avcTrack.endDts-this.avcTrack.startDts)/1e3,this.isFirstRemux&&(this.isFirstRemux=!1,u.logger.log("FLVParser.remux, hasAudio = "+this.hasAudio+", hasVideo = "+this.hasVideo),u.logger.log("FLVParser.remux, aacTrack["+s.startDts+", "+s.endDts+"], avcTrack["+e.startDts+", "+e.endDts+"]"),this.initRender(s,e)),!this.hasAudioVideo(s,e))return void u.logger.log("FLVParser.remux, reset audio/video track");this.isDebugLevel>0&&u.logger.log("FLVParser.remux, aacTrack["+s.startDts+", "+s.endDts+"], avcTrack["+e.startDts+", "+e.endDts+"]"),this.handler&&this.handler.parseToRemux(s,e,0,!0),this.resetAvcTrack()}},{key:"initRender",value:function(e,t){0===e.endDts&&-1===e.startDts&&(e.config=void 0),0===t.endDts&&-1===t.startDts&&(this.avcTrack.samples=[])}},{key:"hasAudioVideo",value:function(e,t){var i="",r=!1;return this.hasAudio&&0===e.endDts&&-1===e.startDts&&(r=!0,i="pre has audio, but current no audio data coming."),!r&&this.hasVideo&&(0===t.endDts&&-1===t.startDts||0===t.endDts&&0===t.startDts)&&(r=!0,i="pre has video, but current no video data coming."),r?(u.logger.log(i),this.resetAacTrack(),this.resetAvcTrack(),this._audioVideoSwitch++,this._audioVideoSwitch>3&&this._parserError&&this._parserError.audioVideoSwitchChange(i),!1):(this._audioVideoSwitch=0,!0)}},{key:"parseGenericTag",value:function(e){return{tagType:this.tagTypes[e[0]],dataSize:e[1]<<16|e[2]<<8|e[3],timestamp:e[7]<<24|e[4]<<16|e[5]<<8|e[6],streamID:e[8]<<16|e[9]<<8|e[10]}}},{key:"parseFlvTag",value:function(e){if(!this._parserError.isEnded){var t=this.parseGenericTag(e);switch(e[0]){case 8:this.parseAudioTag(e.subarray(this.FLV_TAG_HEADER_LEN),t);break;case 9:this.parseVideoTag(e.subarray(this.FLV_TAG_HEADER_LEN),t);break;case 18:u.logger.log("FLVParser.parseFlvTag, receive metadata tag."),this.parseScriptTag(e.subarray(this.FLV_TAG_HEADER_LEN))}return t}}},{key:"parseScriptTag",value:function(e){var t=0;if(e[0]===this.AMF_DATA_TYPE_STRING){var i=e[1]<<8|e[2],r=a.default.Uint8ArrayToString(e.subarray(3,3+i));if(10===i&&"onMetaData"===r&&!((t+=3+i)>=e.length)){if(e[t]!==this.AMF_DATA_TYPE_ECMA_ARRAY)return void u.logger.debug("script tag data type not AMF_DATA_TYPE_ECMA_ARRAY");t+=1,this.processArray(e.subarray(t),!0)}}}},{key:"processArray",value:function(e,t){var i=0,r=e[i]<<24|e[i+1]<<16|e[i+2]<<8|e[i+3];i+=4;for(var s=0;s<r;s++){var o=void 0,n=void 0;t&&(o=e[i]<<8|e[i+1],i+=2,n=a.default.Uint8ArrayToString(e.subarray(i,i+o)),i+=o),n===this.keyframes.keyframesName&&(this.keyframes.parsingKeyframes=!0);var u=this.processScriptType(e.subarray(i));this.keyframes.parsingKeyframes&&(this.keyframes.parsingTimes?this.keyframes.times.push(u.value):this.keyframes.parsingFilePositions&&this.keyframes.filepositions.push(u.value)),n===this.keyframes.keyframesName&&(this.keyframes.parsingKeyframes=!1),"duration"===n&&u.value&&u.value>0&&this.handler&&this.handler.parseToSetMSEDuration(u.value),i+=u.len}return i}},{key:"processScriptType",value:function(e){var t=e[0],i=1,r=void 0,s={endOfData:!1};switch(t){case this.SCRIPTTYPE.NUMBER:var o=new Uint8Array(e.subarray(1,9));r=new DataView(o.buffer).getFloat64(0),i+=8;break;case this.SCRIPTTYPE.BOOLEAN:r=e[1],i+=1;break;case this.SCRIPTTYPE.STRING:var n=e[1]<<8|e[2];i+=2,r=a.default.Uint8ArrayToString(e.subarray(3,3+n)),i+=n;break;case this.SCRIPTTYPE.OBJECT:i+=this.processScriptDataObject(e.subarray(1));break;case this.SCRIPTTYPE.MOVIE_CLIP:var u=e[1]<<8|e[2];i+=2,r=a.default.Uint8ArrayToString(e.subarray(3,3+u)),i+=u;break;case this.SCRIPTTYPE.NULL:case this.SCRIPTTYPE.UNDEFINED:break;case this.SCRIPTTYPE.REFERENCE:r=e[1]<<8|e[2],i+=2;break;case this.SCRIPTTYPE.ECMA_ARRAY:i+=this.processArray(e.subarray(1),!0);break;case this.SCRIPTTYPE.END_OF_DATA:s.endOfData=!0,i+=3;break;case this.SCRIPTTYPE.STRICT_ARRAY:i+=this.processArray(e.subarray(1),!1);break;case this.SCRIPTTYPE.DATE:var c=new Uint8Array(e.subarray(1,9)),l=new DataView(c.buffer).getFloat64(0);i+=8;var h=e[9]<<8|e[10];i+=2,r={dateTime:l,localDateTimeOffset:h};break;case this.SCRIPTTYPE.LONG_STRING:var d=e[1]<<24|e[2]<<16|e[3]<<8|e[4];i+=4,r=a.default.Uint8ArrayToString(e.subarray(5,5+d)),i+=d}return s.type=t,s.value=r,s.len=i,s}},{key:"processScriptDataObject",value:function(e){var t=void 0,i=0;do{var r=e[i]<<8|e[i+1],s=void 0;if(i+=2,s=a.default.Uint8ArrayToString(e.subarray(i,i+r)),i+=r,this.keyframes.parsingKeyframes&&(s===this.keyframes.timesName?this.keyframes.parsingTimes=!0:s===this.keyframes.filepositionsName&&(this.keyframes.parsingFilePositions=!0)),t=this.processScriptType(e.subarray(i)),this.keyframes.parsingKeyframes&&(s===this.keyframes.timesName?this.keyframes.parsingTimes=!1:s===this.keyframes.filepositionsName&&(this.keyframes.parsingFilePositions=!1)),i+=t.len,t.type<0||t.type>12){u.logger.error("FLVParser.processScriptDataObject error: type = "+t.type);break}u.logger.debug("[ScriptDataObject]keynameStr = "+s+", type = "+t.type+", value = "+t.value+", len = "+t.len+", end = "+t.endOfData)}while(!t.endOfData);return i}},{key:"parseFlv",value:function(e){var t=0,i=void 0,r=void 0,s=void 0;for(this.hasFlvHeaderParsed||(t+=this.FLV_HEADER_LEN,this.hasFlvHeaderParsed=!0);t<e.byteLength;){if(t+this.FLV_PREV_TAG_SIZE_LEN+this.FLV_TAG_HEADER_LEN>=e.byteLength){this.preTagData=e.subarray(t);break}if(t+=this.FLV_PREV_TAG_SIZE_LEN,r=e[t+1]<<16,r|=e[t+2]<<8,r|=e[t+3],i=r+this.FLV_TAG_HEADER_LEN,t+i>e.byteLength){this.preTagData=e.subarray(t-this.FLV_PREV_TAG_SIZE_LEN);break}r>0&&(s=e.subarray(t,t+i),this.parseFlvTag(s)),t+=i}}},{key:"getKeyframeByTime",value:function(e){var t=0,i=-1;if(!this.keySampleTimeArray.length)return-1;var r=this.keySampleTimeArray.length-1;for(t=0;t<r;t++)if(e>=this.keySampleTimeArray[t]&&e<=this.keySampleTimeArray[t+1]){i=t+1;break}return i>0&&i<this.keySampleTimeArray.length?this.keySampleTimeArray[i]:-1}},{key:"getKeyframePosByTime",value:function(e){var t={time:0,fileposition:0},i=0,r=0;if(this.keyframes.times.length){for(i=0;i<this.keyframes.times.length&&e>=this.keyframes.times[i];i++)t.time=this.keyframes.times[i],r=i;r<=this.keyframes.filepositions.length&&(t.fileposition=this.keyframes.filepositions[r])}return t}},{key:"getKeyframePosWithPreTagLenByTime",value:function(e){var t=this.getKeyframePosByTime(e);return t.fileposition&&(t.fileposition-=this.FLV_PREV_TAG_SIZE_LEN),t}},{key:"addPreTagData",value:function(e){var t=e;return this.preTagData&&(t=this.concatenate(Uint8Array,this.preTagData,e),this.preTagData=null),t}},{key:"concatenate",value:function(e){for(var t=0,i=arguments.length,r=Array(i>1?i-1:0),s=1;s<i;s++)r[s-1]=arguments[s];var o=!0,n=!1,a=void 0;try{for(var u,c=r[Symbol.iterator]();!(o=(u=c.next()).done);o=!0){t+=u.value.length}}catch(e){n=!0,a=e}finally{try{!o&&c.return&&c.return()}finally{if(n)throw a}}var l=new e(t),h=0,d=!0,f=!1,_=void 0;try{for(var v,p=r[Symbol.iterator]();!(d=(v=p.next()).done);d=!0){var m=v.value;l.set(m,h),h+=m.length}}catch(e){f=!0,_=e}finally{try{!d&&p.return&&p.return()}finally{if(f)throw _}}return l}},{key:"debugLogLevel",value:function(e){var t=parseInt(e.level);isNaN(t)?this.isDebugLevel=0:this.isDebugLevel=t}}]),e}();t.default=f},function(e,t,i){"use strict";function r(e){return e&&e.__esModule?e:{default:e}}function s(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}Object.defineProperty(t,"__esModule",{value:!0});var o=function(){function e(e,t){for(var i=0;i<t.length;i++){var r=t[i];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}return function(t,i,r){return i&&e(t.prototype,i),r&&e(t,r),t}}(),n=i(16),a=i(81),u=r(a),c=i(80),l=r(c),h=function(){function e(t,i){s(this,e),this.handler=t,this.ISGenerated=!1,this.PES2MP4SCALEFACTOR=4,this.PES_TIMESCALE=9e4,this.MP4_TIMESCALE=this.PES_TIMESCALE/this.PES2MP4SCALEFACTOR,this.config={maxBufferHole:.3,maxSeekHole:2,stretchShortVideoTrack:!1},this.isDebugLevel=0,this.enableAudioStrategy=!("false"===String((i||{}).enableAudioStrategy))}return o(e,[{key:"destroy",value:function(){this.reset(),this._initPTS=this._initDTS=void 0,this.ISGenerated=!1}},{key:"reset",value:function(){this.nextAacPts=this.nextAvcDts=void 0}},{key:"remux",value:function(e,t,i,r){if(this.ISGenerated||this.generateIS(e,t,i),this.ISGenerated){var s=void 0,o=void 0;if(e.samples.length){if(o=this.remuxAudio(e,i,r),t.samples.length){var n=void 0;o&&(n=o.endPTS-o.startPTS),s=this.remuxVideo(t,i,r,n)}this._onDataHandler(o),this._onDataHandler(s)}else t.samples.length&&(s=this.remuxVideo(t,i,r)),this._onDataHandler(s)}this.handler&&this.handler.remuxToFragParsed()}},{key:"generateIS",value:function(e,t,i){var r={},s=e.samples,o=t.samples,a=this.PES_TIMESCALE,c=void 0===this._initPTS,l=void 0,h=void 0;if(c&&(l=h=1/0),e.config){if(e.timescale=this.timescale,e.timescale*e.duration>Math.pow(2,32)){e.timescale=this.timescale/function e(t,i){return i?e(i,t%i):t}(e.audiosamplerate,1024)}n.logger.log("audio mp4 timescale: "+e.timescale),r.audio={container:"audio/mp4",audioCodec:e.codec,audioMoov:u.default.initSegment([e]),audioChannelCount:e.channelCount},c&&(l=h=s.length?s[0].pts-a*i:0)}t.sps&&t.pps&&o.length&&(t.timescale=this.timescale,r.video={container:"video/mp4",videoCodec:t.codec,videoMoov:u.default.initSegment([t]),videoWidth:t.width,videoHeight:t.height},c&&(l=Math.min(l,o[0].pts-a*i),h=Math.min(h,o[0].dts-a*i))),Object.keys(r).length?(this.handler&&this.handler.remuxToFragParsingInitSegment(r),this.ISGenerated=!0,c&&(this._initPTS=l,this._initDTS=h)):n.logger.error("MP4Remuxer.generateIS error")}},{key:"remuxVideo",value:function(e,t,i,r){var s=8,o=this.PES_TIMESCALE,a=this.PES2MP4SCALEFACTOR,c=void 0,l=void 0,h=void 0,d=void 0,f=void 0,_=void 0,v=void 0,p=e.samples,m=[],g=void 0;g=i?this.nextAvcDts:t<=0?this.nextAvcDts:t*o;for(var y=p[0].dts,E=p[0].dts,S=p[0].pts,R=p[0].pts,T=1;T<p.length;T++){var C=p[T];y=y<=C.dts?y:C.dts,E=E>=C.dts?E:C.dts,S=S<=C.pts?S:C.pts,R=R>=C.pts?R:C.pts}f=Math.max(this._PTSNormalize(y,g)-this._initDTS,0),d=Math.max(this._PTSNormalize(S,g)-this._initDTS,0);var b=Math.round((f-g)/90);i&&b&&b>1&&(f=g,p[0].dts=f+this._initDTS,d=Math.max(d-b,g),p[0].pts=d+this._initDTS),v=Math.max(this._PTSNormalize(E,g)-this._initDTS,0),_=Math.max(this._PTSNormalize(R,g)-this._initDTS,0),_=Math.max(_,v);var P=navigator.vendor,O=navigator.userAgent,A=P&&P.indexOf("Apple")>-1&&O&&!O.match("CriOS");A&&(c=Math.round((v-f)/(a*(p.length-1))));for(var k=0;k<p.length;k++){var I=p[k];A?I.dts=f+k*a*c:(I.dts=Math.max(this._PTSNormalize(I.dts,g)-this._initDTS,f),I.dts=Math.round(I.dts/a)*a),I.pts=Math.max(this._PTSNormalize(I.pts,g)-this._initDTS,I.dts),I.pts=Math.round(I.pts/a)*a}l=new Uint8Array(e.len+4*e.nbNalu+8);var w=new DataView(l.buffer);w.setUint32(0,l.byteLength),l.set(u.default.types.mdat,4);for(var M=0;M<p.length;M++){for(var L=p[M],N=0,D=void 0;L.units.units.length;){var x=L.units.units.shift();w.setUint32(s,x.data.byteLength),s+=4,l.set(x.data,s),s+=x.data.byteLength,N+=4+x.data.byteLength}if(A)D=Math.max(0,c*Math.round((L.pts-L.dts)/(a*c)));else{if(M<p.length-1)c=p[M+1].dts-L.dts;else{var U=this.config,V=L.dts-p[M>0?M-1:M].dts;if(U.stretchShortVideoTrack){var G=U.maxBufferHole,H=U.maxSeekHole,B=Math.floor(Math.min(G,H)*o),j=(r?d+r*o:this.nextAacPts)-L.pts;j>B?(c=j-V,c<0&&(c=V),n.logger.log("It is approximately "+j/90+" ms to the next segment; using duration "+c/90+" ms for the last video frame.")):c=V}else c=V}c/=a,D=Math.round((L.pts-L.dts)/a)}m.push({size:N,duration:c,cts:D,flags:{isLeading:0,isDependedOn:0,hasRedundancy:0,degradPrio:0,dependsOn:L.key?2:1,isNonSync:L.key?0:1}})}if(this.nextAvcDts=v+c*a,e.len=0,e.nbNalu=0,m.length&&navigator.userAgent.toLowerCase().indexOf("chrome")>-1){var F=m[0].flags;F.dependsOn=2,F.isNonSync=0}return e.samples=m,h=u.default.moof(e.sequenceNumber++,f/a,e),e.samples=[],{moof:h,mdat:l,startPTS:d/o,endPTS:(_+a*c)/o,startDTS:f/o,endDTS:this.nextAvcDts/o,type:"video",nb:m.length}}},{key:"remuxAudio",value:function(e,t,i){var r=this.PES_TIMESCALE,s=e.timescale,o=r/s,a=1024*e.timescale/e.audiosamplerate,c=void 0,h=8,d=void 0,f={},_=void 0,v=void 0,p=void 0,m=void 0,g=void 0,y=void 0,E=void 0,S=void 0,R=void 0,T=void 0,C=[];e.samples.sort(function(e,t){return e.pts-t.pts});var b=e.samples,P=i?this.nextAacPts:t*r;if(this.enableAudioStrategy)for(var O=this._PTSNormalize(b[0].pts-this._initPTS,P),A=a*o,k=O+A,I=1;I<b.length;){var w=b[I],M=this._PTSNormalize(w.pts-this._initPTS,P),L=M-k;if(L<-.5*A)this.isDebugLevel>0&&n.logger.log("Dropping frame due to "+Math.abs(L/90)+" ms overlap."),b.splice(I,1),e.len-=w.unit.length;else if(L>.5*A){var N=Math.round(L/A);this.isDebugLevel>0&&n.logger.log("Injecting "+N+" frame"+(N>1?"s":"")+" of missing audio due to "+Math.round(L/90)+" ms gap.");for(var D=0;D<N;D++){var x=b[I-1].pts+A,U=l.default.getSilentFrame(e.channelCount);U||(n.logger.log("Unable to get silent frame for given audio codec; duplicating last frame instead."),U=Array.prototype.slice.call(w.unit,0)),b.splice(I,0,{unit:U,pts:x,dts:x}),e.len+=U.length,I+=1}k+=(N+1)*A,w.pts=b[I-1].pts+A,I+=1}else Math.abs(L)>.1*A&&this.isDebugLevel>0&&n.logger.log("Invalid frame delta "+(M-k+A)+" at PTS "+Math.round(M/90)+" (should be "+A+")."),k+=A,w.pts=b[I-1].pts+A,I+=1}for(;b.length;){if(d=b.shift(),_=d.unit,E=d.pts-this._initDTS,S=d.dts-this._initDTS,void 0!==y)R=this._PTSNormalize(E,y),T=this._PTSNormalize(S,y),f.duration=(T-y)/o;else{R=this._PTSNormalize(E,P),T=this._PTSNormalize(S,P);var V=Math.round(1e3*(R-P)/r);if(i&&V){if(V>0);else if(V<-12){n.logger.log(-V+" ms overlapping between AAC samples detected, drop frame"),e.len-=_.byteLength;continue}R=T=P}if(m=Math.max(0,R),g=Math.max(0,T),!(e.len>0))return null;v=new Uint8Array(e.len+8),c=new DataView(v.buffer),c.setUint32(0,v.byteLength),v.set(u.default.types.mdat,4)}v.set(_,h),h+=_.byteLength,f={size:_.byteLength,cts:0,duration:0,flags:{isLeading:0,isDependedOn:0,hasRedundancy:0,degradPrio:0,dependsOn:1}},C.push(f),y=T}var G=0,H=C.length;if(H>=2&&(G=C[H-2].duration,f.duration=G),H){this.nextAacPts=R+o*G,e.len=0,e.samples=C,p=u.default.moof(e.sequenceNumber++,g/o,e),e.samples=[];return{moof:p,mdat:v,startPTS:m/r,endPTS:this.nextAacPts/r,startDTS:g/r,endDTS:(T+o*G)/r,type:"audio",nb:H}}return null}},{key:"remuxEmptyAudio",value:function(e,t,i,r){n.logger.log("MP4Remuxer.remuxEmptyAudio");var s=this.PES_TIMESCALE,o=e.timescale?e.timescale:e.audiosamplerate,a=s/o,u=r.startDTS*s,c=r.endDTS*s,h=1024*a,d=Math.ceil((c-u)/h),f=l.default.getSilentFrame(e.channelCount);if(!f)return void n.logger.trace("Unable to remuxEmptyAudio since we were unable to get a silent frame for given audio codec!");for(var _=[],v=0;v<d;v++){var p=u+v*h;_.push({unit:Array.prototype.slice.call(f,0),pts:p,dts:p}),e.len+=f.length}if(e.samples=_,e.samples&&e.samples.length){var m=this.remuxAudio(e,t,i);this._onDataHandler(m)}}},{key:"_PTSNormalize",value:function(e,t){var i=void 0;if(void 0===t)return e;for(i=t<e?-8589934592:8589934592;Math.abs(e-t)>4294967296;)e+=i;return e}},{key:"_onDataHandler",value:function(e){e&&this.handler&&this.handler.remuxToFragParsingData(e)}},{key:"debugLogLevel",value:function(e){var t=parseInt(e.level);isNaN(t)?this.isDebugLevel=0:this.isDebugLevel=t}},{key:"passthrough",get:function(){return!1}},{key:"timescale",get:function(){return this.MP4_TIMESCALE}}]),e}();t.default=h},function(e,t,i){"use strict";function r(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}Object.defineProperty(t,"__esModule",{value:!0});var s=function(){function e(e,t){for(var i=0;i<t.length;i++){var r=t[i];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}return function(t,i,r){return i&&e(t.prototype,i),r&&e(t,r),t}}(),o=function(){function e(){r(this,e)}return s(e,null,[{key:"getUintMax",value:function(){return 4294967295}},{key:"Uint8ArrayToString",value:function(e){for(var t="",i=0;i<e.length;i++)t+=String.fromCharCode(e[i]);return t}},{key:"formatWsUrl",value:function(e){var t=e.toString();return 0===t.indexOf("ws")&&(t="http"+t.substring(2)),0===t.indexOf("wss")&&(t="https"+t.substring(3)),t}},{key:"utf8ByteArrayToString",value:function(e){for(var t=[],i=0,r=0,s=void 0,o=void 0,n=void 0,a=void 0,u=void 0;i<e.length;)if((s=e[i++])<128)t[r++]=String.fromCharCode(s);else if(s>191&&s<224){var c=e[i++];t[r++]=String.fromCharCode((31&s)<<6|63&c)}else s>239&&s<365?(o=e[i++],n=e[i++],a=e[i++],u=((7&s)<<18|(63&o)<<12|(63&n)<<6|63&a)-65536,t[r++]=String.fromCharCode(55296+(u>>10)),t[r++]=String.fromCharCode(56320+(1023&u))):(o=e[i++],n=e[i++],t[r++]=String.fromCharCode((15&s)<<12|(63&o)<<6|63&n));return t.join("")}},{key:"stringToUtf8ByteArray",value:function(e){for(var t=void 0,i=[],r=0,s=0;s<e.length;s++)t=e.charCodeAt(s),t<128?i[r++]=t:t<2048?(i[r++]=t>>6|192,i[r++]=63&t|128):55296==(64512&t)&&s+1<e.length&&56320==(64512&e.charCodeAt(s+1))?(t=65536+((1023&t)<<10)+(1023&e.charCodeAt(++s)),i[r++]=t>>18|240,i[r++]=t>>12&63|128,i[r++]=t>>6&63|128,i[r++]=63&t|128):(i[r++]=t>>12|224,i[r++]=t>>6&63|128,i[r++]=63&t|128);return i}}]),e}();t.default=o},function(e,t,i){"use strict";function r(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}Object.defineProperty(t,"__esModule",{value:!0});var s=function(){function e(e,t){for(var i=0;i<t.length;i++){var r=t[i];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}return function(t,i,r){return i&&e(t.prototype,i),r&&e(t,r),t}}(),o=i(8),n=i(16),a=i(78),u=function(e){return e&&e.__esModule?e:{default:e}}(a),c=function(){function e(t,i){r(this,e),this.url=i,this.handler=t,this.isCloseAcive=!1,this.wsLoader=void 0,this.xhrLoader=void 0,this.socketId=parseInt(1e6*Math.random()),this.onWsOpen=this.onWsOpenHandler.bind(this),this.onWsError=this.onWsErrorHandler.bind(this),this.onWsClose=this.onWsCloseHandler.bind(this),this.onWsData=this.onWsMessageHandler.bind(this)}return s(e,[{key:"destroy",value:function(){this.wsLoader&&(this.isCloseAcive=!0,this.wsLoader.close(),this.wsLoader=void 0),this.removeXHRLoader()}},{key:"startLoad",value:function(){n.logger.log("XHRLoader.start: "+this.url),this.startXHRLoad(this.url)}},{key:"startWSLoad",value:function(e){this.isCloseAcive=!1,this.wsLoader=new WebSocket(e),this.wsLoader.binaryType="arraybuffer",this.wsLoader.onopen=this.onWsOpen,this.wsLoader.onerror=this.onWsError,this.wsLoader.onclose=this.onWsClose,this.wsLoader.onmessage=this.onWsData}},{key:"onWsErrorHandler",value:function(e){n.logger.warn("["+this.socketId+"], WebSocket.onerror:"+e.code)}},{key:"onWsOpenHandler",value:function(){this.isCloseAcive=!1,n.logger.log("["+this.socketId+"], WebSocket.onopen"),this.handler&&this.handler.observer&&this.handler.observer.trigger(o.PlayerEvent.MEDIA_EVENT,{type:o.PlayerMessage.SOCKET_OPEN,code:0,message:"websocket open"})}},{key:"onWsCloseHandler",value:function(e){if(n.logger.log("["+this.socketId+"], WebSocket.onclose isActive["+this.isCloseAcive+"]:"+e.code),!this.isCloseAcive)try{e&&e.currentTarget&&e.currentTarget.close(),this.handler&&this.handler.observer&&this.handler.observer.trigger(o.PlayerEvent.MEDIA_EVENT,{type:o.PlayerMessage.SOCKET_CLOSE,code:0,message:"websocket abnormal close"})}catch(e){}}},{key:"onWsMessageHandler",value:function(e){e.data instanceof ArrayBuffer&&this.handler.downloadToStream(e.data)}},{key:"initUrl",value:function(e){if(e){var t=e;return 0===e.indexOf("http:")?t="ws"+e.slice(4,e.length):0===e.indexOf("https:")&&(t="wss"+e.slice(5,e.length)),t}}},{key:"startXHRLoad",value:function(e){this.xhrLoader||(this.xhrLoader=new u.default(this.onXHRLoaderCallback.bind(this))),this.xhrLoader.start(e)}},{key:"removeXHRLoader",value:function(){this.xhrLoader&&(this.xhrLoader.stop(),this.xhrLoader=void 0)}},{key:"onXHRLoaderCallback",value:function(e){if(this.xhrLoader){var t=parseInt(e.code),i=this.xhrLoader.codes,r=e.message||"";if(n.logger.log("XHRLoader.response: "+r),t===i.NOTICE){var s=this.initUrl(this.url);this.startWSLoad(s)}else if(t===i.ERROR)this.handler&&this.handler.observer&&this.handler.observer.trigger(o.PlayerEvent.MEDIA_EVENT,{type:o.PlayerMessage.ERROR,code:0,message:r});else if(t===i.SUCCESS){var a=this.initUrl(r);this.startWSLoad(a)}else t===i.NETWORK&&this.handler&&this.handler.observer&&this.handler.observer.trigger(o.PlayerEvent.MEDIA_EVENT,{type:o.PlayerMessage.NETWORK,code:0,message:r});this.removeXHRLoader()}}}]),e}();t.default=c},function(e,t,i){"use strict";function r(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}Object.defineProperty(t,"__esModule",{value:!0});var s=function(){function e(e,t){for(var i=0;i<t.length;i++){var r=t[i];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}return function(t,i,r){return i&&e(t.prototype,i),r&&e(t,r),t}}(),o=function(){function e(t){r(this,e),this.url="",this.realUrl=void 0,this.isFirstLoad=!0,this.callback=t,this.xhrLoader=void 0,this.retryCount=0,this.retryCountLimit=3,this.retryTimeout=2e4,this.retryTimer=void 0,this.CODES={NETWORK:1,SUCCESS:0,NOTICE:-1,ERROR:-2}}return s(e,[{key:"start",value:function(e){this.stop();var t=void 0;t="undefined"!=typeof XDomainRequest?this.xhrLoader=new XDomainRequest:this.xhrLoader=new XMLHttpRequest,t.onerror=this.xhrLoadError.bind(this),t.onloadend=this.xhrLoadEnd.bind(this),t.onprogress=this.xhrLoadProgress.bind(this),this.retryTimer=window.setTimeout(this.xhrLoadTimeout.bind(this),this.retryTimeout),this.url=e;var i=e+(-1===e.indexOf("?")?"?":"&");i+="randomNum="+Math.random().toFixed(6).substring(2),t.open("GET",i,!0),t.send()}},{key:"stop",value:function(){this.retryTimer&&(window.clearTimeout(this.retryTimer),this.retryTimer=void 0),this.xhrLoader&&(this.xhrLoader.onloadend=void 0,this.xhrLoader.onprogress=void 0,this.xhrLoader.onerror=void 0,this.xhrLoader.abort()),this.realUrl=void 0,this.xhrLoader=void 0}},{key:"response",value:function(e,t){this.callback&&this.callback({code:e,message:t})}},{key:"xhrLoadEnd",value:function(e){if(!e||!e.currentTarget)return this.stop(),void this.response(this.CODES.NOTICE,"xhrLoadEnd response is null");var t=e.currentTarget.status;t>=200&&t<300||304===t?this.response(this.CODES.NOTICE,"xhrLoadEnd success"):this.response(this.CODES.ERROR,"can not find stream, maybe stream is stop"),this.stop()}},{key:"xhrLoadError",value:function(e){if(!e||!e.currentTarget)return this.stop(),void this.response(this.CODES.NOTICE,"xhrLoadError response is null");this.response(this.CODES.ERROR,"get stream file fail"),this.stop()}},{key:"xhrLoadTimeout",value:function(){this.stop(),this.retryCount++,this.retryCount<this.retryCountLimit?this.start(this.url):this.response(this.CODES.NETWORK,"xhrLoad timeout")}},{key:"xhrLoadProgress",value:function(e){if(!e||!e.currentTarget)return this.stop(),void this.response(this.CODES.NOTICE,"xhrLoadProgress response is null");if(!this.realUrl){var t=e.currentTarget.responseURL;if(t&&t.length>0){this.isUrlEqual(t)?this.response(this.CODES.NOTICE,"url not 302 redirect"):(this.realUrl=t,this.response(this.CODES.SUCCESS,t)),this.stop()}else this.stop(),this.isFirstLoad?(this.isFirstLoad=!1,this.start(this.url)):this.response(this.CODES.NETWORK,"get stream file url is empty")}}},{key:"isUrlEqual",value:function(e){if(-1===e.indexOf("?"))return this.url===e;for(var t=e.split("?"),i=t[1].split("&"),r=0;r<i.length;r++){if("randomNum"===i[r].split("=")[0]){i.splice(r,1);break}}var s=t[0];if(!i.length)return this.url===s;for(var o=0;o<i.length;o++)s+=0===o?"?"+i[o]:"&"+i[o];return this.url===s}},{key:"codes",get:function(){return this.CODES}}]),e}();t.default=o},function(e,t,i){"use strict";function r(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}Object.defineProperty(t,"__esModule",{value:!0});var s=function(){function e(e,t){for(var i=0;i<t.length;i++){var r=t[i];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}return function(t,i,r){return i&&e(t.prototype,i),r&&e(t,r),t}}(),o=i(82),n=function(){function e(t){r(this,e),this.data=t,this.bytesAvailable=this.data.byteLength,this.word=0,this.bitsAvailable=0}return s(e,[{key:"loadWord",value:function(){var e=this.data.byteLength-this.bytesAvailable,t=new Uint8Array(4),i=Math.min(4,this.bytesAvailable);if(0===i)throw new Error("no bytes available");t.set(this.data.subarray(e,e+i)),this.word=new DataView(t.buffer).getUint32(0),this.bitsAvailable=8*i,this.bytesAvailable-=i}},{key:"skipBits",value:function(e){var t;this.bitsAvailable>e?(this.word<<=e,this.bitsAvailable-=e):(e-=this.bitsAvailable,t=e>>3,e-=t>>3,this.bytesAvailable-=t,this.loadWord(),this.word<<=e,this.bitsAvailable-=e)}},{key:"readBits",value:function(e){var t=Math.min(this.bitsAvailable,e),i=this.word>>>32-t;return e>32&&o.logger.error("Cannot read more than 32 bits at a time"),this.bitsAvailable-=t,this.bitsAvailable>0?this.word<<=t:this.bytesAvailable>0&&this.loadWord(),t=e-t,t>0?i<<t|this.readBits(t):i}},{key:"skipLZ",value:function(){var e;for(e=0;e<this.bitsAvailable;++e)if(0!=(this.word&2147483648>>>e))return this.word<<=e,this.bitsAvailable-=e,e;return this.loadWord(),e+this.skipLZ()}},{key:"skipUEG",value:function(){this.skipBits(1+this.skipLZ())}},{key:"skipEG",value:function(){this.skipBits(1+this.skipLZ())}},{key:"readUEG",value:function(){var e=this.skipLZ();return this.readBits(e+1)-1}},{key:"readEG",value:function(){var e=this.readUEG();return 1&e?1+e>>>1:-1*(e>>>1)}},{key:"readBoolean",value:function(){return 1===this.readBits(1)}},{key:"readUByte",value:function(){return this.readBits(8)}},{key:"readUShort",value:function(){return this.readBits(16)}},{key:"readUInt",value:function(){return this.readBits(32)}},{key:"skipScalingList",value:function(e){var t,i,r=8,s=8;for(t=0;t<e;t++)0!==s&&(i=this.readEG(),s=(r+i+256)%256),r=0===s?r:s}},{key:"readSPS",value:function(){var e,t,i,r,s,o,n,a=0,u=0,c=0,l=0,h=1;if(this.readUByte(),e=this.readUByte(),this.readBits(5),this.skipBits(3),this.readUByte(),this.skipUEG(),100===e||110===e||122===e||244===e||44===e||83===e||86===e||118===e||128===e){var d=this.readUEG();if(3===d&&this.skipBits(1),this.skipUEG(),this.skipUEG(),this.skipBits(1),this.readBoolean())for(o=3!==d?8:12,n=0;n<o;n++)this.readBoolean()&&(n<6?this.skipScalingList(16):this.skipScalingList(64))}this.skipUEG();var f=this.readUEG();if(0===f)this.readUEG();else if(1===f)for(this.skipBits(1),this.skipEG(),this.skipEG(),t=this.readUEG(),n=0;n<t;n++)this.skipEG();if(this.skipUEG(),this.skipBits(1),i=this.readUEG(),r=this.readUEG(),s=this.readBits(1),0===s&&this.skipBits(1),this.skipBits(1),this.readBoolean()&&(a=this.readUEG(),u=this.readUEG(),c=this.readUEG(),l=this.readUEG()),this.readBoolean()&&this.readBoolean()){var _=void 0;switch(this.readUByte()){case 1:_=[1,1];break;case 2:_=[12,11];break;case 3:_=[10,11];break;case 4:_=[16,11];break;case 5:_=[40,33];break;case 6:_=[24,11];break;case 7:_=[20,11];break;case 8:_=[32,11];break;case 9:_=[80,33];break;case 10:_=[18,11];break;case 11:_=[15,11];break;case 12:_=[64,33];break;case 13:_=[160,99];break;case 14:_=[4,3];break;case 15:_=[3,2];break;case 16:_=[2,1];break;case 255:_=[this.readUByte()<<8|this.readUByte(),this.readUByte()<<8|this.readUByte()]}_&&(h=_[0]/_[1])}return{width:Math.ceil((16*(i+1)-2*a-2*u)*h),height:(2-s)*(r+1)*16-(s?2:4)*(c+l)}}},{key:"readSliceType",value:function(){return this.readUByte(),this.readUEG(),this.readUEG()}}]),e}();t.default=n},function(e,t,i){"use strict";function r(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}Object.defineProperty(t,"__esModule",{value:!0});var s=function(){function e(e,t){for(var i=0;i<t.length;i++){var r=t[i];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}return function(t,i,r){return i&&e(t.prototype,i),r&&e(t,r),t}}(),o=function(){function e(){r(this,e)}return s(e,null,[{key:"getSilentFrame",value:function(e){return 1===e?new Uint8Array([0,200,0,128,35,128]):2===e?new Uint8Array([33,0,73,144,2,25,0,35,128]):3===e?new Uint8Array([0,200,0,128,32,132,1,38,64,8,100,0,142]):4===e?new Uint8Array([0,200,0,128,32,132,1,38,64,8,100,0,128,44,128,8,2,56]):5===e?new Uint8Array([0,200,0,128,32,132,1,38,64,8,100,0,130,48,4,153,0,33,144,2,56]):6===e?new Uint8Array([0,200,0,128,32,132,1,38,64,8,100,0,130,48,4,153,0,33,144,2,0,178,0,32,8,224]):null}}]),e}();t.default=o},function(e,t,i){"use strict";function r(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}Object.defineProperty(t,"__esModule",{value:!0});var s=function(){function e(e,t){for(var i=0;i<t.length;i++){var r=t[i];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}return function(t,i,r){return i&&e(t.prototype,i),r&&e(t,r),t}}(),o=function(){function e(){r(this,e)}return s(e,null,[{key:"init",value:function(){e.types={avc1:[],avcC:[],btrt:[],dinf:[],dref:[],esds:[],ftyp:[],hdlr:[],mdat:[],mdhd:[],mdia:[],mfhd:[],minf:[],moof:[],moov:[],mp4a:[],mvex:[],mvhd:[],sdtp:[],stbl:[],stco:[],stsc:[],stsd:[],stsz:[],stts:[],tfdt:[],tfhd:[],traf:[],trak:[],trun:[],trex:[],tkhd:[],vmhd:[],smhd:[]};var t;for(t in e.types)e.types.hasOwnProperty(t)&&(e.types[t]=[t.charCodeAt(0),t.charCodeAt(1),t.charCodeAt(2),t.charCodeAt(3)]);var i=new Uint8Array([0,0,0,0,0,0,0,0,118,105,100,101,0,0,0,0,0,0,0,0,0,0,0,0,86,105,100,101,111,72,97,110,100,108,101,114,0]),r=new Uint8Array([0,0,0,0,0,0,0,0,115,111,117,110,0,0,0,0,0,0,0,0,0,0,0,0,83,111,117,110,100,72,97,110,100,108,101,114,0]);e.HDLR_TYPES={video:i,audio:r};var s=new Uint8Array([0,0,0,0,0,0,0,1,0,0,0,12,117,114,108,32,0,0,0,1]),o=new Uint8Array([0,0,0,0,0,0,0,0]);e.STTS=e.STSC=e.STCO=o,e.STSZ=new Uint8Array([0,0,0,0,0,0,0,0,0,0,0,0]),e.VMHD=new Uint8Array([0,0,0,1,0,0,0,0,0,0,0,0]),e.SMHD=new Uint8Array([0,0,0,0,0,0,0,0]),e.STSD=new Uint8Array([0,0,0,0,0,0,0,1]);var n=new Uint8Array([105,115,111,109]),a=new Uint8Array([97,118,99,49]),u=new Uint8Array([0,0,0,1]);e.FTYP=e.box(e.types.ftyp,n,u,n,a),e.DINF=e.box(e.types.dinf,e.box(e.types.dref,s))}},{key:"box",value:function(e){for(var t,i=Array.prototype.slice.call(arguments,1),r=8,s=i.length,o=s;s--;)r+=i[s].byteLength;for(t=new Uint8Array(r),t[0]=r>>24&255,t[1]=r>>16&255,t[2]=r>>8&255,t[3]=255&r,t.set(e,4),s=0,r=8;s<o;s++)t.set(i[s],r),r+=i[s].byteLength;return t}},{key:"hdlr",value:function(t){return e.box(e.types.hdlr,e.HDLR_TYPES[t])}},{key:"mdat",value:function(t){return e.box(e.types.mdat,t)}},{key:"mdhd",value:function(t,i){return i*=t,e.box(e.types.mdhd,new Uint8Array([0,0,0,0,0,0,0,2,0,0,0,3,t>>24&255,t>>16&255,t>>8&255,255&t,i>>24,i>>16&255,i>>8&255,255&i,85,196,0,0]))}},{key:"mdia",value:function(t){return e.box(e.types.mdia,e.mdhd(t.timescale,t.duration),e.hdlr(t.type),e.minf(t))}},{key:"mfhd",value:function(t){return e.box(e.types.mfhd,new Uint8Array([0,0,0,0,t>>24,t>>16&255,t>>8&255,255&t]))}},{key:"minf",value:function(t){return"audio"===t.type?e.box(e.types.minf,e.box(e.types.smhd,e.SMHD),e.DINF,e.stbl(t)):e.box(e.types.minf,e.box(e.types.vmhd,e.VMHD),e.DINF,e.stbl(t))}},{key:"moof",value:function(t,i,r){return e.box(e.types.moof,e.mfhd(t),e.traf(r,i))}},{key:"moov",value:function(t){for(var i=t.length,r=[];i--;)r[i]=e.trak(t[i]);return e.box.apply(null,[e.types.moov,e.mvhd(t[0].timescale,t[0].duration)].concat(r).concat(e.mvex(t)))}},{key:"mvex",value:function(t){for(var i=t.length,r=[];i--;)r[i]=e.trex(t[i]);return e.box.apply(null,[e.types.mvex].concat(r))}},{key:"mvhd",value:function(t,i){i*=t;var r=new Uint8Array([0,0,0,0,0,0,0,1,0,0,0,2,t>>24&255,t>>16&255,t>>8&255,255&t,i>>24&255,i>>16&255,i>>8&255,255&i,0,1,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,64,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,255,255,255,255]);return e.box(e.types.mvhd,r)}},{key:"sdtp",value:function(t){var i,r,s=t.samples||[],o=new Uint8Array(4+s.length);for(r=0;r<s.length;r++)i=s[r].flags,o[r+4]=i.dependsOn<<4|i.isDependedOn<<2|i.hasRedundancy;return e.box(e.types.sdtp,o)}},{key:"stbl",value:function(t){return e.box(e.types.stbl,e.stsd(t),e.box(e.types.stts,e.STTS),e.box(e.types.stsc,e.STSC),e.box(e.types.stsz,e.STSZ),e.box(e.types.stco,e.STCO))}},{key:"avc1",value:function(t){var i,r,s,o=[],n=[];for(i=0;i<t.sps.length;i++)r=t.sps[i],s=r.byteLength,o.push(s>>>8&255),o.push(255&s),o=o.concat(Array.prototype.slice.call(r));for(i=0;i<t.pps.length;i++)r=t.pps[i],s=r.byteLength,n.push(s>>>8&255),n.push(255&s),n=n.concat(Array.prototype.slice.call(r));var a=e.box(e.types.avcC,new Uint8Array([1,o[3],o[4],o[5],255,224|t.sps.length].concat(o).concat([t.pps.length]).concat(n))),u=t.width,c=t.height;return e.box(e.types.avc1,new Uint8Array([0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,u>>8&255,255&u,c>>8&255,255&c,0,72,0,0,0,72,0,0,0,0,0,0,0,1,18,100,97,105,108,121,109,111,116,105,111,110,47,104,108,115,46,106,115,0,0,0,0,0,0,0,0,0,0,0,0,0,0,24,17,17]),a,e.box(e.types.btrt,new Uint8Array([0,28,156,128,0,45,198,192,0,45,198,192])))}},{key:"esds",value:function(e){var t=e.config.length;return new Uint8Array([0,0,0,0,3,23+t,0,1,0,4,15+t,64,21,0,0,0,0,0,0,0,0,0,0,0,5].concat([t]).concat(e.config).concat([6,1,2]))}},{key:"mp4a",value:function(t){var i=t.audiosamplerate;return e.box(e.types.mp4a,new Uint8Array([0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,t.channelCount,0,16,0,0,0,0,i>>8&255,255&i,0,0]),e.box(e.types.esds,e.esds(t)))}},{key:"stsd",value:function(t){return"audio"===t.type?e.box(e.types.stsd,e.STSD,e.mp4a(t)):e.box(e.types.stsd,e.STSD,e.avc1(t))}},{key:"tkhd",value:function(t){var i=t.id,r=t.duration*t.timescale,s=t.width,o=t.height;return e.box(e.types.tkhd,new Uint8Array([0,0,0,7,0,0,0,0,0,0,0,0,i>>24&255,i>>16&255,i>>8&255,255&i,0,0,0,0,r>>24,r>>16&255,r>>8&255,255&r,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,64,0,0,0,s>>8&255,255&s,0,0,o>>8&255,255&o,0,0]))}},{key:"traf",value:function(t,i){var r=e.sdtp(t),s=t.id;return e.box(e.types.traf,e.box(e.types.tfhd,new Uint8Array([0,0,0,0,s>>24,s>>16&255,s>>8&255,255&s])),e.box(e.types.tfdt,new Uint8Array([0,0,0,0,i>>24,i>>16&255,i>>8&255,255&i])),e.trun(t,r.length+16+16+8+16+8+8),r)}},{key:"trak",value:function(t){return t.duration=t.duration||4294967295,e.box(e.types.trak,e.tkhd(t),e.mdia(t))}},{key:"trex",value:function(t){var i=t.id;return e.box(e.types.trex,new Uint8Array([0,0,0,0,i>>24,i>>16&255,i>>8&255,255&i,0,0,0,1,0,0,0,0,0,0,0,0,0,1,0,1]))}},{key:"trun",value:function(t,i){var r,s,o,n,a,u,c=t.samples||[],l=c.length,h=12+16*l,d=new Uint8Array(h);for(i+=8+h,d.set([0,0,15,1,l>>>24&255,l>>>16&255,l>>>8&255,255&l,i>>>24&255,i>>>16&255,i>>>8&255,255&i],0),r=0;r<l;r++)s=c[r],o=s.duration,n=s.size,a=s.flags,u=s.cts,d.set([o>>>24&255,o>>>16&255,o>>>8&255,255&o,n>>>24&255,n>>>16&255,n>>>8&255,255&n,a.isLeading<<2|a.dependsOn,a.isDependedOn<<6|a.hasRedundancy<<4|a.paddingValue<<1|a.isNonSync,61440&a.degradPrio,15&a.degradPrio,u>>>24&255,u>>>16&255,u>>>8&255,255&u],12+16*r);return e.box(e.types.trun,d)}},{key:"initSegment",value:function(t){e.types||e.init();var i,r=e.moov(t);return i=new Uint8Array(e.FTYP.byteLength+r.byteLength),i.set(e.FTYP),i.set(r,e.FTYP.byteLength),i}}]),e}();t.default=o},function(e,t,i){"use strict";function r(){}function s(e,t){return t="["+e+"] > "+t}function o(e){var t=window.console[e];return t?function(){for(var i=arguments.length,r=Array(i),o=0;o<i;o++)r[o]=arguments[o];r[0]&&(r[0]=s(e,r[0])),t.apply(window.console,r)}:r}function n(e){for(var t=arguments.length,i=Array(t>1?t-1:0),r=1;r<t;r++)i[r-1]=arguments[r];i.forEach(function(t){c[t]=e[t]?e[t].bind(e):o(t)})}Object.defineProperty(t,"__esModule",{value:!0});var a="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},u={trace:r,debug:r,log:r,warn:r,info:r,error:r},c=u;t.enableLogs=function(e){if(!0===e||"object"===(void 0===e?"undefined":a(e))){n(e,"debug","log","info","warn","error");try{c.log()}catch(e){c=u}}else c=u},t.logger=c},function(e,t,i){"use strict";function r(e){return e&&e.__esModule?e:{default:e}}function s(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function o(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t}function n(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}Object.defineProperty(t,"__esModule",{value:!0});var a=function(){function e(e,t){for(var i=0;i<t.length;i++){var r=t[i];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}return function(t,i,r){return i&&e(t.prototype,i),r&&e(t,r),t}}(),u=i(0),c=i(8),l=i(1),h=r(l),d=i(3),f=r(d),_=function(e){function t(e){s(this,t);var i=o(this,(t.__proto__||Object.getPrototypeOf(t)).call(this));return i.isStop=!0,i.video=e,i}return n(t,e),a(t,[{key:"start",value:function(){this.video?(this.isStop=!1,this.video.addEventListener("pause",this.pause.bind(this)),this.video.addEventListener("error",this.error.bind(this)),this.video.addEventListener("ended",this.ended.bind(this)),this.video.addEventListener("playing",this.play.bind(this)),this.video.addEventListener("seeked",this.seeked.bind(this)),this.video.addEventListener("seeking",this.seeking.bind(this)),this.video.addEventListener("waiting",this.waiting.bind(this))):h.default.warn("video dom undefined",u.LOG.PLAY)}},{key:"stop",value:function(){this.isStop=!0,this.video&&(this.video.removeEventListener("pause",this.pause.bind(this)),this.video.removeEventListener("error",this.error.bind(this)),this.video.removeEventListener("ended",this.ended.bind(this)),this.video.removeEventListener("playing",this.play.bind(this)),this.video.removeEventListener("seeked",this.seeked.bind(this)),this.video.removeEventListener("seeking",this.seeking.bind(this)),this.video.removeEventListener("waiting",this.waiting.bind(this)),this.video=void 0)}},{key:"setVolume",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:1;this.video&&(this.video.volume=e)}},{key:"getVolume",value:function(){return this.video?this.video.volume:-1}},{key:"pause",value:function(){this.isStop||h.default.log("video pause",u.LOG.PLAY)}},{key:"ended",value:function(){this.isStop||h.default.log("video ended",u.LOG.PLAY)}},{key:"play",value:function(){this.isStop||h.default.log("video playing",u.LOG.PLAY)}},{key:"waiting",value:function(){this.isStop||h.default.log("video waiting",u.LOG.PLAY)}},{key:"seeked",value:function(){this.isStop||h.default.log("video seeked",u.LOG.PLAY)}},{key:"seeking",value:function(){this.isStop||h.default.log("video seeking",u.LOG.PLAY)}},{key:"error",value:function(e){if(!this.isStop){if(!e||!e.currentTarget)return void h.default.debug("error: response is null",u.LOG.PLAY);if(!e.currentTarget.error)return void h.default.debug("error: no error response",u.LOG.PLAY);var t=e.currentTarget.error;h.default.error("video: ["+t.code+"]"+t.message,u.LOG.PLAY),t.code!==t.MEDIA_ERR_DECODE?this.trigger(c.PlayerEvent.VIDEO_EVENT,{type:c.PlayerMessage.PLAY_ERROR,code:-1,message:t.message}):this.trigger(c.PlayerEvent.VIDEO_EVENT,{type:c.PlayerMessage.PLAY_RESTART,code:-1,message:t.message})}}}]),t}(f.default);t.default=_},function(e,t,i){"use strict";function r(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}Object.defineProperty(t,"__esModule",{value:!0});var s=function(){function e(e,t){for(var i=0;i<t.length;i++){var r=t[i];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}return function(t,i,r){return i&&e(t.prototype,i),r&&e(t,r),t}}(),o=i(0),n=i(2),a=i(7),u=function(e){return e&&e.__esModule?e:{default:e}}(a),c=function(){function e(){r(this,e),this.url="",this.host=""}return s(e,[{key:"commonOptions",value:function(){var e={host:n.Globals.host,token:n.Globals.token,appId:n.Globals.appId,scene:n.Globals.vimpScene,deviceId:n.Globals.deviceId};return n.Globals.isPermission&&(e.ticket=n.Globals.ticket),e}},{key:"start",value:function(e){this.host=e||"",this.url=n.HOST.PROTOCOL+this.host+"/sls/room"}},{key:"createRoom",value:function(e){var t=this;return new Promise(function(i,r){var s=t.commonOptions();s.command=o.HTTP.CREATE_VROOM,s.roomId=e.roomId||"",s.userId=e.userId||"",s.userRole=n.Globals.permissionIndex,s.param={vRoomId:e.vRoomId||""},n.Globals.isPermission||(s.userRole=e.config),u.default.ajax({url:t.url,data:s,type:"POST",error:r,success:i})})}},{key:"joinRoom",value:function(e){var t=this;return new Promise(function(i,r){var s=t.commonOptions();s.command=o.HTTP.JOIN_VROOM,s.roomId=e.roomId||"",s.userId=e.userId||"",s.userRole=n.Globals.permissionIndex,s.param={vRoomId:e.vRoomId||""},n.Globals.isPermission||(s.userRole=e.config),u.default.ajax({url:t.url,data:s,type:"POST",error:r,success:i})})}},{key:"quitRoom",value:function(e){var t=this;return new Promise(function(i,r){var s=t.commonOptions();s.command=o.HTTP.QUIT_VROOM,s.roomId=e.roomId||"",s.userId=e.userId||"",s.userRole=n.Globals.permissionIndex,s.param={vRoomId:e.vRoomId||""},n.Globals.isPermission||(s.userRole=e.config),u.default.ajax({url:t.url,data:s,type:"POST",error:r,success:i})})}},{key:"destroyRoom",value:function(e){var t=this;return new Promise(function(i,r){var s=t.commonOptions();s.command=o.HTTP.DESTROY_VROOM,s.roomId=e.roomId||"",s.userId=e.userId||"",s.userRole=n.Globals.permissionIndex,s.param={vRoomId:e.vRoomId||""},n.Globals.isPermission||(s.userRole=e.config),u.default.ajax({url:t.url,data:s,type:"POST",error:r,success:i})})}},{key:"fullListRoom",value:function(e){var t=this;return new Promise(function(i,r){var s=t.commonOptions();s.command=o.HTTP.FULL_VLIST,s.roomId=e.roomId||"",s.userId=e.userId||"",s.userRole=n.Globals.permissionIndex,s.param={vRoomId:e.vRoomId||""},n.Globals.isPermission||(s.userRole=e.config),u.default.ajax({url:t.url,data:s,type:"POST",error:r,success:i})})}},{key:"inWhichVRoom",value:function(e){var t=this;return new Promise(function(i,r){var s=t.commonOptions();s.command=o.HTTP.IN_WHICH_VROOM,s.roomId=e.roomId||"",s.userId=e.userId||"",s.userRole=n.Globals.permissionIndex,s.param={},n.Globals.isPermission||(s.userRole=e.config),u.default.ajax({url:t.url,data:s,type:"POST",error:r,success:i})})}}]),e}();t.default=c},function(e,t,i){"use strict";function r(e){return e&&e.__esModule?e:{default:e}}function s(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function o(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t}function n(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}Object.defineProperty(t,"__esModule",{value:!0});var a=function(){function e(e,t){for(var i=0;i<t.length;i++){var r=t[i];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}return function(t,i,r){return i&&e(t.prototype,i),r&&e(t,r),t}}(),u=i(0),c=i(2),l=i(12),h=i(1),d=r(h),f=i(28),_=r(f),v=i(29),p=r(v),m=i(31),g=r(m),y=i(30),E=r(y),S=i(18),R=r(S),T=function(e){function t(){s(this,t);var e=o(this,(t.__proto__||Object.getPrototypeOf(t)).call(this));return e._config={},e._slsHost="",e._vChannelId="",e._isActive=!1,e._isInitial=!0,e._retryCount=0,e._retryTimer=void 0,e.RETRY_CNT_LIMIT=24,e.RETRY_TIMER_TIME=5e3,e._licVRoomClass=void 0,e._ssdispatchClass=void 0,e._connectionClass=void 0,e._interactiverClass=void 0,e}return n(t,e),a(t,[{key:"start",value:function(e){this._isActive=!0,this._config=Object.assign(e,{userRole:0}),this._config.slsHost&&(this._slsHost=this._config.slsHost)}},{key:"stop",value:function(){this._isActive=!1,this._destroyDispatchRetryTimer(),this._destroyConnect(),this._destroySSDispatch(),this._destroyInteractiver(),this._destroyLicVRoom()}},{key:"createRoom",value:function(){var e=this,t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};this._ssDispatchHost(t.isRetry,function(i,r){if(!e._quit("createRoom"))if(i!==u.RSP.SUCCESS)e._dispatchEvent(l.RoomMessage.CREATE_ROOM,u.RSP.ERROR,r);else{if(!e._interactiverClass)return;e._interactiverClass.createRoom({userRole:e._config.userRole,roomId:t.roomId||e._config.roomId,userId:t.userId||e._config.userId}).then(function(i){if(!e._quit("createRoom")){d.default.log("create room response: "+i,u.LOG.ROOM);var r="",s=u.RSP.ERROR,o=JSON.parse(i);if(o&&(r=o[u.RSP.MSG]||"",s=parseInt(o[u.RSP.STATUS])),s!==l.RoomCode.OK&&s!==l.RoomCode.EXIST_ROOM)return e._destroyLicVRoom(),e._connectionClass&&e._destroyConnect(),void e._dispatchEvent(l.RoomMessage.CREATE_ROOM,u.RSP.ERROR,r);e.fullListRoom({roomId:t.roomId||e._config.roomId,userId:t.userId||e._config.userId}),e._createLicVRoom(),e._licVRoomClass.inWhichVRoom({userId:e._config.userId,roomId:e._config.roomId}),e._createConnect(),e._isInitial&&(e._isInitial=!1,e._dispatchEvent(l.RoomMessage.CREATE_ROOM,u.RSP.SUCCESS,r))}}).catch(function(t){e._quit("createRoom")||(d.default.warn("create room failed",u.LOG.ROOM),e._dispatchEvent(l.RoomMessage.CREATE_ROOM,u.RSP.ERROR,"create room failed"))})}})}},{key:"destroyRoom",value:function(){var e=this,t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};this._interactiverClass&&""!==this._slsHost&&this._interactiverClass.destroyRoom({userRole:this._config.userRole,roomId:t.roomId||this._config.roomId,userId:t.userId||this._config.userId}).then(function(t){e._quit("destroyRoom")||d.default.log("destroy room response: "+t,u.LOG.ROOM)}).catch(function(t){e._quit("destroyRoom")||d.default.warn("destroy room failed",u.LOG.ROOM)})}},{key:"fullListRoom",value:function(){var e=this,t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};this._interactiverClass&&""!==this._slsHost&&this._interactiverClass.fullListRoom({userRole:this._config.userRole,roomId:t.roomId||this._config.roomId,userId:t.userId||c.Globals.userId}).then(function(t){if(!e._quit("fullListRoom")){d.default.log("fullList room response: "+t,u.LOG.ROOM);var i=JSON.parse(t)||{};0===parseInt(i[u.RSP.STATUS])&&i[u.RSP.RESULT]&&e._onBroadcastMessage(i[u.RSP.RESULT])}}).catch(function(t){e._quit("fullListRoom")||d.default.warn("fullList room failed",u.LOG.ROOM)})}},{key:"createVRoom",value:function(e){this._licVRoomClass&&e&&e.vChannelId&&(this._vChannelId=e.vChannelId,this._licVRoomClass.createVRoom(e))}},{key:"destroyVRoom",value:function(e){this._licVRoomClass&&e&&e.vChannelId&&this._licVRoomClass.destroyVRoom(e)}},{key:"joinVRoom",value:function(e){this._licVRoomClass&&e&&e.vChannelId&&(this._vChannelId=e.vChannelId,this._licVRoomClass.joinVRoom(e))}},{key:"quitVRoom",value:function(e){this._licVRoomClass&&e&&e.vChannelId&&this._licVRoomClass.quitVRoom(e)}},{key:"fullVListRoom",value:function(e){this._licVRoomClass&&e&&e.vChannelId&&this._licVRoomClass.fullVListRoom(e)}},{key:"inWhichVRoom",value:function(e){this._licVRoomClass&&this._licVRoomClass.inWhichVRoom(e)}},{key:"_quit",value:function(e){return!this._isActive&&(d.default.debug("["+e+"], server stop",u.LOG.ROOM),!0)}},{key:"_isInRoom",value:function(e){return e===this._config.roomId}},{key:"_isInVRoom",value:function(e){return e===this._vChannelId}},{key:"_retrySSDispatch",value:function(){this._retryCount<this.RETRY_CNT_LIMIT?(this._retryCount++,d.default.log("retry dispatch room after "+this.RETRY_TIMER_TIME+"ms",u.LOG.ROOM),this._createDispatchRetryTimer()):(this._destroyDispatchRetryTimer(),this._dispatchEvent(l.RoomMessage.CREATE_ROOM,u.RSP.ERROR,"retry create room limit"))}},{key:"_createDispatchRetryTimer",value:function(){var e=this;this._retryTimer=window.setTimeout(function(){e._retrySSDispatchHost()},this.RETRY_TIMER_TIME)}},{key:"_destroyDispatchRetryTimer",value:function(){this._retryTimer&&(window.clearTimeout(this._retryTimer),this._retryTimer=void 0)}},{key:"_recreateSSDispatch",value:function(){this._retrySSDispatchHost()}},{key:"_createSSDispatch",value:function(){this._ssdispatchClass||(this._ssdispatchClass=new R.default)}},{key:"_destroySSDispatch",value:function(){this._ssdispatchClass&&(this._ssdispatchClass=void 0)}},{key:"_retrySSDispatchHost",value:function(){this.createRoom({isRetry:!0,roomId:this._config.roomId,userId:this._config.userId})}},{key:"_ssDispatchHost",value:function(){var e=this,t=arguments.length>0&&void 0!==arguments[0]&&arguments[0],i=arguments[1];if(!t&&""!==this._slsHost)return this._interactiverClass||(this._retryCount=0,this._destroyDispatchRetryTimer(),this._createInteractiver()),void(i&&i(u.RSP.SUCCESS,"ok"));this._createSSDispatch(),this._ssdispatchClass.dispatch({roomId:this._config.roomId,userRole:this._config.userRole}).then(function(t){e._quit("_ssDispatchHost")||(e._retryCount=0,e._destroyDispatchRetryTimer(),e._slsHost=t,e._createInteractiver(),i&&i(u.RSP.SUCCESS,"ok"))}).catch(function(r){if(!e._quit("_ssDispatchHost")){if(t)return void e._retrySSDispatch();var s=JSON.stringify({status:r&&r.status||0,message:r&&r.message||""});i&&i(u.RSP.ERROR,s)}})}},{key:"_createLicVRoom",value:function(){this._destroyLicVRoom(),this._licVRoomClass=new g.default,this._licVRoomClass.listenTo(l.RoomEvent.ROOM_EVENT,this._onVRoomEventHandler.bind(this)),this._licVRoomClass.start({host:this._slsHost,userId:this._config.userId,roomId:this._config.roomId,userRole:this._config.userRole})}},{key:"_destroyLicVRoom",value:function(){this._licVRoomClass&&(this._licVRoomClass.removeToAll(),this._licVRoomClass.stop(),this._licVRoomClass=void 0)}},{key:"_onVRoomEventHandler",value:function(e){var t=this,i=e[u.RSP.TYPE],r=e[u.RSP.CODE],s=e[u.RSP.DATA],o=e[u.RSP.MESSAGE];switch(i){case l.RoomMessage.JOIN_VROOM:case l.RoomMessage.CREATE_VROOM:r===u.RSP.SUCCESS?this._vChannelId=s[u.RSP.VROOMID]:this._dispatchEvent(i,r,o,s);break;case l.RoomMessage.WHICH_VROOM:if(r===u.RSP.SUCCESS&&s){(s[u.RSP.VROOMID]||[]).forEach(function(e){t.joinVRoom({vChannelId:e,userId:t._config.userId,roomId:t._config.roomId})})}}}},{key:"_createInteractiver",value:function(){this._destroyInteractiver(),this._interactiverClass=new p.default,this._interactiverClass.start(this._slsHost)}},{key:"_destroyInteractiver",value:function(){this._interactiverClass&&(this._interactiverClass=void 0)}},{key:"_createConnect",value:function(){this._destroyConnect();var e=c.HOST.PROTOCOL_WS+this._slsHost;e+="/sls/room/"+c.Globals.impScene+"/",e+=c.Globals.appId+"/"+c.Globals.host+"/",e+=this._config.userId+"/"+c.Globals.token+"/ws",this._connectionClass=new _.default,this._connectionClass.listenTo(l.RoomEvent.CONNECT_EVENT,this._onConnectHandler.bind(this)),this._connectionClass.start(e,{userId:this._config.userId,roomId:this._config.roomId,userRole:this._config.userRole})}},{key:"_destroyConnect",value:function(){this._connectionClass&&(this._connectionClass.stop(),this._connectionClass.removeToAll(),this._connectionClass=void 0)}},{key:"_onConnectHandler",value:function(e){if(e){switch(String(e[u.RSP.TYPE])){case l.RoomEvent.CONNECT_MESSAGE_EVENT:this._ackMessage(e[u.RSP.DATA]);break;case l.RoomEvent.CONNECT_RECREATE_EVENT:case l.RoomEvent.CONNECT_PONG_ERROR_EVENT:this._recreateSSDispatch();break;default:d.default.debug("unvalid connect event type",u.LOG.ROOM)}}}},{key:"_ackMessage",value:function(e){if(e){switch(e[u.RSP.COMMAND]||""){case l.RoomMessage.BROADCAST:this._onBroadcastMessage(e[u.RSP.PARAM]);break;case l.RoomMessage.DESTROY_ROOM:this._onDestroyRoomMessage(e[u.RSP.PARAM]);break;case l.RoomMessage.QUIT_VROOM:this._onQuitVRoomMessage(e[u.RSP.PARAM]);break;case l.RoomMessage.BROADCAST_V:this._onBroadcastVRoomMessage(e[u.RSP.PARAM]);break;case l.RoomMessage.DESTROY_VROOM:this._onDestroyVRoomMessage(e[u.RSP.PARAM])}}}},{key:"_onDestroyRoomMessage",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};this._isInRoom(e[u.RSP.ROOMID])&&this._dispatchEvent(l.RoomMessage.DESTROY_ROOM,u.RSP.SUCCESS,u.RSP.OK,e)}},{key:"_onBroadcastMessage",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};e[u.RSP.USERS]&&this._dispatchEvent(l.RoomMessage.BROADCAST,u.RSP.SUCCESS,u.RSP.OK,e[u.RSP.USERS])}},{key:"_onQuitVRoomMessage",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};this._isInVRoom(e[u.RSP.VROOMID])&&(this._vChannelId="",this._dispatchEvent(l.RoomMessage.BROADCAST_V,u.RSP.SUCCESS,u.RSP.OK,[]))}},{key:"_onDestroyVRoomMessage",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};this._isInVRoom(e[u.RSP.VROOMID])&&(this._vChannelId="",this._dispatchEvent(l.RoomMessage.DESTROY_VROOM,u.RSP.SUCCESS,u.RSP.OK,e))}},{key:"_onBroadcastVRoomMessage",value:function(){var e=this,t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};if(t[u.RSP.USERS]){var i=[];t[u.RSP.USERS].forEach(function(t){t[u.RSP.ROOMID]&&t[u.RSP.VROOMID]&&t[u.RSP.VROOMID]===e._vChannelId&&t[u.RSP.ROOMID]!==e._config.roomId&&i.push(t)}),this._dispatchEvent(l.RoomMessage.BROADCAST_V,u.RSP.SUCCESS,u.RSP.OK,i)}}},{key:"_dispatchEvent",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:-1,i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:"",r=arguments.length>3&&void 0!==arguments[3]?arguments[3]:{};this._isActive&&this.trigger(l.RoomEvent.ROOM_EVENT,{type:e,code:t,message:i,data:r})}}]),t}(E.default);t.default=T},function(e,t,i){"use strict";function r(e){return e&&e.__esModule?e:{default:e}}function s(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function o(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t}function n(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}Object.defineProperty(t,"__esModule",{value:!0});var a=function(){function e(e,t){for(var i=0;i<t.length;i++){var r=t[i];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}return function(t,i,r){return i&&e(t.prototype,i),r&&e(t,r),t}}(),u=i(0),c=i(2),l=i(12),h=i(1),d=r(h),f=i(28),_=r(f),v=i(29),p=r(v),m=i(31),g=r(m),y=i(30),E=r(y),S=i(18),R=r(S),T=function(e){function t(){s(this,t);var e=o(this,(t.__proto__||Object.getPrototypeOf(t)).call(this));return e._config={},e._slsHost="",e._isActive=!1,e._isInitial=!0,e._retryCount=0,e._retryTimer=void 0,e.RETRY_CNT_LIMIT=24,e.RETRY_TIMER_TIME=5e3,e._licVRoomClass=void 0,e._ssdispatchClass=void 0,e._connectionClass=void 0,e._interactiverClass=void 0,e}return n(t,e),a(t,[{key:"start",value:function(e){this._isActive=!0,this._config=Object.assign(e,{userRole:1}),this._config.slsHost&&(this._slsHost=this._config.slsHost)}},{key:"stop",value:function(){this._isActive=!1,this._destroyDispatchRetryTimer(),this._destroyConnect(),this._destroySSDispatch(),this._destroyInteractiver(),this._destroyLicVRoom()}},{key:"joinRoom",value:function(){var e=this,t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};this._ssDispatchHost(t.isRetry,function(i,r){if(!e._quit("joinRoom"))if(i!==u.RSP.SUCCESS)e._dispatchEvent(l.RoomMessage.JOIN_ROOM,u.RSP.ERROR,r);else{if(!e._interactiverClass)return;e._interactiverClass.joinRoom({userRole:e._config.userRole,roomId:t.roomId||e._config.roomId,userId:t.userId||e._config.userId}).then(function(i){if(!e._quit("joinRoom")){d.default.log("join room response: "+i,u.LOG.ROOM);var r=JSON.parse(i)||{},s=r[u.RSP.MSG],o=parseInt(r[u.RSP.STATUS]);if(o!==l.RoomCode.OK&&o!==l.RoomCode.EXIST_CONNECTED_LIST&&o!==l.RoomCode.EXIST_CONNECTING_LIST&&o!==l.RoomCode.AGREE_CONNECTED_LIST)return e._destroyLicVRoom(),e._connectionClass&&e._destroyConnect(),void e._dispatchEvent(l.RoomMessage.JOIN_ROOM,o,s);e.fullListRoom({roomId:t.roomId||e._config.roomId,userId:t.userId||e._config.userId}),e._createLicVRoom(),e._licVRoomClass.inWhichVRoom({userId:t.userId||e._config.userId,roomId:t.roomId||e._config.roomId}),e._createConnect(),e._isInitial&&(e._isInitial=!1,e._dispatchEvent(l.RoomMessage.JOIN_ROOM,u.RSP.SUCCESS,s))}}).catch(function(t){e._quit("joinRoom")||(d.default.warn("join room failed",u.LOG.ROOM),e._dispatchEvent(l.RoomMessage.JOIN_ROOM,u.RSP.ERROR,"join room failed"))})}})}},{key:"quitRoom",value:function(){var e=this,t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};this._interactiverClass&&""!==this._slsHost&&this._interactiverClass.quitRoom({userRole:this._config.userRole,roomId:t.roomId||this._config.roomId,userId:t.userId||this._config.userId}).then(function(t){e._quit("quitRoom")||d.default.log("quit room response: "+t,u.LOG.ROOM)}).catch(function(t){e._quit("quitRoom")||d.default.warn("quit room failed",u.LOG.ROOM)})}},{key:"fullListRoom",value:function(){var e=this,t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};this._interactiverClass&&""!==this._slsHost&&this._interactiverClass.fullListRoom({userRole:this._config.userRole,roomId:t.roomId||this._config.roomId,userId:t.userId||c.Globals.userId}).then(function(t){if(!e._quit("fullListRoom")){d.default.log("fullList room response: "+t,u.LOG.ROOM);var i=JSON.parse(t)||{};0===parseInt(i[u.RSP.STATUS])&&i[u.RSP.RESULT]&&e._onBroadcastMessage(i[u.RSP.RESULT])}}).catch(function(t){e._quit("fullListRoom")||d.default.warn("fullList room failed",u.LOG.ROOM)})}},{key:"_quit",value:function(e){return!this._isActive&&(d.default.debug("["+e+"], server stop",u.LOG.ROOM),!0)}},{key:"_isInRoom",value:function(e){return e===this._config.roomId}},{key:"_retrySSDispatch",value:function(){this._retryCount<this.RETRY_CNT_LIMIT?(this._retryCount++,d.default.log("retry dispatch room after "+this.RETRY_TIMER_TIME+"ms",u.LOG.ROOM),this._createDispatchRetryTimer()):(this._destroyDispatchRetryTimer(),this._dispatchEvent(l.RoomMessage.JOIN_ROOM,u.RSP.ERROR,"retry join room limit"))}},{key:"_createDispatchRetryTimer",value:function(){var e=this;this._retryTimer=window.setTimeout(function(){e._retrySSDispatchHost()},this.RETRY_TIMER_TIME)}},{key:"_destroyDispatchRetryTimer",value:function(){this._retryTimer&&(window.clearTimeout(this._retryTimer),this._retryTimer=void 0)}},{key:"_recreateSSDispatch",value:function(){this._retrySSDispatchHost()}},{key:"_createSSDispatch",value:function(){this._ssdispatchClass||(this._ssdispatchClass=new R.default)}},{key:"_destroySSDispatch",value:function(){this._ssdispatchClass&&(this._ssdispatchClass=void 0)}},{key:"_retrySSDispatchHost",value:function(){this.joinRoom({isRetry:!0,roomId:this._config.roomId,userId:this._config.userId})}},{key:"_ssDispatchHost",value:function(){var e=this,t=arguments.length>0&&void 0!==arguments[0]&&arguments[0],i=arguments[1];if(!t&&""!==this._slsHost)return this._interactiverClass||(this._retryCount=0,this._destroyDispatchRetryTimer(),this._createInteractiver()),void(i&&i(u.RSP.SUCCESS,"ok"));this._createSSDispatch(),this._ssdispatchClass.dispatch({roomId:this._config.roomId,userRole:this._config.userRole}).then(function(t){e._quit("_ssDispatchHost")||(e._retryCount=0,e._destroyDispatchRetryTimer(),e._slsHost=t,e._createInteractiver(),i&&i(u.RSP.SUCCESS,"ok"))}).catch(function(r){if(!e._quit("_ssDispatchHost")){if(t)return void e._retrySSDispatch();var s=JSON.stringify({status:r&&r.status||0,message:r&&r.message||""});i&&i(u.RSP.ERROR,s)}})}},{key:"_createLicVRoom",value:function(){this._destroyLicVRoom(),this._licVRoomClass=new g.default,this._licVRoomClass.listenTo(l.RoomEvent.ROOM_EVENT,this._onVRoomEventHandler.bind(this)),this._licVRoomClass.start({host:this._slsHost,userId:this._config.userId,roomId:this._config.roomId,userRole:this._config.userRole})}},{key:"_destroyLicVRoom",value:function(){this._licVRoomClass&&(this._licVRoomClass.removeToAll(),this._licVRoomClass.stop(),this._licVRoomClass=void 0)}},{key:"_onVRoomEventHandler",value:function(e){var t=this,i=e[u.RSP.TYPE],r=e[u.RSP.CODE],s=e[u.RSP.DATA];e[u.RSP.MESSAGE];switch(i){case l.RoomMessage.WHICH_VROOM:if(r===u.RSP.SUCCESS&&s){(s[u.RSP.VROOMID]||[]).forEach(function(e){t._licVRoomClass&&t._licVRoomClass.fullVListRoom({vChannelId:e,userId:t._config.userId,roomId:t._config.roomId})})}}}},{key:"_createInteractiver",value:function(){this._destroyInteractiver(),this._interactiverClass=new p.default,this._interactiverClass.start(this._slsHost)}},{key:"_destroyInteractiver",value:function(){this._interactiverClass&&(this._interactiverClass=void 0)}},{key:"_createConnect",value:function(){this._destroyConnect();var e=c.HOST.PROTOCOL_WS+this._slsHost;e+="/sls/room/"+c.Globals.impScene+"/",e+=c.Globals.appId+"/"+c.Globals.host+"/",e+=this._config.userId+"/"+c.Globals.token+"/ws",this._connectionClass=new _.default,this._connectionClass.listenTo(l.RoomEvent.CONNECT_EVENT,this._onConnectHandler.bind(this)),this._connectionClass.start(e,{userId:this._config.userId,roomId:this._config.roomId,userRole:this._config.userRole})}},{key:"_destroyConnect",value:function(){this._connectionClass&&(this._connectionClass.stop(),this._connectionClass.removeToAll(),this._connectionClass=void 0)}},{key:"_onConnectHandler",value:function(e){if(e){switch(String(e[u.RSP.TYPE])){case l.RoomEvent.CONNECT_MESSAGE_EVENT:this._ackMessage(e[u.RSP.DATA]);break;case l.RoomEvent.CONNECT_RECREATE_EVENT:case l.RoomEvent.CONNECT_PONG_ERROR_EVENT:this._recreateSSDispatch();break;default:d.default.debug("unvalid connect event type",u.LOG.ROOM)}}}},{key:"_ackMessage",value:function(e){if(e){switch(e[u.RSP.COMMAND]||""){case l.RoomMessage.BROADCAST:this._onBroadcastMessage(e[u.RSP.PARAM]);break;case l.RoomMessage.DESTROY_ROOM:this._onDestroyRoomMessage(e[u.RSP.PARAM]);break;case l.RoomMessage.QUIT_VROOM:this._onQuitVRoomMessage(e[u.RSP.PARAM]);break;case l.RoomMessage.BROADCAST_V:this._onBroadcastVRoomMessage(e[u.RSP.PARAM]);break;case l.RoomMessage.DESTROY_VROOM:this._onDestroyVRoomMessage(e[u.RSP.PARAM])}}}},{key:"_onBroadcastMessage",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};e[u.RSP.USERS]&&this._dispatchEvent(l.RoomMessage.BROADCAST,u.RSP.SUCCESS,u.RSP.OK,e[u.RSP.USERS])}},{key:"_onDestroyRoomMessage",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},t=e.roomId;this._isInRoom(t)&&this._dispatchEvent(l.RoomMessage.DESTROY_ROOM,u.RSP.SUCCESS,u.RSP.OK,e)}},{key:"_onQuitVRoomMessage",value:function(){arguments.length>0&&void 0!==arguments[0]&&arguments[0];this._dispatchEvent(l.RoomMessage.BROADCAST_V,u.RSP.SUCCESS,u.RSP.OK,[])}},{key:"_onDestroyVRoomMessage",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};this._dispatchEvent(l.RoomMessage.DESTROY_VROOM,u.RSP.SUCCESS,u.RSP.OK,e)}},{key:"_onBroadcastVRoomMessage",value:function(){var e=this,t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};if(t[u.RSP.USERS]){var i=[];t[u.RSP.USERS].forEach(function(t){t[u.RSP.ROOMID]&&t[u.RSP.ROOMID]!==e._config.roomId&&i.push(t)}),this._dispatchEvent(l.RoomMessage.BROADCAST_V,u.RSP.SUCCESS,u.RSP.OK,i)}}},{key:"_dispatchEvent",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:-1,i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:"",r=arguments.length>3&&void 0!==arguments[3]?arguments[3]:{};this._isActive&&this.trigger(l.RoomEvent.ROOM_EVENT,{type:e,code:t,message:i,data:r})}}]),t}(E.default);t.default=T},function(e,t,i){"use strict";function r(e){return e&&e.__esModule?e:{default:e}}function s(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}Object.defineProperty(t,"__esModule",{value:!0});var o=function(){function e(e,t){for(var i=0;i<t.length;i++){var r=t[i];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}return function(t,i,r){return i&&e(t.prototype,i),r&&e(t,r),t}}(),n=i(4),a=i(0),u=i(6),c=r(u),l=i(1),h=r(l),d=function(){function e(t){s(this,e),this.config={},this.observer=t,this.previewStream=void 0}return o(e,[{key:"quit",value:function(e){return!!this.isStop&&(h.default.debug("["+e+"]server stop",a.LOG.PREVIEW),!0)}},{key:"start",value:function(e){if(this.stop(),this.config=e||{},!this.config.playerDom)return h.default.warn("no preview video dom",a.LOG.PREVIEW),void this.dispatchEvent(a.RSP.ERROR,"no preview video dom");this.isStop=!1;var t=this.parsePreviewConfig();h.default.log(JSON.stringify(t),a.LOG.PREVIEW),c.default.isOldGetUserMedia()?window.navigator?window.navigator.getUserMedia(t,this.gotStream.bind(this),this.gotStreamError.bind(this)):(h.default.warn("mediaDevices or getUserMedia not supported!",a.LOG.PREVIEW),this.stop()):window.navigator&&window.navigator.mediaDevices?window.navigator.mediaDevices.getUserMedia(t).then(this.gotStream.bind(this)).catch(this.gotStreamError.bind(this)):(h.default.warn("mediaDevices or getUserMedia not supported!",a.LOG.PREVIEW),this.stop())}},{key:"stop",value:function(){this.isStop=!0,this.previewStream&&this.stopStream(this.previewStream)}},{key:"parsePreviewConfig",value:function(){var e={audio:{},video:{width:480,height:320}};if("false"===String(this.config.isAudio)&&(e.audio=!1),"false"===String(this.config.isVideo))return e.video=!1,e;void 0!==this.config.audioId&&e.audio&&(e.audio.deviceId=this.config.audioId);var t=this.config.videoId||this.config.deviceId;if(void 0!==t&&e.video&&(e.video.deviceId=t),void 0!==this.config.profile){var i=c.default.getAspectByProfile(this.config.profile);e.video.width=i.width,e.video.height=i.height}else if(void 0!==this.config.width&&void 0!==this.config.height){var r=parseInt(this.config.width),s=parseInt(this.config.height);r=r<0||r>4096?480:r,s=s<0||s>2160?320:s,e.video.width=r,e.video.height=s}if("false"===String(this.config.landscape)){var o=e.video.width,n=e.video.height;e.video.width=n,e.video.height=o}return e}},{key:"stopStream",value:function(e){var t=[];try{t=e.getTracks()}catch(e){t=[]}for(var i=0;i<t.length;i++)t[i].stop();this.previewStream=void 0}},{key:"gotStream",value:function(e){if(this.quit("gotStream"))return void this.stopStream(e);var t=this.config.playerDom;if(!t)return h.default.error("no preview video dom",a.LOG.PREVIEW),this.dispatchEvent(a.RSP.ERROR,"no preview video dom"),void this.stop();var i=0;if(void 0!==this.config.rotation&&(i=parseInt(this.config.rotation),i<0&&(i=-i),i>360&&(i%=360)),"false"!==String(this.config.isMirror)){var r="scale(-1, 1)";0!==i&&(r+=" rotate("+i+"deg)");for(var s=["transform","oTransform","msTransform","mozTransform","webkitTransform"],o=0;o<s.length;o++)t.style[s[o]]=r}t.srcObject=e,this.previewStream=e;var n=function e(i){h.default.log("video playing",a.LOG.PREVIEW),t.removeEventListener("playing",e)},u=function e(i){var r=i.target.videoWidth,s=i.target.videoHeight;h.default.log("localMetadata["+r+"x"+s+"]",a.LOG.PREVIEW),t.removeEventListener("loadedmetadata",e)};t.volume=0,t.addEventListener("playing",n),t.addEventListener("loadedmetadata",u),this.dispatchEvent(a.RSP.SUCCESS,"success")}},{key:"gotStreamError",value:function(e){this.quit("gotStreamError")||(this.dispatchEvent(a.RSP.ERROR,e.toString()),h.default.warn(e.toString(),a.LOG.PREVIEW),this.stop())}},{key:"dispatchEvent",value:function(e,t){this.observer&&(this.quit("dispatchEvent")||this.observer.trigger(n.Event.PREVIEW_EVENT,{code:e,message:t}))}}]),e}();t.default=d},function(e,t,i){"use strict";function r(e){return e&&e.__esModule?e:{default:e}}function s(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}Object.defineProperty(t,"__esModule",{value:!0});var o=function(){function e(e,t){for(var i=0;i<t.length;i++){var r=t[i];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}return function(t,i,r){return i&&e(t.prototype,i),r&&e(t,r),t}}(),n=i(9),a=i(0),u=i(5),c=i(2),l=i(33),h=r(l),d=i(11),f=r(d),_=function(){function e(t,i){s(this,e),this._isActive=!1,this._handler=t,this._callback=i,this._peer=void 0,this._peerConnParser=null,this._timer=void 0,this._TIMER_TIME=1e3*u.Report.period}return o(e,[{key:"start",value:function(){var e=this;this._timer&&(window.clearInterval(this._timer),this._timer=void 0),this._isActive=!0,this._timer=window.setInterval(function(){e._peer&&e._isActive&&e.getPeerStatus()},this._TIMER_TIME)}},{key:"stop",value:function(){this._isActive=!1,this._timer&&(window.clearInterval(this._timer),this._timer=void 0),this._peer&&(this._peer=void 0)}},{key:"getPeerStatus",value:function(){this._peer&&(this._isActive=!0,this._reportor||(this._reportor=new f.default),this._createPeerConnParser())}},{key:"_createPeerConnParser",value:function(){var e=this;this._peerConnParser||(this._peerConnParser=new h.default,this._peerConnParser.listenTo(n.PullMessage.PEER_STAT,function(t){if(t){var i=t[a.RSP.TYPE],r=t[a.RSP.DATA]||{};i===n.STAT.PEER_STAT_EVENT&&(e._reportStat(r),e._callback&&e._callback(r)),e._isActive||e._peerConnParser&&(e._peerConnParser.removeToAll(),e._peerConnParser=null)}})),this._peerConnParser.peer=this.peer,this._peerConnParser.start()}},{key:"_reportStat",value:function(e){if(this._reportor){var t={};t[u.MACRO.MIC_URL]=this.url,t[u.MACRO.ROOM_ID]=this.roomId,t[u.MACRO.DEV_INFO]=c.Globals.deviceId,t[u.MACRO.EVENT_NAME]=u.MACRO.RGL_PULL_REPORT,t[u.MACRO.AVG_VLR]=e[u.MACRO.AVG_VLR]||"0.000",t[u.MACRO.AVG_ALR]=e[u.MACRO.AVG_ALR]||"0.000",t[u.MACRO.TTL_VSP]=e[u.MACRO.TTL_VSP]||"0",t[u.MACRO.TTL_ASP]=e[u.MACRO.TTL_ASP]||"0",t[u.MACRO.JITTER_TIME]=e[u.MACRO.JITTER_TIME]||"0",t[u.MACRO.JITTER_COUNT]=e[u.MACRO.JITTER_COUNT]||"0",t[u.MACRO.TRANS_INFO]=e[u.MACRO.TRANS_INFO]||"rtc_udp",t[u.MACRO.AVG_DEC_FPS]=e[u.MACRO.AVG_DEC_FPS]||"0.000",t[u.MACRO.AVG_TRAN_FPS]=e[u.MACRO.AVG_TRAN_FPS]||"0.000",t[u.MACRO.EVENT_TIME]=this._reportor.getCurrentTime(),""!==this.avType&&(t[u.MACRO.MIC_TYPE]=this.avType),this._handler&&(t[u.MACRO.JITTER_COUNT]=this._handler.getWaitingCount().toFixed(0)),this._reportor.report({data:t}),this._isActive||(this._reportor=void 0)}}},{key:"peer",get:function(){return this._peer},set:function(e){this._peer!==e&&(this._peer=e)}},{key:"roomId",get:function(){return this._roomId||""},set:function(e){this._roomId=e||""}},{key:"url",get:function(){return this._url||""},set:function(e){this._url=e||""}},{key:"avType",get:function(){return this._avType||""},set:function(e){this._avType=e}}]),e}();t.default=_},function(e,t,i){"use strict";function r(e){return e&&e.__esModule?e:{default:e}}function s(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function o(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t}function n(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}Object.defineProperty(t,"__esModule",{value:!0});var a=function(){function e(e,t){for(var i=0;i<t.length;i++){var r=t[i];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}return function(t,i,r){return i&&e(t.prototype,i),r&&e(t,r),t}}(),u=i(0),c=i(9),l=i(2),h=i(5),d=i(91),f=r(d),_=i(88),v=r(_),p=i(93),m=r(p),g=i(92),y=r(g),E=i(33),S=r(E),R=i(94),T=r(R),C=i(1),b=r(C),P=i(15),O=r(P),A=i(3),k=r(A),I=function(e){function t(){s(this,t);var e=o(this,(t.__proto__||Object.getPrototypeOf(t)).call(this));return e._config={},e._isActive=!1,e._getStater=void 0,e._lastErrorType="",e._rtcReportor=void 0,e._remoteStream=void 0,e._trackDetector=void 0,e._remoteVideoPlayer=void 0,e._pullUrl="",e._urlSwitch=-1,e._urlIndex=-1,e._enforceTCP=!1,e._networkConfig={},e._peer=void 0,e._peerRetryCount=0,e._peerRetryTimer=void 0,e._rtcServerXHR=void 0,e._rtcServerHeaders=void 0,e._rtcServerRetryCount=0,e._rtcServerRetryTimer=void 0,e.RTC_FACTOR=3,e.PRE_TIME_LIMIT=60,e.RTC_RETRY_LIMIT=80,e.RTC_RETRY_TIMER_TIME=1e3,e.PULL_LONG_TIME=216e5,e._ICE_STATE={FAILED:"failed",CHECKING:"checking",CONNECTED:"connected",COMPLETED:"completed",DISCONNECTED:"disconnected"},e._peerConnTimer=null,e._peerConnParser=null,e.PEER_ABNORMAL_TIME=2e4,e}return n(t,e),a(t,[{key:"start",value:function(e){this._isActive=!0,this._config=e||{},this._parsePeerConfig(this._config),this._createReport(),this._createRemoteVideoPlayer(),h.Report.enable&&(this._lastErrorType="",this._runPeerStatusTimer(!0)),this._createRTCPeer()}},{key:"stop",value:function(){this._isActive=!1,this._reportStopPull(),this._destroyReport(),this._runPeerStatusTimer(!1),this._destroyPeerConnTimer(),this._destroyLongPullTimer(),this._destroyPeerRetryTimer(!0),this._destroyRTCServerRetryTimer(!0),this._destroyTrackDetector(),this._destroyPeer(),this._destroyRemoteStream(),this._destroyRemoteVideoPlayer()}},{key:"switchAudio",value:function(e){if(this._remoteStream){var t=this._remoteStream.getAudioTracks();t&&t.length&&t.forEach(function(t){"true"===String(e)||"false"===String(e)?t.enabled="true"===String(e):t.enabled=!t.enabled,b.default.log("current audio track state is "+(t.enabled?"on":"off"),u.LOG.PULL)})}}},{key:"switchVideo",value:function(e){if(this._remoteStream){var t=this._remoteStream.getVideoTracks();t&&t.length&&t.forEach(function(t){"true"===String(e)||"false"===String(e)?t.enabled="true"===String(e):t.enabled=!t.enabled,b.default.log("current video track state is "+(t.enabled?"on":"off"),u.LOG.PULL)})}}},{key:"getPeerStatus",value:function(){!(arguments.length>0&&void 0!==arguments[0])||arguments[0];this._createPeerStater(),this._getStater.getPeerStatus()}},{key:"getWaitingCount",value:function(){var e=0;return this._remoteVideoPlayer&&(e=this._remoteVideoPlayer.waitingCount,this._remoteVideoPlayer.waitingCount=0),e}},{key:"_quit",value:function(e){return!this._isActive&&(b.default.debug("["+e+"]server stop",u.LOG.PULL),!0)}},{key:"_parsePeerConfig",value:function(e){this._enforceTCP=!1,this._config.networkConfig&&(this._networkConfig=this._config.networkConfig||{},this._enforceTCP="true"===String(this._networkConfig.enforceTCP))}},{key:"_createReport",value:function(){h.Report.enable&&!this._rtcReportor&&(this._rtcReportor=new f.default)}},{key:"_destroyReport",value:function(){this._rtcReportor&&(this._rtcReportor.stop(),this._rtcReportor=void 0)}},{key:"_createRemoteVideoPlayer",value:function(){var e=this;this._remoteVideoPlayer||(this._remoteVideoPlayer=new T.default(this._config.playerDom),this._remoteVideoPlayer.listenTo(c.PullEvent.VIDEO_EVENT,function(t){if(t&&!e._quit("PullEvent.VIDEO_EVENT")){var i=t[u.RSP.TYPE],r=t[u.RSP.CODE],s=t[u.RSP.MESSAGE],o=t[u.RSP.DATA]||{};switch(i){case c.PullMessage.PLAY_METADATA:case c.PullMessage.PLAY_ERROR:e._dispatchEvent(i,r,s,o)}}})),this._remoteVideoPlayer.start()}},{key:"_destroyRemoteVideoPlayer",value:function(){this._remoteVideoPlayer&&(this._remoteVideoPlayer.removeToAll(),this._remoteVideoPlayer.stop(),this._remoteVideoPlayer=void 0)}},{key:"_createRTCPeer",value:function(){try{this._peer=new RTCPeerConnection(null)}catch(e){return b.default.warn(e.toString(),u.LOG.PULL),this._reportError(h.ErrorType.REFUSED,e.toString()),void this._reCreateRTCPeer()}this._peer.ontrack=this._goRemoteStream.bind(this),this._peer.onicecandidate=this._onIceCandidate.bind(this),this._peer.oniceconnectionstatechange=this._onIceStateChange.bind(this),this._getStater&&(this._getStater.peer=this._peer),this._rtcServerHeaders={},this._rtcServerHeaders[l.HOST.RTC_HEADER_TOKEN]=l.Globals.token,this._rtcServerHeaders[l.HOST.RTC_HEADER_APP_ID]=l.Globals.appId,this._rtcServerHeaders[l.HOST.RTC_HEADER_USER_ID]=l.Globals.userId,this._rtcServerHeaders[l.HOST.RTC_HEADER_TRACE_ID]=l.Globals.traceId,l.Globals.isPermission&&(this._rtcServerHeaders[l.HOST.RTC_HEADER_TICKET]=l.Globals.ticket),this._postRTCServer({},this._rtcServerHeaders)}},{key:"_destroyPeer",value:function(){this._peer&&(this._peer.ontrack=void 0,this._peer.onicecandidate=void 0,this._peer.oniceconnectionstatechange=void 0,this._peer.close(),this._peer=void 0)}},{key:"_getAvailablePullUrl",value:function(){var e=this._config.pullUrls[0];return this._urlSwitch++,this._urlSwitch%2==0?(this._urlSwitch=0,this._urlIndex++,this._urlIndex>=this._config.pullUrls.length&&(this._urlIndex=0),e=this._config.pullUrls[this._urlIndex]):""!==this._pullUrl?this._pullUrl:e}},{key:"_postRTCServer",value:function(e,t){if(this._destroyRTCServerRetryTimer(!1),!this._quit("_postRTCServer")){this._pullUrl=this._getAvailablePullUrl(),this._rtcReportor&&(this._rtcReportor.avType="",this._getStater&&(this._getStater.avType="")),this._reportStartPull(),this._rtcServerXHR||(this._rtcServerXHR=new O.default(this._postRTCServerSuccess.bind(this),this._postRTCServerFailed.bind(this)));var i={};i[u.XHR.METHOD]="GET",i[u.XHR.HEADERS]=t,this._rtcServerXHR.start(this._pullUrl,e,i)}}},{key:"_postRTCServerSuccess",value:function(e,t){var i=this;if(!this._quit("_postRTCServerSuccess")){var r="";if(!e||t!==u.XHR.SUCCESS)return r=e?"response status: "+t:"response is null",this._reportError(h.ErrorType.UNKNOWN,r),void this._startRTCServerRetryTimer();var s=void 0,o=void 0;try{s=JSON.parse(e).sdp,o=s.replace(/;;/g,"\r\n")}catch(e){return r="parse sdp response failed",this._reportError(h.ErrorType.REFUSED,"SDP Parsed Error"),this._dispatchEvent(c.PullMessage.RTC_SERVER_ERROR,u.RSP.ERROR,r),void this.stop()}o=y.default.resetICECandidate({enforceTCP:this._enforceTCP},o),b.default.log("peer answer SDP: \n"+o,u.LOG.PULL);var n=o.indexOf("m=audio"),a=o.indexOf("m=video");if(this._remoteVideoPlayer&&(a>0?this._remoteVideoPlayer.setHasVideo(!0):this._remoteVideoPlayer.setHasVideo(!1)),this._rtcReportor&&(n>0&&a>0?this._rtcReportor.avType="av":n>0?this._rtcReportor.avType="audio":a>0&&(this._rtcReportor.avType="video"),this._getStater&&(this._getStater.avType=this._rtcReportor.avType)),!this._peer)return void b.default.warn("RTCPeerConnection offline",u.LOG.PULL);this._destroyRTCServerRetryTimer(!0),this._peer.setRemoteDescription({type:"offer",sdp:o},function(){b.default.log("set remote description success",u.LOG.PULL),i._peer.createAnswer().then(i._onCreateAnswerSuccess.bind(i),i._onCreateAnswerError.bind(i))},function(e){var t="set remote description failed["+e.toString()+"]";b.default.warn(t,u.LOG.PULL),i._reportError(h.ErrorType.REFUSED,"setRemoteDescription failed"),i._dispatchEvent(c.PullMessage.RTC_SERVER_ERROR,u.RSP.ERROR,t),i.stop()})}}},{key:"_postRTCServerFailed",value:function(e,t){if(!this._quit("_postRTCServerFailed")){this._destroyRTCServerRetryTimer(!1),e||(e={});var i="",r=parseInt(e[u.XHR.STATUS]);if(this._reportError(h.ErrorType.REFUSED,"status="+r),!isNaN(r)){if(400===r?i="request error by error url or http headers or body":403===r&&(i="authentication faied, forbidden access"),""!==i)return this._dispatchEvent(c.PullMessage.RTC_SERVER_ERROR,r,i),void this.stop();b.default.log("subscribe status["+r+"]",u.LOG.PULL)}this._startRTCServerRetryTimer()}}},{key:"_startRTCServerRetryTimer",value:function(){var e=this;if(++this._rtcServerRetryCount<this.RTC_RETRY_LIMIT){var t=this.RTC_RETRY_TIMER_TIME;this._rtcServerRetryCount>=this.PRE_TIME_LIMIT&&(t=this.RTC_RETRY_TIMER_TIME*this.RTC_FACTOR),b.default.log("["+this._rtcServerRetryCount+"]rePostRTCServer after "+t+"ms",u.LOG.PULL),this._rtcServerRetryTimer=window.setTimeout(function(){e._quit("rtcServerRetryTimer")||e._postRTCServer({},e._rtcServerHeaders)},t)}else this._reportError(h.ErrorType.REFUSED,"pull retry limit"),this._dispatchEvent(c.PullMessage.RTC_SERVER_ERROR,u.RSP.ERROR,"subscribe retry limit error"),this.stop()}},{key:"_destroyRTCServerRetryTimer",value:function(){arguments.length>0&&void 0!==arguments[0]&&arguments[0]&&(this._rtcServerRetryCount=0),this._rtcServerRetryTimer&&(window.clearTimeout(this._rtcServerRetryTimer),this._rtcServerRetryTimer=void 0)}},{key:"_onCreateAnswerError",value:function(e){this._quit("_onCreateAnswerError")||(b.default.warn(e.toString(),u.LOG.PULL),this._reportError(h.ErrorType.REFUSED,"create answer error"),this._reCreateRTCPeer())}},{key:"_onCreateAnswerSuccess",value:function(e){var t=this;if(!this._quit("_onCreateAnswerSuccess")){if(!e||!e.sdp)return b.default.warn("createAnswerOffer null",u.LOG.PULL),this._reportError(h.ErrorType.REFUSED,"setLocalDsp failed"),this._dispatchEvent(c.PullMessage.RTC_SERVER_ERROR,u.RSP.ERROR,"subscribe failed"),void this.stop();b.default.log("local answer SDP: \n"+e.sdp,u.LOG.PULL),this._peer&&this._peer.setLocalDescription(e,function(){t._quit("setLocalDescription")||(b.default.log("set local description success",u.LOG.PULL),t._createLongPullTimer(),t._dispatchEvent(c.PullMessage.RTC_SERVER_SUCCESS,u.RSP.SUCCESS,"subscribe success"))},function(e){t._quit("setLocalDescription")||(b.default.warn("set local description failed["+e.toString()+"]",u.LOG.PULL),t._reportError(h.ErrorType.REFUSED,"setLocalDsp failed"),t._dispatchEvent(c.PullMessage.RTC_SERVER_ERROR,u.RSP.ERROR,"subscribe failed"),t.stop())})}}},{key:"_reCreateRTCPeer",value:function(){this._quit("_reCreateRTCPeer")||(this._destroyPeer(),this._destroyPeerRetryTimer(),this._destroyRTCServerRetryTimer(!0),this._startPeerRetryTimer())}},{key:"_destroyPeerRetryTimer",value:function(){arguments.length>0&&void 0!==arguments[0]&&arguments[0]&&(this._peerRetryCount=0),this._peerRetryTimer&&(window.clearTimeout(this._peerRetryTimer),this._peerRetryTimer=void 0)}},{key:"_startPeerRetryTimer",value:function(){if(++this._peerRetryCount<this.RTC_RETRY_LIMIT){var e=this.RTC_RETRY_TIMER_TIME;this._peerRetryCount>=this.PRE_TIME_LIMIT&&(e=this.RTC_RETRY_TIMER_TIME*this.RTC_FACTOR),b.default.log("["+this._peerRetryCount+"]recreate rtcPeer after "+e+"ms",u.LOG.PULL),this._peerRetryTimer=window.setTimeout(this._createRTCPeer.bind(this),e)}else this._reportError(h.ErrorType.REFUSED,"recreate peer limit"),this._dispatchEvent(c.PullMessage.RTC_SERVER_ERROR,u.RSP.ERROR,"recreate rtcPeer limit error"),this.stop()}},{key:"_createTrackDetector",value:function(){var e=this;this._trackDetector||(this._trackDetector=new m.default(function(){e._quit("TrackDetect callback")||e._remoteStream&&e._remoteVideoPlayer&&e._remoteVideoPlayer.play(e._remoteStream)}))}},{key:"_destroyTrackDetector",value:function(){this._trackDetector&&(this._trackDetector.stop(),this._trackDetector=void 0)}},{key:"_goRemoteStream",value:function(e){this._quit("_goRemoteStream")||(this._remoteStream=e.streams[0],this._remoteVideoPlayer?this._remoteVideoPlayer.play(this._remoteStream):b.default.warn("no remote video player",u.LOG.PULL),"true"===String(this._config.isTrackDetect)&&(this._createTrackDetector(),this._trackDetector.start(this._remoteStream)))}},{key:"_destroyRemoteStream",value:function(){this._destroyTrackDetector(),this._remoteStream=void 0}},{key:"_onIceCandidate",value:function(e){if(!this._quit("_onIceCandidate")){var t="null";e&&e.candidate&&(t=e.candidate.candidate),b.default.log("ICE candidate: \n"+t,u.LOG.PULL)}}},{key:"_onIceStateChange",value:function(e){if(!this._quit("_onIceStateChange")&&this._peer&&e&&e.currentTarget){var t=e.currentTarget;t.iceConnectionState&&t.iceGatheringState&&(b.default.log("iceConnectionState: "+t.iceConnectionState+", iceGatheringState: "+t.iceGatheringState,u.LOG.PULL),t.iceConnectionState===this._ICE_STATE.FAILED?(this._reportError(h.ErrorType.TIMEOUT,"ice conn failed"),this._reCreateRTCPeer()):t.iceConnectionState===this._ICE_STATE.COMPLETED?(this._destroyPeerConnTimer(),this._destroyPeerRetryTimer(!0),""!==this._lastErrorType&&(this._reportSuccess(this._lastErrorType),this._lastErrorType="")):t.iceConnectionState===this._ICE_STATE.CHECKING?this._enforceTCP||"true"!==String(this._networkConfig.isDetect)||(b.default.log("ready to detect connection network",u.LOG.PULL),this._createPeerConnTimer()):t.iceConnectionState===this._ICE_STATE.CONNECTED&&this._destroyPeerConnTimer())}}},{key:"_createLongPullTimer",value:function(){var e=this;this._destroyLongPullTimer();var t=!1,i=this.PULL_LONG_TIME;if(this._config.longPullConfig){var r=this._config.longPullConfig||{};t="true"===String(r.enable),void 0!==r.time&&(i=parseInt(r.time),(isNaN(i)||i<1e4)&&(i=this.PULL_LONG_TIME))}t&&!this._longPullTimer&&(this._longPullTimer=window.setTimeout(function(){e._quit("_createLongPullTimer")||(b.default.log("pull long time",u.LOG.PULL),e._reportError(h.ErrorType.REFUSED,"pull long time"),e._reCreateRTCPeer())},i))}},{key:"_destroyLongPullTimer",value:function(){this._longPullTimer&&(window.clearTimeout(this._longPullTimer),this._longPullTimer=void 0)}},{key:"_createPeerStater",value:function(){this._getStater||(this._getStater=new v.default(this)),this._getStater.peer=this._peer}},{key:"_destroyPeerStater",value:function(){this._getStater&&(this._getStater.stop(),this._getStater=void 0)}},{key:"_runPeerStatusTimer",value:function(){arguments.length>0&&void 0!==arguments[0]&&!arguments[0]?(this._getStater&&this._getStater.getPeerStatus(),this._destroyPeerStater()):(this._createPeerStater(),this._getStater.start())}},{key:"_reportStartPull",value:function(){this._rtcReportor&&h.Report.enable&&(this._rtcReportor.url=this._pullUrl,this._rtcReportor.roomId=this._config.roomId||"",this._getStater&&(this._getStater.url=this._rtcReportor.url,this._getStater.roomId=this._rtcReportor.roomId),this._rtcReportor.reportStartPull())}},{key:"_reportStopPull",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"";this._rtcReportor&&h.Report.enable&&this._rtcReportor.reportStopPull(e)}},{key:"_reportError",value:function(e,t){if(this._rtcReportor&&h.Report.enable){var i=t;i.length>20&&(i=i.substr(0,20)),this._lastErrorType=e,this._rtcReportor.reportError({type:e,message:i})}}},{key:"_reportSuccess",value:function(e){this._rtcReportor&&h.Report.enable&&this._rtcReportor.reportSuccess(e)}},{key:"_createPeerConnTimer",value:function(){var e=this;this._peerConnTimer||(this._peerConnTimer=window.setTimeout(function(){e._onPeerConnTimerHandler()},this.PEER_ABNORMAL_TIME))}},{key:"_destroyPeerConnTimer",value:function(){this._peerConnTimer&&(window.clearTimeout(this._peerConnTimer),this._peerConnTimer=null),this._peerConnParser&&(this._peerConnParser.removeToAll(),this._peerConnParser=null)}},{key:"_onPeerConnTimerHandler",value:function(){var e=this;this._destroyPeerConnTimer(),this._peer&&!this._quit("_onPeerConnTimerHandler")&&(this._peerConnParser||(this._peerConnParser=new S.default,this._peerConnParser.listenTo(c.PullMessage.PEER_STAT,function(t){e._onPeerStatEventHandler(t)})),this._peerConnParser.peer=this._peer,this._peerConnParser.start())}},{key:"_onPeerStatEventHandler",value:function(e){if(e&&!this._quit("_onPeerStatEventHandler")){var t=e[u.RSP.TYPE],i=e[u.RSP.DATA]||{};switch(t){case c.STAT.PEER_CONN_SWITCH_EVENT:var r=i[c.STAT.PEER_PROC],s=parseInt(i[c.STAT.PEER_BYTES_RECEIVED]);if(b.default.log("connection protocol["+r+"], bytesReceived["+s+"]",u.LOG.PULL),"udp"===r&&0===s){var o="peer connection abnormal, try switching to tcp";b.default.warn(o,u.LOG.PULL),this._dispatchEvent(c.PullMessage.PEER_CONN_SWITCH_EVENT,u.RSP.SUCCESS,o)}}}}},{key:"_dispatchEvent",value:function(e,t,i){var r=arguments.length>3&&void 0!==arguments[3]?arguments[3]:{};this._quit("_dispatchEvent")||this.trigger(c.PullEvent.PEER_EVENT,{type:e,code:t,message:i,data:r})}}]),t}(k.default);t.default=I},function(e,t,i){"use strict";function r(e){return e&&e.__esModule?e:{default:e}}function s(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function o(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t}function n(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}Object.defineProperty(t,"__esModule",{value:!0});var a=function(){function e(e,t){for(var i=0;i<t.length;i++){var r=t[i];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}return function(t,i,r){return i&&e(t.prototype,i),r&&e(t,r),t}}(),u=i(0),c=i(9),l=i(2),h=i(89),d=r(h),f=i(6),_=r(f),v=i(1),p=r(v),m=i(3),g=r(m),y=function(e){function t(){s(this,t);var e=o(this,(t.__proto__||Object.getPrototypeOf(t)).call(this));return e._isActive=!1,e._config={},e._rtcPeer=void 0,e}return n(t,e),a(t,[{key:"start",value:function(e){this._isActive=!0,this._config=e||{},l.Globals.isRtcTest?this.pullUrls=this._assemblePullUrl(l.Globals.rtcPullHosts):this.pullUrls=this._assemblePullUrl(l.Globals.rtcHosts),this.pullUrl=this.pullUrls[0],this._subscribe()}},{key:"stop",value:function(){this._isActive=!1,this._destroyRTCPeer()}},{key:"switchAudio",value:function(e){this._rtcPeer&&this._rtcPeer.switchAudio(e)}},{key:"switchVideo",value:function(e){this._rtcPeer&&this._rtcPeer.switchVideo(e)}},{key:"getPeerStatus",value:function(){var e=!(arguments.length>0&&void 0!==arguments[0])||arguments[0];this._rtcPeer&&this._rtcPeer.getPeerStatus(e)}},{key:"_quit",value:function(e){return!this._isActive&&(p.default.debug("["+e+"]server stop",u.LOG.PULL),!0)}},{key:"_parsePullUrl",value:function(e){var t=this._config.pullUrl,i=t.split("?"),r=_.default.getQueryParams(i[1]),s=_.default.getStreamName(i[0]),o=void 0;o=""===l.Globals.rtcTestHost?l.HOST.RTC_HOST:l.Globals.rtcTestHost;var n=l.HOST.PROTOCOL+o;n+=":"+l.HOST.RTC_PORT+"/"+s,n+="?v="+l.HOST.RTC_VER+"&type=subscribe";for(var a in r)if(r.hasOwnProperty(a))switch(a){case"host":case"wsHost":case"proto":n+="&"+a+"="+r[a];break;case"nodeaddr":e||(n+="&"+a+"="+r[a]);break;case"area":""!==r[a]&&(n+="&"+a+"="+r[a])}if(!e)return n;for(var u=[],c=n,h=0;h<e.length;h++)c+="&nodeaddr="+e[h]+":"+l.HOST.RTC_TRAN_PORT,u.push(c),c=n;return u.length||u.push(n),u}},{key:"_assemblePullUrl",value:function(e){var t=void 0;t=""===l.Globals.rtcTestHost?l.HOST.RTC_HOST:l.Globals.rtcTestHost;var i=l.HOST.PROTOCOL+t;if(i+=":"+l.HOST.RTC_PORT+"/"+this._config.streamName,i+="?v="+l.HOST.RTC_VER+"&type=subscribe&wsHost="+l.Globals.host,void 0!==this._config.proto&&(i+="&proto="+parseInt(this._config.proto)),l.Globals.isRtcArea){var r=this._config.area||l.Globals.rtcArea;""!==r&&(i+="&area="+r)}for(var s=[],o=i,n=0;n<e.length;n++)o+="&nodeaddr="+e[n]+":"+l.HOST.RTC_TRAN_PORT,s.push(o),o=i;return s.length||s.push(i),s}},{key:"_subscribe",value:function(){this._createRTCPeerServer()}},{key:"_destroyRTCPeer",value:function(){this._rtcPeer&&(this._rtcPeer.removeToAll(),this._rtcPeer.stop(),this._rtcPeer=void 0)}},{key:"_createRTCPeerServer",value:function(){var e=this,t=this._config;this._rtcPeer||(this._rtcPeer=new d.default,this._rtcPeer.listenTo(c.PullEvent.PEER_EVENT,function(t){if(t){var i=t[u.RSP.TYPE],r=t[u.RSP.CODE],s=t[u.RSP.MESSAGE],o=t[u.RSP.DATA]||{};switch(i){case c.PullMessage.PLAY_METADATA:case c.PullMessage.RTC_SERVER_SUCCESS:case c.PullMessage.RTC_SERVER_ERROR:case c.PullMessage.PLAY_ERROR:case c.PullMessage.PEER_CONN_SWITCH_EVENT:e._dispatchEvent(i,r,s,o)}}})),t.pullUrls=this.pullUrls,this._rtcPeer.start(t)}},{key:"_dispatchEvent",value:function(e,t,i){var r=arguments.length>3&&void 0!==arguments[3]?arguments[3]:{};this._quit("_dispatchEvent")||this.trigger(c.PullEvent.PULL_EVENT,{type:e,code:t,message:i,data:r})}},{key:"userId",get:function(){return this._config.userId||void 0}},{key:"roomId",get:function(){return this._config.roomId||void 0}},{key:"peerUserId",get:function(){return this._config.peerUserId||void 0}},{key:"playerId",get:function(){return this._config.playerId||void 0}},{key:"playerDom",get:function(){return this._config.playerDom||void 0}}]),t}(g.default);t.default=y},function(e,t,i){"use strict";function r(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}Object.defineProperty(t,"__esModule",{value:!0});var s=function(){function e(e,t){for(var i=0;i<t.length;i++){var r=t[i];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}return function(t,i,r){return i&&e(t.prototype,i),r&&e(t,r),t}}(),o=i(5),n=i(0),a=i(2),u=i(11),c=function(e){return e&&e.__esModule?e:{default:e}}(u),l=function(){function e(){r(this,e),this._url="",this._roomId="",this._avType="",this.init()}return s(e,[{key:"init",value:function(){this._reportor=new c.default}},{key:"stop",value:function(){this._reportor=void 0}},{key:"reportStartPull",value:function(){if(this._reportor){var e={};e[o.MACRO.MIC_URL]=this.url,e[o.MACRO.ROOM_ID]=this.roomId,e[o.MACRO.DEV_INFO]=a.Globals.deviceId,e[o.MACRO.ADEC_MODE]=o.MACRO.DEC_MODE,e[o.MACRO.VDEC_MODE]=o.MACRO.DEC_MODE,e[o.MACRO.EVENT_NAME]=o.MACRO.PULL_START,e[o.MACRO.MIC_TIME]=e[o.MACRO.EVENT_TIME]=this._reportor.getCurrentTime(),this._reportor.report({data:e})}}},{key:"reportStopPull",value:function(){arguments.length>0&&void 0!==arguments[0]&&arguments[0];if(this._reportor&&""!==this.url){var e={};e[o.MACRO.MIC_URL]=this.url,e[o.MACRO.ROOM_ID]=this.roomId,e[o.MACRO.DEV_INFO]=a.Globals.deviceId,e[o.MACRO.EVENT_NAME]=o.MACRO.PULL_STOP,e[o.MACRO.EVENT_TIME]=this._reportor.getCurrentTime(),""!==this.avType&&(e[o.MACRO.MIC_TYPE]=this.avType),this._reportor.report({data:e})}}},{key:"reportError",value:function(e){if(this._reportor){var t={};t[o.MACRO.MIC_URL]=this.url,t[o.MACRO.ROOM_ID]=this.roomId,t[o.MACRO.CONN_TYPE]=o.ConnType.PULL,t[o.MACRO.EVENT_NAME]=o.MACRO.CONN_ERR,t[o.MACRO.ERR_TYPE]=e[n.RSP.TYPE]||"",t[o.MACRO.ERR_INFO]=e[n.RSP.MESSAGE]||"",t[o.MACRO.EVENT_TIME]=this._reportor.getCurrentTime(),this._reportor.report({data:t})}}},{key:"reportSuccess",value:function(e){if(this._reportor){var t={};t[o.MACRO.MIC_URL]=this.url,t[o.MACRO.ROOM_ID]=this.roomId,t[o.MACRO.CONN_TYPE]=o.ConnType.PULL,t[o.MACRO.EVENT_NAME]=o.MACRO.CONN_SUCC,t[o.MACRO.EVENT_TIME]=this._reportor.getCurrentTime(),""!==this.avType&&(t[o.MACRO.MIC_TYPE]=this.avType),this._reportor.report({data:t})}}},{key:"reportStat",value:function(e){if(this._reportor){var t={};t[o.MACRO.MIC_URL]=this.url,t[o.MACRO.ROOM_ID]=this.roomId,t[o.MACRO.DEV_INFO]=a.Globals.deviceId,t[o.MACRO.EVENT_NAME]=o.MACRO.RGL_PULL_REPORT,t[o.MACRO.AVG_VLR]=e[o.MACRO.AVG_VLR]||"0.000",t[o.MACRO.AVG_ALR]=e[o.MACRO.AVG_ALR]||"0.000",t[o.MACRO.TTL_VSP]=e[o.MACRO.TTL_VSP]||"0",t[o.MACRO.TTL_ASP]=e[o.MACRO.TTL_ASP]||"0",t[o.MACRO.JITTER_TIME]=e[o.MACRO.JITTER_TIME]||"0",t[o.MACRO.JITTER_COUNT]=e[o.MACRO.JITTER_COUNT]||"0",t[o.MACRO.AVG_DEC_FPS]=e[o.MACRO.AVG_DEC_FPS]||"0.000",t[o.MACRO.AVG_TRAN_FPS]=e[o.MACRO.AVG_TRAN_FPS]||"0.000",t[o.MACRO.EVENT_TIME]=this._reportor.getCurrentTime(),""!==this.avType&&(t[o.MACRO.MIC_TYPE]=this.avType),this._reportor.report({data:t})}}},{key:"roomId",get:function(){return this._roomId},set:function(e){this._roomId=e||""}},{key:"url",get:function(){return this._url},set:function(e){var t="",i=[],r=e.split("?");r&&(i=r[0].split("/"))&&i.length>1&&(t=a.Globals.host+"/"+i[i.length-2]+"/"+i[i.length-1]),this._url=t}},{key:"avType",get:function(){return this._avType},set:function(e){this._avType=e}}]),e}();t.default=l},function(e,t,i){"use strict";function r(e){return e&&e.__esModule?e:{default:e}}function s(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}Object.defineProperty(t,"__esModule",{value:!0});var o=function(){function e(e,t){for(var i=0;i<t.length;i++){var r=t[i];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}return function(t,i,r){return i&&e(t.prototype,i),r&&e(t,r),t}}(),n=i(0),a=i(1),u=r(a),c=i(37),l=r(c),h=i(13),d=r(h),f=function(){function e(){s(this,e)}return o(e,null,[{key:"resetICECandidate",value:function(e,t){var i=t,r=l.default.hasCandidate(i);u.default.log("have udp candidate: "+r.hasUDP,n.LOG.PULL),u.default.log("have tcp candidate: "+r.hasTCP,n.LOG.PULL);var s=e.enforceTCP;return s&&r.hasTCP&&(u.default.log("disable udp channel",n.LOG.PULL),i=l.default.removeCandidate(i,"udp")),!s&&r.hasUDP&&r.hasTCP&&d.default.isFirefox()&&(u.default.log("firefox force to disable tcp channel",n.LOG.PULL),i=l.default.removeCandidate(i,"tcp")),i}}]),e}();t.default=f},function(e,t,i){"use strict";function r(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}Object.defineProperty(t,"__esModule",{value:!0});var s=function(){function e(e,t){for(var i=0;i<t.length;i++){var r=t[i];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}return function(t,i,r){return i&&e(t.prototype,i),r&&e(t,r),t}}(),o=i(0),n=i(1),a=function(e){return e&&e.__esModule?e:{default:e}}(n),u=function(){function e(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:null;r(this,e),this.DETECT_LIMIT=6,this.STRACK_TIME=5e3,this.trackTimerCount=0,this.trackTimer=void 0,this.audioTracks=null,this.videoTracks=null,this.muteAudioTrackCount=0,this.muteVideoTrackCount=0,this.renderStreamCallback=t}return s(e,[{key:"start",value:function(e){e&&(this.audioTracks=e.getAudioTracks(),this.videoTracks=e.getVideoTracks()),this.listenStreamTrack(),this.startTrackTimer()}},{key:"stop",value:function(){this.stopTrackTimer(),this.unlistenStreamTrack()}},{key:"listenStreamTrack",value:function(){[this.audioTracks,this.videoTracks].forEach(function(e){e&&e.length&&e.forEach(function(e){e&&!e.onmute&&(e.onmute=function(){a.default.log(e.kind+" track trigger onmute",o.LOG.PULL)}),e&&!e.onunmute&&(e.onunmute=function(){a.default.log(e.kind+" track trigger onunmute",o.LOG.PULL)})})})}},{key:"unlistenStreamTrack",value:function(){[this.audioTracks,this.videoTracks].forEach(function(e){e&&e.length&&e.forEach(function(e){e&&e.onmute&&(e.onmute=null),e&&e.onunmute&&(e.onunmute=null)})}),this.audioTracks=null,this.videoTracks=null,this.muteAudioTrackCount=0,this.muteVideoTrackCount=0}},{key:"startTrackTimer",value:function(){var e=this;this.stopTrackTimer(),this.muteAudioTrackCount=0,this.muteVideoTrackCount=0,this.trackTimer=window.setInterval(function(){if(++e.trackTimerCount>e.DETECT_LIMIT)return e._disableStreamTrack(),e.stop(),void a.default.log("stop streamTrack timer",o.LOG.PULL);e._detectStreamTrack()},this.STRACK_TIME)}},{key:"stopTrackTimer",value:function(){this.trackTimer&&(window.clearInterval(this.trackTimer),this.trackTimer=null),this.trackTimerCount=0}},{key:"_disableStreamTrack",value:function(){var e=!0;this.muteAudioTrackCount>=this.DETECT_LIMIT&&this.audioTracks&&this.audioTracks.length&&(e=!0,this.audioTracks.forEach(function(t){e=!1,t.enabled=!1,a.default.log("disable audio track",o.LOG.PULL)}),e||this.renderStreamCallback&&this.renderStreamCallback()),this.muteVideoTrackCount>=this.DETECT_LIMIT&&this.videoTracks&&this.videoTracks.length&&(e=!0,this.videoTracks.forEach(function(t){e=!1,t.enabled=!1,a.default.log("disable video track",o.LOG.PULL)}),e||this.renderStreamCallback&&this.renderStreamCallback()),a.default.log("muteAudioTrackCount = "+this.muteAudioTrackCount+", muteVideoTrackCount = "+this.muteVideoTrackCount,o.LOG.PULL)}},{key:"_detectStreamTrack",value:function(){var e=!1;this.audioTracks&&this.audioTracks.length&&(this.audioTracks.forEach(function(t){"true"===String(t.muted)&&(e=!0)}),e&&this.muteAudioTrackCount++),this.videoTracks&&this.videoTracks.length&&(this.videoTracks.forEach(function(t){"true"===String(t.muted)&&(e=!0)}),e&&this.muteVideoTrackCount++)}}]),e}();t.default=u},function(e,t,i){"use strict";function r(e){return e&&e.__esModule?e:{default:e}}function s(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function o(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t}function n(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}Object.defineProperty(t,"__esModule",{value:!0});var a=function(){function e(e,t){for(var i=0;i<t.length;i++){var r=t[i];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}return function(t,i,r){return i&&e(t.prototype,i),r&&e(t,r),t}}(),u=i(0),c=i(9),l=i(1),h=r(l),d=i(3),f=r(d),_=function(e){function t(e){s(this,t);var i=o(this,(t.__proto__||Object.getPrototypeOf(t)).call(this));return i.video=e,i._isActive=!1,i._isHasVideo=!1,i._waitingCount=0,i}return n(t,e),a(t,[{key:"quit",value:function(e){return!this._isActive&&(h.default.debug("["+e+"]server stop",u.LOG.PULL),!0)}},{key:"start",value:function(){if(this._isActive=!0,!this.video)return void h.default.warn("add remote video is null",u.LOG.PULL);this.video.addEventListener("pause",this.localPause.bind(this)),this.video.addEventListener("error",this.localError.bind(this)),this.video.addEventListener("ended",this.localEnded.bind(this)),this.video.addEventListener("playing",this.localPlay.bind(this)),this.video.addEventListener("waiting",this.localWaiting.bind(this)),this.video.addEventListener("loadedmetadata",this.localMetadata.bind(this))}},{key:"stop",value:function(){this._isActive=!1,this.video&&(this.video.srcObject=null,this.video.removeEventListener("pause",this.localPause.bind(this)),this.video.removeEventListener("error",this.localError.bind(this)),this.video.removeEventListener("ended",this.localEnded.bind(this)),this.video.removeEventListener("playing",this.localPlay.bind(this)),this.video.removeEventListener("waiting",this.localWaiting.bind(this)),this.video.removeEventListener("loadedmetadata",this.localMetadata.bind(this)),this.video=void 0)}},{key:"play",value:function(e){this.video&&this.video.srcObject!==e&&(this.video.srcObject=e)}},{key:"setHasVideo",value:function(e){this._isHasVideo="true"===String(e)}},{key:"localEnded",value:function(){this.quit("localEnded")||h.default.log("video ended",u.LOG.PULL)}},{key:"localPause",value:function(){this.quit("localPause")||h.default.log("video pause",u.LOG.PULL)}},{key:"localPlay",value:function(){this.quit("localPlay")||h.default.log("video playing",u.LOG.PULL)}},{key:"localWaiting",value:function(){this.quit("localWaiting")||(this._waitingCount++,h.default.log("video waiting",u.LOG.PULL))}},{key:"localError",value:function(e){if(!this.quit("localError")){var t=void 0;e&&e.currentTarget&&(t=e.currentTarget.error);var i=0,r="";t&&(i=t.code||0,r=t.message,h.default.error("localError: ["+i+"]["+r+"]",u.LOG.PULL)),this.dispatchEvent(c.PullMessage.PLAY_ERROR,i,r)}}},{key:"localMetadata",value:function(e){var t=this;if(!this.quit("localMetadata")){var i=-1,r=-1;if(e&&e.target&&(i=e.target.videoWidth,r=e.target.videoHeight),h.default.log("remoteMetadata ["+i+"x"+r+"]",u.LOG.PULL),e&&e.target)try{e.target.play()}catch(e){}this.dispatchEvent(c.PullMessage.PLAY_METADATA,u.RSP.SUCCESS,"metadata",{width:i,height:r}),this._isHasVideo&&(i>=0&&i<=2||r>=0&&r<=2)&&window.setTimeout(function(){t.quit("localMetadata")||(e&&e.target&&(i=e.target.videoWidth,r=e.target.videoHeight),h.default.log("remoteMetadata ["+i+"x"+r+"]",u.LOG.PULL),t.dispatchEvent(c.PullMessage.PLAY_METADATA,u.RSP.SUCCESS,"metadata",{width:i,height:r}))},5e3)}}},{key:"dispatchEvent",value:function(e,t,i){var r=arguments.length>3&&void 0!==arguments[3]?arguments[3]:{};this.quit("dispatchEvent")||this.trigger(c.PullEvent.VIDEO_EVENT,{type:e,code:t,message:i,data:r})}},{key:"waitingCount",set:function(e){this._waitingCount=e},get:function(){return this._waitingCount}}]),t}(f.default);t.default=_},function(e,t,i){"use strict";function r(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}Object.defineProperty(t,"__esModule",{value:!0});var s=function(){function e(e,t){for(var i=0;i<t.length;i++){var r=t[i];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}return function(t,i,r){return i&&e(t.prototype,i),r&&e(t,r),t}}(),o=i(27),n=function(){function e(t,i){r(this,e),this._destNode=i,this._audioContext=t,this._src="",this._buffer=null,this._isLoaded=!1,this._xhrRequest=null,this._loop=!1,this._loopStart=0,this._loopEnd=0,this._volume=1,this._volumeNode=null,this._sourceNode=null}return s(e,[{key:"init",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};e=e||{};for(var t in e)if(e.hasOwnProperty(t))switch(t){case"isLoop":this._loop="true"===String(e[t]);break;case"loopStart":var i=parseInt(e[t]);!isNaN(i)&&i>=0&&(this._loopStart=i);break;case"loopEnd":var r=parseInt(e[t]);!isNaN(r)&&r>=0&&(this._loopEnd=r);break;case"volume":var s=parseInt(e[t]);!isNaN(s)&&s>=0&&s<=1&&(this._volume=s)}}},{key:"start",value:function(e,t){var i=this;this._src=e,this._xhrRequest?this._isLoaded||this._xhrRequest.abort():this._xhrRequest=o.XHR.createXHR(),this._xhrRequest.open("GET",this._src,!0),this._xhrRequest.responseType="arraybuffer",this._xhrRequest.onload=function(){i._decodeData(i._xhrRequest.response,t)},this._xhrRequest.send()}},{key:"stop",value:function(){this._destroyXHR(),this._buffer=null,this._isLoaded=!1,this._destroyGainNode(),this._destroySourceNode()}},{key:"play",value:function(){this._isLoaded&&this._audioContext&&(this._volumeNode||this._createGainNode(),this._sourceNode&&this._destroySourceNode(),this._createSourceNode(),this._sourceNode.connect(this._volumeNode),this._volumeNode.connect(this._destNode),this._sourceNode.start(0))}},{key:"resume",value:function(){this._isLoaded&&this._volumeNode&&this._volumeNode.connect(this._destNode)}},{key:"pause",value:function(){this._isLoaded&&this._volumeNode&&this._volumeNode.disconnect()}},{key:"setVolume",value:function(e){this._volume=e,this._volumeNode&&(this._volumeNode.gain.value=e)}},{key:"setLoop",value:function(e,t){!1===e?this._loop=!1:(this._loop=!0,this._loopStart=e||0,this._loopEnd=t||0),this._sourceNode&&(this._sourceNode.loopStart=this._loopStart,this._sourceNode.loopEnd=this._loopEnd,this._sourceNode.loop=this._loop)}},{key:"_destroyXHR",value:function(){this._xhrRequest&&(this._xhrRequest.abort(),this._xhrRequest=null)}},{key:"_decodeData",value:function(e,t){var i=this;if(!e||!this._audioContext)return void(t&&t(null));this._audioContext.decodeAudioData(e,function(e){i._buffer=e,i._isLoaded=!0,t&&t(e)},function(){t&&t(null)})}},{key:"_createGainNode",value:function(){this._audioContext&&(this._volumeNode||(this._volumeNode=this._audioContext.createGain(),this._volumeNode.gain.value=this._volume))}},{key:"_destroyGainNode",value:function(){this._volumeNode&&(this._volumeNode.disconnect(),this._volumeNode=null)}},{key:"_createSourceNode",value:function(){this._audioContext&&(this._sourceNode||(this._sourceNode=this._audioContext.createBufferSource(),this._sourceNode.buffer=this._buffer,this._sourceNode.loopStart=this._loopStart,this._sourceNode.loopEnd=this._loopEnd,this._sourceNode.loop=this._loop))}},{key:"_destroySourceNode",value:function(){this._sourceNode&&(this._sourceNode.disconnect(),this._sourceNode.buffer=null,this._sourceNode=null)}}]),e}();t.default=n},function(e,t,i){"use strict";function r(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}Object.defineProperty(t,"__esModule",{value:!0});var s=function(){function e(e,t){for(var i=0;i<t.length;i++){var r=t[i];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}return function(t,i,r){return i&&e(t.prototype,i),r&&e(t,r),t}}(),o=i(95),n=function(e){return e&&e.__esModule?e:{default:e}}(o),a=function(){function e(){r(this,e),this._audioCTX=null,this._gainNode=null,this._sourceNode=null,this._destAudioNode=null,this._compressorNode=null,this._volume=1,this._soundClass=null,this._isCompress=!1}return s(e,[{key:"init",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};this._config=e||{},this._isCompress=!("false"===this._config.isCompress)}},{key:"start",value:function(e,t){var i=[],r=void 0,s=null,o=e.getAudioTracks(),n=e.getVideoTracks();if(o&&o.length){var a=this._gainAuidoTrack(e);a&&(r=a.getAudioTracks())}r&&r.length&&(r.forEach(function(e){i.push(e)}),n&&n.length&&n.forEach(function(e){i.push(e)}),s=new MediaStream(i)),t&&t(s)}},{key:"stop",value:function(){this.stopMix(),this._destroyGainNode(),this._destroyCompressor(),this._destroySourceNode(),this._destroyDestinationNode(),this._destroyAudioContext()}},{key:"startMix",value:function(){var e=this,t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"";this._createSoundStream(),this._soundClass.start(t,function(t){e._soundClass&&e._soundClass.play()})}},{key:"stopMix",value:function(){this._destroySoundStream()}},{key:"pauseMix",value:function(){this._soundClass&&this._soundClass.pause()}},{key:"resumeMix",value:function(){this._soundClass&&this._soundClass.resume()}},{key:"setMixLoop",value:function(e,t){this._soundClass&&this._soundClass.setLoop(e,t)}},{key:"setMixAudioVolume",value:function(e,t){var i=parseFloat(e);i<0||i>1||(this._volume=i,0===t?this._gainNode&&this._gainNode.gain&&(this._gainNode.gain.value=i):1===t&&this._soundClass&&this._soundClass.setVolume(i))}},{key:"_gainAuidoTrack",value:function(e){try{return this._audioCTX||(this._audioCTX=this._createAudioContext()),this._createSourceNode(e),this._createDestinationNode(),this._createGainNode(),this._createCompressor(),this._sourceNode.connect(this._gainNode),this._isCompress?(this._gainNode.connect(this._compressorNode),this._compressorNode.connect(this._destAudioNode)):this._gainNode.connect(this._destAudioNode),this._createSoundStream(),this._destAudioNode.stream}catch(e){return this.stop(),null}}},{key:"_createSoundStream",value:function(){this._soundClass||(this._isCompress?this._soundClass=new n.default(this._audioCTX,this._compressorNode):this._soundClass=new n.default(this._audioCTX,this._destAudioNode),this._soundClass.init(this._config||{}))}},{key:"_destroySoundStream",value:function(){this._soundClass&&(this._soundClass.stop(),this._soundClass=void 0)}},{key:"_createAudioContext",value:function(e){return new(window.AudioContext||window.webkitAudioContext)}},{key:"_destroyAudioContext",value:function(){this._audioCTX&&(this._audioCTX.close(),this._audioCTX=null)}},{key:"_createSourceNode",value:function(e){this._audioCTX&&(this._sourceNode&&this._destroySourceNode(),this._sourceNode=this._audioCTX.createMediaStreamSource(e))}},{key:"_destroySourceNode",value:function(){this._sourceNode&&(this._sourceNode.mediaStream&&this._destroyStream(this._sourceNode.mediaStream),this._sourceNode=null)}},{key:"_createDestinationNode",value:function(){this._audioCTX&&(this._destAudioNode||(this._destAudioNode=this._audioCTX.createMediaStreamDestination()))}},{key:"_destroyDestinationNode",value:function(){this._destAudioNode&&(this._destAudioNode.mediaStream&&this._destroyStream(this._destAudioNode.mediaStream),this._destAudioNode=null)}},{key:"_createGainNode",value:function(){this._audioCTX&&(this._gainNode||(this._gainNode=this._audioCTX.createGain(),this._gainNode.gain.value=this._volume))}},{key:"_destroyGainNode",value:function(){this._gainNode&&(this._gainNode.disconnect(),this._gainNode=null)}},{key:"_createCompressor",value:function(){this._audioCTX&&this._isCompress&&(this._compressorNode||(this._compressorNode=this._audioCTX.createDynamicsCompressor(),this._compressorNode.threshold.setValueAtTime(-50,this._audioCTX.currentTime),this._compressorNode.knee.setValueAtTime(40,this._audioCTX.currentTime),this._compressorNode.ratio.setValueAtTime(12,this._audioCTX.currentTime),this._compressorNode.attack.setValueAtTime(0,this._audioCTX.currentTime),this._compressorNode.release.setValueAtTime(.25,this._audioCTX.currentTime)))}},{key:"_destroyCompressor",value:function(){this._compressorNode&&(this._compressorNode.disconnect(),this._compressorNode=null)}},{key:"_destroyStream",value:function(e){if(e)try{for(var t=e.getTracks(),i=0;i<t.length;i++)t[i].stop()}catch(e){}}}]),e}();t.default=a},function(e,t,i){"use strict";function r(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}Object.defineProperty(t,"__esModule",{value:!0});var s=function(){function e(e,t){for(var i=0;i<t.length;i++){var r=t[i];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}return function(t,i,r){return i&&e(t.prototype,i),r&&e(t,r),t}}(),o=i(6),n=function(e){return e&&e.__esModule?e:{default:e}}(o),a=function(){function e(){r(this,e)}return s(e,[{key:"parse",value:function(e){var t={audio:{},video:{},mediaConfig:e.mediaConfig||{}};return e.audio?"boolean"==typeof e.audio?t.audio=!("false"===String(e.audio)):t=this.parseAudioConfig(e.audio,t):delete t.audio,e.video?"boolean"==typeof e.video?t.video=!("false"===String(e.video)):t=this.parseVideoConfig(e.video,t):delete t.video,t}},{key:"parseAudioConfig",value:function(e,t){var i=t;for(var r in e)if(e.hasOwnProperty(r))switch(r){case"bitrate":case"bitRate":var s=parseInt(e[r]);i.mediaConfig.audioBitrate=s>0&&s<=512?s:0;break;case"deviceId":i.audio[r]=e[r];break;case"sampleSize":case"channelCount":i.audio[r]=parseInt(e[r]);break;case"echoCancellation":i.audio[r]=!("false"===String(e[r])),i.audio[r]||(i=n.default.closeEchoCancellation(i));break;case"isCBR":i.mediaConfig.isAudioCBR="true"===String(e[r])}return i}},{key:"parseVideoConfig",value:function(e,t){var i=t,r={width:-1,height:-1};for(var s in e)if(e.hasOwnProperty(s))switch(s){case"bitrate":case"bitRate":var o=parseInt(e[s]);i.mediaConfig.videoBitrate=o>0&&o<=8192?o:0;break;case"brFactor":var a=parseInt(e[s]);i.mediaConfig.brFactor=a>0&&a<1?a:.6;break;case"deviceId":i.video[s]=e[s];break;case"width":var u=parseInt(e[s]);u>0&&u<=4096&&(r.width=u);break;case"height":var c=parseInt(e[s]);c>0&&c<=2160&&(r.height=c);break;case"framerate":case"frameRate":var l=parseInt(e[s]);l>0&&l<=75&&(i.video.frameRate=l);break;case"landscape":i.mediaConfig[s]=!("false"===String(e[s]));break;case"isCBR":i.mediaConfig.isVideoCBR="true"===String(e[s]);break;case"isBrControl":i.mediaConfig.isBrControl="true"===String(e[s])}var h=void 0,d=void 0,f=void 0,_=i.mediaConfig.landscape;return f=-1===r.width||-1===r.height?n.default.getAspectByProfile(e.profile):r,h=f.width,d=f.height,i.video.width=_?h:d,i.video.height=_?d:h,i.mediaConfig.width=i.video.width,i.mediaConfig.height=i.video.height,i}}]),e}();t.default=a},function(e,t,i){"use strict";function r(e){return e&&e.__esModule?e:{default:e}}function s(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}Object.defineProperty(t,"__esModule",{value:!0});var o=function(){function e(e,t){for(var i=0;i<t.length;i++){var r=t[i];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}return function(t,i,r){return i&&e(t.prototype,i),r&&e(t,r),t}}(),n=i(10),a=i(0),u=i(5),c=i(2),l=i(35),h=r(l),d=i(34),f=r(d),_=i(11),v=r(_),p=function(){function e(t){s(this,e),this._isActive=!1,this._callback=t,this._timer=void 0,this._TIMER_TIME=1e3*u.Report.period,this._peerConnParser=null,this._reportor=new v.default,this._params=new f.default}return o(e,[{key:"init",value:function(e){this._params.roomId=(e||{}).roomId||"",this._params.micType=(e||{}).micType||"av"}},{key:"start",value:function(){var e=this;this._timer&&(window.clearInterval(this._timer),this._timer=void 0),this._isActive=!0,this._timer=window.setInterval(function(){e._peer&&e._isActive&&e.getPeerStatus()},this._TIMER_TIME)}},{key:"stop",value:function(){this._isActive=!1,this._timer&&(window.clearInterval(this._timer),this._timer=void 0),this._peer&&(this._peer=void 0)}},{key:"getPeerStatus",value:function(){this._peer&&(this._isActive=!0,this._reportor||(this._reportor=new v.default),this._createPeerConnParser())}},{key:"_createPeerConnParser",value:function(){var e=this;this._peerConnParser||(this._peerConnParser=new h.default,this._peerConnParser.listenTo(n.PushMessage.PEER_STAT,function(t){if(t){var i=t[a.RSP.TYPE],r=t[a.RSP.DATA]||{};i===n.STAT.PEER_STAT_EVENT&&(e._reportStat(r),e._callback&&e._callback(r)),e._isActive||e._peerConnParser&&(e._peerConnParser.removeToAll(),e._peerConnParser=null)}})),this._peerConnParser.peer=this.peer,this._peerConnParser.start()}},{key:"_reportStat",value:function(e){if(this._reportor&&u.Report.enable){var t={};t[u.MACRO.MIC_URL]=this.url,t[u.MACRO.ROOM_ID]=this.roomId,t[u.MACRO.MIC_TYPE]=this.micType,t[u.MACRO.DEV_INFO]=c.Globals.deviceId,t[u.MACRO.EVENT_NAME]=u.MACRO.RGL_PUSH_REPORT,t[u.MACRO.AVG_VLR]=e[u.MACRO.AVG_VLR]||"0.000",t[u.MACRO.AVG_ALR]=e[u.MACRO.AVG_ALR]||"0.000",t[u.MACRO.AVG_VBR]=e[u.MACRO.AVG_VBR]||"0.000",t[u.MACRO.AVG_ABR]=e[u.MACRO.AVG_ABR]||"0.000",t[u.MACRO.TTL_VSP]=e[u.MACRO.TTL_VSP]||"0",t[u.MACRO.TTL_ASP]=e[u.MACRO.TTL_ASP]||"0",t[u.MACRO.AVG_RVBR]=e[u.MACRO.AVG_RVBR]||"0.000",t[u.MACRO.TAR_ENC_BR]=e[u.MACRO.TAR_ENC_BR]||"0.000",t[u.MACRO.TRANS_INFO]=e[u.MACRO.TRANS_INFO]||"rtc_udp",t[u.MACRO.AVG_ENC_FPS]=e[u.MACRO.AVG_ENC_FPS]||"0.000",t[u.MACRO.AVG_TRAN_FPS]=e[u.MACRO.AVG_TRAN_FPS]||"0.000",t[u.MACRO.EVENT_TIME]=this._reportor.getCurrentTime(),this._reportor.report({data:t}),this._isActive||(this._reportor=void 0)}}},{key:"peer",get:function(){return this._peer},set:function(e){this._peer=e}},{key:"roomId",get:function(){return this._params.roomId||""}},{key:"micType",get:function(){return this._params.micType||"av"}},{key:"url",get:function(){return this._params.url},set:function(e){this._params.url=e}}]),e}();t.default=p},function(e,t,i){"use strict";function r(e){return e&&e.__esModule?e:{default:e}}function s(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function o(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t}function n(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}Object.defineProperty(t,"__esModule",{value:!0});var a=function(){function e(e,t){for(var i=0;i<t.length;i++){var r=t[i];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}return function(t,i,r){return i&&e(t.prototype,i),r&&e(t,r),t}}(),u=i(0),c=i(10),l=i(2),h=i(5),d=i(98),f=r(d),_=i(105),v=r(_),p=i(35),m=r(p),g=i(6),y=r(g),E=i(1),S=r(E),R=i(3),T=r(R),C=i(15),b=r(C),P=function(e){function t(e){s(this,t);var i=o(this,(t.__proto__||Object.getPrototypeOf(t)).call(this));return i._handler=e,i._config={},i._isActive=!1,i._pushUrl="",i._urlIndex=-1,i._urlSwitch=-1,i._dispatchIP="",i._enforceTCP=!1,i._networkConfig={},i._lastErrorType="",i._getStater=void 0,i._localStream=void 0,i._peer=void 0,i._peerRetryCount=0,i._peerRetryTimer=void 0,i._rtcSDP="",i._rtcServerXHR=void 0,i._rtcServerHeaders=void 0,i._rtcRepeatCount=0,i._rtcServerRetryCount=0,i._rtcServerRetryTimer=void 0,i.RTC_REPEAT_COUNT_LIMIT=4,i.RTC_FACTOR=3,i.PRE_TIME_LIMIT=60,i.RTC_RETRY_LIMIT=80,i.RTC_RETRY_TIMER_TIME=1e3,i._ICE_STATE={FAILED:"failed",CHECKING:"checking",CONNECTED:"connected",COMPLETED:"completed",DISCONNECTED:"disconnected"},i._peerConnTimer=null,i._peerConnParser=null,i.PEER_ABNORMAL_TIME=2e4,i}return n(t,e),a(t,[{key:"start",value:function(e,t){this._isActive=!0,this._config=t||{mix:{},media:{}},this._parsePeerConfig(this._config),this._localStream=e,this._createRTCPeer(),h.Report.enable&&(this._lastErrorType="",this._runPeerStatusTimer(!0))}},{key:"stop",value:function(){this._isActive=!1,this._runPeerStatusTimer(!1),this._destroyPeerConnTimer(),this._destroyPeerRetryTimer(!0),this._destroyRTCServerRetryTimer(!0),this._destroyPeer(),this._localStream&&(this._localStream=void 0)}},{key:"getPeerStatus",value:function(){!(arguments.length>0&&void 0!==arguments[0])||arguments[0];this._createPeerStater(),this._getStater.getPeerStatus()}},{key:"_quit",value:function(e){return!this._isActive&&(S.default.debug("["+e+"]server stop",u.LOG.PUSH),this.stop(),!0)}},{key:"_parsePeerConfig",value:function(){this._enforceTCP=!1,this._config.networkConfig&&(this._networkConfig=this._config.networkConfig||{},this._enforceTCP="true"===String(this._networkConfig.enforceTCP))}},{key:"_setVideoType",value:function(){var e="";if(void 0!==this._config.videoType){var t=String(this._config.videoType).toUpperCase();switch(t){case c.VideoType.VP8:case c.VideoType.VP9:case c.VideoType.H264:e=t.toLowerCase()}}return""===e&&(y.default.isMobileQQ()||y.default.isMobileWX()||y.default.isMobileFirefox())&&(e="vp8"),e}},{key:"_serializeSDPData",value:function(e){var t={peer_bitrate:500,sdp:e?e.replace(/\r\n/g,";;"):""};if(this._config.media&&this._config.media.videoBitrate>0&&(t.peer_bitrate=this._config.media.videoBitrate),this._config.mix&&void 0!==this._config.mix.trace&&(t.trace="true"===String(this._config.mix.trace)),this._config.mix&&void 0!==this._config.mix.firInterval){var i=parseInt(this._config.mix.firInterval);i>=0&&i<=120&&(t.fir_interval=i)}"true"===String(this._config.isSei)&&(t.local_timestamp=String((new Date).getTime()),S.default.log("enable send sei frame",u.LOG.PUSH));var r=this._setVideoType();return""!==r&&(t.video=r,S.default.log("send video code type "+r,u.LOG.PUSH)),JSON.stringify(t)}},{key:"_destroyPeer",value:function(){this._peer&&(this._peer.onicecandidate=void 0,this._peer.oniceconnectionstatechange=void 0,this._peer.close(),this._peer=void 0)}},{key:"_createRTCPeer",value:function(){try{this._peer=new RTCPeerConnection(null)}catch(e){return S.default.warn(e.toString(),u.LOG.PUSH),this._reportError(h.ErrorType.REFUSED,e.toString()),void this._recreateRTCPeer()}this._peer.onicecandidate=this._onIceCandidate.bind(this),this._peer.oniceconnectionstatechange=this._onIceStateChange.bind(this),this._sendLocalOffer()}},{key:"_sendLocalOffer",value:function(){var e=this,t=!1,i=!1,r=this._config.media.isAudio,s=this._config.media.isVideo;if(!this._localStream)return S.default.warn("no local stream",u.LOG.PUSH),this._reportError(h.ErrorType.REFUSED,"no local stream"),void this._recreateRTCPeer();this._localStream.getTracks().forEach(function(r){"audio"===r.kind&&(t=!0),"video"===r.kind&&(i=!0),e._peer.addTrack(r,e._localStream)}),(t||i)&&(r!==t&&(S.default.log("send audio is "+r+", but real is "+t,u.LOG.PUSH),r=t),s!==i&&(S.default.log("send video is "+s+", but real is "+i,u.LOG.PUSH),s=i));var o={offerToReceiveAudio:r,offerToReceiveVideo:s};this._peer.createOffer(o).then(this._onCreateOfferSuccess.bind(this),this._onCreateOfferError.bind(this))}},{key:"_onCreateOfferError",value:function(e){this._quit("_onCreateOfferError")||(S.default.warn(e.toString(),u.LOG.PUSH),this._reportError(h.ErrorType.REFUSED,"createOfferError"),this._recreateRTCPeer())}},{key:"_onCreateOfferSuccess",value:function(e){var t=this;this._quit("_onCreateOfferSuccess")||this._peer.setLocalDescription(e,function(){if(!t._quit("setLocalDescription")){var i=e.sdp;S.default.log("offer SDP: \n"+i,u.LOG.PUSH),t._rtcSDP=t._serializeSDPData(i),t._rtcServerHeaders={},t._rtcServerHeaders[l.HOST.RTC_HEADER_TOKEN]=l.Globals.token,t._rtcServerHeaders[l.HOST.RTC_HEADER_APP_ID]=l.Globals.appId,t._rtcServerHeaders[l.HOST.RTC_HEADER_USER_ID]=l.Globals.userId,t._rtcServerHeaders[l.HOST.RTC_HEADER_TRACE_ID]=l.Globals.traceId,l.Globals.isPermission&&(t._rtcServerHeaders[l.HOST.RTC_HEADER_TICKET]=l.Globals.ticket),t._postRTCServer(t._rtcSDP,t._rtcServerHeaders)}},function(e){if(!t._quit("setLocalDescription")){var i="set local description failed["+e.toString()+"]";S.default.warn(i,u.LOG.PUSH),t._reportError(h.ErrorType.REFUSED,"setLocalDsp failed"),t._dispatchEvent(c.PushMessage.RTC_SERVER_ERROR,u.RSP.ERROR,i),t.stop()}})}},{key:"_recreateRTCPeer",value:function(){this._quit("_recreateRTCPeer")||(this._destroyPeer(),this._destroyPeerRetryTimer(),this._destroyRTCServerRetryTimer(!0),this._startPeerRetryTimer())}},{key:"_destroyPeerRetryTimer",value:function(){arguments.length>0&&void 0!==arguments[0]&&arguments[0]&&(this._peerRetryCount=0),this._peerRetryTimer&&(window.clearTimeout(this._peerRetryTimer),this._peerRetryTimer=void 0)}},{key:"_startPeerRetryTimer",value:function(){if(++this._peerRetryCount<this.RTC_RETRY_LIMIT){var e=this.RTC_RETRY_TIMER_TIME;this._peerRetryCount>=this.PRE_TIME_LIMIT&&(e=this.RTC_RETRY_TIMER_TIME*this.RTC_FACTOR),S.default.log("["+this._peerRetryCount+"]recreate rtcPeer after "+e+"ms",u.LOG.PUSH),this._peerRetryTimer=window.setTimeout(this._createRTCPeer.bind(this),e)}else this._reportStopPush("recreate peer limit"),this._dispatchEvent(c.PushMessage.RTC_SERVER_ERROR,u.RSP.ERROR,"recreate rtcPeer limit error"),this.stop()}},{key:"_onIceCandidate",value:function(e){if(!this._quit("_onIceCandidate")){var t="null";e&&e.candidate&&(t=e.candidate.candidate),S.default.log("ICE candidate: \n"+t,u.LOG.PUSH)}}},{key:"_onIceStateChange",value:function(e){if(!this._quit("_onIceStateChange")&&this._peer&&e&&e.currentTarget){var t=e.currentTarget;t.iceConnectionState&&t.iceGatheringState&&(S.default.log("iceConnectionState: "+t.iceConnectionState+", iceGatheringState: "+t.iceGatheringState,u.LOG.PUSH),t.iceConnectionState===this._ICE_STATE.FAILED?(this._reportError(h.ErrorType.TIMEOUT,"ice conn failed"),this._recreateRTCPeer()):t.iceConnectionState===this._ICE_STATE.COMPLETED?(this._destroyPeerConnTimer(),this._destroyPeerRetryTimer(!0),""!==this._lastErrorType&&(this._reportSuccess(this._lastErrorType),this._lastErrorType="")):t.iceConnectionState===this._ICE_STATE.CHECKING?this._enforceTCP||"true"!==String(this._networkConfig.isDetect)||(S.default.log("ready to detect connection network",u.LOG.PUSH),this._createPeerConnTimer()):t.iceConnectionState===this._ICE_STATE.CONNECTED&&this._destroyPeerConnTimer())}}},{key:"_getAvailablePushUrl",value:function(){var e=this._config.pushUrls[0];return this._urlSwitch++,this._urlSwitch%2==0?(this._urlSwitch=0,this._urlIndex++,this._urlIndex>=this._config.pushUrls.length&&(this._urlIndex=0),e=this._config.pushUrls[this._urlIndex]):""!==this._pushUrl?this._pushUrl:e}},{key:"_destroyRTCServerRetryTimer",value:function(){arguments.length>0&&void 0!==arguments[0]&&arguments[0]&&(this._rtcRepeatCount=0,this._rtcServerRetryCount=0),this._rtcServerRetryTimer&&(window.clearTimeout(this._rtcServerRetryTimer),this._rtcServerRetryTimer=void 0)}},{key:"_startRTCServerRetryTimer",value:function(){var e=this;if(++this._rtcServerRetryCount<this.RTC_RETRY_LIMIT){var t=this.RTC_RETRY_TIMER_TIME;this._rtcServerRetryCount>=this.PRE_TIME_LIMIT&&(t=this.RTC_RETRY_TIMER_TIME*this.RTC_FACTOR),S.default.log("["+this._rtcServerRetryCount+"]rePostRTCServer after "+t+"ms",u.LOG.PUSH),this._rtcServerRetryTimer=window.setTimeout(function(){e._quit("_rtcServerRetryTimer")||e._postRTCServer(e._rtcSDP,e._rtcServerHeaders)},t)}else this._reportStopPush("publish retry limit"),this._dispatchEvent(c.PushMessage.RTC_SERVER_ERROR,u.RSP.ERROR,"publish retry limit error"),this.stop()}},{key:"_isStreamConfilct",value:function(){var e=this;if(++this._rtcRepeatCount<this.RTC_REPEAT_COUNT_LIMIT){var t=5*this.RTC_RETRY_TIMER_TIME;return S.default.log("["+this._rtcRepeatCount+"]forbidden repeat after "+t+"ms",u.LOG.PUSH),this._rtcServerRetryTimer=window.setTimeout(function(){e._quit("_rtcServerRetryTimer")||e._postRTCServer(e._rtcSDP,e._rtcServerHeaders)},t),!0}return!1}},{key:"_postRTCServer",value:function(e,t){if(this._destroyRTCServerRetryTimer(!1),!this._quit("postRTCServer")){this._pushUrl=this._getAvailablePushUrl(),this._getStater&&(this._getStater.url=this._pushUrl),this._reportStartPush(this._pushUrl),this._rtcServerXHR||(this._rtcServerXHR=new b.default(this._postRTCServerSuccess.bind(this),this._postRTCServerFailed.bind(this)));var i={};i[u.XHR.HEADERS]=t,this._rtcServerXHR.start(this._pushUrl,e,i)}}},{key:"_postRTCServerSuccess",value:function(e,t){var i=this;if(!this._quit("_postRTCServerSuccess")){var r="";if(!e||t!==u.XHR.SUCCESS)return r=e?"postRTCServer response status: "+t:"postRTCServer response is null",this._reportError(h.ErrorType.UNKNOWN,r),void this._startRTCServerRetryTimer();var s=void 0,o=void 0;try{s=JSON.parse(e).sdp,o=s.replace(/;;/g,"\r\n")}catch(e){return r="parse sdp response failed",this._dispatchEvent(c.PushMessage.RTC_SERVER_ERROR,u.RSP.ERROR,r),void this.stop()}var n=o;if(n=v.default.resetICECandidate({enforceTCP:this._enforceTCP},n),n=v.default.bitrateControl(this._config.media,n),S.default.log("answer SDP: \n"+n,u.LOG.PUSH),!this._peer)return void S.default.warn("peer is undefined",u.LOG.PUSH);this._destroyRTCServerRetryTimer(!0),this._peer.setRemoteDescription({type:"answer",sdp:n},function(){if(!i._quit("setRemoteDescription")){S.default.log("set remote description success",u.LOG.PUSH);var e=i._pushUrl.indexOf("nodeaddr=");if(e>0){var t=i._pushUrl.substr(e+"nodeaddr=".length),r=t.split(":");r&&r.length&&(i._dispatchIP=r[0])}var s=l.Globals.isRtcTest?l.Globals.rtcPushHosts:l.Globals.rtcHosts,o={hosts:s,currentHost:""!==i._dispatchIP?i._dispatchIP:s[0]};l.Globals.isRtcArea&&""!==l.Globals.rtcArea&&(o.area=l.Globals.rtcArea),i._dispatchEvent(c.PushMessage.RTC_SERVER_SUCCESS,u.RSP.SUCCESS,"publish success",o)}},function(e){if(!i._quit("setRemoteDescription")){var t="set remote description failed["+e.toString()+"]";S.default.warn(t,u.LOG.PUSH),i._dispatchEvent(c.PushMessage.RTC_SERVER_ERROR,u.RSP.ERROR,t),i.stop()}})}}},{key:"_postRTCServerFailed",value:function(e,t){if(!this._quit("_postRTCServerFailed")){this._destroyRTCServerRetryTimer(!1),e||(e={});var i="",r=parseInt(e[u.XHR.STATUS]);if(this._reportError(h.ErrorType.REFUSED,"status="+r),!isNaN(r)){if(400===r)i="request error by error url or http headers or body";else if(403===r)i="authentication faied, forbidden access";else if(409===r){if(i="stream in publishing, forbidden repeat",this._isStreamConfilct())return}else 500===r||590===r&&(i="linkers beyond room limit");if(""!==i)return this._dispatchEvent(c.PushMessage.RTC_SERVER_ERROR,r,i),void this.stop();S.default.log("publish status["+r+"]",u.LOG.PUSH)}this._startRTCServerRetryTimer()}}},{key:"_createPeerStater",value:function(){this._getStater||(this._getStater=new f.default,this._getStater.init({roomId:this._config.roomId||"",micType:this._config.micType||"av"})),this._getStater.peer=this._peer}},{key:"_destroyPeerStater",value:function(){this._getStater&&(this._getStater.stop(),this._getStater=void 0)}},{key:"_runPeerStatusTimer",value:function(){arguments.length>0&&void 0!==arguments[0]&&!arguments[0]?(this._getStater&&this._getStater.getPeerStatus(),this._destroyPeerStater()):(this._createPeerStater(),this._getStater.start())}},{key:"_reportStartPush",value:function(e){this._handler&&this._handler.reportStartPush(e)}},{key:"_reportStopPush",value:function(e){this._handler&&this._handler.reportStopPush(e)}},{key:"_reportError",value:function(e,t){var i=t;i.length>20&&(i=i.substr(0,20)),this._lastErrorType=e,this._handler&&this._handler.reportError({type:e,message:i})}},{key:"_reportSuccess",value:function(e){this._handler&&this._handler.reportSuccess(e)}},{key:"_createPeerConnTimer",value:function(){var e=this;this._peerConnTimer||(this._peerConnTimer=window.setTimeout(function(){e._onPeerConnTimerHandler()},this.PEER_ABNORMAL_TIME))}},{key:"_destroyPeerConnTimer",value:function(){this._peerConnTimer&&(window.clearTimeout(this._peerConnTimer),this._peerConnTimer=null),this._peerConnParser&&(this._peerConnParser.removeToAll(),this._peerConnParser=null)}},{key:"_onPeerConnTimerHandler",value:function(){var e=this;this._destroyPeerConnTimer(),this._peer&&!this._quit("_onPeerConnTimerHandler")&&(this._peerConnParser||(this._peerConnParser=new m.default,this._peerConnParser.listenTo(c.PushMessage.PEER_STAT,function(t){e._onPeerStatEventHandler(t)})),this._peerConnParser.peer=this._peer,this._peerConnParser.start())}},{key:"_onPeerStatEventHandler",value:function(e){if(e&&!this._quit("_onPeerStatEventHandler")){var t=e[u.RSP.TYPE],i=e[u.RSP.DATA]||{};switch(t){case c.STAT.PEER_CONN_SWITCH_EVENT:var r=i[c.STAT.PEER_PROC],s=parseInt(i[c.STAT.PEER_BYTES_RECEIVED]);if(S.default.log("connection protocol["+r+"], bytesReceived["+s+"]",u.LOG.PUSH),"udp"===r&&0===s){var o="peer connection abnormal, try switching to tcp";S.default.warn(o,u.LOG.PUSH),this._dispatchEvent(c.PushMessage.PEER_CONN_SWITCH_EVENT,u.RSP.SUCCESS,o)}}}}},{key:"_dispatchEvent",value:function(e,t,i,r){this._quit("_dispatchEvent")||this.trigger(c.PushEvent.PEER_EVENT,{type:e,code:t,message:i,data:r})}},{key:"peer",get:function(){return this._peer}}]),t}(T.default);t.default=P},function(e,t,i){"use strict";function r(e){return e&&e.__esModule?e:{default:e}}function s(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function o(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t}function n(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}Object.defineProperty(t,"__esModule",{value:!0});var a=function(){function e(e,t){for(var i=0;i<t.length;i++){var r=t[i];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}return function(t,i,r){return i&&e(t.prototype,i),r&&e(t,r),t}}(),u=i(10),c=i(0),l=i(2),h=i(5),d=i(99),f=r(d),_=i(101),v=r(_),p=i(106),m=r(p),g=i(97),y=r(g),E=i(102),S=r(E),R=i(104),T=r(R),C=i(107),b=r(C),P=i(96),O=r(P),A=i(6),k=r(A),I=i(1),w=r(I),M=i(3),L=r(M),N=function(e){function t(){s(this,t);var e=o(this,(t.__proto__||Object.getPrototypeOf(t)).call(this));return e._isActive=!1,e._pushUrls=[],e._config={},e._mixConfig={},e._mediaConfig={},e._audioTracks=[],e._videoTracks=[],e._oriStream=void 0,e._localStream=void 0,e._isEndRestart=!1,e._cameraConstraint=void 0,e._rtcPeer=void 0,e._rtcReportor=void 0,e._rtcScreener=void 0,e._constaintParser=void 0,e._localVideoPlayer=void 0,e._customStreamer=void 0,e._enableMixAudio=!1,e._mixAudioControlor=void 0,e}return n(t,e),a(t,[{key:"start",value:function(e){this._isActive=!0,this._config=e||{},this._parsePushConfig(),this._createReport(),this._resetMediaConfig(),this._parseCameraConstraint(),this._createLocalVideoPlayer(),void 0!==this._config.pushUrl?l.Globals.isRtcTest?this._pushUrls=this._parsePushUrl(l.Globals.rtcPushHosts):this._pushUrls=this._parsePushUrl(l.Globals.rtcHosts):l.Globals.isRtcTest?this._pushUrls=this._assemblePushUrl(l.Globals.rtcPushHosts):this._pushUrls=this._assemblePushUrl(l.Globals.rtcHosts),this._publish()}},{key:"stop",value:function(){this._reset(),this._destroyLocalVideoPlayer(),this._destroyLocalStream(this._localStream),this.reportStopPush(),this._destroyReport(),this._destroyScreenMixer(),this._destroyCustomStream()}},{key:"stopAudio",value:function(){this._audioTracks&&this._audioTracks.length&&this._audioTracks.forEach(function(e){e.stop(),w.default.log("stop current audio track",c.LOG.PUSH)})}},{key:"stopVideo",value:function(){this._videoTracks&&this._videoTracks.length&&this._videoTracks.forEach(function(e){e.stop(),w.default.log("stop current video track",c.LOG.PUSH)})}},{key:"switchAudio",value:function(e){this._audioTracks&&this._audioTracks.length&&this._audioTracks.forEach(function(t){"true"===String(e)||"false"===String(e)?t.enabled="true"===String(e):t.enabled=!t.enabled,w.default.log("current audio track state is "+(t.enabled?"on":"off"),c.LOG.PUSH)})}},{key:"switchVideo",value:function(e){this._videoTracks&&this._videoTracks.length&&this._videoTracks.forEach(function(t){"true"===String(e)||"false"===String(e)?t.enabled="true"===String(e):t.enabled=!t.enabled,w.default.log("current video track state is "+(t.enabled?"on":"off"),c.LOG.PUSH)})}},{key:"addStream",value:function(e){if(!e||"true"!==String(this._config.enableCustom))return void w.default.log("stream is null or use camera module, interface not effective",c.LOG.PUSH);this._addOriginalStream(e)}},{key:"getPeerStatus",value:function(){var e=!(arguments.length>0&&void 0!==arguments[0])||arguments[0];this._rtcPeer&&this._rtcPeer.getPeerStatus(e)}},{key:"reportStartPush",value:function(e){this._rtcReportor&&h.Report.enable&&(this._rtcReportor.url=e,this._rtcReportor.reportStartPush())}},{key:"reportStopPush",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"";this._rtcReportor&&h.Report.enable&&this._rtcReportor.reportStopPush(e)}},{key:"reportError",value:function(e){if(this._rtcReportor&&h.Report.enable){if(e){var t=e[c.RSP.MESSAGE]||"";t.length>20&&(t=t.substr(0,20),e[c.RSP.MESSAGE]=t)}this._rtcReportor.reportError(e)}}},{key:"reportSuccess",value:function(e){this._rtcReportor&&h.Report.enable&&this._rtcReportor.reportSuccess(e)}},{key:"reportStat",value:function(e){this._rtcReportor&&h.Report.enable&&this._rtcReportor.reportStat(e||{})}},{key:"startMixAudio",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"";this._enableMixAudio&&this._mixAudioControlor&&this._mixAudioControlor.startMix(e)}},{key:"stopMixAudio",value:function(){this._enableMixAudio&&this._mixAudioControlor&&this._mixAudioControlor.stopMix()}},{key:"pauseMixAudio",value:function(){this._enableMixAudio&&this._mixAudioControlor&&this._mixAudioControlor.pauseMix()}},{key:"resumeMixAudio",value:function(){this._enableMixAudio&&this._mixAudioControlor&&this._mixAudioControlor.resumeMix()}},{key:"setMixAudioLoop",value:function(e,t){this._enableMixAudio&&this._mixAudioControlor&&this._mixAudioControlor.setMixLoop(e,t)}},{key:"setMixAudioVolume",value:function(e,t){this._enableMixAudio&&this._mixAudioControlor&&this._mixAudioControlor.setMixAudioVolume(e,t)}},{key:"_quit",value:function(e){return!this._isActive&&(w.default.debug("["+e+"]server stop",c.LOG.PUSH),!0)}},{key:"_parsePushConfig",value:function(){if(this._isEndRestart="true"===String(this._config.isEndRestart),this._mixConfig=this._config.mixConfig||{},this._config.mixAudioConfig){var e=this._config.mixAudioConfig||{};this._enableMixAudio="true"===String(e.enable)}var t=this._config.screenConfig;t||(t={},"true"===String(this._config.isScreen)&&(t.enable=!0),this._config.screenConfig=t)}},{key:"_resetMediaConfig",value:function(){this._mediaConfig.isAudio=!0,this._mediaConfig.isVideo=!0,this._mediaConfig.landscape=!0,this._mediaConfig.brFactor=.6,this._mediaConfig.audioBitrate=0,this._mediaConfig.videoBitrate=0,this._mediaConfig.isBrControl=!1,this._mediaConfig.isAudioCBR=!1,this._mediaConfig.isVideoCBR=!1}},{key:"_parseCameraConstraint",value:function(){var e=this._config.camConfig||{};if(e.audio||(this._mediaConfig.isAudio=!1),e.video||(this._mediaConfig.isVideo=!1),!this._mediaConfig.isAudio&&!this._mediaConfig.isVideo)return w.default.warn("error camera config with no audio and video",c.LOG.PUSH),void this._dispatchEvent(u.PushMessage.CAMERA_ERROR,c.RSP.ERROR,"no audio and video config");e.mediaConfig=this._mediaConfig,this._createConstaintParser(),this._cameraConstraint=this._constaintParser.parse(e),this._mediaConfig=this._cameraConstraint.mediaConfig,delete this._cameraConstraint.mediaConfig,w.default.log(JSON.stringify(this._cameraConstraint),c.LOG.PUSH),this._parseReportInfo()}},{key:"_createConstaintParser",value:function(){this._constaintParser||(this._constaintParser=new y.default)}},{key:"_destroyConstaintParser",value:function(){this._constaintParser&&(this._constaintParser=void 0)}},{key:"_createLocalVideoPlayer",value:function(){var e=this;this._localVideoPlayer||(this._localVideoPlayer=new m.default(this.playerDom),this._localVideoPlayer.listenTo(u.PushEvent.VIDEO_EVENT,function(t){if(t){var i=t[c.RSP.TYPE],r=t[c.RSP.CODE],s=t[c.RSP.MESSAGE],o=t[c.RSP.DATA]||{};switch(i){case u.PushMessage.PLAY_ERROR:e._dispatchEvent(u.PushMessage.PLAY_ERROR,r,s,o);break;case u.PushMessage.PLAY_METADATA:e._dispatchEvent(u.PushMessage.PLAY_METADATA,r,s,o)}}})),this._localVideoPlayer.start({isVideo:this._mediaConfig.isVideo})}},{key:"_destroyLocalVideoPlayer",value:function(){this._localVideoPlayer&&(this._localVideoPlayer.removeToAll(),this._localVideoPlayer.stop(),this._localVideoPlayer=void 0)}},{key:"_restart",value:function(){this.stop(),this.start(this._config)}},{key:"_reset",value:function(){this._isActive=!1,this._destroyMixAudioControl(),this._destroyRTCPeerServer(),this._destroyRTCScreener(),this._destroyConstaintParser(),this._cameraConstraint=void 0}},{key:"_parsePushUrl",value:function(e){var t=this._config.pushUrl,i=t.split("?"),r=k.default.getQueryParams(i[1]),s=k.default.getStreamName(i[0]),o=void 0;o=""===l.Globals.rtcTestHost?l.HOST.RTC_HOST:l.Globals.rtcTestHost;var n=l.HOST.PROTOCOL+o;n+=":"+l.HOST.RTC_PORT+"/"+s,n+="?v="+parseInt(r.v)+"&type=publish";for(var a in r)if(r.hasOwnProperty(a))switch(a){case"host":case"wsHost":case"proto":n+="&"+a+"="+r[a];break;case"area":""!==r[a]&&(n+="&"+a+"="+r[a])}var u=[];if(!r.nodeaddr)for(var c=n,h=0;h<e.length;h++)c+="&nodeaddr="+e[h]+":"+l.HOST.RTC_TRAN_PORT,u.push(c),c=n;return u.length||u.push(n),u}},{key:"_assemblePushUrl",value:function(e){var t=void 0;t=""===l.Globals.rtcTestHost?l.HOST.RTC_HOST:l.Globals.rtcTestHost;var i=l.HOST.PROTOCOL+t;if(i+=":"+l.HOST.RTC_PORT+"/"+this._config.streamName,i+="?v="+l.HOST.RTC_VER+"&type=publish&wsHost="+l.Globals.host,void 0!==this._config.proto){var r=parseInt(this._config.proto);isNaN(r)||(i+="&proto="+r)}l.Globals.isRtcArea&&""!==l.Globals.rtcArea&&(i+="&area="+l.Globals.rtcArea);for(var s=[],o=i,n=0;n<e.length;n++)o+="&nodeaddr="+e[n]+":"+l.HOST.RTC_TRAN_PORT,s.push(o),o=i;return s.length||s.push(i),s}},{key:"_createRTCScreener",value:function(){var e=this;this._rtcScreener||(this._rtcScreener=new T.default(this,function(t){e._gotStreamError(t)}))}},{key:"_destroyRTCScreener",value:function(){this._rtcScreener&&(this._rtcScreener.stop(),this._rtcScreener=void 0)}},{key:"_publish",value:function(){if("true"===String(this._config.enableCustom))return void this._dispatchEvent(u.PushMessage.ADD_STREAM,c.RSP.SUCCESS,"not use camera module");var e=this._config.screenConfig||{};if("true"===String(e.enable))return this._createRTCScreener(),void this._rtcScreener.start(this._gotStream.bind(this),this._gotStreamError.bind(this),e);k.default.isOldGetUserMedia()?window.navigator?window.navigator.getUserMedia(this._cameraConstraint,this._gotStream.bind(this),this._gotStreamError.bind(this)):this._gotStreamError("API NotSupported"):window.navigator&&window.navigator.mediaDevices?window.navigator.mediaDevices.getUserMedia(this._cameraConstraint).then(this._gotStream.bind(this)).catch(this._gotStreamError.bind(this)):this._gotStreamError("API NotSupported")}},{key:"_gotStreamError",value:function(e){this._quit("_gotStreamError")||(w.default.error(e.toString(),c.LOG.PUSH),this.reportError({type:h.ErrorType.REFUSED,message:e.toString()}),this._dispatchEvent(u.PushMessage.CAMERA_ERROR,c.RSP.ERROR,e.toString()))}},{key:"_gotStream",value:function(e){if(this._quit("_gotStream"))return this._destroyLocalStream(e),void(this._localStream&&this._destroyLocalStream(this._localStream));var t=this._config.screenConfig||{};"true"===String(t.enable)&&"true"===String(t.isMixInAudio)?this._createScreenMixer(e,t):this._readyStartStream(e)}},{key:"_readyStartStream",value:function(e){var t=this._config.watermarkConfig;t&&"true"===String(t.enable)?(w.default.log("enable watermark",c.LOG.PUSH),this._destroyOrinalStream(),this._oriStream=e,this._customStreamSource()):this._startStream(e)}},{key:"_startStream",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:null;if(void 0!==this._config.rotation){var t=parseInt(this._config.rotation);k.default.setRotationDegreee(this.playerDom,t)}this._localStream&&this._destroyLocalStream(this._localStream),this._enableMixAudio?(w.default.log("enable mix audio",c.LOG.PUSH),this._createMixAudioControl(e),this._localStream||(this._localStream=e)):this._localStream=e;try{this._listenStreamTrack(this._localStream)}catch(e){w.default.log(e.toString(),c.LOG.PUSH)}if(!this._localVideoPlayer)return this._destroyLocalStream(this._localStream),void w.default.warn("local videoPlayer is null",c.LOG.PUSH);this._localVideoPlayer.play(this._localStream),this._createRTCPeerServer()}},{key:"_destroyStream",value:function(e){if(e)try{for(var t=e.getTracks(),i=0;i<t.length;i++)t[i].stop()}catch(e){}}},{key:"_destroyLocalStream",value:function(e){this._destroyStream(e),this._audioTracks=[],this._videoTracks=[],this._localStream=void 0}},{key:"_onTrackEndedHandler",value:function(e){if(!this._quit("_onTrackEndedHandler")){var t="",i="",r="";e&&e.currentTarget&&(t=e.currentTarget.id,i=e.currentTarget.kind,r=e.currentTarget.label),""!==i&&this._dispatchEvent(u.PushMessage.STREAM_TRACK,c.RSP.SUCCESS,"stream track ended",{event:"ended",kind:i,id:t,label:r}),this._isEndRestart&&this._restart()}}},{key:"_listenStreamTrack",value:function(e){var t=this;if(e){var i="",r="",s="";this._audioTracks=e.getAudioTracks(),this._videoTracks=e.getVideoTracks(),this._audioTracks&&this._audioTracks.length&&this._audioTracks.forEach(function(e){e&&(i=e.id||"",r=e.label||"",s=""!==r?r:i,w.default.log("using audio device["+s+"]",c.LOG.PUSH),e.onended=t._onTrackEndedHandler.bind(t))}),this._videoTracks&&this._videoTracks.length&&this._videoTracks.forEach(function(e){e&&(i=e.id||"",r=e.label||"",s=""!==r?r:i,t._rtcReportor&&(t._rtcReportor.camera=s),w.default.log("using video device["+s+"]",c.LOG.PUSH),e.onended=t._onTrackEndedHandler.bind(t))})}}},{key:"_destroyRTCPeerServer",value:function(){this._rtcPeer&&(this._rtcPeer.removeToAll(),this._rtcPeer.stop(),this._rtcPeer=void 0)}},{key:"_createRTCPeerServer",value:function(){var e=this,t=this._config||{};t.mix=this._mixConfig,t.media=this._mediaConfig,t.pushUrls=this._pushUrls,this._rtcPeer||(this._rtcPeer=new f.default(this),this._rtcPeer.listenTo(u.PushEvent.PEER_EVENT,function(t){if(t){var i=t[c.RSP.TYPE],r=t[c.RSP.CODE],s=t[c.RSP.MESSAGE],o=t[c.RSP.DATA]||{};switch(i){case u.PushMessage.RTC_SERVER_ERROR:case u.PushMessage.RTC_SERVER_SUCCESS:case u.PushMessage.PEER_CONN_SWITCH_EVENT:e._dispatchEvent(i,r,s,o)}}})),this._rtcPeer.start(this._localStream,t)}},{key:"_createReport",value:function(){h.Report.enable&&!this._rtcReportor&&(this._rtcReportor=new v.default)}},{key:"_destroyReport",value:function(){this._rtcReportor&&(this._rtcReportor.stop(),this._rtcReportor=void 0)}},{key:"_parseReportInfo",value:function(){this._rtcReportor&&h.Report.enable&&(this._config.micType="av",this._cameraConstraint.video?this._cameraConstraint.audio||(this._config.micType="video",this._rtcReportor.micType="video"):(this._config.micType="audio",this._rtcReportor.micType="audio"),this._rtcReportor.roomId=this._config.roomId||"",this._cameraConstraint.video&&"boolean"!=typeof this._cameraConstraint.video&&(this._rtcReportor.camera=this._cameraConstraint.video.deviceId||"",this._mediaConfig.videoBitrate>0&&(this._rtcReportor.upVBR=this._mediaConfig.videoBitrate.toFixed(3)),this._cameraConstraint.video.frameRate&&(this._rtcReportor.upFPS=this._cameraConstraint.video.frameRate.toFixed(0)),this._rtcReportor.upRES=this._cameraConstraint.video.width+"_"+this._cameraConstraint.video.height))}},{key:"_addOriginalStream",value:function(e){this._destroyOrinalStream(),this._gotStream(e)}},{key:"_destroyOrinalStream",value:function(){this._destroyStream(this._oriStream),this._oriStream=void 0}},{key:"_customStreamSource",value:function(){var e=this;this._customStreamer||(this._customStreamer=new b.default);var t=this._config.watermarkConfig||{};this._customStreamer.start(this._oriStream,t).then(function(t){if(!e._quit("_customStreamSource")){if(!t)return void e._startStream(e._oriStream);var i=void 0,r=t.getVideoTracks(),s=e._oriStream.getAudioTracks(),o=s&&s.length,n=r&&r.length;if(o&&n)i=new MediaStream([s[0],r[0]]);else if(o&&!n)i=new MediaStream([s[0]]),e._mediaConfig.isVideo=!1;else{if(o||!n)return w.default.warn("custom stream with no audio and video",c.LOG.PUSH),void e._dispatchEvent(u.PushMessage.CAMERA_ERROR,c.RSP.ERROR,"custom stream with no audio and video");i=new MediaStream([r[0]]),e._mediaConfig.isAudio=!1}e._startStream(i)}})}},{key:"_destroyCustomStream",value:function(){this._customStreamer&&(this._customStreamer.stop(),this._customStreamer=void 0),this._destroyOrinalStream()}},{key:"_destroyMixAudioControl",value:function(){this._mixAudioControlor&&(this._mixAudioControlor.stop(),this._mixAudioControlor=void 0)}},{key:"_createMixAudioControl",value:function(e){var t=this;this._mixAudioControlor||(this._mixAudioControlor=new O.default),this._mixAudioControlor.init(this._config.mixAudioConfig||{}),this._mixAudioControlor.start(e,function(e){e&&(t._localStream=e)})}},{key:"_createScreenMixer",value:function(e,t){var i=this;this._camAudioStream||(this._camAudioStream=new S.default(function(t){i._quit("_createScreenMixer")||(t?i._readyStartStream(t):i._readyStartStream(e))})),this._camAudioStream.start(e,t)}},{key:"_destroyScreenMixer",value:function(){this._camAudioStream&&(this._camAudioStream.stop(),this._camAudioStream=null)}},{key:"_dispatchEvent",value:function(e,t,i,r){this._quit("_dispatchEvent")||this.trigger(u.PushEvent.PUSH_EVENT,{type:e,code:t,message:i,data:r})}},{key:"userId",get:function(){return this._config.userId||void 0}},{key:"playerId",get:function(){return this._config.playerId||void 0}},{key:"playerDom",get:function(){return this._config.playerDom||void 0}},{key:"peer",get:function(){return this._rtcPeer}},{key:"mediaConfig",get:function(){return this._mediaConfig}}]),t}(L.default);t.default=N},function(e,t,i){"use strict";function r(e){return e&&e.__esModule?e:{default:e}}function s(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}Object.defineProperty(t,"__esModule",{value:!0});var o=function(){function e(e,t){for(var i=0;i<t.length;i++){var r=t[i];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}return function(t,i,r){return i&&e(t.prototype,i),r&&e(t,r),t}}(),n=i(5),a=i(0),u=i(2),c=i(34),l=r(c),h=i(11),d=r(h),f=function(){function e(){s(this,e),this._reportor=new d.default,this._params=new l.default}return o(e,[{key:"stop",value:function(){this._params={},this._reportor=void 0}},{key:"reportStartPush",value:function(){if(this._reportor){var e={};e[n.MACRO.MIC_URL]=this.url,e[n.MACRO.UP_RES]=this.upRES,e[n.MACRO.UP_VBR]=this.upVBR,e[n.MACRO.UP_FPS]=this.upFPS,e[n.MACRO.ROOM_ID]=this.roomId,e[n.MACRO.MIC_TYPE]=this.micType,e[n.MACRO.CAMERA_INFO]=this.camera,e[n.MACRO.DEV_INFO]=u.Globals.deviceId,e[n.MACRO.AENC_MODE]=n.MACRO.ENC_MODE,e[n.MACRO.VENC_MODE]=n.MACRO.ENC_MODE,e[n.MACRO.EVENT_NAME]=n.MACRO.PUSH_START,e[n.MACRO.MIC_TIME]=e[n.MACRO.EVENT_TIME]=this._reportor.getCurrentTime(),this._reportor.report({data:e})}}},{key:"reportStopPush",value:function(){arguments.length>0&&void 0!==arguments[0]&&arguments[0];if(this._reportor&&""!==this.url){var e={};e[n.MACRO.MIC_URL]=this.url,e[n.MACRO.ROOM_ID]=this.roomId,e[n.MACRO.MIC_TYPE]=this.micType,e[n.MACRO.DEV_INFO]=u.Globals.deviceId,e[n.MACRO.EVENT_NAME]=n.MACRO.PUSH_STOP,e[n.MACRO.EVENT_TIME]=this._reportor.getCurrentTime(),this._reportor.report({data:e})}}},{key:"reportError",value:function(e){if(this._reportor){var t={};t[n.MACRO.MIC_URL]=this.url,t[n.MACRO.ROOM_ID]=this.roomId,t[n.MACRO.MIC_TYPE]=this.micType,t[n.MACRO.CONN_TYPE]=n.ConnType.PUSH,t[n.MACRO.EVENT_NAME]=n.MACRO.CONN_ERR,t[n.MACRO.ERR_TYPE]=e[a.RSP.TYPE]||"",t[n.MACRO.ERR_INFO]=e[a.RSP.MESSAGE]||"",t[n.MACRO.EVENT_TIME]=this._reportor.getCurrentTime(),this._reportor.report({data:t})}}},{key:"reportSuccess",value:function(e){if(this._reportor){var t={};t[n.MACRO.MIC_URL]=this.url,t[n.MACRO.ROOM_ID]=this.roomId,t[n.MACRO.MIC_TYPE]=this.micType,t[n.MACRO.CONN_TYPE]=n.ConnType.PUSH,t[n.MACRO.EVENT_NAME]=n.MACRO.CONN_SUCC,t[n.MACRO.EVENT_TIME]=this._reportor.getCurrentTime(),this._reportor.report({data:t})}}},{key:"reportStat",value:function(e){if(this._reportor){var t={};t[n.MACRO.MIC_URL]=this.url,t[n.MACRO.ROOM_ID]=this.roomId,t[n.MACRO.MIC_TYPE]=this.micType,t[n.MACRO.DEV_INFO]=u.Globals.deviceId,t[n.MACRO.EVENT_NAME]=n.MACRO.RGL_PUSH_REPORT,t[n.MACRO.AVG_VLR]=e[n.MACRO.AVG_VLR]||"0.000",t[n.MACRO.AVG_ALR]=e[n.MACRO.AVG_ALR]||"0.000",t[n.MACRO.AVG_VBR]=e[n.MACRO.AVG_VBR]||"0.000",t[n.MACRO.AVG_ABR]=e[n.MACRO.AVG_ABR]||"0.000",t[n.MACRO.TTL_VSP]=e[n.MACRO.TTL_VSP]||"0",t[n.MACRO.TTL_ASP]=e[n.MACRO.TTL_ASP]||"0",t[n.MACRO.AVG_RVBR]=e[n.MACRO.AVG_RVBR]||"0.000",t[n.MACRO.TAR_ENC_BR]=e[n.MACRO.TAR_ENC_BR]||"0.000",t[n.MACRO.AVG_ENC_FPS]=e[n.MACRO.AVG_ENC_FPS]||"0.000",t[n.MACRO.AVG_TRAN_FPS]=e[n.MACRO.AVG_TRAN_FPS]||"0.000",t[n.MACRO.EVENT_TIME]=this._reportor.getCurrentTime(),this._reportor.report({data:t})}}},{key:"roomId",get:function(){return this._params.roomId},set:function(e){this._params.roomId=e||""}},{key:"camera",get:function(){return this._params.camera},set:function(e){this._params.camera=e||""}},{key:"micType",get:function(){return this._params.micType},set:function(e){this._params.micType=e||""}},{key:"upRES",get:function(){return this._params.upRES},set:function(e){this._params.upRES=e||""}},{key:"upVBR",get:function(){return this._params.upVBR},set:function(e){this._params.upVBR=e||"500"}},{key:"upFPS",get:function(){return this._params.upFPS},set:function(e){this._params.upFPS=e||"-1"}},{key:"url",get:function(){return this._params.url},set:function(e){this._params.url=e}}]),e}();t.default=f},function(e,t,i){"use strict";function r(e){return e&&e.__esModule?e:{default:e}}function s(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}Object.defineProperty(t,"__esModule",{value:!0});var o=function(){function e(e,t){for(var i=0;i<t.length;i++){var r=t[i];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}return function(t,i,r){return i&&e(t.prototype,i),r&&e(t,r),t}}(),n=i(0),a=i(103),u=r(a),c=i(6),l=r(c),h=i(1),d=r(h),f=function(){function e(t){s(this,e),this._isActive=!1,this._audioDeviceId="",this._callback=t,this._screenStream=null,this._cameraStream=null,this._isMixInOut=!1,this._InOutAudioMixer=null}return o(e,[{key:"start",value:function(e,t){this._parse(t);var i={audio:{}};this._screenStream!==e&&(this._screenStream=e),""!==this._audioDeviceId&&(i.audio.deviceId=this._audioDeviceId),this._isActive=!0,this._destroyCameraStream(),l.default.isOldGetUserMedia()?window.navigator?window.navigator.getUserMedia(i,this._gotStream.bind(this),this._gotStreamError.bind(this)):this._callback&&this._callback(null):window.navigator&&window.navigator.mediaDevices?window.navigator.mediaDevices.getUserMedia(i).then(this._gotStream.bind(this)).catch(this._gotStreamError.bind(this)):this._callback&&this._callback(null)}},{key:"stop",value:function(){this._isActive=!1,this._destroyCameraStream(),this._destroyMixInOutAudio()}},{key:"_parse",value:function(e){e=e||{};for(var t in e)if(e.hasOwnProperty(t))switch(t){case"audio":var i=e[t]||{};this._audioDeviceId=i.deviceId||"";break;case"isMixInOutAudio":this._isMixInOut="true"===String(e[t])}}},{key:"_gotStream",value:function(e){if(this._isActive){if(this._destroyCameraStream(),this._cameraStream=e,!this._screenStream||!this._cameraStream)return this._destroyCameraStream(),this._callback&&this._callback(null),void d.default.log("no screen or camera stream",n.LOG.SCREEN);var t=this._cameraStream.getAudioTracks(),i=this._screenStream.getAudioTracks(),r=this._screenStream.getVideoTracks();if(!t||!t.length)return this._destroyCameraStream(),d.default.log("camera stream has no audio track",n.LOG.SCREEN),void(this._callback&&this._callback(null));this._isMixInOut?i&&i.length?(d.default.log("switch to complex mix",n.LOG.SCREEN),this._createMixInOutAudio()):(d.default.log("switch to normal mix",n.LOG.SCREEN),this._mixTracks(t,r)):(d.default.log("mix in audio",n.LOG.SCREEN),this._mixTracks(t,r))}}},{key:"_gotStreamError",value:function(e){this._isActive&&(this._destroyCameraStream(),this._callback&&this._callback(null))}},{key:"_mixTracks",value:function(e,t){var i=[];e&&e.forEach(function(e){i.push(e)}),t&&t.forEach(function(e){i.push(e)}),i.length?this._callback&&this._callback(new MediaStream(i)):(this._destroyCameraStream(),this._callback&&this._callback(null))}},{key:"_createMixInOutAudio",value:function(){if(this._InOutAudioMixer||(this._InOutAudioMixer=new u.default),this._screenStream&&this._cameraStream){var e=void 0,t=void 0,i=this._InOutAudioMixer.start(this._screenStream,this._cameraStream);i?(d.default.log("mix in and out audio",n.LOG.SCREEN),e=i.getAudioTracks(),t=this._screenStream.getVideoTracks()):(e=this._cameraStream.getAudioTracks(),t=this._screenStream.getVideoTracks()),this._mixTracks(e,t)}}},{key:"_destroyMixInOutAudio",value:function(){this._InOutAudioMixer&&(this._InOutAudioMixer.stop(),this._InOutAudioMixer=null)}},{key:"_destroyStream",value:function(e){if(e)try{for(var t=e.getTracks(),i=0;i<t.length;i++)t[i].stop()}catch(e){}}},{key:"_destroyCameraStream",value:function(){this._cameraStream&&(this._destroyStream(this._cameraStream),this._cameraStream=null)}},{key:"_destroyScreenStream",value:function(){this._screenStream&&(this._destroyStream(this._screenStream),this._screenStream=null)}}]),e}();t.default=f},function(e,t,i){"use strict";function r(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}Object.defineProperty(t,"__esModule",{value:!0});var s=function(){function e(e,t){for(var i=0;i<t.length;i++){var r=t[i];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}return function(t,i,r){return i&&e(t.prototype,i),r&&e(t,r),t}}(),o=i(0),n=i(1),a=function(e){return e&&e.__esModule?e:{default:e}}(n),u=function(){function e(){r(this,e),this._context=null,this._oVolume=1,this._oGainNode=null,this._oSourceNode=null,this._mVolume=1,this._mGainNode=null,this._mSourceNode=null,this._destAudioNode=null}return s(e,[{key:"start",value:function(e,t){if(!e||!t)return a.default.log("no oStream or mStream",o.LOG.SCREEN),null;try{return this._createAudioContext(),this._createDestinationNode(),this._createOriSourceNode(e),this._createOriGainNode(),this._oSourceNode.connect(this._oGainNode),this._oGainNode.connect(this._destAudioNode),this._createMixSourceNode(t),this._createMixGainNode(),this._mSourceNode.connect(this._mGainNode),this._mGainNode.connect(this._destAudioNode),this._destAudioNode.stream}catch(e){return a.default.log(e.toString(),o.LOG.SCREEN),null}}},{key:"stop",value:function(){this._destroyOriGainNode(),this._destroyOriSourceNode(),this._destroyMixGainNode(),this._destroyMixSourceNode(),this._destroyDestinationNode(),this._destroyAudioContext()}},{key:"_createAudioContext",value:function(){if(!this._context){var e=window.AudioContext||window.webkitAudioContext,t=new e;this._context=t}}},{key:"_destroyAudioContext",value:function(){this._context&&(this._context.close(),this._context=null)}},{key:"_createDestinationNode",value:function(){this._context&&(this._destAudioNode||(this._destAudioNode=this._context.createMediaStreamDestination()))}},{key:"_destroyDestinationNode",value:function(){this._destAudioNode&&(this._destAudioNode.mediaStream&&this._destroyStream(this._destAudioNode.mediaStream),this._destAudioNode=null)}},{key:"_createOriSourceNode",value:function(e){this._context&&(this._oSourceNode&&this._destroyOriSourceNode(),this._oSourceNode=this._context.createMediaStreamSource(e))}},{key:"_destroyOriSourceNode",value:function(){this._oSourceNode&&(this._oSourceNode.mediaStream&&this._destroyStream(this._oSourceNode.mediaStream),this._oSourceNode=null)}},{key:"_createOriGainNode",value:function(){this._context&&(this._oGainNode||(this._oGainNode=this._context.createGain(),this._oGainNode.gain.value=this._oVolume))}},{key:"_destroyOriGainNode",value:function(){this._oGainNode&&(this._oGainNode.disconnect(),this._oGainNode=null)}},{key:"_createMixSourceNode",value:function(e){this._context&&(this._mSourceNode&&this._destroyMixSourceNode(),this._mSourceNode=this._context.createMediaStreamSource(e))}},{key:"_destroyMixSourceNode",value:function(){this._mSourceNode&&(this._mSourceNode.mediaStream&&this._destroyStream(this._mSourceNode.mediaStream),this._mSourceNode=null)}},{key:"_createMixGainNode",value:function(){this._context&&(this._mGainNode||(this._mGainNode=this._context.createGain(),this._mGainNode.gain.value=this._mVolume))}},{key:"_destroyMixGainNode",value:function(){this._mGainNode&&(this._mGainNode.disconnect(),this._mGainNode=null)}},{key:"_destroyStream",value:function(e){if(e)try{for(var t=e.getTracks(),i=0;i<t.length;i++)t[i].stop()}catch(e){}}}]),e}();t.default=u},function(e,t,i){"use strict";function r(e){return e&&e.__esModule?e:{default:e}}function s(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}Object.defineProperty(t,"__esModule",{value:!0});var o=function(){function e(e,t){for(var i=0;i<t.length;i++){var r=t[i];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}return function(t,i,r){return i&&e(t.prototype,i),r&&e(t,r),t}}(),n=i(0),a=i(6),u=r(a),c=i(1),l=r(c),h=i(112),d=r(h),f=function(){function e(t,i){s(this,e),this.handler=t,this.isStop=!0,this.screener=void 0,this.callback=i,this._screenStream=null}return o(e,[{key:"start",value:function(e,t){var i=this,r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{};this.isStop=!1,this.screener||(this.screener=new d.default),this.screener.getScreenId(function(s,o,a){return i.isStop?(l.default.warn("[getScreenId], service stop",n.LOG.SCREEN),void i.stop()):s&&(l.default.warn(s,n.LOG.SCREEN),i.callback)?void i.callback(s.toString()):!o&&(l.default.warn("no sourceId!",n.LOG.SCREEN),i.callback)?void i.callback("no sourceId!"):a?("false"===String(r.isMixOutAudio)&&(l.default.log("not record out audio",n.LOG.SCREEN),a.audio=!1),a.audio||"false"!==String(r.isMixInAudio)||(l.default.log("not record in and out audio",n.LOG.SCREEN),i.handler.mediaConfig.isAudio=!1),i.handler.mediaConfig.isVideo=!0,void(u.default.isOldGetUserMedia()?window.navigator?window.navigator.getUserMedia(a,function(t){i._screenStream=t,e&&e(t)},t):l.default.warn("getUserMedia api not supported!",n.LOG.SCREEN):window.navigator&&window.navigator.mediaDevices?window.navigator.mediaDevices.getUserMedia(a).then(function(t){i._screenStream=t,e&&e(t)}).catch(t):l.default.warn("getUserMedia api not supported!",n.LOG.SCREEN))):void l.default.warn("no screen_constraints!",n.LOG.SCREEN)},{})}},{key:"stop",value:function(){if(this.isStop=!0,this._screenStream)try{for(var e=this._screenStream.getTracks(),t=0;t<e.length;t++)e[t].stop()}catch(e){}this._screenStream=null,this.screener&&(this.screener=void 0)}}]),e}();t.default=f},function(e,t,i){"use strict";function r(e){return e&&e.__esModule?e:{default:e}}function s(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}Object.defineProperty(t,"__esModule",{value:!0});var o=function(){function e(e,t){for(var i=0;i<t.length;i++){var r=t[i];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}return function(t,i,r){return i&&e(t.prototype,i),r&&e(t,r),t}}(),n=i(0),a=i(1),u=r(a),c=i(37),l=r(c),h=i(13),d=r(h),f=function(){function e(){s(this,e)}return o(e,null,[{key:"resetICECandidate",value:function(e,t){var i=t,r=l.default.hasCandidate(i);u.default.log("have udp candidate: "+r.hasUDP,n.LOG.PUSH),u.default.log("have tcp candidate: "+r.hasTCP,n.LOG.PUSH);var s=e.enforceTCP;return s&&r.hasTCP&&(u.default.log("disable udp channel",n.LOG.PUSH),i=l.default.removeCandidate(i,"udp")),!s&&r.hasUDP&&r.hasTCP&&d.default.isFirefox()&&(u.default.log("firefox force to disable tcp channel",n.LOG.PUSH),i=l.default.removeCandidate(i,"tcp")),i}},{key:"bitrateControl",value:function(e,t){var i=t;return e.audioBitrate>0&&(i=l.default.setBandwidth(i,"audio",e.audioBitrate)),e.videoBitrate>0&&(i=e.isBrControl?l.default.bitrateControl(i,{max:e.videoBitrate,start:e.videoBitrate,min:Math.floor(e.videoBitrate*e.brFactor)}):l.default.setBandwidth(i,"video",e.videoBitrate)),e.isAudioCBR&&(i=l.default.bitrateConstant(i,"audio")),e.isVideoCBR&&(i=l.default.bitrateConstant(i,"video")),i}}]),e}();t.default=f},function(e,t,i){"use strict";function r(e){return e&&e.__esModule?e:{default:e}}function s(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function o(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t}function n(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}Object.defineProperty(t,"__esModule",{value:!0});var a=function(){function e(e,t){for(var i=0;i<t.length;i++){var r=t[i];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}return function(t,i,r){return i&&e(t.prototype,i),r&&e(t,r),t}}(),u=i(0),c=i(10),l=i(1),h=r(l),d=i(3),f=r(d),_=function(e){function t(e){s(this,t);var i=o(this,(t.__proto__||Object.getPrototypeOf(t)).call(this));return i.isActive=!1,i.video=e,i.isVideo=!0,i}return n(t,e),a(t,[{key:"quit",value:function(e){return!this.isActive&&(h.default.debug("["+e+"]server stop",u.LOG.PUSH),!0)}},{key:"start",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};if(this.isActive=!0,this.isVideo=!("false"===String(e.isVideo)),!this.video)return void h.default.warn("add local video is null",u.LOG.PUSH);this.video.volume=0,this.video.addEventListener("pause",this.localPause.bind(this)),this.video.addEventListener("error",this.localError.bind(this)),this.video.addEventListener("ended",this.localEnded.bind(this)),this.video.addEventListener("playing",this.localPlay.bind(this)),this.video.addEventListener("waiting",this.localWaiting.bind(this)),this.video.addEventListener("loadedmetadata",this.localMetadata.bind(this))}},{key:"stop",value:function(){this.isActive=!1,this.video&&(this.video.srcObject=null,this.video.removeEventListener("pause",this.localPause.bind(this)),this.video.removeEventListener("error",this.localError.bind(this)),this.video.removeEventListener("ended",this.localEnded.bind(this)),this.video.removeEventListener("playing",this.localPlay.bind(this)),this.video.removeEventListener("waiting",this.localWaiting.bind(this)),this.video.removeEventListener("loadedmetadata",this.localMetadata.bind(this)),this.video=void 0)}},{key:"play",value:function(e){this.video&&(this.video.srcObject=e)}},{key:"localEnded",value:function(){this.quit("localEnded")||h.default.log("video ended",u.LOG.PUSH)}},{key:"localPause",value:function(){this.quit("localPause")||h.default.log("video pause",u.LOG.PUSH)}},{key:"localPlay",value:function(){this.quit("localPlay")||h.default.log("video playing",u.LOG.PUSH)}},{key:"localWaiting",value:function(){this.quit("localWaiting")||h.default.log("video waiting",u.LOG.PUSH)}},{key:"localError",value:function(e){if(!this.quit("localError")){var t=void 0;e&&e.currentTarget&&(t=e.currentTarget.error);var i=-1,r="unknow";t&&(i=t.code||-1,r=t.message,h.default.error("localError: ["+i+"]["+r+"]",u.LOG.PUSH)),this.dispatchEvent(c.PushMessage.PLAY_ERROR,i,r)}}},{key:"localMetadata",value:function(e){var t=this;if(!this.quit("localMetadata")){var i=-1,r=-1;if(e&&e.target&&(i=e.target.videoWidth,r=e.target.videoHeight),e&&e.target)try{e.target.play()}catch(e){}this.isVideo&&(i>=0&&i<=2||r>=0&&r<=2)?window.setTimeout(function(){t.quit("localMetadata")||(e&&e.target&&(i=e.target.videoWidth,r=e.target.videoHeight),h.default.log("localMetadata ["+i+"x"+r+"]",u.LOG.PUSH),t.dispatchEvent(c.PushMessage.PLAY_METADATA,u.RSP.SUCCESS,"metadata",{width:i,height:r}))},5e3):(h.default.log("localMetadata ["+i+"x"+r+"]",u.LOG.PUSH),this.dispatchEvent(c.PushMessage.PLAY_METADATA,u.RSP.SUCCESS,"metadata",{width:i,height:r}))}}},{key:"dispatchEvent",value:function(e,t,i){var r=arguments.length>3&&void 0!==arguments[3]?arguments[3]:{};this.quit("dispatchEvent")||this.trigger(c.PushEvent.VIDEO_EVENT,{type:e,code:t,message:i,data:r})}}]),t}(f.default);t.default=_},function(e,t,i){"use strict";function r(e){return e&&e.__esModule?e:{default:e}}function s(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}Object.defineProperty(t,"__esModule",{value:!0});var o=function(){function e(e,t){for(var i=0;i<t.length;i++){var r=t[i];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}return function(t,i,r){return i&&e(t.prototype,i),r&&e(t,r),t}}(),n=i(0),a=i(55),u=r(a),c=i(108),l=r(c),h=i(1),d=r(h),f=function(){function e(){s(this,e),this._filename="",this._watermarkImages=[],this._watermarkWorker=null}return o(e,[{key:"start",value:function(e){var t=this,i=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};return this.stop(),this._parseConfig(i),Promise.resolve().then(function(){if(t._hiddenVideoElement||t._createHiddenVideoElement(),t._hiddenVideoElement.volume=0,t._hiddenVideoElement.srcObject=e,!(t._hiddenVideoElement.paused||t._hiddenVideoElement.buffered&&!t._hiddenVideoElement.buffered.length))return Promise.resolve();t._hiddenVideoElement.onplaying=function(){return Promise.resolve()},t._hiddenVideoElement.onloadedmetadata=function(){return Promise.resolve()}}).then(function(){return t._hiddenVideoElement&&(t._hiddenVideoElement.onplaying=null,t._hiddenVideoElement.onloadedmetadata=null),t._watermarkImages.length?(t._createHiddenCanvas(),t._startWatermarkWorker(),t._watermarkWorker?t._hiddenCanvasElement.captureStream(20):(d.default.log("creat webWorker failed",n.LOG.PUSH),t.stop(),null)):(d.default.log("no image watermark",n.LOG.PUSH),t.stop(),null)})}},{key:"stop",value:function(){this._stopWatermarkWorker(),this._destroyWatermark(),this._destroyHiddenVideoElement(),this._destroyHiddenCanvasElement()}},{key:"_parseConfig",value:function(e){if(e)for(var t in e)if(e.hasOwnProperty(t))switch(t){case"workerFilename":this._filename=e[t]||"";break;case"config":this._parseWatermark(e[t]||[])}}},{key:"_createHiddenVideoElement",value:function(){this._hiddenVideoElement||(this._hiddenVideoElement=document.createElement("video"),this._hiddenVideoElement.setAttribute("autoplay","autoplay"),this._hiddenVideoElement.setAttribute("playsinline",""),this._hiddenVideoElement.setAttribute("x5-playsinline",""),this._hiddenVideoElement.setAttribute("webkit-playsinline",""),this._hiddenVideoElement.setAttribute("oncontextmenu","return false"),this._isSafari()?(this._hiddenVideoElement.setAttribute("width","1px"),this._hiddenVideoElement.setAttribute("height","1px")):this._hiddenVideoElement.style.display="none")}},{key:"_destroyHiddenVideoElement",value:function(){this._hiddenVideoElement&&(this._hiddenVideoElement.srcObject=null,this._hiddenVideoElement=void 0)}},{key:"_createHiddenCanvas",value:function(){this._hiddenCanvasElement||(this._hiddenCanvasElement=document.createElement("canvas"),this._hiddenCanvasElement.style.display="none",this._hiddenCanvasElement.setAttribute("width",this._hiddenVideoElement.videoWidth),this._hiddenCanvasElement.setAttribute("height",this._hiddenVideoElement.videoHeight)),this._canvasVidContext=this._hiddenCanvasElement.getContext("2d")}},{key:"_destroyHiddenCanvasElement",value:function(){this._hiddenCanvasElement=void 0}},{key:"_parseWatermark",value:function(e){if(e&&e.length)for(var t=void 0,i=0;i<e.length;i++){t=e[i];var r={url:"",x:.05,y:.05,width:.2,height:.2};for(var s in t)if(t.hasOwnProperty(s))switch(s){case"url":r[s]=t[s]||"";break;case"x":case"y":var o=parseFloat(t[s]);!isNaN(o)&&o>0&&o<=1&&(r[s]=o);break;case"width":case"height":var n=parseFloat(t[s]);!isNaN(n)&&n>0&&n<=1&&(r[s]=n)}this._createWatermark(r)}}},{key:"_createWatermark",value:function(e){var t=new l.default;t.setImage(e),this._watermarkImages.push(t)}},{key:"_destroyWatermark",value:function(){this._watermarkImages.forEach(function(e){e.resetImage()}),this._watermarkImages=[]}},{key:"_sendImageToCanvas",value:function(){var e=this;this._hiddenCanvasElement&&this._hiddenVideoElement&&(0===this._hiddenCanvasElement.width&&0!==this._hiddenVideoElement.videoWidth&&(this._hiddenCanvasElement.setAttribute("width",this._hiddenVideoElement.videoWidth),this._hiddenCanvasElement.setAttribute("height",this._hiddenVideoElement.videoHeight)),0!==this._hiddenVideoElement.videoWidth&&this._watermarkImages.forEach(function(t){t.isPos||t.setPos(e._hiddenVideoElement.videoWidth,e._hiddenVideoElement.videoHeight)}),0!==this._hiddenCanvasElement.width&&(this._canvasVidContext.drawImage(this._hiddenVideoElement,0,0,this._hiddenVideoElement.videoWidth,this._hiddenVideoElement.videoHeight),this._watermarkImages.forEach(function(t){t.image&&t.isLoaded&&e._canvasVidContext.drawImage(t.image,t.pos.x,t.pos.y,t.pos.width,t.pos.height)})))}},{key:"_startWatermarkWorker",value:function(){var e=this;try{this._watermarkWorker||(""===this._filename?this._watermarkWorker=(0,u.default)(109):this._watermarkWorker=new Worker(this._filename))}catch(e){d.default.warn(e.toString(),n.LOG.PUSH),this._watermarkWorker=null}this._watermarkWorker&&(this._watermarkWorker.onmessage=function(t){e._sendImageToCanvas(),e._watermarkWorker.postMessage([])},this._watermarkWorker.postMessage([]))}},{key:"_stopWatermarkWorker",value:function(){this._watermarkWorker&&(this._watermarkWorker.terminate(),this._watermarkWorker=void 0)}},{key:"_isSafari",value:function(){var e=navigator.userAgent.toLowerCase();return-1!==e.indexOf("safari")&&-1===e.indexOf("chrome")}}]),e}();t.default=f},function(e,t,i){"use strict";function r(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}Object.defineProperty(t,"__esModule",{value:!0});var s=function(){function e(e,t){for(var i=0;i<t.length;i++){var r=t[i];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}return function(t,i,r){return i&&e(t.prototype,i),r&&e(t,r),t}}(),o=function(){function e(){r(this,e),this._url="",this._isPos=!1,this._isLoaded=!1,this._imagePos={},this._imageElem=null}return s(e,[{key:"setImage",value:function(){var e=this,t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};this._imagePos=t||{},this._imageElem||(this._isLoaded=!1,this._imageElem=new Image,this._imageElem.onload=function(){e._isLoaded=!0},this._imageElem.onerror=function(){e.resetImage()}),this._imageElem.src=this._imagePos.url||""}},{key:"setPos",value:function(e,t){this._isPos||(this._isPos=!0,this._imagePos.x*=e,this._imagePos.y*=t,this._imagePos.width*=e,this._imagePos.height*=t)}},{key:"resetImage",value:function(){this._isPos=!1,this._isLoaded=!1,this._imageElem=null}},{key:"pos",get:function(){return this._imagePos}},{key:"image",get:function(){return this._imageElem}},{key:"isPos",get:function(){return this._isPos}},{key:"isLoaded",get:function(){return this._isLoaded}}]),e}();t.default=o},function(e,t,i){"use strict";e.exports=function(e){e.addEventListener("message",function(t){e.postMessage([])})}},function(e,t,i){"use strict";function r(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}Object.defineProperty(t,"__esModule",{value:!0});var s=function(){function e(e,t){for(var i=0;i<t.length;i++){var r=t[i];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}return function(t,i,r){return i&&e(t.prototype,i),r&&e(t,r),t}}(),o=function(){function e(){r(this,e),this._cameras=[],this._cameraIndex=0,this._aspectIndex=0,this._logCallback=void 0,this._mediaStream=void 0,this._customAspect=void 0,this.ASPECT=[{width:240,height:180,label:"180P_1"},{width:320,height:180,label:"180P_2"},{width:480,height:360,label:"360P_1"},{width:640,height:360,label:"360P_2"},{width:640,height:480,label:"480P_1"},{width:848,height:480,label:"480P_2"},{width:720,height:540,label:"540P_1"},{width:960,height:540,label:"540P_2"},{width:960,height:720,label:"720P_1"},{width:1280,height:720,label:"720P_2"},{width:1440,height:1080,label:"1080P_1"},{width:1920,height:1080,label:"1080P_2"}]}return s(e,[{key:"detect",value:function(e){var t=this;this._cameraIndex=0,this._aspectIndex=0,this._destroyTimer(),this._getMediaDevices(function(i){t._cameras=i,t._cameras.length&&(e?(t._customAspect=e,t._aspectTest(e,t._cameras[0])):(t._customAspect=void 0,t._aspectTest(t.ASPECT[0],t._cameras[0])))})}},{key:"setLogCallback",value:function(e){this._logCallback=e}},{key:"_trace",value:function(e){console&&console.log&&console.log(e),this._logCallback&&this._logCallback(e)}},{key:"_getMediaDevices",value:function(e){var t=void 0,i=[],r=window.navigator.mediaDevices;r&&r.enumerateDevices?r.enumerateDevices().then(function(r){for(var s in r)if(r.hasOwnProperty(s)){var o={};t=r[s],o.kind=t.kind,o.label=t.label,o.groupId=t.groupId,o.deviceId=t.deviceId,""===o.label&&(o.label=o.deviceId),"videoinput"===t.kind&&i.push(o)}e&&e(i)}).catch(function(){e&&e(i)}):e&&e(i)}},{key:"_aspectTest",value:function(e,t){var i=this;this._mediaStream&&this._mediaStream.getTracks().forEach(function(e){e.stop()});var r={audio:!1,video:{deviceId:t.deviceId?{exact:t.deviceId}:void 0,width:{exact:e.width},height:{exact:e.height}}},s=e.width+"x"+e.height;navigator.mediaDevices.getUserMedia(r).then(function(r){i._mediaStream=r,i._trace("trying "+s+"["+e.label+"] on ["+t.label+"] successed"),i._createTimer()}).catch(function(r){i._trace("trying "+s+"["+e.label+"] on ["+t.label+"] failed: "+r.toString()),i._createTimer()})}},{key:"_createTimer",value:function(){this._destroyTimer(),this._customAspect?++this._cameraIndex<this._cameras.length&&(this._timer=window.setTimeout(this._onTimerHandler.bind(this),200)):(this._aspectIndex++,this._aspectIndex<this.ASPECT.length?this._cameraIndex<this._cameras.length&&(this._timer=window.setTimeout(this._onTimerHandler.bind(this),200)):++this._cameraIndex<this._cameras.length&&(this._aspectIndex=0,this._timer=window.setTimeout(this._onTimerHandler.bind(this),200)))}},{key:"_destroyTimer",value:function(){this._timer&&(window.clearTimeout(this._timer),this._timer=void 0),this._mediaStream&&this._mediaStream.getTracks().forEach(function(e){e.stop()})}},{key:"_onTimerHandler",value:function(){this._customAspect?this._aspectTest(this._customAspect,this._cameras[this._cameraIndex]):this._aspectTest(this.ASPECT[this._aspectIndex],this._cameras[this._cameraIndex])}}]),e}();t.default=o},function(e,t,i){"use strict";function r(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}Object.defineProperty(t,"__esModule",{value:!0});var s=function(){function e(e,t){for(var i=0;i<t.length;i++){var r=t[i];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}return function(t,i,r){return i&&e(t.prototype,i),r&&e(t,r),t}}(),o=function(){function e(){r(this,e),this.notifys={},this.enableNotification=!!Notification}return s(e,[{key:"notify",value:function(e,t){if(this.enableNotification){var i=Math.random().toFixed(8).substring(2),r=window.Notification||window.mozNotification||window.webkitNotification;new r(e,{tag:i,body:t.body||"",icon:"../images/avatar.jpg",requireInteraction:"true"===String(t.isFixed)})}}},{key:"close",value:function(){this.notifys={}}}]),e}();t.default=o},function(e,t,i){"use strict";function r(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}Object.defineProperty(t,"__esModule",{value:!0});var s=function(){function e(e,t){for(var i=0;i<t.length;i++){var r=t[i];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}return function(t,i,r){return i&&e(t.prototype,i),r&&e(t,r),t}}(),o=i(2),n=function(){function e(){r(this,e),this.iframe=void 0,window.getScreenConstraints=this.windowGetScreenConstraints.bind(this),window.getChromeExtensionStatus=this.windowGetChromeExtensionStatus.bind(this),this.IFRAME_ADDR="https://static.cloudv.haplat.net/player/getSourceId.html",this.IFRAME_TEST_ADDR="https://vclient.test.8686c.com:88/linxj/extension/getSourceId.html",this.IFRAME_OFFICIAL_ADDR="https://www.webrtc-experiment.com/getSourceId/"}return s(e,[{key:"getConstraints",value:function(e,t,i){var r={audio:!1,video:{mandatory:{chromeMediaSource:e?"screen":"desktop",maxWidth:window.screen.width>1920?window.screen.width:1920,maxHeight:window.screen.height>1080?window.screen.height:1080},optional:[]}};return i&&(r.audio={mandatory:{chromeMediaSource:e?"screen":"desktop",echoCancellation:!0},optional:[]}),t&&(r.video.mandatory.chromeMediaSourceId=t,r.audio&&r.audio.mandatory&&(r.audio.mandatory.chromeMediaSourceId=t)),r}},{key:"getScreenId",value:function(e,t){function i(t){t&&t.data&&(t.data.chromeMediaSourceId&&("PermissionDeniedError"===t.data.chromeMediaSourceId?e&&e("permission-denied"):e&&e(null,t.data.chromeMediaSourceId,s.getConstraints(null,t.data.chromeMediaSourceId,t.data.canRequestAudioTrack)),window.removeEventListener("message",i)),t.data.chromeExtensionStatus&&(e&&e(t.data.chromeExtensionStatus,null,s.getConstraints(t.data.chromeExtensionStatus)),window.removeEventListener("message",i)))}var r=this;if(-1!==navigator.userAgent.indexOf("Edge")&&(navigator.msSaveOrOpenBlob||navigator.msSaveBlob))return void(e&&e({video:!0}));if(navigator.mozGetUserMedia)return void(e&&e(null,"firefox",{video:{mozMediaSource:"window",mediaSource:"window"}}));var s=this;window.addEventListener("message",i),t?window.setTimeout(function(){r.postGetSourceIdMessage(t)},100):window.setTimeout(function(){r.postGetSourceIdMessage()},100)}},{key:"postGetSourceIdMessage",value:function(e){var t=this;return this.iframe?this.iframe.isLoaded?void(e?e.forEach?this.iframe.contentWindow.postMessage({captureCustomSourceId:e},"*"):this.iframe.contentWindow.postMessage({captureSourceIdWithAudio:!0},"*"):this.iframe.contentWindow.postMessage({captureSourceId:!0},"*")):void window.setTimeout(function(){t.postGetSourceIdMessage(e)},100):void this.loadIFrame(function(){t.postGetSourceIdMessage(e)})}},{key:"windowGetScreenConstraints",value:function(e){var t=this;this.loadIFrame(function(){t.getScreenId(function(t,i,r){r||(r={video:!0}),e(t,r.video)})})}},{key:"loadIFrame",value:function(e){var t=this;if(this.iframe)return void e();this.iframe=document.createElement("iframe"),this.iframe&&(this.iframe.onload=function(){t.iframe.isLoaded=!0,e()},o.Globals.isScreenTest?2===o.Globals.screenPathType?this.iframe.src=this.IFRAME_TEST_ADDR:3===o.Globals.screenPathType?this.iframe.src=this.IFRAME_OFFICIAL_ADDR:this.iframe.src=this.IFRAME_ADDR:this.iframe.src=this.IFRAME_ADDR,this.iframe.style.display="none",(document.body||document.documentElement).appendChild(this.iframe))}},{key:"windowGetChromeExtensionStatus",value:function(e){function t(i){i.data&&(i.data.chromeExtensionStatus&&e(i.data.chromeExtensionStatus),window.removeEventListener("message",t))}var i=this;if(navigator.mozGetUserMedia)return void e("installed-enabled");window.addEventListener("message",t),window.setTimeout(function(){i.postGetChromeExtensionStatusMessage()},100)}},{key:"postGetChromeExtensionStatusMessage",value:function(){var e=this;return this.iframe?this.iframe.isLoaded?void this.iframe.contentWindow.postMessage({getChromeExtensionStatus:!0},"*"):void setTimeout(function(){e.postGetChromeExtensionStatusMessage()},100):void this.loadIFrame(function(){e.postGetChromeExtensionStatusMessage()})}}]),e}();t.default=n},function(e,t,i){"use strict";function r(e){return e&&e.__esModule?e:{default:e}}var s=i(2),o=i(6),n=r(o),a=i(1),u=r(a),c=i(39),l=r(c),h=i(40),d=r(h),f=i(41),_=r(f),v=i(43),p=r(v),m=i(42),g=r(m),y=i(21),E=r(y),S=i(20),R=r(S),T=i(24),C=r(T),b=i(23),P=r(b),O=i(22),A=r(O),k=i(4),I=function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var i in e)Object.prototype.hasOwnProperty.call(e,i)&&(t[i]=e[i]);return t.default=e,t}(k),w=!1,M=I.Event;t.WSEvent=I,t.WSInit=function(){var e=void 0;return{init:function(t,i){var r=this;w=!1,e||(e=new _.default(function(e){w=!0,i&&i(e),r.destroy()}),e.start(t))},destroy:function(){e&&(e.stop(),e=void 0)}}}(),t.WSAuth=function(){return{fetch:function(e){d.default.fetch(e)},setUserAuthInfo:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};s.Globals.token=e.token||"",s.Globals.ticket=e.ticket||"";var t=parseInt(e.permissionIndex);isNaN(t)||-1!==t&&0!==t&&1!==t||(s.Globals.permissionIndex=t)}}}(),t.WSDestroy=function(){return{destroy:function(){e.exports.WSEmitter.removeToAll(),e.exports.WSInit.destroy(),e.exports.WSChannel.destroy(),e.exports.WSPlayer.destroy(),e.exports.WSPusher.destroy(),e.exports.WSPuller.destroy(),e.exports.WSMixer.destroy(),e.exports.WSSignal.destroy()}}}(),t.WSSignal=function(){var e=void 0;return{init:function(){w&&(e||(e=new p.default))},createChannel:function(t){if(e)return e.createChannel(t)},joinChannel:function(t){var i=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"",r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:"",s=arguments.length>3&&void 0!==arguments[3]?arguments[3]:[],o=arguments.length>4&&void 0!==arguments[4]?arguments[4]:{};e&&e.joinChannel(t,i,r,s,o)},quitChannel:function(t){e&&e.quitChannel(t)},sendUnicastMessage:function(t,i,r){e&&e.sendUnicastMessage(t,i,r)},sendMulticastMessage:function(t,i,r){e&&e.sendMulticastMessage(t,i,r)},sendBroadcastMessage:function(t,i){e&&e.sendBroadcastMessage(t,i)},destroy:function(){e&&(e=void 0)}}}(),t.WSPlayer=function(){var e=void 0;return{play:function(t){w&&t&&(e||(e=new E.default,e.listenTo(M.PLAYER_EVENT,function(e){s.Globals.observer&&s.Globals.observer.trigger(M.PLAYER_EVENT,e)}),e.start(t)))},play2:function(){return w?new E.default:void 0},getVolume:function(){return e?e.getVolume():-1},setVolume:function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:1;if(e){var i=parseFloat(t);!isNaN(i)&&i>=0&&i<=1&&e&&e.setVolume(i)}},debug:function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};e&&e.debug(t)},debugSourceBuffer:function(){e&&e.debugSourceBuffer()},stop:function(){e&&(e.removeToAll(),e.stop(),e=void 0)},destroy:function(){this.stop()}}}(),t.WSPreviewer=function(){var e=void 0;return{startPreview:function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};w&&(e||(e=new A.default),e.start(t))},startPreview2:function(){return w?new A.default:void 0},stopPreview:function(){e&&(e.stop(),e=void 0)},destroy:function(){this.stopPreview()}}}(),t.WSPusher=function(){var e=void 0;return{startPush:function(t){w&&t&&(e||(e=new C.default,e.listenTo(M.PUSH_STREAM_EVENT,function(e){s.Globals.observer&&s.Globals.observer.trigger(M.PUSH_STREAM_EVENT,e)}),e.start(t)))},startPush2:function(){return w?new C.default:void 0},switchAudio:function(t){e&&e.switchAudio(t)},switchVideo:function(t){e&&e.switchVideo(t)},addStream:function(t){e&&t&&e.addStream(t)},getPeerStatus:function(){var t=!(arguments.length>0&&void 0!==arguments[0])||arguments[0];e&&e.getPeerStatus(t)},startMixAudio:function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"";e&&e.startMixAudio(t)},stopMixAudio:function(){e&&e.stopMixAudio()},pauseMixAudio:function(){e&&e.pauseMixAudio()},resumeMixAudio:function(){e&&e.resumeMixAudio()},setMixAudioVolume:function(t){var i=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0;e&&e.setMixAudioVolume(t,i)},setMixAudioLoop:function(t,i){e&&e.setMixAudioLoop(t,i)},stopPush:function(){e&&(e.removeToAll(),e.stop(),e=void 0)},destroy:function(){this.stopPush()}}}(),t.WSPuller=function(){var e=void 0;return{startPull:function(t){w&&t&&(e||(e=new P.default,e.listenTo(M.PULL_STREAM_EVENT,function(e){s.Globals.observer&&s.Globals.observer.trigger(M.PULL_STREAM_EVENT,e)}),e.start(t)))},startPull2:function(){return w?new P.default:void 0},switchAudio:function(t){e&&e.switchAudio(t)},switchVideo:function(t){e&&e.switchVideo(t)},getPeerStatus:function(){var t=!(arguments.length>0&&void 0!==arguments[0])||arguments[0];e&&e.getPeerStatus(t)},stopPull:function(){e&&(e.removeToAll(),e.stop(),e=void 0)},destroy:function(){this.stopPull()}}}(),t.WSMixer=function(){var e=void 0;return{startMix:function(t){w&&t&&(e||(e=new R.default,e.listenTo(M.MIX_STREAM_EVENT,function(e){s.Globals.observer&&s.Globals.observer.trigger(M.MIX_STREAM_EVENT,e)}),e.start(t)))},startMix2:function(){return w?new R.default:void 0},mixHost:function(t){e&&e.mixHost(t)},mixSwitchHost:function(){e&&e.mixSwitchHost()},mixCreate:function(t){e&&e.mixCreate(t)},mixModify:function(t){e&&e.mixModify(t)},mixAdjust:function(t){e&&e.mixAdjust(t)},mixJoin:function(t){e&&e.mixJoin(t)},mixQuit:function(t){e&&e.mixQuit(t)},mixStatus:function(t){e&&e.mixStatus(t)},mixQuery:function(t){e&&e.mixQuery(t)},mixDestroy:function(t){e&&e.mixDestroy(t)},startMixCheck:function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:60;e&&e.startMixCheck(t)},stopMixCheck:function(){e&&e.stopMixCheck()},stopMix:function(){e&&(e.removeToAll(),e.stop(),e=void 0)},destroy:function(){this.stopMix()}}}(),t.WSChannel=function(){var e=void 0;return{init:function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};w&&(e||(e=new g.default,e.listenTo(M.CHANNEL_EVENT,function(e){s.Globals.observer&&s.Globals.observer.trigger(M.CHANNEL_EVENT,e)})),e.init(t))},startPreview:function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};e&&e.startPreview(t)},stopPreview:function(){e&&e.stopPreview()},sendMessage:function(t,i){e&&e.sendMessage(t,i)},broadcastMessage:function(t){e&&e.sendMessage(t)},changeRole:function(t){e&&e.changeRole(t)},createChannel:function(t,i,r){e&&e.createChannel(t,i,r)},destroyChannel:function(){e&&e.destroyChannel()},joinChannel:function(t,i,r){e&&e.joinChannel(t,i,r)},quitChannel:function(){e&&e.quitChannel()},joinVChannel:function(t){e&&e.joinVChannel(t)},quitVChannel:function(t){e&&e.quitVChannel(t)},debug:function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};e&&e.debug(t)},debugSourceBuffer:function(){e&&e.debugSourceBuffer()},stopPushAudio:function(){},stopPushVideo:function(){},switchAudio:function(t){e&&e.switchAudio(t)},switchVideo:function(t){e&&e.switchVideo(t)},addStream:function(t){e&&e.addStream(t)},startMixAudio:function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"";e&&e.startMixAudio(t)},stopMixAudio:function(){e&&e.stopMixAudio()},pauseMixAudio:function(){e&&e.pauseMixAudio()},resumeMixAudio:function(){e&&e.resumeMixAudio()},setMixAudioVolume:function(t){var i=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0;e&&e.setMixAudioVolume(t,i)},setMixAudioLoop:function(t,i){e&&e.setMixAudioLoop(t,i)},destroy:function(){e&&(e.removeToAll(),e.stop(),e=void 0)}}}(),t.WSEmitter={trigger:function(e){if(s.Globals.observer){for(var t,i=arguments.length,r=Array(i>1?i-1:0),o=1;o<i;o++)r[o-1]=arguments[o];(t=s.Globals.observer).trigger.apply(t,[e].concat(r))}},listenTo:function(e,t){s.Globals.observer&&s.Globals.observer.listenTo(e,t)},removeTo:function(e,t){s.Globals.observer&&s.Globals.observer.removeTo(e,t)},removeToAll:function(){s.Globals.observer&&s.Globals.observer.removeToAll()}},t.WSLogger={debug:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"Page";u.default.debug(e,t)},log:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"Page";u.default.log(e,t)},warn:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"Page";u.default.warn(e,t)},error:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"Page";u.default.error(e,t)},init:function(e){var t=e||{};t.id&&u.default.setLogPanel(t.id),t.level&&u.default.setLogLevel(t.level),t.callback&&u.default.setLogCallback(t.callback)}},t.WSUtil={version:"ILive_V2.5.1.20181225",trim:function(e){return n.default.trim(e)},uuid:function(){return n.default.uuid()},getBlowserInfo:function(){return n.default.getBlowserInfo()},getBrowserUUID:function(e){return n.default.getBrowserUUID(e)},getMediaDevices:function(e){n.default.getMediaDevices(e)},setVideoVolume:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:100;n.default.setVideoVolume(e,t)},setVideoDisplay:function(e,t){n.default.setVideoDisplay(e,t)},isMobile:function(){return n.default.isMobile()},isMobileQQ:function(){return n.default.isMobileQQ()},isMobileWX:function(){return n.default.isMobileWX()},isMobileFirefox:function(){return n.default.isMobileFirefox()},isMobileSafari:function(){return n.default.isIos()&&n.default.isSafari()},isOldGetUserMedia:function(){return n.default.isOldGetUserMedia()},isMSESupported:function(){return n.default.isMSESupported()},isWebRTCSupported:function(){return n.default.isWebRTCSupported()},isGetUserMediaSupported:function(){return n.default.isGetUserMediaSupported()},hasUserMedia:function(){return n.default.hasUserMedia()},hasRTCPeerConnection:function(){return n.default.hasRTCPeerConnection()}},t.WSDebug={parseSPS:function(e){return l.default.parseSPS(e)},aspectDetect:function(e,t){l.default.aspectDetect(e,t)},notify:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};l.default.notify(e)}}}])});